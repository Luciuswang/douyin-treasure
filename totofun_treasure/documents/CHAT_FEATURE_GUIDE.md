# 💬 好友聊天功能使用指南

> Totofun 突突翻 - 真实的好友聊天系统

---

## 📋 功能概览

### ✅ 已实现功能

#### 1. 好友系统
- ✅ 搜索用户（通过昵称或ID）
- ✅ 发送好友请求
- ✅ 接受/拒绝好友请求
- ✅ 好友列表展示
- ✅ 在线状态显示
- ✅ 删除好友

#### 2. 聊天功能
- ✅ 一对一实时聊天
- ✅ 文字消息
- ✅ 消息时间显示
- ✅ 未读消息提示
- ✅ 消息已读状态

#### 3. 特殊消息
- ✅ 位置分享
- ✅ 宝藏分享
- ✅ 任务分享
- ✅ 组队邀请

#### 4. 用户体验
- ✅ 实时消息推送
- ✅ 在线状态同步
- ✅ 消息列表自动滚动
- ✅ 未读消息角标

---

## 🚀 快速开始

### 第一步：配置 Firebase

详细配置步骤请参考：[Firebase 配置指南](./FIREBASE_SETUP.md)

**快速配置清单**：
- [ ] 创建 Firebase 项目
- [ ] 下载配置文件
- [ ] 启用 Authentication（匿名登录）
- [ ] 启用 Realtime Database
- [ ] 配置数据库规则

### 第二步：安装依赖

```bash
cd totofun_treasure
flutter pub get
```

### 第三步：运行应用

```bash
# Android
flutter run -d <your-device-id>

# iOS
flutter run -d <your-device-id>

# Chrome（Web）
flutter run -d chrome
```

---

## 📱 使用教程

### 1. 添加好友

#### 方法一：搜索添加

1. 点击右下角的**聊天按钮**（💬）
2. 点击右上角的**添加好友**按钮（➕）
3. 输入好友的**昵称**或**用户ID**
4. 点击「搜索」
5. 在搜索结果中点击「添加」按钮
6. 等待对方接受

#### 方法二：通过用户ID添加

每个用户都有唯一的ID，可以直接搜索ID添加：

```
示例ID：user_1234567890
```

### 2. 接受好友请求

1. 点击右下角的**聊天按钮**（💬）
2. 切换到「新的请求」标签
3. 查看好友请求列表
4. 点击「接受」或「拒绝」

### 3. 开始聊天

1. 在「我的好友」列表中
2. 点击好友头像或名称
3. 进入聊天界面
4. 输入消息，点击发送

### 4. 发送特殊消息

在聊天界面：

1. 点击输入框左侧的**加号**按钮（➕）
2. 选择消息类型：
   - 📍 **发送位置** - 分享你的当前位置
   - 🎁 **分享宝藏** - 分享发现的宝藏
   - 📋 **分享任务** - 分享任务信息
   - 👥 **组队邀请** - 邀请好友一起寻宝

### 5. 管理好友

#### 查看好友信息
- 在好友列表中，**长按**好友头像
- 查看详细信息

#### 删除好友
1. 在好友列表中，**长按**好友头像
2. 选择「删除好友」
3. 确认删除

---

## 🎨 界面说明

### 好友列表页面

```
┌─────────────────────────────┐
│  ← 好友              🔍  ➕  │  ← 标题栏
├─────────────────────────────┤
│  我的好友  |  新的请求       │  ← 标签栏
├─────────────────────────────┤
│                             │
│  👤 张三          🟢 在线   │  ← 好友项
│     最近一起寻宝了...        │
│                             │
│  👤 李四          ⚫ 离线   │
│     分享了一个宝藏...        │
│                             │
└─────────────────────────────┘
```

### 聊天界面

```
┌─────────────────────────────┐
│  ← 👤 张三    🟢 在线    ⋮  │  ← 标题栏
├─────────────────────────────┤
│                             │
│  [他] 嘿，一起去寻宝？       │
│       14:20                 │
│                             │
│       我在附近！ [你]        │
│             14:21           │
│                             │
│  [他] 📍 分享了位置          │
│       杭州市西湖区           │
│       14:22                 │
│                             │
├─────────────────────────────┤
│  ➕  [输入消息...]      📤   │  ← 输入栏
└─────────────────────────────┘
```

### 主界面聊天按钮

```
右下角悬浮按钮：
┌──────┐
│ 💬 3 │  ← 未读消息数
└──────┘
```

---

## 🔧 技术架构

### 数据模型

#### ChatUser（聊天用户）
```dart
{
  id: String,           // 用户ID
  nickname: String,     // 昵称
  avatar: String?,      // 头像URL
  isOnline: bool,       // 在线状态
  lastSeen: int?,       // 最后在线时间
  level: int,           // 等级
  experience: int,      // 经验值
}
```

#### ChatMessage（聊天消息）
```dart
{
  id: String,           // 消息ID
  chatId: String,       // 会话ID
  senderId: String,     // 发送者ID
  receiverId: String,   // 接收者ID
  type: MessageType,    // 消息类型
  content: String,      // 消息内容
  extra: Map?,          // 额外数据
  timestamp: int,       // 时间戳
  isRead: bool,         // 是否已读
}
```

#### Friendship（好友关系）
```dart
{
  id: String,           // 关系ID
  userId: String,       // 用户ID
  friendId: String,     // 好友ID
  status: Status,       // 状态（待确认/已接受/已拒绝）
  createdAt: int,       // 创建时间
  acceptedAt: int?,     // 接受时间
  remark: String?,      // 备注名
}
```

### Firebase 数据结构

```
firebase-realtime-database/
├── users/                    # 用户信息
│   ├── {userId}/
│   │   ├── id
│   │   ├── nickname
│   │   ├── avatar
│   │   ├── isOnline
│   │   └── lastSeen
│   └── ...
│
├── friendships/              # 好友关系
│   ├── {userId}_{friendId}/
│   │   ├── userId
│   │   ├── friendId
│   │   ├── status
│   │   └── createdAt
│   └── ...
│
├── messages/                 # 聊天消息
│   ├── {chatId}/
│   │   ├── {messageId}/
│   │   │   ├── senderId
│   │   │   ├── receiverId
│   │   │   ├── content
│   │   │   └── timestamp
│   │   └── ...
│   └── ...
│
└── conversations/            # 会话列表
    ├── {userId}/
    │   ├── {friendId}/
    │   │   ├── lastMessage
    │   │   ├── lastMessageTime
    │   │   └── unreadCount
    │   └── ...
    └── ...
```

---

## 🎯 使用场景

### 场景1：寻宝组队

**小明和小红是好友，想一起去寻宝**

1. 小明在地图上发现了一个宝藏
2. 点击宝藏详情的「分享」按钮
3. 选择分享给小红
4. 小红收到宝藏分享消息
5. 点击消息查看宝藏位置
6. 两人约定时间一起去寻宝

### 场景2：任务协作

**商家发布了需要多人协作的任务**

1. 小明看到一个组队任务
2. 在聊天中发送组队邀请给小红
3. 小红接受邀请
4. 两人一起完成任务
5. 共同获得奖励

### 场景3：位置分享

**小明和小红约好见面，但找不到对方**

1. 小明在聊天中点击「发送位置」
2. 小红收到位置消息
3. 点击位置消息查看地图
4. 根据位置找到小明

---

## 📊 数据统计

### 用户行为追踪

聊天系统会记录以下数据（用于优化产品）：

- 好友数量分布
- 消息发送频率
- 活跃时段分析
- 特殊消息使用率
- 用户留存率

### 隐私保护

- ✅ 消息端到端加密（计划中）
- ✅ 用户可删除聊天记录
- ✅ 用户可屏蔽好友
- ✅ 不会向第三方分享聊天内容

---

## 🔐 安全规则

### Firebase Realtime Database 规则

```json
{
  "rules": {
    "users": {
      "$uid": {
        ".read": "auth != null",
        ".write": "$uid === auth.uid"
      }
    },
    "friendships": {
      "$friendshipId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    "messages": {
      "$chatId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    "conversations": {
      "$userId": {
        ".read": "$userId === auth.uid",
        ".write": "$userId === auth.uid"
      }
    }
  }
}
```

**说明**：
- 用户只能读写自己的数据
- 好友关系需要认证后才能操作
- 消息需要认证后才能读写
- 会话列表只能自己访问

---

## 🐛 常见问题

### Q1: 为什么收不到消息？

**可能原因**：
1. 网络连接问题
2. Firebase 未正确配置
3. 对方未发送成功

**解决方案**：
1. 检查网络连接
2. 重启应用
3. 查看 Firebase 控制台的实时数据

### Q2: 好友请求发送失败？

**可能原因**：
1. 对方ID不存在
2. 已经是好友
3. 网络问题

**解决方案**：
1. 确认对方ID正确
2. 检查好友列表
3. 重试发送

### Q3: 消息显示延迟？

**可能原因**：
1. 网络延迟
2. Firebase 服务器响应慢

**解决方案**：
1. 检查网络速度
2. 选择更近的 Firebase 区域
3. 优化数据库查询

### Q4: 如何清空聊天记录？

**当前版本**：暂不支持清空聊天记录

**计划功能**：
- 删除单条消息
- 清空与某人的聊天记录
- 设置消息自动删除

---

## 🚀 未来计划

### 近期功能（1-2周）

- [ ] 图片消息
- [ ] 语音消息
- [ ] 表情包
- [ ] 消息撤回
- [ ] 消息转发

### 中期功能（1-2月）

- [ ] 群聊功能
- [ ] 视频通话
- [ ] 语音通话
- [ ] 朋友圈
- [ ] 附近的人

### 长期功能（3-6月）

- [ ] 端到端加密
- [ ] 消息云备份
- [ ] 多设备同步
- [ ] AI智能回复
- [ ] 翻译功能

---

## 💡 开发提示

### 本地测试

**多设备测试**：
1. 在两台设备上安装应用
2. 使用不同的用户登录
3. 互相添加好友
4. 测试聊天功能

**模拟器测试**：
1. 启动两个Android模拟器
2. 在两个模拟器上运行应用
3. 进行聊天测试

### 调试技巧

**查看 Firebase 实时数据**：
1. 打开 Firebase 控制台
2. 进入 Realtime Database
3. 查看数据实时变化

**查看日志**：
```bash
flutter logs
```

**清除缓存**：
```bash
flutter clean
flutter pub get
```

---

## 📞 技术支持

遇到问题？

1. 查看 [Firebase 配置指南](./FIREBASE_SETUP.md)
2. 查看 [项目 README](../README.md)
3. 提交 Issue 到 GitHub
4. 联系开发团队

---

**祝你使用愉快！开始和好友一起寻宝吧！** 🎉



