<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totofun 突突翻 - GPS寻宝游戏</title>
<meta name="description" content="基于GPS定位的实时寻宝游戏，探索身边的宝藏">
    <meta name="keywords" content="GPS寻宝,Totofun,突突翻,高德地图,定位游戏,寻宝游戏">
    
    <!-- PWA支持 -->
    <meta name="theme-color" content="#4FC3F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="icon" type="image/png" href="assets/images/totofun-logo.png">
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: system-ui, -apple-system, 'PingFang SC', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 50%, #FFA500 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #333;
            padding: 10px;
            line-height: 1.6;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            color: white;
            margin-bottom: 20px;
        }
        
        .logo-container {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            padding: 20px;
            display: inline-block;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            width: 160px;
            height: 160px;
            margin: 0 auto;
            display: block;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.15));
        }
        
        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) scale(1); 
            }
            50% { 
                transform: translateY(-10px) scale(1.05); 
            }
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            color: #ffffff;
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .stat {
            text-align: center;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .card h3 {
            color: #1E3A8A;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin: 20px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .api-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .api-input:focus {
            border-color: #4FC3F7;
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover:before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(79, 195, 247, 0.5);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn:disabled:before {
            display: none;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status.info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%);
            color: #1976d2;
            border: 1px solid #2196F3;
        }
        
        .status.success {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            color: #2e7d32;
            border: 1px solid #4CAF50;
        }
        
        .status.error {
            background: linear-gradient(135deg, #ffebee 0%, #ffeef0 100%);
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .status.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #fffbf0 100%);
            color: #856404;
            border: 1px solid #ffc107;
        }
        
        #map-container {
            width: 100%;
            height: 60vh;
            min-height: 400px;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid #e1e5e9;
            margin: 20px 0;
            position: relative;
            background: #f8f9fa;
        }
        
        .map-placeholder {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
            color: #666; 
            flex-direction: column;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .map-placeholder-icon {
            font-size: 4rem; 
            margin-bottom: 20px;
            opacity: 0.6;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .controls {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .gps-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .gps-info h4 {
            color: #1E3A8A;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .gps-data {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 0.9rem;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            line-height: 1.5;
        }
        
        .tutorial {
            background: linear-gradient(135deg, #fff3cd 0%, #fffbf0 100%);
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            font-size: 0.95rem;
        }
        
        .tutorial h4 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .tutorial ol {
            margin-left: 20px;
        }
        
        .tutorial li {
            margin: 8px 0;
        }
        
        .tutorial a {
            color: #4FC3F7;
            text-decoration: none;
            font-weight: 600;
        }
        
        .tutorial a:hover {
            text-decoration: underline;
        }
        
        .features {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        @media (min-width: 768px) {
            .features {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .feature {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .feature:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(79, 195, 247, 0.2);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .feature h4 {
            color: #1E3A8A;
            margin-bottom: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4FC3F7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="assets/images/totofun-logo.png" alt="Totofun Logo" class="logo">
            </div>
            <h1 class="title">Totofun 突突翻</h1>
            <p class="subtitle">基于GPS的实时寻宝游戏 - 探索身边的宝藏</p>
            <div class="hero-stats">
                <div class="stat">
                    <span class="stat-number" id="user-name">游客</span>
                    <span class="stat-label">玩家昵称</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="user-level">LV.1</span>
                    <span class="stat-label">当前等级</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="total-treasures">0</span>
                    <span class="stat-label">发现宝藏</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="accuracy">0m</span>
                    <span class="stat-label">定位精度</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>🚀 快速开始</h3>
            <button class="btn" onclick="initMap()">
                <span id="init-btn-text">🚀 启动寻宝之旅</span>
            </button>
            
            <!-- 高级选项：切换API Key -->
            <details style="margin-top: 15px;">
                <summary style="cursor: pointer; color: #666; font-size: 0.9rem;">🔧 高级选项</summary>
                <div class="input-group" style="margin-top: 10px;">
                    <label for="api-key">自定义高德地图API Key:</label>
                    <input type="password" id="api-key" class="api-input" placeholder="留空使用默认Key">
                </div>
            </details>
            
            <div class="tutorial">
                <h4>📋 快速开始指南:</h4>
                <ol>
                    <li>申请<a href="https://console.amap.com/" target="_blank">高德地图API Key</a></li>
                    <li>输入API Key并点击启动</li>
                    <li>允许浏览器获取位置权限</li>
                    <li>在户外环境中获得最佳GPS体验</li>
                    <li>开始寻找附近的宝藏！</li>
                </ol>
                
                <h4>🔧 移动端调试:</h4>
                <p style="font-size: 0.85rem; color: #666;">
                    • 长按GPS信息区域查看详细调试信息<br>
                    • 如果定位失败，会自动使用上海位置<br>
                    • 确保在HTTPS环境下使用（GitHub Pages自动支持）<br>
                    • 键盘快捷键: Ctrl+S 切换到上海位置，Ctrl+D 显示调试信息
                </p>
            </div>
            
            <div class="status info" id="status">
                <span>🔄</span>
                <span>等待配置API Key启动地图服务...</span>
            </div>
        </div>

        <div class="features">
            <div class="feature">
                <div class="feature-icon">📱</div>
                <h4>移动端优化</h4>
                <p>专为手机端设计，支持触摸操作和响应式布局</p>
            </div>
            <div class="feature">
                <div class="feature-icon">🎯</div>
                <h4>精准定位</h4>
                <p>使用高精度GPS定位，支持室外精确寻宝</p>
            </div>
            <div class="feature">
                <div class="feature-icon">🏆</div>
                <h4>多种宝藏</h4>
                <p>钻石、皇冠、金币等多种宝藏类型等你发现</p>
            </div>
            <div class="feature">
                <div class="feature-icon">🌍</div>
                <h4>实时地图</h4>
                <p>基于高德地图的实时位置显示和导航</p>
            </div>
        </div>

        <div class="card">
            <h3>📍 GPS状态信息</h3>
            <div class="gps-info">
                <h4>当前位置信息:</h4>
                <div class="gps-data" id="gps-data">
                    等待获取GPS数据...
                </div>
            </div>
        </div>

        <div class="card">
            <div id="map-container">
                <div class="map-placeholder">
                    <div class="map-placeholder-icon pulse">🗺️</div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">地图即将加载</div>
                        <div style="color: #888;">配置API Key后即可显示高德地图</div>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="testGPS()" disabled id="gps-btn">
                    📍 重新定位
                </button>
                <button class="btn" onclick="centerToUser()" disabled id="center-btn">
                    🎯 回到我的位置
                </button>
                <button class="btn" onclick="generateNearbyTreasures()" disabled id="generate-btn">
                    🗺️ 生成宝藏
                </button>
                <button class="btn" onclick="addTreasure()" disabled id="treasure-btn">
                    ✨ 添加宝藏
                </button>
                <button class="btn" onclick="clearMap()" disabled id="clear-btn">
                    🗑️ 清空地图
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let map = null;
        let userMarker = null;
        let treasureMarkers = [];
        let userLocation = null;
        let watchId = null;

        // 用户数据管理
        let userData = {
            username: '',
            level: {
                currentLevel: 1,
                experience: 0,
                badges: []
            },
            stats: {
                treasuresCreated: 0,
                treasuresDiscovered: 0,
                totalLikes: 0,
                totalViews: 0
            },
            preferences: {
                interests: [],
                explorationRadius: 5000,
                language: 'zh-CN'
            },
            discoveredTreasures: [],
            createdTreasures: [],
            achievements: [],
            lastActiveAt: new Date()
        };

        // 本地存储管理
        const storageManager = {
            save: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('存储失败:', error);
                    return false;
                }
            },
            load: (key) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('读取失败:', error);
                    return null;
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('删除失败:', error);
                    return false;
                }
            }
        };

        // 完整的宝藏类型系统（基于数据模型）
        const treasureTypes = [
            { 
                icon: '💎', 
                name: '钻石宝藏', 
                color: '#e74c3c', 
                rarity: 'legendary',
                category: '摄影',
                rewards: { experience: 100, coins: 50 },
                discoveryRadius: 30
            },
            { 
                icon: '👑', 
                name: '皇冠宝藏', 
                color: '#9b59b6', 
                rarity: 'epic',
                category: '历史',
                rewards: { experience: 80, coins: 40 },
                discoveryRadius: 35
            },
            { 
                icon: '💰', 
                name: '金币宝藏', 
                color: '#f1c40f', 
                rarity: 'rare',
                category: '购物',
                rewards: { experience: 60, coins: 30 },
                discoveryRadius: 40
            },
            { 
                icon: '🏺', 
                name: '古董宝藏', 
                color: '#e67e22', 
                rarity: 'uncommon',
                category: '艺术',
                rewards: { experience: 40, coins: 20 },
                discoveryRadius: 45
            },
            { 
                icon: '💍', 
                name: '戒指宝藏', 
                color: '#3498db', 
                rarity: 'common',
                category: '美食',
                rewards: { experience: 20, coins: 10 },
                discoveryRadius: 50
            },
            { 
                icon: '🎭', 
                name: '面具宝藏', 
                color: '#8e44ad', 
                rarity: 'rare',
                category: '音乐',
                rewards: { experience: 55, coins: 25 },
                discoveryRadius: 40
            },
            { 
                icon: '⚔️', 
                name: '神器宝藏', 
                color: '#2c3e50', 
                rarity: 'legendary',
                category: '运动',
                rewards: { experience: 120, coins: 60 },
                discoveryRadius: 25
            },
            { 
                icon: '🏆', 
                name: '奖杯宝藏', 
                color: '#f39c12', 
                rarity: 'epic',
                category: '旅游',
                rewards: { experience: 90, coins: 45 },
                discoveryRadius: 30
            }
        ];

        // 用户等级系统
        const levelSystem = {
            getLevel: (experience) => Math.floor(Math.sqrt(experience / 100)) + 1,
            getExpForLevel: (level) => Math.pow(level - 1, 2) * 100,
            getExpToNext: (currentExp) => {
                const currentLevel = levelSystem.getLevel(currentExp);
                const nextLevelExp = levelSystem.getExpForLevel(currentLevel + 1);
                return nextLevelExp - currentExp;
            }
        };

        // 徽章系统
        const badgeSystem = [
            { name: 'first_treasure', icon: '🎯', title: '初探者', description: '发现第一个宝藏' },
            { name: 'treasure_hunter', icon: '🏃', title: '寻宝猎人', description: '发现10个宝藏' },
            { name: 'treasure_master', icon: '👑', title: '寻宝大师', description: '发现50个宝藏' },
            { name: 'legendary_finder', icon: '💎', title: '传奇发现者', description: '发现传奇级宝藏' },
            { name: 'category_expert', icon: '🎓', title: '分类专家', description: '在每个分类中都发现宝藏' },
            { name: 'speed_runner', icon: '⚡', title: '闪电侠', description: '1小时内发现5个宝藏' },
            { name: 'explorer', icon: '🗺️', title: '探险家', description: '探索超过5公里范围' },
            { name: 'social_star', icon: '⭐', title: '社交之星', description: '创建的宝藏被发现100次' }
        ];

        // 更新状态显示
        function updateStatus(message, type = 'info', showLoading = false) {
            const status = document.getElementById('status');
            const iconMap = {
                info: '🔄',
                success: '✅',
                error: '❌',
                warning: '⚠️'
            };
            
            const icon = showLoading ? '<span class="loading"></span>' : iconMap[type];
            status.innerHTML = `${icon}<span>${message}</span>`;
            status.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 更新GPS数据显示
        function updateGPSData(data) {
            const gpsData = document.getElementById('gps-data');
            gpsData.innerHTML = data;
        }

        // 宝藏管理系统
        const treasureManager = {
            // 创建宝藏数据
            createTreasure: (position, type, creator = 'system') => {
                const treasure = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    title: type.name,
                    description: `一个珍贵的${type.name}，等待着勇敢的探险者来发现！`,
                    creator: creator,
                    location: {
                        coordinates: position,
                        discoveryRadius: type.discoveryRadius
                    },
                    category: type.category,
                    rewards: type.rewards,
                    rarity: type.rarity,
                    icon: type.icon,
                    color: type.color,
                    stats: {
                        views: 0,
                        likes: 0,
                        discoveries: 0
                    },
                    createdAt: new Date(),
                    status: 'active'
                };
                return treasure;
            },

            // 发现宝藏
            discoverTreasure: (treasureId, userPosition) => {
                const treasureIndex = userData.createdTreasures.findIndex(t => t.id === treasureId);
                if (treasureIndex === -1) return { success: false, reason: 'treasure_not_found' };

                const treasure = userData.createdTreasures[treasureIndex];
                const distance = calculateDistance(userPosition, treasure.location.coordinates);

                if (distance > treasure.location.discoveryRadius) {
                    return { 
                        success: false, 
                        reason: 'too_far',
                        distance: distance,
                        requiredDistance: treasure.location.discoveryRadius
                    };
                }

                // 检查是否已经发现过
                if (userData.discoveredTreasures.includes(treasureId)) {
                    return { success: false, reason: 'already_discovered' };
                }

                // 记录发现
                userData.discoveredTreasures.push(treasureId);
                userData.stats.treasuresDiscovered += 1;
                treasure.stats.discoveries += 1;

                // 奖励经验和金币
                const reward = userManager.addExperience(treasure.rewards.experience);
                userManager.addCoins(treasure.rewards.coins);

                // 检查成就
                achievementManager.checkAchievements();

                // 保存数据
                saveUserData();

                return {
                    success: true,
                    treasure: treasure,
                    rewards: treasure.rewards,
                    levelUp: reward.levelUp
                };
            }
        };

        // 用户管理系统
        const userManager = {
            // 添加经验值
            addExperience: (points) => {
                const oldLevel = userData.level.currentLevel;
                userData.level.experience += points;
                
                const newLevel = levelSystem.getLevel(userData.level.experience);
                if (newLevel > oldLevel) {
                    userData.level.currentLevel = newLevel;
                    
                    // 等级提升奖励
                    const reward = {
                        coins: newLevel * 10,
                        badge: newLevel % 10 === 0 ? `level_${newLevel}` : null
                    };

                    if (reward.badge) {
                        userManager.addBadge(reward.badge, '🏆', `达到第${newLevel}级`);
                    }

                    return {
                        levelUp: true,
                        oldLevel: oldLevel,
                        newLevel: newLevel,
                        reward: reward
                    };
                }
                
                return { levelUp: false };
            },

            // 添加徽章
            addBadge: (badgeName, icon, description) => {
                const existingBadge = userData.level.badges.find(badge => badge.name === badgeName);
                if (!existingBadge) {
                    userData.level.badges.push({
                        name: badgeName,
                        icon: icon,
                        description: description,
                        unlockedAt: new Date()
                    });
                    return true;
                }
                return false;
            },

            // 添加金币（虚拟货币）
            addCoins: (amount) => {
                if (!userData.coins) userData.coins = 0;
                userData.coins += amount;
            },

            // 获取用户等级信息
            getLevelInfo: () => {
                const currentExp = userData.level.experience;
                const currentLevel = userData.level.currentLevel;
                const expForCurrentLevel = levelSystem.getExpForLevel(currentLevel);
                const expForNextLevel = levelSystem.getExpForLevel(currentLevel + 1);
                const expToNext = expForNextLevel - currentExp;
                const progress = ((currentExp - expForCurrentLevel) / (expForNextLevel - expForCurrentLevel)) * 100;

                return {
                    currentLevel,
                    currentExp,
                    expToNext,
                    progress: Math.max(0, Math.min(100, progress))
                };
            }
        };

        // 成就系统
        const achievementManager = {
            checkAchievements: () => {
                const achievements = [];

                // 第一个宝藏
                if (userData.stats.treasuresDiscovered === 1) {
                    achievements.push(userManager.addBadge('first_treasure', '🎯', '发现第一个宝藏'));
                }

                // 寻宝猎人
                if (userData.stats.treasuresDiscovered === 10) {
                    achievements.push(userManager.addBadge('treasure_hunter', '🏃', '发现10个宝藏'));
                }

                // 寻宝大师
                if (userData.stats.treasuresDiscovered === 50) {
                    achievements.push(userManager.addBadge('treasure_master', '👑', '发现50个宝藏'));
                }

                // 传奇发现者（发现传奇级宝藏）
                const legendaryFound = userData.createdTreasures.some(t => 
                    userData.discoveredTreasures.includes(t.id) && t.rarity === 'legendary'
                );
                if (legendaryFound) {
                    achievements.push(userManager.addBadge('legendary_finder', '💎', '发现传奇级宝藏'));
                }

                return achievements.filter(Boolean);
            }
        };

        // 距离计算工具
        function calculateDistance(pos1, pos2) {
            const R = 6371000; // 地球半径(米)
            const lat1 = pos1[1] * Math.PI / 180;
            const lat2 = pos2[1] * Math.PI / 180;
            const deltaLat = (pos2[1] - pos1[1]) * Math.PI / 180;
            const deltaLng = (pos2[0] - pos1[0]) * Math.PI / 180;

            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // 保存和加载用户数据
        function saveUserData() {
            userData.lastActiveAt = new Date();
            storageManager.save('totofun-treasure-user', userData);
        }

        function loadUserData() {
            const saved = storageManager.load('totofun-treasure-user');
            if (saved) {
                userData = { ...userData, ...saved };
                // 确保日期字段正确解析
                if (saved.lastActiveAt) {
                    userData.lastActiveAt = new Date(saved.lastActiveAt);
                }
            }
        }

        // 更新统计数据显示
        function updateStats(accuracy = 0) {
            document.getElementById('total-treasures').textContent = userData.stats.treasuresDiscovered || 0;
            document.getElementById('accuracy').textContent = `${Math.round(accuracy)}m`;
            
            // 更新用户信息
            if (document.getElementById('user-name')) {
                document.getElementById('user-name').textContent = userData.username || '游客';
            }
            if (document.getElementById('user-level')) {
                document.getElementById('user-level').textContent = `LV.${userData.level.currentLevel}`;
            }
        }

        // 默认API Key（你的高德地图Key）
        const DEFAULT_AMAP_KEY = '你的高德地图API_Key'; // TODO: 替换成你的实际Key
        
        // 初始化地图
        function initMap() {
            let apiKey = document.getElementById('api-key').value.trim();
            
            // 如果用户没有输入，使用默认Key
            if (!apiKey) {
                apiKey = localStorage.getItem('amap-api-key') || DEFAULT_AMAP_KEY;
            }
            
            if (!apiKey || apiKey === '你的高德地图API_Key') {
                updateStatus('请先配置高德地图API Key！展开"高级选项"输入你的Key', 'error');
                return;
            }

            updateStatus('正在加载高德地图...', 'info', true);
            localStorage.setItem('amap-api-key', apiKey);

            // 更新按钮状态
            const initBtn = document.getElementById('init-btn-text');
            initBtn.innerHTML = '<span class="loading"></span> 正在加载...';

            // 动态加载高德地图API（包含坐标转换插件）
            const script = document.createElement('script');
            script.src = `https://webapi.amap.com/maps?v=2.0&key=${apiKey}`;
            script.onload = function() {
                console.log('高德地图API加载成功');
                createMap();
            };
            script.onerror = function() {
                console.error('高德地图API加载失败');
                updateStatus('高德地图API加载失败！请检查Key是否正确或网络连接', 'error');
                document.getElementById('init-btn-text').innerHTML = '🚀 重新启动';
            };
            document.head.appendChild(script);
        }

        // 创建地图实例（改进版本）
        function createMap() {
            try {
                console.log('开始创建地图实例...');
                updateStatus('正在创建地图实例...', 'info', true);
                
                // 检查AMap是否可用
                if (typeof AMap === 'undefined') {
                    throw new Error('AMap对象未定义，地图API可能未正确加载');
                }
                
                map = new AMap.Map('map-container', {
                    zoom: 15,
                    center: [121.4737, 31.2304], // 默认上海坐标
                    viewMode: '2D',
                    showLabel: true,
                    mapStyle: 'amap://styles/normal',
                    resizeEnable: true,
                    rotateEnable: false,
                    pitchEnable: false,
                    dragEnable: true,
                    zoomEnable: true,
                    doubleClickZoom: true
                });

                console.log('地图实例创建成功，等待加载完成...');

                // 地图加载完成事件
                map.on('complete', function() {
                    console.log('地图加载完成');
                    updateStatus('地图加载成功！正在获取您的位置...', 'success');
                    
                    // 重置按钮
                    document.getElementById('init-btn-text').innerHTML = '✅ 地图已启动';
                    
                    // 启用控制按钮
                    document.querySelectorAll('.btn').forEach(btn => {
                        if (!btn.onclick || btn.onclick.toString().includes('initMap')) {
                            return;
                        }
                        btn.disabled = false;
                    });

                    // 自动获取位置
                    setTimeout(() => {
                        console.log('开始自动获取GPS位置...');
                        testGPS();
                    }, 1000);
                });

                // 地图点击事件 - 添加宝藏
                map.on('click', function(e) {
                    console.log('地图点击事件:', e.lnglat);
                    if (userLocation && confirm('在此位置添加宝藏？')) {
                        addTreasureAtPosition([e.lnglat.lng, e.lnglat.lat]);
                    }
                });
                
                // 地图移动事件（用于调试）
                map.on('moveend', function() {
                    const center = map.getCenter();
                    console.log('地图中心:', center.lng, center.lat, '缩放级别:', map.getZoom());
                });

            } catch (error) {
                console.error('地图创建失败:', error);
                updateStatus('地图创建失败: ' + error.message, 'error');
                document.getElementById('init-btn-text').innerHTML = '🚀 重新启动';
            }
        }

        // 测试GPS定位（改进版本 - 针对PC和手机优化）
        function testGPS() {
            if (!map) {
                updateStatus('请先初始化地图！', 'warning');
                return;
            }

            updateStatus('正在获取GPS位置...', 'info', true);
            updateGPSData('<div class="loading"></div> 正在定位...');

            // 检测设备类型
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            console.log('设备类型:', isMobile ? '移动设备' : 'PC设备');

            if (!navigator.geolocation) {
                updateStatus('浏览器不支持GPS定位功能', 'error');
                handleLocationError({ code: 0, message: '不支持定位' });
                return;
            }

            // PC端使用IP定位作为备选
            if (!isMobile) {
                console.log('PC端检测到，将使用IP定位 + 高德定位服务');
                useAmapGeolocation();
                return;
            }

            // 移动端使用GPS定位
            console.log('移动端检测到，使用GPS定位');
            navigator.geolocation.getCurrentPosition(
                handleLocationSuccess,
                (error) => {
                    console.log('高精度定位失败，尝试普通精度...');
                    navigator.geolocation.getCurrentPosition(
                        handleLocationSuccess,
                        (error2) => {
                            console.log('GPS定位失败，尝试使用高德定位服务');
                            useAmapGeolocation();
                        },
                        {
                            enableHighAccuracy: false,
                            timeout: 15000,
                            maximumAge: 30000
                        }
                    );
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // 使用高德定位服务（基于IP，适合PC端）
        function useAmapGeolocation() {
            console.log('使用高德定位服务...');
            updateStatus('正在使用网络定位...', 'info', true);
            
            AMap.plugin('AMap.Geolocation', function() {
                const geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    zoomToAccuracy: true,
                    buttonPosition: 'RB'
                });
                
                geolocation.getCurrentPosition(function(status, result) {
                    console.log('高德定位结果:', status, result);
                    if (status === 'complete') {
                        const position = {
                            coords: {
                                latitude: result.position.lat,
                                longitude: result.position.lng,
                                accuracy: result.accuracy || 100
                            },
                            timestamp: Date.now()
                        };
                        // 高德返回的已经是GCJ-02坐标，直接使用
                        handleAmapLocationSuccess(position);
                    } else {
                        console.log('高德定位失败，使用默认位置');
                        handleLocationError({ code: 2, message: '网络定位失败' });
                    }
                });
            });
        }

        // 处理高德定位成功（无需坐标转换）
        function handleAmapLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy || 100;
            const timestamp = new Date(position.timestamp).toLocaleString();
            
            console.log('✅ 高德定位成功 (GCJ-02):', { lat, lng, accuracy });
            console.log('📍 准确坐标 [经度, 纬度]:', [lng, lat]);
            
            userLocation = [lng, lat];
            
            // 立即设置地图中心和缩放（在创建标记之前）
            console.log('🗺️ 先设置地图中心...');
            map.setZoomAndCenter(17, userLocation);
            
            updateStatus(`定位成功！精度: ${Math.round(accuracy)}米 (网络定位)`, 'success');
            updateGPSData(`
                <strong>📍 位置信息</strong><br>
                定位方式: 高德网络定位<br>
                纬度: ${lat.toFixed(6)}<br>
                经度: ${lng.toFixed(6)}<br>
                精度: ${Math.round(accuracy)}米 ${accuracy < 200 ? '✅' : '⚠️'}<br>
                时间: ${timestamp}<br>
                <small style="color: #666;">
                    坐标系: GCJ-02 (高德地图)<br>
                    💡 PC端建议使用手机访问获得更精确的GPS定位
                </small>
            `);
            
            updateStats(accuracy);
            
            // 延迟创建标记，确保地图已经移动到位
            setTimeout(() => {
                console.log('📌 创建用户标记...');
                createUserMarker();
            }, 300);
            
            setTimeout(() => {
                if (treasureMarkers.length === 0) {
                    console.log('🎁 开始生成宝藏...');
                    generateNearbyTreasures();
                }
            }, 800);
        }


        // 处理定位成功（改进版本 - 添加坐标转换）
        function handleLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy || 0;
            const timestamp = new Date(position.timestamp).toLocaleString();
            
            console.log('✅ 原始GPS坐标 (WGS84):', { lat, lng, accuracy });
            console.log('🔄 开始坐标转换...');
            
            // 检查AMap.convertFrom是否可用
            if (typeof AMap === 'undefined' || !AMap.convertFrom) {
                console.warn('⚠️ AMap.convertFrom 不可用，直接使用原始坐标');
                useRawCoordinates(lat, lng, accuracy, timestamp);
                return;
            }
            
            // 使用高德地图的坐标转换功能将WGS84转换为GCJ-02
            try {
                AMap.convertFrom([lng, lat], 'gps', function(status, result) {
                    console.log('坐标转换状态:', status);
                    console.log('坐标转换结果:', result);
                    
                    if (result.info === 'ok' && result.locations && result.locations.length > 0) {
                        const convertedLocation = result.locations[0];
                        userLocation = [convertedLocation.lng, convertedLocation.lat];
                        
                        console.log('✅ 转换后坐标 (GCJ-02):', userLocation);
                        console.log('📏 偏移距离:', calculateDistance([lng, lat], userLocation).toFixed(2), '米');
                        
                        updateStatus(`GPS定位成功！精度: ${Math.round(accuracy)}米 (坐标已转换)`, 'success');
                        updateGPSData(`
                            <strong>📍 位置信息</strong><br>
                            原始位置 (WGS84):<br>
                            纬度: ${lat.toFixed(6)}<br>
                            经度: ${lng.toFixed(6)}<br>
                            <br>
                            转换后位置 (GCJ-02):<br>
                            纬度: ${convertedLocation.lat.toFixed(6)} ${convertedLocation.lat > 30 && convertedLocation.lat < 32 ? '✅' : '❓'}<br>
                            经度: ${convertedLocation.lng.toFixed(6)} ${convertedLocation.lng > 120 && convertedLocation.lng < 122 ? '✅' : '❓'}<br>
                            <br>
                            精度: ${Math.round(accuracy)}米 ${accuracy < 100 ? '✅' : accuracy < 500 ? '⚠️' : '❌'}<br>
                            时间: ${timestamp}<br>
                            <small style="color: #666;">
                                坐标系: WGS84 → GCJ-02 (高德)<br>
                                ${convertedLocation.lat > 30 && convertedLocation.lat < 32 && convertedLocation.lng > 120 && convertedLocation.lng < 122 ? '🎯 上海地区定位成功' : '🌍 非上海地区'}
                            </small>
                        `);
                        
                        updateStats(accuracy);
                        
                        // 先设置地图中心和缩放
                        console.log('🗺️ 先设置地图中心...');
                        map.setZoomAndCenter(17, userLocation);
                        
                        // 延迟创建标记
                        setTimeout(() => {
                            console.log('📌 创建用户标记...');
                            createUserMarker();
                        }, 300);
                        
                        // 立即生成宝藏
                        setTimeout(() => {
                            if (treasureMarkers.length === 0) {
                                console.log('🎁 开始生成宝藏...');
                                generateNearbyTreasures();
                            }
                        }, 800);
                    } else {
                        // 如果转换失败，直接使用原始坐标（可能会有偏移）
                        console.warn('⚠️ 坐标转换失败，使用原始坐标');
                        useRawCoordinates(lat, lng, accuracy, timestamp);
                    }
                });
            } catch (error) {
                console.error('❌ 坐标转换异常:', error);
                useRawCoordinates(lat, lng, accuracy, timestamp);
            }
        }

        // 使用原始坐标的辅助函数
        function useRawCoordinates(lat, lng, accuracy, timestamp) {
            userLocation = [lng, lat];
            
            console.log('📍 使用原始坐标 (WGS84):', userLocation);
            
            updateStatus(`GPS定位成功！精度: ${Math.round(accuracy)}米 (未转换坐标，可能有偏移)`, 'warning');
            updateGPSData(`
                <strong>📍 位置信息</strong><br>
                纬度: ${lat.toFixed(6)} ${lat > 30 && lat < 32 ? '✅' : '❓'}<br>
                经度: ${lng.toFixed(6)} ${lng > 120 && lng < 122 ? '✅' : '❓'}<br>
                精度: ${Math.round(accuracy)}米 ${accuracy < 100 ? '✅' : accuracy < 500 ? '⚠️' : '❌'}<br>
                时间: ${timestamp}<br>
                <small style="color: #666;">
                    坐标系: WGS84 (未转换)<br>
                    ⚠️ 坐标转换失败，位置可能有偏移 50-500米<br>
                    ${lat > 30 && lat < 32 && lng > 120 && lng < 122 ? '🎯 上海地区定位成功' : '🌍 非上海地区'}
                </small>
            `);
            
            updateStats(accuracy);
            
            // 先设置地图中心和缩放
            console.log('🗺️ 先设置地图中心...');
            map.setZoomAndCenter(17, userLocation);
            
            // 延迟创建标记
            setTimeout(() => {
                console.log('📌 创建用户标记...');
                createUserMarker();
            }, 300);
            
            setTimeout(() => {
                if (treasureMarkers.length === 0) {
                    console.log('🎁 开始生成宝藏...');
                    generateNearbyTreasures();
                }
            }, 800);
        }

        // 处理定位错误
        function handleLocationError(error) {
            let errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = '用户拒绝了位置权限，请在浏览器设置中允许位置访问';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = '位置信息不可用，请检查GPS是否开启';
                    break;
                case error.TIMEOUT:
                    errorMsg = '定位请求超时，请重试';
                    break;
                default:
                    errorMsg = '未知定位错误，请重试';
                    break;
            }
            
            updateStatus(`GPS定位失败: ${errorMsg}`, 'error');
            updateGPSData(`
                <strong>❌ 定位失败</strong><br>
                错误: ${errorMsg}<br>
                <small style="color: #666;">
                    建议:<br>
                    • 在户外重试<br>
                    • 检查浏览器权限设置<br>
                    • 确保GPS功能已开启
                </small>
            `);
            
            // 使用默认位置（上海外滩）
            userLocation = [121.4737, 31.2304];
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            updateStatus('GPS定位失败，使用默认位置（上海外滩）。建议在户外重新尝试定位。', 'warning');
            
            // 即使是默认位置也生成宝藏
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1000);
        }

        // 创建用户位置标记（改进版本 - 添加调试信息）
        function createUserMarker() {
            console.log('========== 开始创建用户标记 ==========');
            console.log('当前地图对象:', map ? '✅ 已初始化' : '❌ 未初始化');
            console.log('当前用户位置:', userLocation);
            
            if (!map) {
                console.error('❌ 地图未初始化');
                updateStatus('地图未初始化，无法创建标记', 'error');
                return false;
            }
            
            if (!userLocation || !Array.isArray(userLocation) || userLocation.length !== 2) {
                console.error('❌ 用户位置无效:', userLocation);
                updateStatus('用户位置无效，无法创建标记', 'error');
                return false;
            }

            console.log('📍 准备创建标记，位置:', userLocation);
            console.log('经度:', userLocation[0], '纬度:', userLocation[1]);

            // 移除旧标记
            if (userMarker) {
                console.log('🗑️ 移除旧的用户标记');
                try {
                    map.remove(userMarker);
                    userMarker = null;
                    console.log('✅ 旧标记已移除');
                } catch (error) {
                    console.error('❌ 移除旧标记失败:', error);
                }
            }

            try {
                console.log('🎨 创建标记图标...');
                // 使用简单的SVG，不包含emoji（避免btoa编码错误）
                const svgIcon = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60">
                        <defs>
                            <radialGradient id="glow" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#4CAF50;stop-opacity:0.3" />
                            </radialGradient>
                        </defs>
                        <circle cx="30" cy="30" r="25" fill="url(#glow)" opacity="0.6"/>
                        <circle cx="30" cy="30" r="18" fill="#4CAF50" stroke="white" stroke-width="4"/>
                        <circle cx="30" cy="30" r="12" fill="#81C784"/>
                        <circle cx="30" cy="30" r="6" fill="white"/>
                        <path d="M 30 10 L 28 20 L 32 20 Z" fill="white" opacity="0.8"/>
                    </svg>
                `;
                
                console.log('📌 创建Marker对象...');
                // 使用encodeURIComponent代替btoa，避免Unicode问题
                const encodedSvg = encodeURIComponent(svgIcon);
                
                userMarker = new AMap.Marker({
                    position: new AMap.LngLat(userLocation[0], userLocation[1]),
                    icon: new AMap.Icon({
                        image: 'data:image/svg+xml;charset=utf-8,' + encodedSvg,
                        size: new AMap.Size(60, 60),
                        imageSize: new AMap.Size(60, 60),
                        imageOffset: new AMap.Pixel(0, 0)
                    }),
                    title: `我的位置\n经度: ${userLocation[0].toFixed(6)}\n纬度: ${userLocation[1].toFixed(6)}`,
                    zIndex: 1000,
                    offset: new AMap.Pixel(-30, -30),
                    animation: 'AMAP_ANIMATION_BOUNCE',
                    clickable: true
                });

                console.log('✅ Marker对象创建成功');
                console.log('➕ 添加标记到地图...');
                
                map.add(userMarker);
                
                console.log('✅ 标记已添加到地图');
                console.log('📊 当前地图上的标记数:', map.getAllOverlays('marker').length);
                
                // 验证标记是否正确添加
                const allMarkers = map.getAllOverlays('marker');
                console.log('地图上的所有标记:', allMarkers);
                
                // 添加点击事件
                userMarker.on('click', function() {
                    console.log('👆 用户标记被点击');
                    const infoWindow = new AMap.InfoWindow({
                        content: `
                            <div style="padding: 10px; text-align: center;">
                                <div style="font-size: 1.5rem; margin-bottom: 5px;">📍 我的位置</div>
                                <div style="color: #666; font-size: 0.9rem;">经度: ${userLocation[0].toFixed(6)}</div>
                                <div style="color: #666; font-size: 0.9rem;">纬度: ${userLocation[1].toFixed(6)}</div>
                            </div>
                        `,
                        anchor: 'bottom-center',
                        offset: new AMap.Pixel(0, -5)
                    });
                    infoWindow.open(map, userLocation);
                });
                
                console.log('========== 用户标记创建完成 ✅ ==========');
                return true;
                
            } catch (error) {
                console.error('❌ 创建用户标记失败:', error);
                console.error('错误堆栈:', error.stack);
                updateStatus('创建用户标记失败: ' + error.message, 'error');
                return false;
            }
        }

        // 生成周围的宝藏
        function generateNearbyTreasures() {
            if (!map || !userLocation) {
                updateStatus('请先获取GPS位置！', 'warning');
                return;
            }

            // 清空现有宝藏
            if (treasureMarkers.length > 0) {
                clearMap();
            }

            updateStatus('正在为您生成周围的宝藏...', 'info', true);

            // 生成3-5个宝藏
            const treasureCount = Math.floor(Math.random() * 3) + 3;
            
            for (let i = 0; i < treasureCount; i++) {
                setTimeout(() => {
                    const treasureType = getRandomTreasureByRarity();
                    
                    // 在用户位置周围生成
                    const angle = Math.random() * 2 * Math.PI;
                    const distance = Math.random() * 0.003 + 0.001; // 约100-400米
                    
                    const offsetLng = Math.cos(angle) * distance;
                    const offsetLat = Math.sin(angle) * distance;
                    const position = [userLocation[0] + offsetLng, userLocation[1] + offsetLat];

                    addTreasureAtPosition(position, treasureType);
                    
                    if (i === treasureCount - 1) {
                        updateStatus(`🗺️ 已生成${treasureCount}个宝藏！开始寻宝吧！`, 'success');
                    }
                }, i * 200);
            }
        }

        // 根据稀有度随机选择宝藏类型
        function getRandomTreasureByRarity() {
            const rarityWeights = {
                'common': 40,
                'uncommon': 30,
                'rare': 20,
                'epic': 8,
                'legendary': 2
            };

            // 创建加权数组
            let weightedArray = [];
            treasureTypes.forEach(type => {
                const weight = rarityWeights[type.rarity] || 10;
                for (let i = 0; i < weight; i++) {
                    weightedArray.push(type);
                }
            });

            return weightedArray[Math.floor(Math.random() * weightedArray.length)];
        }

        // 手动添加单个宝藏
        function addTreasure() {
            if (!map || !userLocation) {
                updateStatus('请先获取GPS位置！', 'warning');
                return;
            }

            const treasureType = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
            
            // 在用户位置附近随机生成宝藏
            const offsetLng = (Math.random() - 0.5) * 0.008; // 约400米范围
            const offsetLat = (Math.random() - 0.5) * 0.008;
            const position = [userLocation[0] + offsetLng, userLocation[1] + offsetLat];

            addTreasureAtPosition(position, treasureType);
        }

        // 在指定位置添加宝藏
        function addTreasureAtPosition(position, treasureType = null) {
            if (!map || !position) return;

            if (!treasureType) {
                treasureType = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
            }

            // 创建宝藏数据
            const treasureData = treasureManager.createTreasure(position, treasureType, 'player');
            userData.createdTreasures.push(treasureData);
            userData.stats.treasuresCreated += 1;

            // 创建地图标记（使用简单图形代替emoji）
            const treasureSvg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50">
                    <defs>
                        <radialGradient id="glow-${treasureType.name}" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:${treasureType.color};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:${treasureType.color};stop-opacity:0.2" />
                        </radialGradient>
                    </defs>
                    <circle cx="25" cy="25" r="22" fill="url(#glow-${treasureType.name})" opacity="0.6"/>
                    <circle cx="25" cy="25" r="18" fill="${treasureType.color}" stroke="white" stroke-width="3"/>
                    <circle cx="25" cy="25" r="12" fill="${treasureType.color}" opacity="0.8"/>
                    <circle cx="25" cy="25" r="6" fill="white" opacity="0.9"/>
                    <text x="25" y="30" text-anchor="middle" fill="white" font-size="20" font-weight="bold">?</text>
                </svg>
            `;
            const encodedTreasureSvg = encodeURIComponent(treasureSvg);
            
            const treasureMarker = new AMap.Marker({
                position: position,
                icon: new AMap.Icon({
                    image: 'data:image/svg+xml;charset=utf-8,' + encodedTreasureSvg,
                    size: new AMap.Size(50, 50),
                    imageOffset: new AMap.Pixel(-25, -25)
                }),
                title: `${treasureType.name} (${treasureType.rarity})`,
                zIndex: 500
            });

            // 存储宝藏ID到标记上
            treasureMarker.treasureId = treasureData.id;

            // 添加点击事件
            treasureMarker.on('click', function() {
                if (userLocation) {
                    const distance = calculateDistance(userLocation, position);
                    const requiredDistance = treasureData.location.discoveryRadius;
                    
                    if (distance <= requiredDistance) {
                        // 尝试发现宝藏
                        const result = treasureManager.discoverTreasure(treasureData.id, userLocation);
                        
                        if (result.success) {
                            // 发现成功
                            map.remove(treasureMarker);
                            treasureMarkers = treasureMarkers.filter(m => m !== treasureMarker);
                            
                            let message = `🎉 恭喜！您发现了${result.treasure.title}！\n`;
                            message += `💰 获得 ${result.rewards.coins} 金币\n`;
                            message += `⭐ 获得 ${result.rewards.experience} 经验`;
                            
                            if (result.levelUp) {
                                message += `\n🎊 等级提升！LV.${result.levelUp.oldLevel} → LV.${result.levelUp.newLevel}`;
                            }
                            
                            updateStatus(message, 'success');
                            
                            // 检查新成就
                            const newAchievements = achievementManager.checkAchievements();
                            if (newAchievements.length > 0) {
                                setTimeout(() => {
                                    updateStatus('🏆 获得新成就！查看徽章系统了解详情', 'success');
                                }, 2000);
                            }
                            
                        } else {
                            // 发现失败
                            if (result.reason === 'already_discovered') {
                                updateStatus('您已经发现过这个宝藏了', 'warning');
                            } else if (result.reason === 'too_far') {
                                updateStatus(`距离太远！还需要靠近${Math.round(result.distance - result.requiredDistance)}米`, 'warning');
                            }
                        }
                    } else {
                        updateStatus(`${treasureType.name}距离您还有${Math.round(distance)}米（需要在${requiredDistance}米内）`, 'info');
                        
                        // 显示距离指示
                        const infoWindow = new AMap.InfoWindow({
                            content: `
                                <div style="padding: 10px; text-align: center;">
                                    <div style="font-size: 1.2rem; margin-bottom: 5px;">${treasureType.icon} ${treasureType.name}</div>
                                    <div style="color: #666; font-size: 0.9rem;">距离: ${Math.round(distance)}米</div>
                                    <div style="color: #666; font-size: 0.9rem;">需要: ${requiredDistance}米内</div>
                                    <div style="color: #4FC3F7; font-size: 0.8rem; margin-top: 5px;">
                                        💰 ${treasureType.rewards.coins} 金币 | ⭐ ${treasureType.rewards.experience} 经验
                                    </div>
                                </div>
                            `,
                            anchor: 'bottom-center',
                            offset: new AMap.Pixel(0, -5)
                        });
                        infoWindow.open(map, position);
                        
                        // 3秒后自动关闭
                        setTimeout(() => {
                            infoWindow.close();
                        }, 3000);
                    }
                }
            });

            // 添加到地图
            map.add(treasureMarker);
            treasureMarkers.push(treasureMarker);
            
            // 保存数据
            saveUserData();
            updateStats();
        }

        // 回到我的位置
        function centerToUser() {
            if (!map) {
                updateStatus('请先初始化地图！', 'warning');
                return;
            }
            
            if (!userLocation) {
                updateStatus('还没有获取到位置，请先点击"重新定位"', 'warning');
                return;
            }
            
            console.log('移动地图到用户位置:', userLocation);
            console.log('当前地图中心:', map.getCenter());
            
            // 使用 setZoomAndCenter 确保同时设置缩放和中心
            map.setZoomAndCenter(17, userLocation);
            
            // 如果用户标记存在，触发弹跳动画
            if (userMarker) {
                userMarker.setAnimation('AMAP_ANIMATION_BOUNCE');
                setTimeout(() => {
                    userMarker.setAnimation('AMAP_ANIMATION_NONE');
                }, 1000);
            }
            
            updateStatus('🎯 已回到您的位置', 'success');
        }

        // 清空地图
        function clearMap() {
            if (treasureMarkers.length === 0) {
                updateStatus('地图上没有宝藏', 'info');
                return;
            }

            map.remove(treasureMarkers);
            treasureMarkers = [];
            updateStatus('🗑️ 已清空所有宝藏', 'success');
            updateStats();
        }

        // 首次使用检查
        function checkFirstTimeUser() {
            const isFirstTime = !localStorage.getItem('totofun-treasure-user');
            if (isFirstTime) {
                // 首次使用，显示欢迎和昵称设置
                setTimeout(() => {
                    const username = prompt('🎉 欢迎来到 Totofun 突突翻！\n\n请输入你的游戏昵称（3-10个字符）:', '寻宝探险家');
                    if (username && username.length >= 3 && username.length <= 10) {
                        userData.username = username;
                        saveUserData();
                        updateStatus(`欢迎，${username}！开始你的寻宝之旅吧！`, 'success');
                    } else if (username) {
                        alert('昵称长度应该在3-10个字符之间');
                        checkFirstTimeUser();
                    }
                }, 1000);
            } else {
                // 老用户，显示欢迎回来消息
                if (userData.username) {
                    updateStatus(`欢迎回来，${userData.username}！`, 'success');
                }
            }
        }

        // 页面加载时的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载用户数据
            loadUserData();
            
            const savedKey = localStorage.getItem('amap-api-key');
            if (savedKey) {
                document.getElementById('api-key').value = savedKey;
                updateStatus('发现已保存的API Key，点击启动即可开始游戏', 'success');
            }

            // 检查首次用户
            checkFirstTimeUser();

            // 显示用户信息
            if (userData.stats.treasuresDiscovered > 0) {
                setTimeout(() => {
                    updateStatus(`你已发现 ${userData.stats.treasuresDiscovered} 个宝藏，等级 LV.${userData.level.currentLevel}，继续加油！`, 'success');
                }, 2000);
            }

            // 更新初始统计
            updateStats();
            
            // 显示用户统计信息
            updateUserDisplay();
        });

        // 更新用户显示信息
        function updateUserDisplay() {
            const levelInfo = userManager.getLevelInfo();
            
            // 更新统计显示
            if (document.getElementById('total-treasures')) {
                document.getElementById('total-treasures').textContent = userData.stats.treasuresDiscovered;
            }
            
            // 如果有徽章显示区域，更新徽章
            if (userData.level.badges.length > 0) {
                console.log('🏆 已获得徽章:', userData.level.badges.map(b => `${b.icon} ${b.description}`).join(', '));
            }
        }

        // 导出用户数据（用于调试或备份）
        function exportUserData() {
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'totofun-treasure-userdata.json';
            a.click();
            URL.revokeObjectURL(url);
            updateStatus('用户数据已导出', 'success');
        }

        // 重置用户数据
        function resetUserData() {
            if (confirm('确定要重置所有游戏数据吗？此操作不可撤销！')) {
                storageManager.remove('totofun-treasure-user');
                location.reload();
            }
        }

        // 移动端调试功能
        function debugLocationInfo() {
            let debugInfo = `
                <strong>🔧 调试信息</strong><br>
                用户代理: ${navigator.userAgent.substring(0, 50)}...<br>
                支持GPS: ${navigator.geolocation ? '✅' : '❌'}<br>
                当前时间: ${new Date().toLocaleString()}<br>
                地图状态: ${map ? '✅ 已初始化' : '❌ 未初始化'}<br>
                用户位置: ${userLocation ? `${userLocation[1].toFixed(4)}, ${userLocation[0].toFixed(4)}` : '❌ 未获取'}<br>
                宝藏数量: ${treasureMarkers.length}<br>
                HTTPS: ${location.protocol === 'https:' ? '✅' : '❌ GPS需要HTTPS'}<br>
            `;
            
            // 检查权限状态
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    debugInfo += `GPS权限: ${result.state}<br>`;
                    updateGPSData(debugInfo);
                });
            } else {
                updateGPSData(debugInfo);
            }
        }


        // 强制使用上海位置（调试用）
        function useShanghai() {
            userLocation = [121.4737, 31.2304]; // 上海外滩
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            updateStatus('🗺️ 已切换到上海外滩位置', 'success');
            updateGPSData(`
                <strong>📍 上海外滩位置</strong><br>
                纬度: 31.230400 ✅<br>
                经度: 121.473700 ✅<br>
                精度: 模拟位置<br>
                时间: ${new Date().toLocaleString()}<br>
                <small style="color: #666;">🎯 上海地区模拟定位</small>
            `);
            
            // 生成宝藏
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1000);
        }

        // 键盘快捷键和触摸事件
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        if (!map) initMap();
                        else testGPS();
                        break;
                    case 't':
                        e.preventDefault();
                        addTreasure();
                        break;
                    case 's':
                        e.preventDefault();
                        useShanghai();
                        break;
                    case 'd':
                        e.preventDefault();
                        debugLocationInfo();
                        break;
                    case 'Delete':
                    case 'Backspace':
                        e.preventDefault();
                        clearMap();
                        break;
                }
            }
        });

        // 移动端长按显示调试信息
        let touchTimer;
        document.addEventListener('touchstart', function(e) {
            if (e.target.id === 'gps-data') {
                touchTimer = setTimeout(() => {
                    debugLocationInfo();
                }, 1000);
            }
        });

        document.addEventListener('touchend', function() {
            clearTimeout(touchTimer);
        });
    </script>
</body>
</html>
