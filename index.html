<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ–å® - GPSå¯»å®æ¸¸æˆ</title>
    <meta name="description" content="åŸºäºGPSå®šä½çš„å®æ—¶å¯»å®æ¸¸æˆï¼Œæ”¯æŒé«˜å¾·åœ°å›¾">
    <meta name="keywords" content="GPSå¯»å®,æŠ–éŸ³,é«˜å¾·åœ°å›¾,å®šä½æ¸¸æˆ">
    
    <!-- PWAæ”¯æŒ -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: system-ui, -apple-system, 'PingFang SC', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            color: white;
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .stat {
            text-align: center;
            color: white;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin: 20px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .api-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .api-input:focus {
            border-color: #667eea;
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover:before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn:disabled:before {
            display: none;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status.info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%);
            color: #1976d2;
            border: 1px solid #2196F3;
        }
        
        .status.success {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            color: #2e7d32;
            border: 1px solid #4CAF50;
        }
        
        .status.error {
            background: linear-gradient(135deg, #ffebee 0%, #ffeef0 100%);
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .status.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #fffbf0 100%);
            color: #856404;
            border: 1px solid #ffc107;
        }
        
        #map-container {
            width: 100%;
            height: 60vh;
            min-height: 400px;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid #e1e5e9;
            margin: 20px 0;
            position: relative;
            background: #f8f9fa;
        }
        
        .map-placeholder {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
            color: #666; 
            flex-direction: column;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .map-placeholder-icon {
            font-size: 4rem; 
            margin-bottom: 20px;
            opacity: 0.6;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .controls {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .gps-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .gps-info h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .gps-data {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 0.9rem;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            line-height: 1.5;
        }
        
        .tutorial {
            background: linear-gradient(135deg, #fff3cd 0%, #fffbf0 100%);
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            font-size: 0.95rem;
        }
        
        .tutorial h4 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .tutorial ol {
            margin-left: 20px;
        }
        
        .tutorial li {
            margin: 8px 0;
        }
        
        .tutorial a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .tutorial a:hover {
            text-decoration: underline;
        }
        
        .features {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        @media (min-width: 768px) {
            .features {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .feature {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .feature:hover {
            transform: translateY(-5px);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .feature h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸ—ºï¸ æŠ–å®</h1>
            <p class="subtitle">åŸºäºGPSçš„å®æ—¶å¯»å®æ¸¸æˆ</p>
            <div class="hero-stats">
                <div class="stat">
                    <span class="stat-number" id="online-users">0</span>
                    <span class="stat-label">åœ¨çº¿ç”¨æˆ·</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="total-treasures">0</span>
                    <span class="stat-label">å®è—æ€»æ•°</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="accuracy">0m</span>
                    <span class="stat-label">å®šä½ç²¾åº¦</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ”‘ é«˜å¾·åœ°å›¾é…ç½®</h3>
            <div class="input-group">
                <label for="api-key">é«˜å¾·åœ°å›¾API Key:</label>
                <input type="password" id="api-key" class="api-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é«˜å¾·åœ°å›¾WebæœåŠ¡API Key">
            </div>
            <button class="btn" onclick="initMap()">
                <span id="init-btn-text">ğŸš€ å¯åŠ¨å¯»å®ä¹‹æ—…</span>
            </button>
            
            <div class="tutorial">
                <h4>ğŸ“‹ å¿«é€Ÿå¼€å§‹æŒ‡å—:</h4>
                <ol>
                    <li>ç”³è¯·<a href="https://console.amap.com/" target="_blank">é«˜å¾·åœ°å›¾API Key</a></li>
                    <li>è¾“å…¥API Keyå¹¶ç‚¹å‡»å¯åŠ¨</li>
                    <li>å…è®¸æµè§ˆå™¨è·å–ä½ç½®æƒé™</li>
                    <li>åœ¨æˆ·å¤–ç¯å¢ƒä¸­è·å¾—æœ€ä½³GPSä½“éªŒ</li>
                    <li>å¼€å§‹å¯»æ‰¾é™„è¿‘çš„å®è—ï¼</li>
                </ol>
                
                <h4>ğŸ”§ ç§»åŠ¨ç«¯è°ƒè¯•:</h4>
                <p style="font-size: 0.85rem; color: #666;">
                    â€¢ é•¿æŒ‰GPSä¿¡æ¯åŒºåŸŸæŸ¥çœ‹è¯¦ç»†è°ƒè¯•ä¿¡æ¯<br>
                    â€¢ å¦‚æœå®šä½å¤±è´¥ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ä¸Šæµ·ä½ç½®<br>
                    â€¢ ç¡®ä¿åœ¨HTTPSç¯å¢ƒä¸‹ä½¿ç”¨ï¼ˆGitHub Pagesè‡ªåŠ¨æ”¯æŒï¼‰<br>
                    â€¢ é”®ç›˜å¿«æ·é”®: Ctrl+S åˆ‡æ¢åˆ°ä¸Šæµ·ä½ç½®ï¼ŒCtrl+D æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                </p>
            </div>
            
            <div class="status info" id="status">
                <span>ğŸ”„</span>
                <span>ç­‰å¾…é…ç½®API Keyå¯åŠ¨åœ°å›¾æœåŠ¡...</span>
            </div>
        </div>

        <div class="features">
            <div class="feature">
                <div class="feature-icon">ğŸ“±</div>
                <h4>ç§»åŠ¨ç«¯ä¼˜åŒ–</h4>
                <p>ä¸“ä¸ºæ‰‹æœºç«¯è®¾è®¡ï¼Œæ”¯æŒè§¦æ‘¸æ“ä½œå’Œå“åº”å¼å¸ƒå±€</p>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ¯</div>
                <h4>ç²¾å‡†å®šä½</h4>
                <p>ä½¿ç”¨é«˜ç²¾åº¦GPSå®šä½ï¼Œæ”¯æŒå®¤å¤–ç²¾ç¡®å¯»å®</p>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ†</div>
                <h4>å¤šç§å®è—</h4>
                <p>é’»çŸ³ã€çš‡å† ã€é‡‘å¸ç­‰å¤šç§å®è—ç±»å‹ç­‰ä½ å‘ç°</p>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸŒ</div>
                <h4>å®æ—¶åœ°å›¾</h4>
                <p>åŸºäºé«˜å¾·åœ°å›¾çš„å®æ—¶ä½ç½®æ˜¾ç¤ºå’Œå¯¼èˆª</p>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ GPSçŠ¶æ€ä¿¡æ¯</h3>
            <div class="gps-info">
                <h4>å½“å‰ä½ç½®ä¿¡æ¯:</h4>
                <div class="gps-data" id="gps-data">
                    ç­‰å¾…è·å–GPSæ•°æ®...
                </div>
            </div>
        </div>

        <div class="card">
            <div id="map-container">
                <div class="map-placeholder">
                    <div class="map-placeholder-icon pulse">ğŸ—ºï¸</div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">åœ°å›¾å³å°†åŠ è½½</div>
                        <div style="color: #888;">é…ç½®API Keyåå³å¯æ˜¾ç¤ºé«˜å¾·åœ°å›¾</div>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="testGPS()" disabled id="gps-btn">
                    ğŸ“ é‡æ–°å®šä½
                </button>
                <button class="btn" onclick="generateNearbyTreasures()" disabled id="generate-btn">
                    ğŸ—ºï¸ ç”Ÿæˆå®è—
                </button>
                <button class="btn" onclick="addTreasure()" disabled id="treasure-btn">
                    âœ¨ æ·»åŠ å®è—
                </button>
                <button class="btn" onclick="clearMap()" disabled id="clear-btn">
                    ğŸ—‘ï¸ æ¸…ç©ºåœ°å›¾
                </button>
                <button class="btn" onclick="emergencyTest()" style="background: #ff6b6b;">
                    ğŸš¨ ç´§æ€¥æµ‹è¯•
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let map = null;
        let userMarker = null;
        let treasureMarkers = [];
        let userLocation = null;
        let watchId = null;

        // ç”¨æˆ·æ•°æ®ç®¡ç†
        let userData = {
            username: '',
            level: {
                currentLevel: 1,
                experience: 0,
                badges: []
            },
            stats: {
                treasuresCreated: 0,
                treasuresDiscovered: 0,
                totalLikes: 0,
                totalViews: 0
            },
            preferences: {
                interests: [],
                explorationRadius: 5000,
                language: 'zh-CN'
            },
            discoveredTreasures: [],
            createdTreasures: [],
            achievements: [],
            lastActiveAt: new Date()
        };

        // æœ¬åœ°å­˜å‚¨ç®¡ç†
        const storageManager = {
            save: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('å­˜å‚¨å¤±è´¥:', error);
                    return false;
                }
            },
            load: (key) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('è¯»å–å¤±è´¥:', error);
                    return null;
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    return false;
                }
            }
        };

        // å®Œæ•´çš„å®è—ç±»å‹ç³»ç»Ÿï¼ˆåŸºäºæ•°æ®æ¨¡å‹ï¼‰
        const treasureTypes = [
            { 
                icon: 'ğŸ’', 
                name: 'é’»çŸ³å®è—', 
                color: '#e74c3c', 
                rarity: 'legendary',
                category: 'æ‘„å½±',
                rewards: { experience: 100, coins: 50 },
                discoveryRadius: 30
            },
            { 
                icon: 'ğŸ‘‘', 
                name: 'çš‡å† å®è—', 
                color: '#9b59b6', 
                rarity: 'epic',
                category: 'å†å²',
                rewards: { experience: 80, coins: 40 },
                discoveryRadius: 35
            },
            { 
                icon: 'ğŸ’°', 
                name: 'é‡‘å¸å®è—', 
                color: '#f1c40f', 
                rarity: 'rare',
                category: 'è´­ç‰©',
                rewards: { experience: 60, coins: 30 },
                discoveryRadius: 40
            },
            { 
                icon: 'ğŸº', 
                name: 'å¤è‘£å®è—', 
                color: '#e67e22', 
                rarity: 'uncommon',
                category: 'è‰ºæœ¯',
                rewards: { experience: 40, coins: 20 },
                discoveryRadius: 45
            },
            { 
                icon: 'ğŸ’', 
                name: 'æˆ’æŒ‡å®è—', 
                color: '#3498db', 
                rarity: 'common',
                category: 'ç¾é£Ÿ',
                rewards: { experience: 20, coins: 10 },
                discoveryRadius: 50
            },
            { 
                icon: 'ğŸ­', 
                name: 'é¢å…·å®è—', 
                color: '#8e44ad', 
                rarity: 'rare',
                category: 'éŸ³ä¹',
                rewards: { experience: 55, coins: 25 },
                discoveryRadius: 40
            },
            { 
                icon: 'âš”ï¸', 
                name: 'ç¥å™¨å®è—', 
                color: '#2c3e50', 
                rarity: 'legendary',
                category: 'è¿åŠ¨',
                rewards: { experience: 120, coins: 60 },
                discoveryRadius: 25
            },
            { 
                icon: 'ğŸ†', 
                name: 'å¥–æ¯å®è—', 
                color: '#f39c12', 
                rarity: 'epic',
                category: 'æ—…æ¸¸',
                rewards: { experience: 90, coins: 45 },
                discoveryRadius: 30
            }
        ];

        // ç”¨æˆ·ç­‰çº§ç³»ç»Ÿ
        const levelSystem = {
            getLevel: (experience) => Math.floor(Math.sqrt(experience / 100)) + 1,
            getExpForLevel: (level) => Math.pow(level - 1, 2) * 100,
            getExpToNext: (currentExp) => {
                const currentLevel = levelSystem.getLevel(currentExp);
                const nextLevelExp = levelSystem.getExpForLevel(currentLevel + 1);
                return nextLevelExp - currentExp;
            }
        };

        // å¾½ç« ç³»ç»Ÿ
        const badgeSystem = [
            { name: 'first_treasure', icon: 'ğŸ¯', title: 'åˆæ¢è€…', description: 'å‘ç°ç¬¬ä¸€ä¸ªå®è—' },
            { name: 'treasure_hunter', icon: 'ğŸƒ', title: 'å¯»å®çŒäºº', description: 'å‘ç°10ä¸ªå®è—' },
            { name: 'treasure_master', icon: 'ğŸ‘‘', title: 'å¯»å®å¤§å¸ˆ', description: 'å‘ç°50ä¸ªå®è—' },
            { name: 'legendary_finder', icon: 'ğŸ’', title: 'ä¼ å¥‡å‘ç°è€…', description: 'å‘ç°ä¼ å¥‡çº§å®è—' },
            { name: 'category_expert', icon: 'ğŸ“', title: 'åˆ†ç±»ä¸“å®¶', description: 'åœ¨æ¯ä¸ªåˆ†ç±»ä¸­éƒ½å‘ç°å®è—' },
            { name: 'speed_runner', icon: 'âš¡', title: 'é—ªç”µä¾ ', description: '1å°æ—¶å†…å‘ç°5ä¸ªå®è—' },
            { name: 'explorer', icon: 'ğŸ—ºï¸', title: 'æ¢é™©å®¶', description: 'æ¢ç´¢è¶…è¿‡5å…¬é‡ŒèŒƒå›´' },
            { name: 'social_star', icon: 'â­', title: 'ç¤¾äº¤ä¹‹æ˜Ÿ', description: 'åˆ›å»ºçš„å®è—è¢«å‘ç°100æ¬¡' }
        ];

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info', showLoading = false) {
            const status = document.getElementById('status');
            const iconMap = {
                info: 'ğŸ”„',
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸'
            };
            
            const icon = showLoading ? '<span class="loading"></span>' : iconMap[type];
            status.innerHTML = `${icon}<span>${message}</span>`;
            status.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ›´æ–°GPSæ•°æ®æ˜¾ç¤º
        function updateGPSData(data) {
            const gpsData = document.getElementById('gps-data');
            gpsData.innerHTML = data;
        }

        // å®è—ç®¡ç†ç³»ç»Ÿ
        const treasureManager = {
            // åˆ›å»ºå®è—æ•°æ®
            createTreasure: (position, type, creator = 'system') => {
                const treasure = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    title: type.name,
                    description: `ä¸€ä¸ªçè´µçš„${type.name}ï¼Œç­‰å¾…ç€å‹‡æ•¢çš„æ¢é™©è€…æ¥å‘ç°ï¼`,
                    creator: creator,
                    location: {
                        coordinates: position,
                        discoveryRadius: type.discoveryRadius
                    },
                    category: type.category,
                    rewards: type.rewards,
                    rarity: type.rarity,
                    icon: type.icon,
                    color: type.color,
                    stats: {
                        views: 0,
                        likes: 0,
                        discoveries: 0
                    },
                    createdAt: new Date(),
                    status: 'active'
                };
                return treasure;
            },

            // å‘ç°å®è—
            discoverTreasure: (treasureId, userPosition) => {
                const treasureIndex = userData.createdTreasures.findIndex(t => t.id === treasureId);
                if (treasureIndex === -1) return { success: false, reason: 'treasure_not_found' };

                const treasure = userData.createdTreasures[treasureIndex];
                const distance = calculateDistance(userPosition, treasure.location.coordinates);

                if (distance > treasure.location.discoveryRadius) {
                    return { 
                        success: false, 
                        reason: 'too_far',
                        distance: distance,
                        requiredDistance: treasure.location.discoveryRadius
                    };
                }

                // æ£€æŸ¥æ˜¯å¦å·²ç»å‘ç°è¿‡
                if (userData.discoveredTreasures.includes(treasureId)) {
                    return { success: false, reason: 'already_discovered' };
                }

                // è®°å½•å‘ç°
                userData.discoveredTreasures.push(treasureId);
                userData.stats.treasuresDiscovered += 1;
                treasure.stats.discoveries += 1;

                // å¥–åŠ±ç»éªŒå’Œé‡‘å¸
                const reward = userManager.addExperience(treasure.rewards.experience);
                userManager.addCoins(treasure.rewards.coins);

                // æ£€æŸ¥æˆå°±
                achievementManager.checkAchievements();

                // ä¿å­˜æ•°æ®
                saveUserData();

                return {
                    success: true,
                    treasure: treasure,
                    rewards: treasure.rewards,
                    levelUp: reward.levelUp
                };
            }
        };

        // ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
        const userManager = {
            // æ·»åŠ ç»éªŒå€¼
            addExperience: (points) => {
                const oldLevel = userData.level.currentLevel;
                userData.level.experience += points;
                
                const newLevel = levelSystem.getLevel(userData.level.experience);
                if (newLevel > oldLevel) {
                    userData.level.currentLevel = newLevel;
                    
                    // ç­‰çº§æå‡å¥–åŠ±
                    const reward = {
                        coins: newLevel * 10,
                        badge: newLevel % 10 === 0 ? `level_${newLevel}` : null
                    };

                    if (reward.badge) {
                        userManager.addBadge(reward.badge, 'ğŸ†', `è¾¾åˆ°ç¬¬${newLevel}çº§`);
                    }

                    return {
                        levelUp: true,
                        oldLevel: oldLevel,
                        newLevel: newLevel,
                        reward: reward
                    };
                }
                
                return { levelUp: false };
            },

            // æ·»åŠ å¾½ç« 
            addBadge: (badgeName, icon, description) => {
                const existingBadge = userData.level.badges.find(badge => badge.name === badgeName);
                if (!existingBadge) {
                    userData.level.badges.push({
                        name: badgeName,
                        icon: icon,
                        description: description,
                        unlockedAt: new Date()
                    });
                    return true;
                }
                return false;
            },

            // æ·»åŠ é‡‘å¸ï¼ˆè™šæ‹Ÿè´§å¸ï¼‰
            addCoins: (amount) => {
                if (!userData.coins) userData.coins = 0;
                userData.coins += amount;
            },

            // è·å–ç”¨æˆ·ç­‰çº§ä¿¡æ¯
            getLevelInfo: () => {
                const currentExp = userData.level.experience;
                const currentLevel = userData.level.currentLevel;
                const expForCurrentLevel = levelSystem.getExpForLevel(currentLevel);
                const expForNextLevel = levelSystem.getExpForLevel(currentLevel + 1);
                const expToNext = expForNextLevel - currentExp;
                const progress = ((currentExp - expForCurrentLevel) / (expForNextLevel - expForCurrentLevel)) * 100;

                return {
                    currentLevel,
                    currentExp,
                    expToNext,
                    progress: Math.max(0, Math.min(100, progress))
                };
            }
        };

        // æˆå°±ç³»ç»Ÿ
        const achievementManager = {
            checkAchievements: () => {
                const achievements = [];

                // ç¬¬ä¸€ä¸ªå®è—
                if (userData.stats.treasuresDiscovered === 1) {
                    achievements.push(userManager.addBadge('first_treasure', 'ğŸ¯', 'å‘ç°ç¬¬ä¸€ä¸ªå®è—'));
                }

                // å¯»å®çŒäºº
                if (userData.stats.treasuresDiscovered === 10) {
                    achievements.push(userManager.addBadge('treasure_hunter', 'ğŸƒ', 'å‘ç°10ä¸ªå®è—'));
                }

                // å¯»å®å¤§å¸ˆ
                if (userData.stats.treasuresDiscovered === 50) {
                    achievements.push(userManager.addBadge('treasure_master', 'ğŸ‘‘', 'å‘ç°50ä¸ªå®è—'));
                }

                // ä¼ å¥‡å‘ç°è€…ï¼ˆå‘ç°ä¼ å¥‡çº§å®è—ï¼‰
                const legendaryFound = userData.createdTreasures.some(t => 
                    userData.discoveredTreasures.includes(t.id) && t.rarity === 'legendary'
                );
                if (legendaryFound) {
                    achievements.push(userManager.addBadge('legendary_finder', 'ğŸ’', 'å‘ç°ä¼ å¥‡çº§å®è—'));
                }

                return achievements.filter(Boolean);
            }
        };

        // è·ç¦»è®¡ç®—å·¥å…·
        function calculateDistance(pos1, pos2) {
            const R = 6371000; // åœ°çƒåŠå¾„(ç±³)
            const lat1 = pos1[1] * Math.PI / 180;
            const lat2 = pos2[1] * Math.PI / 180;
            const deltaLat = (pos2[1] - pos1[1]) * Math.PI / 180;
            const deltaLng = (pos2[0] - pos1[0]) * Math.PI / 180;

            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // ä¿å­˜å’ŒåŠ è½½ç”¨æˆ·æ•°æ®
        function saveUserData() {
            userData.lastActiveAt = new Date();
            storageManager.save('douyin-treasure-user', userData);
        }

        function loadUserData() {
            const saved = storageManager.load('douyin-treasure-user');
            if (saved) {
                userData = { ...userData, ...saved };
                // ç¡®ä¿æ—¥æœŸå­—æ®µæ­£ç¡®è§£æ
                if (saved.lastActiveAt) {
                    userData.lastActiveAt = new Date(saved.lastActiveAt);
                }
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
        function updateStats(accuracy = 0) {
            document.getElementById('online-users').textContent = '1';
            document.getElementById('total-treasures').textContent = treasureMarkers.length;
            document.getElementById('accuracy').textContent = `${Math.round(accuracy)}m`;
            
            // æ›´æ–°ç”¨æˆ·ç­‰çº§ä¿¡æ¯
            const levelInfo = userManager.getLevelInfo();
            if (document.getElementById('user-level')) {
                document.getElementById('user-level').textContent = `LV.${levelInfo.currentLevel}`;
            }
            if (document.getElementById('user-exp')) {
                document.getElementById('user-exp').textContent = `${userData.level.experience} EXP`;
            }
        }

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            const apiKey = document.getElementById('api-key').value.trim();
            
            if (!apiKey) {
                updateStatus('è¯·è¾“å…¥é«˜å¾·åœ°å›¾API Keyï¼', 'error');
                return;
            }

            updateStatus('æ­£åœ¨åŠ è½½é«˜å¾·åœ°å›¾...', 'info', true);
            localStorage.setItem('amap-api-key', apiKey);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const initBtn = document.getElementById('init-btn-text');
            initBtn.innerHTML = '<span class="loading"></span> æ­£åœ¨åŠ è½½...';

            // åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾API
            const script = document.createElement('script');
            script.src = `https://webapi.amap.com/maps?v=2.0&key=${apiKey}&plugin=AMap.Geolocation`;
            script.onload = function() {
                createMap();
            };
            script.onerror = function() {
                updateStatus('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥Keyæ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œè¿æ¥', 'error');
                document.getElementById('init-btn-text').innerHTML = 'ğŸš€ é‡æ–°å¯åŠ¨';
            };
            document.head.appendChild(script);
        }

        // åˆ›å»ºåœ°å›¾å®ä¾‹
        function createMap() {
            try {
                updateStatus('æ­£åœ¨åˆ›å»ºåœ°å›¾å®ä¾‹...', 'info', true);
                
                map = new AMap.Map('map-container', {
                    zoom: 14,
                    center: [121.4737, 31.2304], // é»˜è®¤ä¸Šæµ·åæ ‡
                    viewMode: '2D',
                    showLabel: true,
                    mapStyle: 'amap://styles/normal',
                    resizeEnable: true
                });

                // åœ°å›¾åŠ è½½å®Œæˆäº‹ä»¶
                map.on('complete', function() {
                    updateStatus('åœ°å›¾åŠ è½½æˆåŠŸï¼æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...', 'success');
                    
                    // é‡ç½®æŒ‰é’®
                    document.getElementById('init-btn-text').innerHTML = 'âœ… åœ°å›¾å·²å¯åŠ¨';
                    
                    // å¯ç”¨æ§åˆ¶æŒ‰é’®
                    document.querySelectorAll('.btn').forEach(btn => {
                        if (!btn.onclick || btn.onclick.toString().includes('initMap')) {
                            return;
                        }
                        btn.disabled = false;
                    });

                    // è‡ªåŠ¨è·å–ä½ç½®
                    setTimeout(() => {
                        testGPS();
                    }, 1000);
                });

                // åœ°å›¾ç‚¹å‡»äº‹ä»¶ - æ·»åŠ å®è—
                map.on('click', function(e) {
                    if (userLocation && confirm('åœ¨æ­¤ä½ç½®æ·»åŠ å®è—ï¼Ÿ')) {
                        addTreasureAtPosition([e.lnglat.lng, e.lnglat.lat]);
                    }
                });

            } catch (error) {
                updateStatus('åœ°å›¾åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                document.getElementById('init-btn-text').innerHTML = 'ğŸš€ é‡æ–°å¯åŠ¨';
            }
        }

        // æµ‹è¯•GPSå®šä½
        function testGPS() {
            if (!map) {
                updateStatus('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼', 'warning');
                return;
            }

            updateStatus('æ­£åœ¨è·å–GPSä½ç½®...', 'info', true);
            updateGPSData('<div class="loading"></div> æ­£åœ¨å®šä½...');

            // ç›´æ¥ä½¿ç”¨æµè§ˆå™¨åŸç”ŸGPSï¼ˆæ›´å¯é ï¼‰
            useNativeGeolocation();
            
            // å¦‚æœåŸç”ŸAPIå¤±è´¥ï¼Œå†å°è¯•é«˜å¾·å®šä½ï¼ˆä½œä¸ºå¤‡é€‰ï¼‰
            setTimeout(() => {
                if (!userLocation && window.AMap && AMap.Geolocation) {
                    updateStatus('å°è¯•é«˜å¾·åœ°å›¾å®šä½æœåŠ¡...', 'info', true);
                    
                    const geolocation = new AMap.Geolocation({
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 10000,
                        convert: true,
                        showButton: false,
                        showMarker: false,
                        showCircle: false
                    });

                    geolocation.getCurrentPosition((status, result) => {
                        if (status === 'complete' && !userLocation) {
                            handleLocationSuccess({
                                coords: {
                                    latitude: result.position.lat,
                                    longitude: result.position.lng,
                                    accuracy: result.accuracy || 100
                                },
                                timestamp: Date.now()
                            });
                        } else if (status === 'error') {
                            console.log('é«˜å¾·å®šä½å¤±è´¥:', result);
                            if (!userLocation) {
                                // æœ€åä½¿ç”¨é»˜è®¤ä½ç½®
                                handleLocationError({ code: 0, message: 'æ‰€æœ‰å®šä½æ–¹å¼å‡å¤±è´¥' });
                            }
                        }
                    });
                }
            }, 3000);
        }

        // ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿå®šä½API
        function useNativeGeolocation() {
            console.log('å¼€å§‹GPSå®šä½æµç¨‹...');
            
            if (!navigator.geolocation) {
                updateStatus('æµè§ˆå™¨ä¸æ”¯æŒGPSå®šä½åŠŸèƒ½', 'error');
                updateGPSData('é”™è¯¯: æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½API');
                console.error('æµè§ˆå™¨ä¸æ”¯æŒgeolocation');
                return;
            }

            console.log('æµè§ˆå™¨æ”¯æŒGPSï¼Œå¼€å§‹å®šä½...');
            updateStatus('æ­£åœ¨ä½¿ç”¨GPSå®šä½...', 'info', true);
            
            // è®¾ç½®å®šä½é€‰é¡¹
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };
            
            console.log('å®šä½é€‰é¡¹:', options);
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('GPSå®šä½æˆåŠŸ:', position);
                    handleLocationSuccess(position);
                },
                (error) => {
                    console.error('GPSå®šä½å¤±è´¥:', error);
                    console.log('é”™è¯¯ä»£ç :', error.code, 'é”™è¯¯æ¶ˆæ¯:', error.message);
                    
                    updateStatus('GPSå®šä½å¤±è´¥ï¼Œå°è¯•ä½ç²¾åº¦å®šä½...', 'warning', true);
                    
                    // é™çº§åˆ°ä½ç²¾åº¦å®šä½
                    const lowAccuracyOptions = {
                        enableHighAccuracy: false,
                        timeout: 20000,
                        maximumAge: 600000
                    };
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            console.log('ä½ç²¾åº¦å®šä½æˆåŠŸ:', position);
                            handleLocationSuccess(position);
                        },
                        (fallbackError) => {
                            console.error('æ‰€æœ‰å®šä½æ–¹å¼å¤±è´¥:', fallbackError);
                            handleLocationError(fallbackError);
                        },
                        lowAccuracyOptions
                    );
                },
                options
            );
        }

        // å¤„ç†å®šä½æˆåŠŸ
        function handleLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy || 0;
            const timestamp = new Date(position.timestamp).toLocaleString();
            
            userLocation = [lng, lat];
            
            updateStatus(`GPSå®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³`, 'success');
            updateGPSData(`
                <strong>ğŸ“ ä½ç½®ä¿¡æ¯</strong><br>
                çº¬åº¦: ${lat.toFixed(6)} ${lat > 30 && lat < 32 ? 'âœ…' : 'â“'}<br>
                ç»åº¦: ${lng.toFixed(6)} ${lng > 120 && lng < 122 ? 'âœ…' : 'â“'}<br>
                ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 100 ? 'âœ…' : accuracy < 500 ? 'âš ï¸' : 'âŒ'}<br>
                æ—¶é—´: ${timestamp}<br>
                <small style="color: #666;">
                    åæ ‡ç³»: WGS84<br>
                    ${lat > 30 && lat < 32 && lng > 120 && lng < 122 ? 'ğŸ¯ ä¸Šæµ·åœ°åŒºå®šä½æˆåŠŸ' : 'ğŸŒ éä¸Šæµ·åœ°åŒºæˆ–å®šä½å¼‚å¸¸'}
                </small>
            `);
            
            updateStats(accuracy);
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(17);
            
            // è‡ªåŠ¨ç”Ÿæˆå‘¨å›´çš„å®è—
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1500);
        }

        // å¤„ç†å®šä½é”™è¯¯
        function handleLocationError(error) {
            let errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'ç”¨æˆ·æ‹’ç»äº†ä½ç½®æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ä½ç½®è®¿é—®';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥GPSæ˜¯å¦å¼€å¯';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'å®šä½è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•';
                    break;
                default:
                    errorMsg = 'æœªçŸ¥å®šä½é”™è¯¯ï¼Œè¯·é‡è¯•';
                    break;
            }
            
            updateStatus(`GPSå®šä½å¤±è´¥: ${errorMsg}`, 'error');
            updateGPSData(`
                <strong>âŒ å®šä½å¤±è´¥</strong><br>
                é”™è¯¯: ${errorMsg}<br>
                <small style="color: #666;">
                    å»ºè®®:<br>
                    â€¢ åœ¨æˆ·å¤–é‡è¯•<br>
                    â€¢ æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®<br>
                    â€¢ ç¡®ä¿GPSåŠŸèƒ½å·²å¼€å¯
                </small>
            `);
            
            // ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·å¤–æ»©ï¼‰
            userLocation = [121.4737, 31.2304];
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            updateStatus('GPSå®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·å¤–æ»©ï¼‰ã€‚å»ºè®®åœ¨æˆ·å¤–é‡æ–°å°è¯•å®šä½ã€‚', 'warning');
            
            // å³ä½¿æ˜¯é»˜è®¤ä½ç½®ä¹Ÿç”Ÿæˆå®è—
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1000);
        }

        // åˆ›å»ºç”¨æˆ·ä½ç½®æ ‡è®°
        function createUserMarker() {
            if (!map || !userLocation) return;

            if (userMarker) {
                map.remove(userMarker);
            }

            userMarker = new AMap.Marker({
                position: userLocation,
                icon: new AMap.Icon({
                    image: 'data:image/svg+xml;base64,' + btoa(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60">
                            <circle cx="30" cy="30" r="25" fill="#4CAF50" stroke="white" stroke-width="5"/>
                            <circle cx="30" cy="30" r="8" fill="white"/>
                            <text x="30" y="38" text-anchor="middle" fill="white" font-size="24">ğŸ“</text>
                        </svg>
                    `),
                    size: new AMap.Size(60, 60),
                    imageOffset: new AMap.Pixel(-30, -30)
                }),
                title: 'æˆ‘çš„ä½ç½®',
                zIndex: 1000,
                animation: 'AMAP_ANIMATION_BOUNCE'
            });

            map.add(userMarker);
        }

        // ç”Ÿæˆå‘¨å›´çš„å®è—
        function generateNearbyTreasures() {
            console.log('å¼€å§‹ç”Ÿæˆå®è—...');
            console.log('åœ°å›¾çŠ¶æ€:', map ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–');
            console.log('ç”¨æˆ·ä½ç½®:', userLocation);
            
            if (!map) {
                updateStatus('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼', 'warning');
                console.error('åœ°å›¾æœªåˆå§‹åŒ–');
                return;
            }
            
            if (!userLocation) {
                updateStatus('è¯·å…ˆè·å–GPSä½ç½®ï¼', 'warning');
                console.error('ç”¨æˆ·ä½ç½®æœªè·å–');
                return;
            }

            // æ¸…ç©ºç°æœ‰å®è—
            if (treasureMarkers.length > 0) {
                console.log('æ¸…ç©ºç°æœ‰å®è—:', treasureMarkers.length);
                clearMap();
            }

            updateStatus('æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆå‘¨å›´çš„å®è—...', 'info', true);
            console.log('å¼€å§‹ç”Ÿæˆå®è—æµç¨‹...');

            // ç”Ÿæˆ3-6ä¸ªå®è—
            const treasureCount = Math.floor(Math.random() * 4) + 3;
            console.log('è®¡åˆ’ç”Ÿæˆå®è—æ•°é‡:', treasureCount);
            
            for (let i = 0; i < treasureCount; i++) {
                setTimeout(() => {
                    console.log(`ç”Ÿæˆç¬¬${i + 1}ä¸ªå®è—...`);
                    
                    // éšæœºé€‰æ‹©å®è—ç±»å‹ï¼Œç¨€æœ‰åº¦å½±å“æ¦‚ç‡
                    const treasureType = getRandomTreasureByRarity();
                    console.log('é€‰æ‹©çš„å®è—ç±»å‹:', treasureType);
                    
                    // åœ¨ç”¨æˆ·ä½ç½®å‘¨å›´500ç±³å†…éšæœºç”Ÿæˆ
                    const angle = Math.random() * 2 * Math.PI;
                    const distance = Math.random() * 0.005 + 0.001; // 100-600ç±³
                    
                    const offsetLng = Math.cos(angle) * distance;
                    const offsetLat = Math.sin(angle) * distance;
                    const position = [userLocation[0] + offsetLng, userLocation[1] + offsetLat];
                    
                    console.log('å®è—ä½ç½®:', position);

                    try {
                        addTreasureAtPosition(position, treasureType);
                        console.log(`ç¬¬${i + 1}ä¸ªå®è—ç”ŸæˆæˆåŠŸ`);
                    } catch (error) {
                        console.error(`ç¬¬${i + 1}ä¸ªå®è—ç”Ÿæˆå¤±è´¥:`, error);
                    }
                    
                    if (i === treasureCount - 1) {
                        updateStatus(`ğŸ—ºï¸ å·²ç”Ÿæˆ${treasureCount}ä¸ªå®è—ï¼å¼€å§‹æ‚¨çš„å¯»å®ä¹‹æ—…å§ï¼`, 'success');
                        console.log('æ‰€æœ‰å®è—ç”Ÿæˆå®Œæˆ');
                    }
                }, i * 300); // ç¼©çŸ­é—´éš”åˆ°300ms
            }
        }

        // æ ¹æ®ç¨€æœ‰åº¦éšæœºé€‰æ‹©å®è—ç±»å‹
        function getRandomTreasureByRarity() {
            const rarityWeights = {
                'common': 40,
                'uncommon': 30,
                'rare': 20,
                'epic': 8,
                'legendary': 2
            };

            // åˆ›å»ºåŠ æƒæ•°ç»„
            let weightedArray = [];
            treasureTypes.forEach(type => {
                const weight = rarityWeights[type.rarity] || 10;
                for (let i = 0; i < weight; i++) {
                    weightedArray.push(type);
                }
            });

            return weightedArray[Math.floor(Math.random() * weightedArray.length)];
        }

        // æ‰‹åŠ¨æ·»åŠ å•ä¸ªå®è—
        function addTreasure() {
            if (!map || !userLocation) {
                updateStatus('è¯·å…ˆè·å–GPSä½ç½®ï¼', 'warning');
                return;
            }

            const treasureType = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
            
            // åœ¨ç”¨æˆ·ä½ç½®é™„è¿‘éšæœºç”Ÿæˆå®è—
            const offsetLng = (Math.random() - 0.5) * 0.008; // çº¦400ç±³èŒƒå›´
            const offsetLat = (Math.random() - 0.5) * 0.008;
            const position = [userLocation[0] + offsetLng, userLocation[1] + offsetLat];

            addTreasureAtPosition(position, treasureType);
        }

        // åœ¨æŒ‡å®šä½ç½®æ·»åŠ å®è—
        function addTreasureAtPosition(position, treasureType = null) {
            console.log('addTreasureAtPosition è¢«è°ƒç”¨');
            console.log('ä½ç½®å‚æ•°:', position);
            console.log('å®è—ç±»å‹å‚æ•°:', treasureType);
            console.log('å½“å‰åœ°å›¾çŠ¶æ€:', map);
            
            if (!position || !Array.isArray(position) || position.length !== 2) {
                console.error('æ— æ•ˆçš„ä½ç½®å‚æ•°:', position);
                updateStatus('âŒ ä½ç½®å‚æ•°é”™è¯¯', 'error');
                return;
            }
            
            if (!map) {
                console.error('åœ°å›¾æœªåˆå§‹åŒ–');
                updateStatus('âŒ åœ°å›¾æœªåˆå§‹åŒ–', 'error');
                return;
            }

            if (!treasureType) {
                treasureType = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
                console.log('éšæœºé€‰æ‹©å®è—ç±»å‹:', treasureType);
            }

            try {
                // åˆ›å»ºå®è—æ•°æ®
                console.log('åˆ›å»ºå®è—æ•°æ®...');
                const treasureData = treasureManager.createTreasure(position, treasureType, 'player');
                console.log('å®è—æ•°æ®åˆ›å»ºæˆåŠŸ:', treasureData);
                
                userData.createdTreasures.push(treasureData);
                userData.stats.treasuresCreated += 1;
                console.log('ç”¨æˆ·æ•°æ®æ›´æ–°å®Œæˆ');

                // åˆ›å»ºåœ°å›¾æ ‡è®°
                console.log('åˆ›å»ºåœ°å›¾æ ‡è®°...');
                const treasureMarker = new AMap.Marker({
                    position: position,
                    icon: new AMap.Icon({
                        image: 'data:image/svg+xml;base64,' + btoa(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50">
                                <circle cx="25" cy="25" r="20" fill="${treasureType.color}" stroke="white" stroke-width="4"/>
                                <circle cx="25" cy="25" r="15" fill="${treasureType.color}" opacity="0.3"/>
                                <text x="25" y="33" text-anchor="middle" fill="white" font-size="18">${treasureType.icon}</text>
                            </svg>
                        `),
                        size: new AMap.Size(50, 50),
                        imageOffset: new AMap.Pixel(-25, -25)
                    }),
                    title: `${treasureType.name} (${treasureType.rarity})`,
                    zIndex: 500
                });
                console.log('åœ°å›¾æ ‡è®°åˆ›å»ºæˆåŠŸ:', treasureMarker);

            // å­˜å‚¨å®è—IDåˆ°æ ‡è®°ä¸Š
            treasureMarker.treasureId = treasureData.id;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            treasureMarker.on('click', function() {
                if (userLocation) {
                    const distance = calculateDistance(userLocation, position);
                    const requiredDistance = treasureData.location.discoveryRadius;
                    
                    if (distance <= requiredDistance) {
                        // å°è¯•å‘ç°å®è—
                        const result = treasureManager.discoverTreasure(treasureData.id, userLocation);
                        
                        if (result.success) {
                            // å‘ç°æˆåŠŸ
                            map.remove(treasureMarker);
                            treasureMarkers = treasureMarkers.filter(m => m !== treasureMarker);
                            
                            let message = `ğŸ‰ æ­å–œï¼æ‚¨å‘ç°äº†${result.treasure.title}ï¼\n`;
                            message += `ğŸ’° è·å¾— ${result.rewards.coins} é‡‘å¸\n`;
                            message += `â­ è·å¾— ${result.rewards.experience} ç»éªŒ`;
                            
                            if (result.levelUp) {
                                message += `\nğŸŠ ç­‰çº§æå‡ï¼LV.${result.levelUp.oldLevel} â†’ LV.${result.levelUp.newLevel}`;
                            }
                            
                            updateStatus(message, 'success');
                            
                            // æ£€æŸ¥æ–°æˆå°±
                            const newAchievements = achievementManager.checkAchievements();
                            if (newAchievements.length > 0) {
                                setTimeout(() => {
                                    updateStatus('ğŸ† è·å¾—æ–°æˆå°±ï¼æŸ¥çœ‹å¾½ç« ç³»ç»Ÿäº†è§£è¯¦æƒ…', 'success');
                                }, 2000);
                            }
                            
                        } else {
                            // å‘ç°å¤±è´¥
                            if (result.reason === 'already_discovered') {
                                updateStatus('æ‚¨å·²ç»å‘ç°è¿‡è¿™ä¸ªå®è—äº†', 'warning');
                            } else if (result.reason === 'too_far') {
                                updateStatus(`è·ç¦»å¤ªè¿œï¼è¿˜éœ€è¦é è¿‘${Math.round(result.distance - result.requiredDistance)}ç±³`, 'warning');
                            }
                        }
                    } else {
                        updateStatus(`${treasureType.name}è·ç¦»æ‚¨è¿˜æœ‰${Math.round(distance)}ç±³ï¼ˆéœ€è¦åœ¨${requiredDistance}ç±³å†…ï¼‰`, 'info');
                        
                        // æ˜¾ç¤ºè·ç¦»æŒ‡ç¤º
                        const infoWindow = new AMap.InfoWindow({
                            content: `
                                <div style="padding: 10px; text-align: center;">
                                    <div style="font-size: 1.2rem; margin-bottom: 5px;">${treasureType.icon} ${treasureType.name}</div>
                                    <div style="color: #666; font-size: 0.9rem;">è·ç¦»: ${Math.round(distance)}ç±³</div>
                                    <div style="color: #666; font-size: 0.9rem;">éœ€è¦: ${requiredDistance}ç±³å†…</div>
                                    <div style="color: #667eea; font-size: 0.8rem; margin-top: 5px;">
                                        ğŸ’° ${treasureType.rewards.coins} é‡‘å¸ | â­ ${treasureType.rewards.experience} ç»éªŒ
                                    </div>
                                </div>
                            `,
                            anchor: 'bottom-center',
                            offset: new AMap.Pixel(0, -5)
                        });
                        infoWindow.open(map, position);
                        
                        // 3ç§’åè‡ªåŠ¨å…³é—­
                        setTimeout(() => {
                            infoWindow.close();
                        }, 3000);
                    }
                }
            });

                // æ·»åŠ åˆ°åœ°å›¾
                console.log('æ·»åŠ æ ‡è®°åˆ°åœ°å›¾...');
                map.add(treasureMarker);
                treasureMarkers.push(treasureMarker);
                console.log('æ ‡è®°å·²æ·»åŠ åˆ°åœ°å›¾ï¼Œå½“å‰å®è—æ•°é‡:', treasureMarkers.length);
                
                // ä¿å­˜æ•°æ®
                saveUserData();
                
                updateStatus(`âœ¨ åˆ›å»ºäº†${treasureType.name}å®è—ï¼ï¼ˆ${treasureType.category}ç±»åˆ«ï¼‰`, 'success');
                updateStats();
                
            } catch (error) {
                console.error('æ·»åŠ å®è—å¤±è´¥:', error);
                updateStatus(`âŒ å®è—åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…ç©ºåœ°å›¾
        function clearMap() {
            if (treasureMarkers.length === 0) {
                updateStatus('åœ°å›¾ä¸Šæ²¡æœ‰å®è—', 'info');
                return;
            }

            map.remove(treasureMarkers);
            treasureMarkers = [];
            updateStatus('ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰å®è—', 'success');
            updateStats();
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åŠ è½½ç”¨æˆ·æ•°æ®
            loadUserData();
            
            const savedKey = localStorage.getItem('amap-api-key');
            if (savedKey) {
                document.getElementById('api-key').value = savedKey;
                updateStatus('å‘ç°å·²ä¿å­˜çš„API Keyï¼Œç‚¹å‡»å¯åŠ¨å³å¯å¼€å§‹æ¸¸æˆ', 'success');
            }

            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            if (userData.stats.treasuresDiscovered > 0) {
                updateStatus(`æ¬¢è¿å›æ¥ï¼æ‚¨å·²å‘ç° ${userData.stats.treasuresDiscovered} ä¸ªå®è—ï¼Œå½“å‰ç­‰çº§ LV.${userData.level.currentLevel}`, 'success');
            }

            // æ›´æ–°åˆå§‹ç»Ÿè®¡
            updateStats();
            
            // æ˜¾ç¤ºç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
            updateUserDisplay();
        });

        // æ›´æ–°ç”¨æˆ·æ˜¾ç¤ºä¿¡æ¯
        function updateUserDisplay() {
            const levelInfo = userManager.getLevelInfo();
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            if (document.getElementById('total-treasures')) {
                document.getElementById('total-treasures').textContent = userData.stats.treasuresDiscovered;
            }
            
            // å¦‚æœæœ‰å¾½ç« æ˜¾ç¤ºåŒºåŸŸï¼Œæ›´æ–°å¾½ç« 
            if (userData.level.badges.length > 0) {
                console.log('ğŸ† å·²è·å¾—å¾½ç« :', userData.level.badges.map(b => `${b.icon} ${b.description}`).join(', '));
            }
        }

        // å¯¼å‡ºç”¨æˆ·æ•°æ®ï¼ˆç”¨äºè°ƒè¯•æˆ–å¤‡ä»½ï¼‰
        function exportUserData() {
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'douyin-treasure-userdata.json';
            a.click();
            URL.revokeObjectURL(url);
            updateStatus('ç”¨æˆ·æ•°æ®å·²å¯¼å‡º', 'success');
        }

        // é‡ç½®ç”¨æˆ·æ•°æ®
        function resetUserData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ¸¸æˆæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                storageManager.remove('douyin-treasure-user');
                location.reload();
            }
        }

        // ç§»åŠ¨ç«¯è°ƒè¯•åŠŸèƒ½
        function debugLocationInfo() {
            let debugInfo = `
                <strong>ğŸ”§ è°ƒè¯•ä¿¡æ¯</strong><br>
                ç”¨æˆ·ä»£ç†: ${navigator.userAgent.substring(0, 50)}...<br>
                æ”¯æŒGPS: ${navigator.geolocation ? 'âœ…' : 'âŒ'}<br>
                å½“å‰æ—¶é—´: ${new Date().toLocaleString()}<br>
                åœ°å›¾çŠ¶æ€: ${map ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}<br>
                ç”¨æˆ·ä½ç½®: ${userLocation ? `${userLocation[1].toFixed(4)}, ${userLocation[0].toFixed(4)}` : 'âŒ æœªè·å–'}<br>
                å®è—æ•°é‡: ${treasureMarkers.length}<br>
                HTTPS: ${location.protocol === 'https:' ? 'âœ…' : 'âŒ GPSéœ€è¦HTTPS'}<br>
            `;
            
            // æ£€æŸ¥æƒé™çŠ¶æ€
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    debugInfo += `GPSæƒé™: ${result.state}<br>`;
                    updateGPSData(debugInfo);
                });
            } else {
                updateGPSData(debugInfo);
            }
        }

        // ç´§æ€¥æµ‹è¯•åŠŸèƒ½
        function emergencyTest() {
            console.log('ğŸš¨ å¼€å§‹ç´§æ€¥æµ‹è¯•...');
            updateStatus('ğŸš¨ ç´§æ€¥æµ‹è¯•å¼€å§‹...', 'info', true);
            
            // å¼ºåˆ¶è®¾ç½®ä¸Šæµ·ä½ç½®
            userLocation = [121.4737, 31.2304];
            console.log('è®¾ç½®ç”¨æˆ·ä½ç½®:', userLocation);
            
            if (!map) {
                console.error('åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ— æ³•è¿›è¡Œæµ‹è¯•');
                updateStatus('âŒ åœ°å›¾æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            // åˆ›å»ºç”¨æˆ·æ ‡è®°
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            
            updateGPSData(`
                <strong>ğŸš¨ ç´§æ€¥æµ‹è¯•ä½ç½®</strong><br>
                çº¬åº¦: 31.230400 âœ…<br>
                ç»åº¦: 121.473700 âœ…<br>
                ç²¾åº¦: æµ‹è¯•æ¨¡å¼<br>
                æ—¶é—´: ${new Date().toLocaleString()}<br>
                <small style="color: #666;">ğŸ¯ ä¸Šæµ·å¤–æ»©æµ‹è¯•ä½ç½®</small>
            `);
            
            // æ¸…ç©ºç°æœ‰å®è—
            clearMap();
            
            // ç›´æ¥åˆ›å»ºä¸€ä¸ªæµ‹è¯•å®è—
            console.log('åˆ›å»ºæµ‹è¯•å®è—...');
            setTimeout(() => {
                const testPosition = [121.4737 + 0.001, 31.2304 + 0.001]; // ç¨å¾®åç§»
                const testTreasure = treasureTypes[0]; // ä½¿ç”¨ç¬¬ä¸€ä¸ªå®è—ç±»å‹
                
                console.log('æµ‹è¯•å®è—ä½ç½®:', testPosition);
                console.log('æµ‹è¯•å®è—ç±»å‹:', testTreasure);
                
                try {
                    addTreasureAtPosition(testPosition, testTreasure);
                    updateStatus('ğŸš¨ ç´§æ€¥æµ‹è¯•å®Œæˆï¼å¦‚æœçœ‹åˆ°å®è—è¯´æ˜åŠŸèƒ½æ­£å¸¸', 'success');
                } catch (error) {
                    console.error('ç´§æ€¥æµ‹è¯•å¤±è´¥:', error);
                    updateStatus('âŒ ç´§æ€¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                }
            }, 500);
        }

        // å¼ºåˆ¶ä½¿ç”¨ä¸Šæµ·ä½ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        function useShanghai() {
            userLocation = [121.4737, 31.2304]; // ä¸Šæµ·å¤–æ»©
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            updateStatus('ğŸ—ºï¸ å·²åˆ‡æ¢åˆ°ä¸Šæµ·å¤–æ»©ä½ç½®', 'success');
            updateGPSData(`
                <strong>ğŸ“ ä¸Šæµ·å¤–æ»©ä½ç½®</strong><br>
                çº¬åº¦: 31.230400 âœ…<br>
                ç»åº¦: 121.473700 âœ…<br>
                ç²¾åº¦: æ¨¡æ‹Ÿä½ç½®<br>
                æ—¶é—´: ${new Date().toLocaleString()}<br>
                <small style="color: #666;">ğŸ¯ ä¸Šæµ·åœ°åŒºæ¨¡æ‹Ÿå®šä½</small>
            `);
            
            // ç”Ÿæˆå®è—
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1000);
        }

        // é”®ç›˜å¿«æ·é”®å’Œè§¦æ‘¸äº‹ä»¶
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        if (!map) initMap();
                        else testGPS();
                        break;
                    case 't':
                        e.preventDefault();
                        addTreasure();
                        break;
                    case 's':
                        e.preventDefault();
                        useShanghai();
                        break;
                    case 'd':
                        e.preventDefault();
                        debugLocationInfo();
                        break;
                    case 'Delete':
                    case 'Backspace':
                        e.preventDefault();
                        clearMap();
                        break;
                }
            }
        });

        // ç§»åŠ¨ç«¯é•¿æŒ‰æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        let touchTimer;
        document.addEventListener('touchstart', function(e) {
            if (e.target.id === 'gps-data') {
                touchTimer = setTimeout(() => {
                    debugLocationInfo();
                }, 1000);
            }
        });

        document.addEventListener('touchend', function() {
            clearTimeout(touchTimer);
        });
    </script>
</body>
</html>
