<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totofun çªçªç¿» - GPSå¯»å®æ¸¸æˆ</title>
<meta name="description" content="åŸºäºGPSå®šä½çš„å®æ—¶å¯»å®æ¸¸æˆï¼Œæ¢ç´¢èº«è¾¹çš„å®è—">
    <meta name="keywords" content="GPSå¯»å®,Totofun,çªçªç¿»,é«˜å¾·åœ°å›¾,å®šä½æ¸¸æˆ,å¯»å®æ¸¸æˆ">
    
    <!-- PWAæ”¯æŒ -->
    <meta name="theme-color" content="#4FC3F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="icon" type="image/png" href="assets/images/totofun-logo.png">
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: system-ui, -apple-system, 'PingFang SC', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 50%, #FFA500 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #333;
            padding: 10px;
            line-height: 1.6;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            color: white;
            margin-bottom: 20px;
        }
        
        .logo-container {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            padding: 20px;
            display: inline-block;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            width: 160px;
            height: 160px;
            margin: 0 auto;
            display: block;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.15));
        }
        
        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) scale(1); 
            }
            50% { 
                transform: translateY(-10px) scale(1.05); 
            }
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            color: #ffffff;
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .stat {
            text-align: center;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .card h3 {
            color: #1E3A8A;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin: 20px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .api-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .api-input:focus {
            border-color: #4FC3F7;
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover:before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(79, 195, 247, 0.5);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn:disabled:before {
            display: none;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status.info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%);
            color: #1976d2;
            border: 1px solid #2196F3;
        }
        
        .status.success {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            color: #2e7d32;
            border: 1px solid #4CAF50;
        }
        
        .status.error {
            background: linear-gradient(135deg, #ffebee 0%, #ffeef0 100%);
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .status.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #fffbf0 100%);
            color: #856404;
            border: 1px solid #ffc107;
        }
        
        #map-container {
            width: 100%;
            height: 60vh;
            min-height: 400px;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid #e1e5e9;
            margin: 20px 0;
            position: relative;
            background: #f8f9fa;
        }
        
        .map-placeholder {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
            color: #666; 
            flex-direction: column;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .map-placeholder-icon {
            font-size: 4rem; 
            margin-bottom: 20px;
            opacity: 0.6;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .controls {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .gps-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .gps-info h4 {
            color: #1E3A8A;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .gps-data {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 0.9rem;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            line-height: 1.5;
        }
        
        .tutorial {
            background: linear-gradient(135deg, #fff3cd 0%, #fffbf0 100%);
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            font-size: 0.95rem;
        }
        
        .tutorial h4 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .tutorial ol {
            margin-left: 20px;
        }
        
        .tutorial li {
            margin: 8px 0;
        }
        
        .tutorial a {
            color: #4FC3F7;
            text-decoration: none;
            font-weight: 600;
        }
        
        .tutorial a:hover {
            text-decoration: underline;
        }
        
        .features {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        @media (min-width: 768px) {
            .features {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .feature {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .feature:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(79, 195, 247, 0.2);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .feature h4 {
            color: #1E3A8A;
            margin-bottom: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4FC3F7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="assets/images/totofun-logo.png" alt="Totofun Logo" class="logo">
            </div>
            <h1 class="title">Totofun çªçªç¿»</h1>
            <p class="subtitle">åŸºäºGPSçš„å®æ—¶å¯»å®æ¸¸æˆ - æ¢ç´¢èº«è¾¹çš„å®è—</p>
            <div class="hero-stats">
                <div class="stat">
                    <span class="stat-number" id="user-name">æ¸¸å®¢</span>
                    <span class="stat-label">ç©å®¶æ˜µç§°</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="user-level">LV.1</span>
                    <span class="stat-label">å½“å‰ç­‰çº§</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="total-treasures">0</span>
                    <span class="stat-label">å‘ç°å®è—</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="accuracy">0m</span>
                    <span class="stat-label">å®šä½ç²¾åº¦</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸš€ å¿«é€Ÿå¼€å§‹</h3>
            <button class="btn" onclick="initMap()">
                <span id="init-btn-text">ğŸš€ å¯åŠ¨å¯»å®ä¹‹æ—…</span>
            </button>
            
            <!-- é«˜çº§é€‰é¡¹ï¼šåˆ‡æ¢API Key -->
            <details style="margin-top: 15px;">
                <summary style="cursor: pointer; color: #666; font-size: 0.9rem;">ğŸ”§ é«˜çº§é€‰é¡¹</summary>
                <div class="input-group" style="margin-top: 10px;">
                    <label for="api-key">è‡ªå®šä¹‰é«˜å¾·åœ°å›¾API Key:</label>
                    <input type="password" id="api-key" class="api-input" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤Key">
                </div>
            </details>
            
            <div class="tutorial">
                <h4>ğŸ“‹ å¿«é€Ÿå¼€å§‹æŒ‡å—:</h4>
                <ol>
                    <li>ç”³è¯·<a href="https://console.amap.com/" target="_blank">é«˜å¾·åœ°å›¾API Key</a></li>
                    <li>è¾“å…¥API Keyå¹¶ç‚¹å‡»å¯åŠ¨</li>
                    <li>å…è®¸æµè§ˆå™¨è·å–ä½ç½®æƒé™</li>
                    <li>åœ¨æˆ·å¤–ç¯å¢ƒä¸­è·å¾—æœ€ä½³GPSä½“éªŒ</li>
                    <li>å¼€å§‹å¯»æ‰¾é™„è¿‘çš„å®è—ï¼</li>
                </ol>
                
                <h4>ğŸ”§ ç§»åŠ¨ç«¯è°ƒè¯•:</h4>
                <p style="font-size: 0.85rem; color: #666;">
                    â€¢ é•¿æŒ‰GPSä¿¡æ¯åŒºåŸŸæŸ¥çœ‹è¯¦ç»†è°ƒè¯•ä¿¡æ¯<br>
                    â€¢ å¦‚æœå®šä½å¤±è´¥ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ä¸Šæµ·ä½ç½®<br>
                    â€¢ ç¡®ä¿åœ¨HTTPSç¯å¢ƒä¸‹ä½¿ç”¨ï¼ˆGitHub Pagesè‡ªåŠ¨æ”¯æŒï¼‰<br>
                    â€¢ é”®ç›˜å¿«æ·é”®: Ctrl+S åˆ‡æ¢åˆ°ä¸Šæµ·ä½ç½®ï¼ŒCtrl+D æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                </p>
            </div>
            
            <div class="status info" id="status">
                <span>ğŸ”„</span>
                <span>ç­‰å¾…é…ç½®API Keyå¯åŠ¨åœ°å›¾æœåŠ¡...</span>
            </div>
        </div>

        <div class="features">
            <div class="feature">
                <div class="feature-icon">ğŸ“±</div>
                <h4>ç§»åŠ¨ç«¯ä¼˜åŒ–</h4>
                <p>ä¸“ä¸ºæ‰‹æœºç«¯è®¾è®¡ï¼Œæ”¯æŒè§¦æ‘¸æ“ä½œå’Œå“åº”å¼å¸ƒå±€</p>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ¯</div>
                <h4>ç²¾å‡†å®šä½</h4>
                <p>ä½¿ç”¨é«˜ç²¾åº¦GPSå®šä½ï¼Œæ”¯æŒå®¤å¤–ç²¾ç¡®å¯»å®</p>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ†</div>
                <h4>å¤šç§å®è—</h4>
                <p>é’»çŸ³ã€çš‡å† ã€é‡‘å¸ç­‰å¤šç§å®è—ç±»å‹ç­‰ä½ å‘ç°</p>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸŒ</div>
                <h4>å®æ—¶åœ°å›¾</h4>
                <p>åŸºäºé«˜å¾·åœ°å›¾çš„å®æ—¶ä½ç½®æ˜¾ç¤ºå’Œå¯¼èˆª</p>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ GPSçŠ¶æ€ä¿¡æ¯</h3>
            <div class="gps-info">
                <h4>å½“å‰ä½ç½®ä¿¡æ¯:</h4>
                <div class="gps-data" id="gps-data">
                    ç­‰å¾…è·å–GPSæ•°æ®...
                </div>
            </div>
        </div>

        <div class="card">
            <div id="map-container">
                <div class="map-placeholder">
                    <div class="map-placeholder-icon pulse">ğŸ—ºï¸</div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">åœ°å›¾å³å°†åŠ è½½</div>
                        <div style="color: #888;">é…ç½®API Keyåå³å¯æ˜¾ç¤ºé«˜å¾·åœ°å›¾</div>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="testGPS()" disabled id="gps-btn">
                    ğŸ“ é‡æ–°å®šä½
                </button>
                <button class="btn" onclick="centerToUser()" disabled id="center-btn">
                    ğŸ¯ å›åˆ°æˆ‘çš„ä½ç½®
                </button>
                <button class="btn" onclick="generateNearbyTreasures()" disabled id="generate-btn">
                    ğŸ—ºï¸ ç”Ÿæˆå®è—
                </button>
                <button class="btn" onclick="addTreasure()" disabled id="treasure-btn">
                    âœ¨ æ·»åŠ å®è—
                </button>
                <button class="btn" onclick="clearMap()" disabled id="clear-btn">
                    ğŸ—‘ï¸ æ¸…ç©ºåœ°å›¾
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let map = null;
        let userMarker = null;
        let treasureMarkers = [];
        let userLocation = null;
        let watchId = null;

        // ç”¨æˆ·æ•°æ®ç®¡ç†
        let userData = {
            username: '',
            level: {
                currentLevel: 1,
                experience: 0,
                badges: []
            },
            stats: {
                treasuresCreated: 0,
                treasuresDiscovered: 0,
                totalLikes: 0,
                totalViews: 0
            },
            preferences: {
                interests: [],
                explorationRadius: 5000,
                language: 'zh-CN'
            },
            discoveredTreasures: [],
            createdTreasures: [],
            achievements: [],
            lastActiveAt: new Date()
        };

        // æœ¬åœ°å­˜å‚¨ç®¡ç†
        const storageManager = {
            save: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('å­˜å‚¨å¤±è´¥:', error);
                    return false;
                }
            },
            load: (key) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('è¯»å–å¤±è´¥:', error);
                    return null;
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    return false;
                }
            }
        };

        // å®Œæ•´çš„å®è—ç±»å‹ç³»ç»Ÿï¼ˆåŸºäºæ•°æ®æ¨¡å‹ï¼‰
        const treasureTypes = [
            { 
                icon: 'ğŸ’', 
                name: 'é’»çŸ³å®è—', 
                color: '#e74c3c', 
                rarity: 'legendary',
                category: 'æ‘„å½±',
                rewards: { experience: 100, coins: 50 },
                discoveryRadius: 30
            },
            { 
                icon: 'ğŸ‘‘', 
                name: 'çš‡å† å®è—', 
                color: '#9b59b6', 
                rarity: 'epic',
                category: 'å†å²',
                rewards: { experience: 80, coins: 40 },
                discoveryRadius: 35
            },
            { 
                icon: 'ğŸ’°', 
                name: 'é‡‘å¸å®è—', 
                color: '#f1c40f', 
                rarity: 'rare',
                category: 'è´­ç‰©',
                rewards: { experience: 60, coins: 30 },
                discoveryRadius: 40
            },
            { 
                icon: 'ğŸº', 
                name: 'å¤è‘£å®è—', 
                color: '#e67e22', 
                rarity: 'uncommon',
                category: 'è‰ºæœ¯',
                rewards: { experience: 40, coins: 20 },
                discoveryRadius: 45
            },
            { 
                icon: 'ğŸ’', 
                name: 'æˆ’æŒ‡å®è—', 
                color: '#3498db', 
                rarity: 'common',
                category: 'ç¾é£Ÿ',
                rewards: { experience: 20, coins: 10 },
                discoveryRadius: 50
            },
            { 
                icon: 'ğŸ­', 
                name: 'é¢å…·å®è—', 
                color: '#8e44ad', 
                rarity: 'rare',
                category: 'éŸ³ä¹',
                rewards: { experience: 55, coins: 25 },
                discoveryRadius: 40
            },
            { 
                icon: 'âš”ï¸', 
                name: 'ç¥å™¨å®è—', 
                color: '#2c3e50', 
                rarity: 'legendary',
                category: 'è¿åŠ¨',
                rewards: { experience: 120, coins: 60 },
                discoveryRadius: 25
            },
            { 
                icon: 'ğŸ†', 
                name: 'å¥–æ¯å®è—', 
                color: '#f39c12', 
                rarity: 'epic',
                category: 'æ—…æ¸¸',
                rewards: { experience: 90, coins: 45 },
                discoveryRadius: 30
            }
        ];

        // ç”¨æˆ·ç­‰çº§ç³»ç»Ÿ
        const levelSystem = {
            getLevel: (experience) => Math.floor(Math.sqrt(experience / 100)) + 1,
            getExpForLevel: (level) => Math.pow(level - 1, 2) * 100,
            getExpToNext: (currentExp) => {
                const currentLevel = levelSystem.getLevel(currentExp);
                const nextLevelExp = levelSystem.getExpForLevel(currentLevel + 1);
                return nextLevelExp - currentExp;
            }
        };

        // å¾½ç« ç³»ç»Ÿ
        const badgeSystem = [
            { name: 'first_treasure', icon: 'ğŸ¯', title: 'åˆæ¢è€…', description: 'å‘ç°ç¬¬ä¸€ä¸ªå®è—' },
            { name: 'treasure_hunter', icon: 'ğŸƒ', title: 'å¯»å®çŒäºº', description: 'å‘ç°10ä¸ªå®è—' },
            { name: 'treasure_master', icon: 'ğŸ‘‘', title: 'å¯»å®å¤§å¸ˆ', description: 'å‘ç°50ä¸ªå®è—' },
            { name: 'legendary_finder', icon: 'ğŸ’', title: 'ä¼ å¥‡å‘ç°è€…', description: 'å‘ç°ä¼ å¥‡çº§å®è—' },
            { name: 'category_expert', icon: 'ğŸ“', title: 'åˆ†ç±»ä¸“å®¶', description: 'åœ¨æ¯ä¸ªåˆ†ç±»ä¸­éƒ½å‘ç°å®è—' },
            { name: 'speed_runner', icon: 'âš¡', title: 'é—ªç”µä¾ ', description: '1å°æ—¶å†…å‘ç°5ä¸ªå®è—' },
            { name: 'explorer', icon: 'ğŸ—ºï¸', title: 'æ¢é™©å®¶', description: 'æ¢ç´¢è¶…è¿‡5å…¬é‡ŒèŒƒå›´' },
            { name: 'social_star', icon: 'â­', title: 'ç¤¾äº¤ä¹‹æ˜Ÿ', description: 'åˆ›å»ºçš„å®è—è¢«å‘ç°100æ¬¡' }
        ];

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info', showLoading = false) {
            const status = document.getElementById('status');
            const iconMap = {
                info: 'ğŸ”„',
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸'
            };
            
            const icon = showLoading ? '<span class="loading"></span>' : iconMap[type];
            status.innerHTML = `${icon}<span>${message}</span>`;
            status.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ›´æ–°GPSæ•°æ®æ˜¾ç¤º
        function updateGPSData(data) {
            const gpsData = document.getElementById('gps-data');
            gpsData.innerHTML = data;
        }

        // å®è—ç®¡ç†ç³»ç»Ÿ
        const treasureManager = {
            // åˆ›å»ºå®è—æ•°æ®
            createTreasure: (position, type, creator = 'system') => {
                const treasure = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    title: type.name,
                    description: `ä¸€ä¸ªçè´µçš„${type.name}ï¼Œç­‰å¾…ç€å‹‡æ•¢çš„æ¢é™©è€…æ¥å‘ç°ï¼`,
                    creator: creator,
                    location: {
                        coordinates: position,
                        discoveryRadius: type.discoveryRadius
                    },
                    category: type.category,
                    rewards: type.rewards,
                    rarity: type.rarity,
                    icon: type.icon,
                    color: type.color,
                    stats: {
                        views: 0,
                        likes: 0,
                        discoveries: 0
                    },
                    createdAt: new Date(),
                    status: 'active'
                };
                return treasure;
            },

            // å‘ç°å®è—
            discoverTreasure: (treasureId, userPosition) => {
                const treasureIndex = userData.createdTreasures.findIndex(t => t.id === treasureId);
                if (treasureIndex === -1) return { success: false, reason: 'treasure_not_found' };

                const treasure = userData.createdTreasures[treasureIndex];
                const distance = calculateDistance(userPosition, treasure.location.coordinates);

                if (distance > treasure.location.discoveryRadius) {
                    return { 
                        success: false, 
                        reason: 'too_far',
                        distance: distance,
                        requiredDistance: treasure.location.discoveryRadius
                    };
                }

                // æ£€æŸ¥æ˜¯å¦å·²ç»å‘ç°è¿‡
                if (userData.discoveredTreasures.includes(treasureId)) {
                    return { success: false, reason: 'already_discovered' };
                }

                // è®°å½•å‘ç°
                userData.discoveredTreasures.push(treasureId);
                userData.stats.treasuresDiscovered += 1;
                treasure.stats.discoveries += 1;

                // å¥–åŠ±ç»éªŒå’Œé‡‘å¸
                const reward = userManager.addExperience(treasure.rewards.experience);
                userManager.addCoins(treasure.rewards.coins);

                // æ£€æŸ¥æˆå°±
                achievementManager.checkAchievements();

                // ä¿å­˜æ•°æ®
                saveUserData();

                return {
                    success: true,
                    treasure: treasure,
                    rewards: treasure.rewards,
                    levelUp: reward.levelUp
                };
            }
        };

        // ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
        const userManager = {
            // æ·»åŠ ç»éªŒå€¼
            addExperience: (points) => {
                const oldLevel = userData.level.currentLevel;
                userData.level.experience += points;
                
                const newLevel = levelSystem.getLevel(userData.level.experience);
                if (newLevel > oldLevel) {
                    userData.level.currentLevel = newLevel;
                    
                    // ç­‰çº§æå‡å¥–åŠ±
                    const reward = {
                        coins: newLevel * 10,
                        badge: newLevel % 10 === 0 ? `level_${newLevel}` : null
                    };

                    if (reward.badge) {
                        userManager.addBadge(reward.badge, 'ğŸ†', `è¾¾åˆ°ç¬¬${newLevel}çº§`);
                    }

                    return {
                        levelUp: true,
                        oldLevel: oldLevel,
                        newLevel: newLevel,
                        reward: reward
                    };
                }
                
                return { levelUp: false };
            },

            // æ·»åŠ å¾½ç« 
            addBadge: (badgeName, icon, description) => {
                const existingBadge = userData.level.badges.find(badge => badge.name === badgeName);
                if (!existingBadge) {
                    userData.level.badges.push({
                        name: badgeName,
                        icon: icon,
                        description: description,
                        unlockedAt: new Date()
                    });
                    return true;
                }
                return false;
            },

            // æ·»åŠ é‡‘å¸ï¼ˆè™šæ‹Ÿè´§å¸ï¼‰
            addCoins: (amount) => {
                if (!userData.coins) userData.coins = 0;
                userData.coins += amount;
            },

            // è·å–ç”¨æˆ·ç­‰çº§ä¿¡æ¯
            getLevelInfo: () => {
                const currentExp = userData.level.experience;
                const currentLevel = userData.level.currentLevel;
                const expForCurrentLevel = levelSystem.getExpForLevel(currentLevel);
                const expForNextLevel = levelSystem.getExpForLevel(currentLevel + 1);
                const expToNext = expForNextLevel - currentExp;
                const progress = ((currentExp - expForCurrentLevel) / (expForNextLevel - expForCurrentLevel)) * 100;

                return {
                    currentLevel,
                    currentExp,
                    expToNext,
                    progress: Math.max(0, Math.min(100, progress))
                };
            }
        };

        // æˆå°±ç³»ç»Ÿ
        const achievementManager = {
            checkAchievements: () => {
                const achievements = [];

                // ç¬¬ä¸€ä¸ªå®è—
                if (userData.stats.treasuresDiscovered === 1) {
                    achievements.push(userManager.addBadge('first_treasure', 'ğŸ¯', 'å‘ç°ç¬¬ä¸€ä¸ªå®è—'));
                }

                // å¯»å®çŒäºº
                if (userData.stats.treasuresDiscovered === 10) {
                    achievements.push(userManager.addBadge('treasure_hunter', 'ğŸƒ', 'å‘ç°10ä¸ªå®è—'));
                }

                // å¯»å®å¤§å¸ˆ
                if (userData.stats.treasuresDiscovered === 50) {
                    achievements.push(userManager.addBadge('treasure_master', 'ğŸ‘‘', 'å‘ç°50ä¸ªå®è—'));
                }

                // ä¼ å¥‡å‘ç°è€…ï¼ˆå‘ç°ä¼ å¥‡çº§å®è—ï¼‰
                const legendaryFound = userData.createdTreasures.some(t => 
                    userData.discoveredTreasures.includes(t.id) && t.rarity === 'legendary'
                );
                if (legendaryFound) {
                    achievements.push(userManager.addBadge('legendary_finder', 'ğŸ’', 'å‘ç°ä¼ å¥‡çº§å®è—'));
                }

                return achievements.filter(Boolean);
            }
        };

        // è·ç¦»è®¡ç®—å·¥å…·
        function calculateDistance(pos1, pos2) {
            const R = 6371000; // åœ°çƒåŠå¾„(ç±³)
            const lat1 = pos1[1] * Math.PI / 180;
            const lat2 = pos2[1] * Math.PI / 180;
            const deltaLat = (pos2[1] - pos1[1]) * Math.PI / 180;
            const deltaLng = (pos2[0] - pos1[0]) * Math.PI / 180;

            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // ä¿å­˜å’ŒåŠ è½½ç”¨æˆ·æ•°æ®
        function saveUserData() {
            userData.lastActiveAt = new Date();
            storageManager.save('totofun-treasure-user', userData);
        }

        function loadUserData() {
            const saved = storageManager.load('totofun-treasure-user');
            if (saved) {
                userData = { ...userData, ...saved };
                // ç¡®ä¿æ—¥æœŸå­—æ®µæ­£ç¡®è§£æ
                if (saved.lastActiveAt) {
                    userData.lastActiveAt = new Date(saved.lastActiveAt);
                }
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
        function updateStats(accuracy = 0) {
            document.getElementById('total-treasures').textContent = userData.stats.treasuresDiscovered || 0;
            document.getElementById('accuracy').textContent = `${Math.round(accuracy)}m`;
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            if (document.getElementById('user-name')) {
                document.getElementById('user-name').textContent = userData.username || 'æ¸¸å®¢';
            }
            if (document.getElementById('user-level')) {
                document.getElementById('user-level').textContent = `LV.${userData.level.currentLevel}`;
            }
        }

        // é»˜è®¤API Keyï¼ˆä½ çš„é«˜å¾·åœ°å›¾Keyï¼‰
        const DEFAULT_AMAP_KEY = 'ä½ çš„é«˜å¾·åœ°å›¾API_Key'; // TODO: æ›¿æ¢æˆä½ çš„å®é™…Key
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            let apiKey = document.getElementById('api-key').value.trim();
            
            // å¦‚æœç”¨æˆ·æ²¡æœ‰è¾“å…¥ï¼Œä½¿ç”¨é»˜è®¤Key
            if (!apiKey) {
                apiKey = localStorage.getItem('amap-api-key') || DEFAULT_AMAP_KEY;
            }
            
            if (!apiKey || apiKey === 'ä½ çš„é«˜å¾·åœ°å›¾API_Key') {
                updateStatus('è¯·å…ˆé…ç½®é«˜å¾·åœ°å›¾API Keyï¼å±•å¼€"é«˜çº§é€‰é¡¹"è¾“å…¥ä½ çš„Key', 'error');
                return;
            }

            updateStatus('æ­£åœ¨åŠ è½½é«˜å¾·åœ°å›¾...', 'info', true);
            localStorage.setItem('amap-api-key', apiKey);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const initBtn = document.getElementById('init-btn-text');
            initBtn.innerHTML = '<span class="loading"></span> æ­£åœ¨åŠ è½½...';

            // åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾APIï¼ˆåŒ…å«åæ ‡è½¬æ¢æ’ä»¶ï¼‰
            const script = document.createElement('script');
            script.src = `https://webapi.amap.com/maps?v=2.0&key=${apiKey}`;
            script.onload = function() {
                console.log('é«˜å¾·åœ°å›¾APIåŠ è½½æˆåŠŸ');
                createMap();
            };
            script.onerror = function() {
                console.error('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥');
                updateStatus('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥Keyæ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œè¿æ¥', 'error');
                document.getElementById('init-btn-text').innerHTML = 'ğŸš€ é‡æ–°å¯åŠ¨';
            };
            document.head.appendChild(script);
        }

        // åˆ›å»ºåœ°å›¾å®ä¾‹ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
        function createMap() {
            try {
                console.log('å¼€å§‹åˆ›å»ºåœ°å›¾å®ä¾‹...');
                updateStatus('æ­£åœ¨åˆ›å»ºåœ°å›¾å®ä¾‹...', 'info', true);
                
                // æ£€æŸ¥AMapæ˜¯å¦å¯ç”¨
                if (typeof AMap === 'undefined') {
                    throw new Error('AMapå¯¹è±¡æœªå®šä¹‰ï¼Œåœ°å›¾APIå¯èƒ½æœªæ­£ç¡®åŠ è½½');
                }
                
                map = new AMap.Map('map-container', {
                    zoom: 15,
                    center: [121.4737, 31.2304], // é»˜è®¤ä¸Šæµ·åæ ‡
                    viewMode: '2D',
                    showLabel: true,
                    mapStyle: 'amap://styles/normal',
                    resizeEnable: true,
                    rotateEnable: false,
                    pitchEnable: false,
                    dragEnable: true,
                    zoomEnable: true,
                    doubleClickZoom: true
                });

                console.log('åœ°å›¾å®ä¾‹åˆ›å»ºæˆåŠŸï¼Œç­‰å¾…åŠ è½½å®Œæˆ...');

                // åœ°å›¾åŠ è½½å®Œæˆäº‹ä»¶
                map.on('complete', function() {
                    console.log('åœ°å›¾åŠ è½½å®Œæˆ');
                    updateStatus('åœ°å›¾åŠ è½½æˆåŠŸï¼æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...', 'success');
                    
                    // é‡ç½®æŒ‰é’®
                    document.getElementById('init-btn-text').innerHTML = 'âœ… åœ°å›¾å·²å¯åŠ¨';
                    
                    // å¯ç”¨æ§åˆ¶æŒ‰é’®
                    document.querySelectorAll('.btn').forEach(btn => {
                        if (!btn.onclick || btn.onclick.toString().includes('initMap')) {
                            return;
                        }
                        btn.disabled = false;
                    });

                    // è‡ªåŠ¨è·å–ä½ç½®
                    setTimeout(() => {
                        console.log('å¼€å§‹è‡ªåŠ¨è·å–GPSä½ç½®...');
                        testGPS();
                    }, 1000);
                });

                // åœ°å›¾ç‚¹å‡»äº‹ä»¶ - æ·»åŠ å®è—
                map.on('click', function(e) {
                    console.log('åœ°å›¾ç‚¹å‡»äº‹ä»¶:', e.lnglat);
                    if (userLocation && confirm('åœ¨æ­¤ä½ç½®æ·»åŠ å®è—ï¼Ÿ')) {
                        addTreasureAtPosition([e.lnglat.lng, e.lnglat.lat]);
                    }
                });
                
                // åœ°å›¾ç§»åŠ¨äº‹ä»¶ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                map.on('moveend', function() {
                    const center = map.getCenter();
                    console.log('åœ°å›¾ä¸­å¿ƒ:', center.lng, center.lat, 'ç¼©æ”¾çº§åˆ«:', map.getZoom());
                });

            } catch (error) {
                console.error('åœ°å›¾åˆ›å»ºå¤±è´¥:', error);
                updateStatus('åœ°å›¾åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                document.getElementById('init-btn-text').innerHTML = 'ğŸš€ é‡æ–°å¯åŠ¨';
            }
        }

        // æµ‹è¯•GPSå®šä½ï¼ˆæ”¹è¿›ç‰ˆæœ¬ - é’ˆå¯¹PCå’Œæ‰‹æœºä¼˜åŒ–ï¼‰
        function testGPS() {
            if (!map) {
                updateStatus('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼', 'warning');
                return;
            }

            updateStatus('æ­£åœ¨è·å–GPSä½ç½®...', 'info', true);
            updateGPSData('<div class="loading"></div> æ­£åœ¨å®šä½...');

            // æ£€æµ‹è®¾å¤‡ç±»å‹
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            console.log('è®¾å¤‡ç±»å‹:', isMobile ? 'ç§»åŠ¨è®¾å¤‡' : 'PCè®¾å¤‡');

            if (!navigator.geolocation) {
                updateStatus('æµè§ˆå™¨ä¸æ”¯æŒGPSå®šä½åŠŸèƒ½', 'error');
                handleLocationError({ code: 0, message: 'ä¸æ”¯æŒå®šä½' });
                return;
            }

            // PCç«¯ä½¿ç”¨IPå®šä½ä½œä¸ºå¤‡é€‰
            if (!isMobile) {
                console.log('PCç«¯æ£€æµ‹åˆ°ï¼Œå°†ä½¿ç”¨IPå®šä½ + é«˜å¾·å®šä½æœåŠ¡');
                useAmapGeolocation();
                return;
            }

            // ç§»åŠ¨ç«¯ä½¿ç”¨GPSå®šä½
            console.log('ç§»åŠ¨ç«¯æ£€æµ‹åˆ°ï¼Œä½¿ç”¨GPSå®šä½');
            navigator.geolocation.getCurrentPosition(
                handleLocationSuccess,
                (error) => {
                    console.log('é«˜ç²¾åº¦å®šä½å¤±è´¥ï¼Œå°è¯•æ™®é€šç²¾åº¦...');
                    navigator.geolocation.getCurrentPosition(
                        handleLocationSuccess,
                        (error2) => {
                            console.log('GPSå®šä½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨é«˜å¾·å®šä½æœåŠ¡');
                            useAmapGeolocation();
                        },
                        {
                            enableHighAccuracy: false,
                            timeout: 15000,
                            maximumAge: 30000
                        }
                    );
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // ä½¿ç”¨é«˜å¾·å®šä½æœåŠ¡ï¼ˆåŸºäºIPï¼Œé€‚åˆPCç«¯ï¼‰
        function useAmapGeolocation() {
            console.log('ä½¿ç”¨é«˜å¾·å®šä½æœåŠ¡...');
            updateStatus('æ­£åœ¨ä½¿ç”¨ç½‘ç»œå®šä½...', 'info', true);
            
            AMap.plugin('AMap.Geolocation', function() {
                const geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    zoomToAccuracy: true,
                    buttonPosition: 'RB'
                });
                
                geolocation.getCurrentPosition(function(status, result) {
                    console.log('é«˜å¾·å®šä½ç»“æœ:', status, result);
                    if (status === 'complete') {
                        const position = {
                            coords: {
                                latitude: result.position.lat,
                                longitude: result.position.lng,
                                accuracy: result.accuracy || 100
                            },
                            timestamp: Date.now()
                        };
                        // é«˜å¾·è¿”å›çš„å·²ç»æ˜¯GCJ-02åæ ‡ï¼Œç›´æ¥ä½¿ç”¨
                        handleAmapLocationSuccess(position);
                    } else {
                        console.log('é«˜å¾·å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®');
                        handleLocationError({ code: 2, message: 'ç½‘ç»œå®šä½å¤±è´¥' });
                    }
                });
            });
        }

        // å¤„ç†é«˜å¾·å®šä½æˆåŠŸï¼ˆæ— éœ€åæ ‡è½¬æ¢ï¼‰
        function handleAmapLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy || 100;
            const timestamp = new Date(position.timestamp).toLocaleString();
            
            console.log('âœ… é«˜å¾·å®šä½æˆåŠŸ (GCJ-02):', { lat, lng, accuracy });
            console.log('ğŸ“ å‡†ç¡®åæ ‡ [ç»åº¦, çº¬åº¦]:', [lng, lat]);
            
            userLocation = [lng, lat];
            
            // ç«‹å³è®¾ç½®åœ°å›¾ä¸­å¿ƒå’Œç¼©æ”¾ï¼ˆåœ¨åˆ›å»ºæ ‡è®°ä¹‹å‰ï¼‰
            console.log('ğŸ—ºï¸ å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒ...');
            map.setZoomAndCenter(17, userLocation);
            
            updateStatus(`å®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³ (ç½‘ç»œå®šä½)`, 'success');
            updateGPSData(`
                <strong>ğŸ“ ä½ç½®ä¿¡æ¯</strong><br>
                å®šä½æ–¹å¼: é«˜å¾·ç½‘ç»œå®šä½<br>
                çº¬åº¦: ${lat.toFixed(6)}<br>
                ç»åº¦: ${lng.toFixed(6)}<br>
                ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 200 ? 'âœ…' : 'âš ï¸'}<br>
                æ—¶é—´: ${timestamp}<br>
                <small style="color: #666;">
                    åæ ‡ç³»: GCJ-02 (é«˜å¾·åœ°å›¾)<br>
                    ğŸ’¡ PCç«¯å»ºè®®ä½¿ç”¨æ‰‹æœºè®¿é—®è·å¾—æ›´ç²¾ç¡®çš„GPSå®šä½
                </small>
            `);
            
            updateStats(accuracy);
            
            // å»¶è¿Ÿåˆ›å»ºæ ‡è®°ï¼Œç¡®ä¿åœ°å›¾å·²ç»ç§»åŠ¨åˆ°ä½
            setTimeout(() => {
                console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                createUserMarker();
            }, 300);
            
            setTimeout(() => {
                if (treasureMarkers.length === 0) {
                    console.log('ğŸ å¼€å§‹ç”Ÿæˆå®è—...');
                    generateNearbyTreasures();
                }
            }, 800);
        }


        // å¤„ç†å®šä½æˆåŠŸï¼ˆæ”¹è¿›ç‰ˆæœ¬ - æ·»åŠ åæ ‡è½¬æ¢ï¼‰
        function handleLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy || 0;
            const timestamp = new Date(position.timestamp).toLocaleString();
            
            console.log('âœ… åŸå§‹GPSåæ ‡ (WGS84):', { lat, lng, accuracy });
            console.log('ğŸ”„ å¼€å§‹åæ ‡è½¬æ¢...');
            
            // æ£€æŸ¥AMap.convertFromæ˜¯å¦å¯ç”¨
            if (typeof AMap === 'undefined' || !AMap.convertFrom) {
                console.warn('âš ï¸ AMap.convertFrom ä¸å¯ç”¨ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹åæ ‡');
                useRawCoordinates(lat, lng, accuracy, timestamp);
                return;
            }
            
            // ä½¿ç”¨é«˜å¾·åœ°å›¾çš„åæ ‡è½¬æ¢åŠŸèƒ½å°†WGS84è½¬æ¢ä¸ºGCJ-02
            try {
                AMap.convertFrom([lng, lat], 'gps', function(status, result) {
                    console.log('åæ ‡è½¬æ¢çŠ¶æ€:', status);
                    console.log('åæ ‡è½¬æ¢ç»“æœ:', result);
                    
                    if (result.info === 'ok' && result.locations && result.locations.length > 0) {
                        const convertedLocation = result.locations[0];
                        userLocation = [convertedLocation.lng, convertedLocation.lat];
                        
                        console.log('âœ… è½¬æ¢ååæ ‡ (GCJ-02):', userLocation);
                        console.log('ğŸ“ åç§»è·ç¦»:', calculateDistance([lng, lat], userLocation).toFixed(2), 'ç±³');
                        
                        updateStatus(`GPSå®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³ (åæ ‡å·²è½¬æ¢)`, 'success');
                        updateGPSData(`
                            <strong>ğŸ“ ä½ç½®ä¿¡æ¯</strong><br>
                            åŸå§‹ä½ç½® (WGS84):<br>
                            çº¬åº¦: ${lat.toFixed(6)}<br>
                            ç»åº¦: ${lng.toFixed(6)}<br>
                            <br>
                            è½¬æ¢åä½ç½® (GCJ-02):<br>
                            çº¬åº¦: ${convertedLocation.lat.toFixed(6)} ${convertedLocation.lat > 30 && convertedLocation.lat < 32 ? 'âœ…' : 'â“'}<br>
                            ç»åº¦: ${convertedLocation.lng.toFixed(6)} ${convertedLocation.lng > 120 && convertedLocation.lng < 122 ? 'âœ…' : 'â“'}<br>
                            <br>
                            ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 100 ? 'âœ…' : accuracy < 500 ? 'âš ï¸' : 'âŒ'}<br>
                            æ—¶é—´: ${timestamp}<br>
                            <small style="color: #666;">
                                åæ ‡ç³»: WGS84 â†’ GCJ-02 (é«˜å¾·)<br>
                                ${convertedLocation.lat > 30 && convertedLocation.lat < 32 && convertedLocation.lng > 120 && convertedLocation.lng < 122 ? 'ğŸ¯ ä¸Šæµ·åœ°åŒºå®šä½æˆåŠŸ' : 'ğŸŒ éä¸Šæµ·åœ°åŒº'}
                            </small>
                        `);
                        
                        updateStats(accuracy);
                        
                        // å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒå’Œç¼©æ”¾
                        console.log('ğŸ—ºï¸ å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒ...');
                        map.setZoomAndCenter(17, userLocation);
                        
                        // å»¶è¿Ÿåˆ›å»ºæ ‡è®°
                        setTimeout(() => {
                            console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                            createUserMarker();
                        }, 300);
                        
                        // ç«‹å³ç”Ÿæˆå®è—
                        setTimeout(() => {
                            if (treasureMarkers.length === 0) {
                                console.log('ğŸ å¼€å§‹ç”Ÿæˆå®è—...');
                                generateNearbyTreasures();
                            }
                        }, 800);
                    } else {
                        // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹åæ ‡ï¼ˆå¯èƒ½ä¼šæœ‰åç§»ï¼‰
                        console.warn('âš ï¸ åæ ‡è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹åæ ‡');
                        useRawCoordinates(lat, lng, accuracy, timestamp);
                    }
                });
            } catch (error) {
                console.error('âŒ åæ ‡è½¬æ¢å¼‚å¸¸:', error);
                useRawCoordinates(lat, lng, accuracy, timestamp);
            }
        }

        // ä½¿ç”¨åŸå§‹åæ ‡çš„è¾…åŠ©å‡½æ•°
        function useRawCoordinates(lat, lng, accuracy, timestamp) {
            userLocation = [lng, lat];
            
            console.log('ğŸ“ ä½¿ç”¨åŸå§‹åæ ‡ (WGS84):', userLocation);
            
            updateStatus(`GPSå®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³ (æœªè½¬æ¢åæ ‡ï¼Œå¯èƒ½æœ‰åç§»)`, 'warning');
            updateGPSData(`
                <strong>ğŸ“ ä½ç½®ä¿¡æ¯</strong><br>
                çº¬åº¦: ${lat.toFixed(6)} ${lat > 30 && lat < 32 ? 'âœ…' : 'â“'}<br>
                ç»åº¦: ${lng.toFixed(6)} ${lng > 120 && lng < 122 ? 'âœ…' : 'â“'}<br>
                ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 100 ? 'âœ…' : accuracy < 500 ? 'âš ï¸' : 'âŒ'}<br>
                æ—¶é—´: ${timestamp}<br>
                <small style="color: #666;">
                    åæ ‡ç³»: WGS84 (æœªè½¬æ¢)<br>
                    âš ï¸ åæ ‡è½¬æ¢å¤±è´¥ï¼Œä½ç½®å¯èƒ½æœ‰åç§» 50-500ç±³<br>
                    ${lat > 30 && lat < 32 && lng > 120 && lng < 122 ? 'ğŸ¯ ä¸Šæµ·åœ°åŒºå®šä½æˆåŠŸ' : 'ğŸŒ éä¸Šæµ·åœ°åŒº'}
                </small>
            `);
            
            updateStats(accuracy);
            
            // å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒå’Œç¼©æ”¾
            console.log('ğŸ—ºï¸ å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒ...');
            map.setZoomAndCenter(17, userLocation);
            
            // å»¶è¿Ÿåˆ›å»ºæ ‡è®°
            setTimeout(() => {
                console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                createUserMarker();
            }, 300);
            
            setTimeout(() => {
                if (treasureMarkers.length === 0) {
                    console.log('ğŸ å¼€å§‹ç”Ÿæˆå®è—...');
                    generateNearbyTreasures();
                }
            }, 800);
        }

        // å¤„ç†å®šä½é”™è¯¯
        function handleLocationError(error) {
            let errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'ç”¨æˆ·æ‹’ç»äº†ä½ç½®æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ä½ç½®è®¿é—®';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥GPSæ˜¯å¦å¼€å¯';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'å®šä½è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•';
                    break;
                default:
                    errorMsg = 'æœªçŸ¥å®šä½é”™è¯¯ï¼Œè¯·é‡è¯•';
                    break;
            }
            
            updateStatus(`GPSå®šä½å¤±è´¥: ${errorMsg}`, 'error');
            updateGPSData(`
                <strong>âŒ å®šä½å¤±è´¥</strong><br>
                é”™è¯¯: ${errorMsg}<br>
                <small style="color: #666;">
                    å»ºè®®:<br>
                    â€¢ åœ¨æˆ·å¤–é‡è¯•<br>
                    â€¢ æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®<br>
                    â€¢ ç¡®ä¿GPSåŠŸèƒ½å·²å¼€å¯
                </small>
            `);
            
            // ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·å¤–æ»©ï¼‰
            userLocation = [121.4737, 31.2304];
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            updateStatus('GPSå®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·å¤–æ»©ï¼‰ã€‚å»ºè®®åœ¨æˆ·å¤–é‡æ–°å°è¯•å®šä½ã€‚', 'warning');
            
            // å³ä½¿æ˜¯é»˜è®¤ä½ç½®ä¹Ÿç”Ÿæˆå®è—
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1000);
        }

        // åˆ›å»ºç”¨æˆ·ä½ç½®æ ‡è®°ï¼ˆæ”¹è¿›ç‰ˆæœ¬ - æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼‰
        function createUserMarker() {
            console.log('========== å¼€å§‹åˆ›å»ºç”¨æˆ·æ ‡è®° ==========');
            console.log('å½“å‰åœ°å›¾å¯¹è±¡:', map ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–');
            console.log('å½“å‰ç”¨æˆ·ä½ç½®:', userLocation);
            
            if (!map) {
                console.error('âŒ åœ°å›¾æœªåˆå§‹åŒ–');
                updateStatus('åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ›å»ºæ ‡è®°', 'error');
                return false;
            }
            
            if (!userLocation || !Array.isArray(userLocation) || userLocation.length !== 2) {
                console.error('âŒ ç”¨æˆ·ä½ç½®æ— æ•ˆ:', userLocation);
                updateStatus('ç”¨æˆ·ä½ç½®æ— æ•ˆï¼Œæ— æ³•åˆ›å»ºæ ‡è®°', 'error');
                return false;
            }

            console.log('ğŸ“ å‡†å¤‡åˆ›å»ºæ ‡è®°ï¼Œä½ç½®:', userLocation);
            console.log('ç»åº¦:', userLocation[0], 'çº¬åº¦:', userLocation[1]);

            // ç§»é™¤æ—§æ ‡è®°
            if (userMarker) {
                console.log('ğŸ—‘ï¸ ç§»é™¤æ—§çš„ç”¨æˆ·æ ‡è®°');
                try {
                    map.remove(userMarker);
                    userMarker = null;
                    console.log('âœ… æ—§æ ‡è®°å·²ç§»é™¤');
                } catch (error) {
                    console.error('âŒ ç§»é™¤æ—§æ ‡è®°å¤±è´¥:', error);
                }
            }

            try {
                console.log('ğŸ¨ åˆ›å»ºæ ‡è®°å›¾æ ‡...');
                // ä½¿ç”¨ç®€å•çš„SVGï¼Œä¸åŒ…å«emojiï¼ˆé¿å…btoaç¼–ç é”™è¯¯ï¼‰
                const svgIcon = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60">
                        <defs>
                            <radialGradient id="glow" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#4CAF50;stop-opacity:0.3" />
                            </radialGradient>
                        </defs>
                        <circle cx="30" cy="30" r="25" fill="url(#glow)" opacity="0.6"/>
                        <circle cx="30" cy="30" r="18" fill="#4CAF50" stroke="white" stroke-width="4"/>
                        <circle cx="30" cy="30" r="12" fill="#81C784"/>
                        <circle cx="30" cy="30" r="6" fill="white"/>
                        <path d="M 30 10 L 28 20 L 32 20 Z" fill="white" opacity="0.8"/>
                    </svg>
                `;
                
                console.log('ğŸ“Œ åˆ›å»ºMarkerå¯¹è±¡...');
                // ä½¿ç”¨encodeURIComponentä»£æ›¿btoaï¼Œé¿å…Unicodeé—®é¢˜
                const encodedSvg = encodeURIComponent(svgIcon);
                
                userMarker = new AMap.Marker({
                    position: new AMap.LngLat(userLocation[0], userLocation[1]),
                    icon: new AMap.Icon({
                        image: 'data:image/svg+xml;charset=utf-8,' + encodedSvg,
                        size: new AMap.Size(60, 60),
                        imageSize: new AMap.Size(60, 60),
                        imageOffset: new AMap.Pixel(0, 0)
                    }),
                    title: `æˆ‘çš„ä½ç½®\nç»åº¦: ${userLocation[0].toFixed(6)}\nçº¬åº¦: ${userLocation[1].toFixed(6)}`,
                    zIndex: 1000,
                    offset: new AMap.Pixel(-30, -30),
                    animation: 'AMAP_ANIMATION_BOUNCE',
                    clickable: true
                });

                console.log('âœ… Markerå¯¹è±¡åˆ›å»ºæˆåŠŸ');
                console.log('â• æ·»åŠ æ ‡è®°åˆ°åœ°å›¾...');
                
                map.add(userMarker);
                
                console.log('âœ… æ ‡è®°å·²æ·»åŠ åˆ°åœ°å›¾');
                console.log('ğŸ“Š å½“å‰åœ°å›¾ä¸Šçš„æ ‡è®°æ•°:', map.getAllOverlays('marker').length);
                
                // éªŒè¯æ ‡è®°æ˜¯å¦æ­£ç¡®æ·»åŠ 
                const allMarkers = map.getAllOverlays('marker');
                console.log('åœ°å›¾ä¸Šçš„æ‰€æœ‰æ ‡è®°:', allMarkers);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                userMarker.on('click', function() {
                    console.log('ğŸ‘† ç”¨æˆ·æ ‡è®°è¢«ç‚¹å‡»');
                    const infoWindow = new AMap.InfoWindow({
                        content: `
                            <div style="padding: 10px; text-align: center;">
                                <div style="font-size: 1.5rem; margin-bottom: 5px;">ğŸ“ æˆ‘çš„ä½ç½®</div>
                                <div style="color: #666; font-size: 0.9rem;">ç»åº¦: ${userLocation[0].toFixed(6)}</div>
                                <div style="color: #666; font-size: 0.9rem;">çº¬åº¦: ${userLocation[1].toFixed(6)}</div>
                            </div>
                        `,
                        anchor: 'bottom-center',
                        offset: new AMap.Pixel(0, -5)
                    });
                    infoWindow.open(map, userLocation);
                });
                
                console.log('========== ç”¨æˆ·æ ‡è®°åˆ›å»ºå®Œæˆ âœ… ==========');
                return true;
                
            } catch (error) {
                console.error('âŒ åˆ›å»ºç”¨æˆ·æ ‡è®°å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                updateStatus('åˆ›å»ºç”¨æˆ·æ ‡è®°å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // ç”Ÿæˆå‘¨å›´çš„å®è—
        function generateNearbyTreasures() {
            if (!map || !userLocation) {
                updateStatus('è¯·å…ˆè·å–GPSä½ç½®ï¼', 'warning');
                return;
            }

            // æ¸…ç©ºç°æœ‰å®è—
            if (treasureMarkers.length > 0) {
                clearMap();
            }

            updateStatus('æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆå‘¨å›´çš„å®è—...', 'info', true);

            // ç”Ÿæˆ3-5ä¸ªå®è—
            const treasureCount = Math.floor(Math.random() * 3) + 3;
            
            for (let i = 0; i < treasureCount; i++) {
                setTimeout(() => {
                    const treasureType = getRandomTreasureByRarity();
                    
                    // åœ¨ç”¨æˆ·ä½ç½®å‘¨å›´ç”Ÿæˆ
                    const angle = Math.random() * 2 * Math.PI;
                    const distance = Math.random() * 0.003 + 0.001; // çº¦100-400ç±³
                    
                    const offsetLng = Math.cos(angle) * distance;
                    const offsetLat = Math.sin(angle) * distance;
                    const position = [userLocation[0] + offsetLng, userLocation[1] + offsetLat];

                    addTreasureAtPosition(position, treasureType);
                    
                    if (i === treasureCount - 1) {
                        updateStatus(`ğŸ—ºï¸ å·²ç”Ÿæˆ${treasureCount}ä¸ªå®è—ï¼å¼€å§‹å¯»å®å§ï¼`, 'success');
                    }
                }, i * 200);
            }
        }

        // æ ¹æ®ç¨€æœ‰åº¦éšæœºé€‰æ‹©å®è—ç±»å‹
        function getRandomTreasureByRarity() {
            const rarityWeights = {
                'common': 40,
                'uncommon': 30,
                'rare': 20,
                'epic': 8,
                'legendary': 2
            };

            // åˆ›å»ºåŠ æƒæ•°ç»„
            let weightedArray = [];
            treasureTypes.forEach(type => {
                const weight = rarityWeights[type.rarity] || 10;
                for (let i = 0; i < weight; i++) {
                    weightedArray.push(type);
                }
            });

            return weightedArray[Math.floor(Math.random() * weightedArray.length)];
        }

        // æ‰‹åŠ¨æ·»åŠ å•ä¸ªå®è—
        function addTreasure() {
            if (!map || !userLocation) {
                updateStatus('è¯·å…ˆè·å–GPSä½ç½®ï¼', 'warning');
                return;
            }

            const treasureType = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
            
            // åœ¨ç”¨æˆ·ä½ç½®é™„è¿‘éšæœºç”Ÿæˆå®è—
            const offsetLng = (Math.random() - 0.5) * 0.008; // çº¦400ç±³èŒƒå›´
            const offsetLat = (Math.random() - 0.5) * 0.008;
            const position = [userLocation[0] + offsetLng, userLocation[1] + offsetLat];

            addTreasureAtPosition(position, treasureType);
        }

        // åœ¨æŒ‡å®šä½ç½®æ·»åŠ å®è—
        function addTreasureAtPosition(position, treasureType = null) {
            if (!map || !position) return;

            if (!treasureType) {
                treasureType = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
            }

            // åˆ›å»ºå®è—æ•°æ®
            const treasureData = treasureManager.createTreasure(position, treasureType, 'player');
            userData.createdTreasures.push(treasureData);
            userData.stats.treasuresCreated += 1;

            // åˆ›å»ºåœ°å›¾æ ‡è®°ï¼ˆä½¿ç”¨ç®€å•å›¾å½¢ä»£æ›¿emojiï¼‰
            const treasureSvg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50">
                    <defs>
                        <radialGradient id="glow-${treasureType.name}" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:${treasureType.color};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:${treasureType.color};stop-opacity:0.2" />
                        </radialGradient>
                    </defs>
                    <circle cx="25" cy="25" r="22" fill="url(#glow-${treasureType.name})" opacity="0.6"/>
                    <circle cx="25" cy="25" r="18" fill="${treasureType.color}" stroke="white" stroke-width="3"/>
                    <circle cx="25" cy="25" r="12" fill="${treasureType.color}" opacity="0.8"/>
                    <circle cx="25" cy="25" r="6" fill="white" opacity="0.9"/>
                    <text x="25" y="30" text-anchor="middle" fill="white" font-size="20" font-weight="bold">?</text>
                </svg>
            `;
            const encodedTreasureSvg = encodeURIComponent(treasureSvg);
            
            const treasureMarker = new AMap.Marker({
                position: position,
                icon: new AMap.Icon({
                    image: 'data:image/svg+xml;charset=utf-8,' + encodedTreasureSvg,
                    size: new AMap.Size(50, 50),
                    imageOffset: new AMap.Pixel(-25, -25)
                }),
                title: `${treasureType.name} (${treasureType.rarity})`,
                zIndex: 500
            });

            // å­˜å‚¨å®è—IDåˆ°æ ‡è®°ä¸Š
            treasureMarker.treasureId = treasureData.id;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            treasureMarker.on('click', function() {
                if (userLocation) {
                    const distance = calculateDistance(userLocation, position);
                    const requiredDistance = treasureData.location.discoveryRadius;
                    
                    if (distance <= requiredDistance) {
                        // å°è¯•å‘ç°å®è—
                        const result = treasureManager.discoverTreasure(treasureData.id, userLocation);
                        
                        if (result.success) {
                            // å‘ç°æˆåŠŸ
                            map.remove(treasureMarker);
                            treasureMarkers = treasureMarkers.filter(m => m !== treasureMarker);
                            
                            let message = `ğŸ‰ æ­å–œï¼æ‚¨å‘ç°äº†${result.treasure.title}ï¼\n`;
                            message += `ğŸ’° è·å¾— ${result.rewards.coins} é‡‘å¸\n`;
                            message += `â­ è·å¾— ${result.rewards.experience} ç»éªŒ`;
                            
                            if (result.levelUp) {
                                message += `\nğŸŠ ç­‰çº§æå‡ï¼LV.${result.levelUp.oldLevel} â†’ LV.${result.levelUp.newLevel}`;
                            }
                            
                            updateStatus(message, 'success');
                            
                            // æ£€æŸ¥æ–°æˆå°±
                            const newAchievements = achievementManager.checkAchievements();
                            if (newAchievements.length > 0) {
                                setTimeout(() => {
                                    updateStatus('ğŸ† è·å¾—æ–°æˆå°±ï¼æŸ¥çœ‹å¾½ç« ç³»ç»Ÿäº†è§£è¯¦æƒ…', 'success');
                                }, 2000);
                            }
                            
                        } else {
                            // å‘ç°å¤±è´¥
                            if (result.reason === 'already_discovered') {
                                updateStatus('æ‚¨å·²ç»å‘ç°è¿‡è¿™ä¸ªå®è—äº†', 'warning');
                            } else if (result.reason === 'too_far') {
                                updateStatus(`è·ç¦»å¤ªè¿œï¼è¿˜éœ€è¦é è¿‘${Math.round(result.distance - result.requiredDistance)}ç±³`, 'warning');
                            }
                        }
                    } else {
                        updateStatus(`${treasureType.name}è·ç¦»æ‚¨è¿˜æœ‰${Math.round(distance)}ç±³ï¼ˆéœ€è¦åœ¨${requiredDistance}ç±³å†…ï¼‰`, 'info');
                        
                        // æ˜¾ç¤ºè·ç¦»æŒ‡ç¤º
                        const infoWindow = new AMap.InfoWindow({
                            content: `
                                <div style="padding: 10px; text-align: center;">
                                    <div style="font-size: 1.2rem; margin-bottom: 5px;">${treasureType.icon} ${treasureType.name}</div>
                                    <div style="color: #666; font-size: 0.9rem;">è·ç¦»: ${Math.round(distance)}ç±³</div>
                                    <div style="color: #666; font-size: 0.9rem;">éœ€è¦: ${requiredDistance}ç±³å†…</div>
                                    <div style="color: #4FC3F7; font-size: 0.8rem; margin-top: 5px;">
                                        ğŸ’° ${treasureType.rewards.coins} é‡‘å¸ | â­ ${treasureType.rewards.experience} ç»éªŒ
                                    </div>
                                </div>
                            `,
                            anchor: 'bottom-center',
                            offset: new AMap.Pixel(0, -5)
                        });
                        infoWindow.open(map, position);
                        
                        // 3ç§’åè‡ªåŠ¨å…³é—­
                        setTimeout(() => {
                            infoWindow.close();
                        }, 3000);
                    }
                }
            });

            // æ·»åŠ åˆ°åœ°å›¾
            map.add(treasureMarker);
            treasureMarkers.push(treasureMarker);
            
            // ä¿å­˜æ•°æ®
            saveUserData();
            updateStats();
        }

        // å›åˆ°æˆ‘çš„ä½ç½®
        function centerToUser() {
            if (!map) {
                updateStatus('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼', 'warning');
                return;
            }
            
            if (!userLocation) {
                updateStatus('è¿˜æ²¡æœ‰è·å–åˆ°ä½ç½®ï¼Œè¯·å…ˆç‚¹å‡»"é‡æ–°å®šä½"', 'warning');
                return;
            }
            
            console.log('ç§»åŠ¨åœ°å›¾åˆ°ç”¨æˆ·ä½ç½®:', userLocation);
            console.log('å½“å‰åœ°å›¾ä¸­å¿ƒ:', map.getCenter());
            
            // ä½¿ç”¨ setZoomAndCenter ç¡®ä¿åŒæ—¶è®¾ç½®ç¼©æ”¾å’Œä¸­å¿ƒ
            map.setZoomAndCenter(17, userLocation);
            
            // å¦‚æœç”¨æˆ·æ ‡è®°å­˜åœ¨ï¼Œè§¦å‘å¼¹è·³åŠ¨ç”»
            if (userMarker) {
                userMarker.setAnimation('AMAP_ANIMATION_BOUNCE');
                setTimeout(() => {
                    userMarker.setAnimation('AMAP_ANIMATION_NONE');
                }, 1000);
            }
            
            updateStatus('ğŸ¯ å·²å›åˆ°æ‚¨çš„ä½ç½®', 'success');
        }

        // æ¸…ç©ºåœ°å›¾
        function clearMap() {
            if (treasureMarkers.length === 0) {
                updateStatus('åœ°å›¾ä¸Šæ²¡æœ‰å®è—', 'info');
                return;
            }

            map.remove(treasureMarkers);
            treasureMarkers = [];
            updateStatus('ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰å®è—', 'success');
            updateStats();
        }

        // é¦–æ¬¡ä½¿ç”¨æ£€æŸ¥
        function checkFirstTimeUser() {
            const isFirstTime = !localStorage.getItem('totofun-treasure-user');
            if (isFirstTime) {
                // é¦–æ¬¡ä½¿ç”¨ï¼Œæ˜¾ç¤ºæ¬¢è¿å’Œæ˜µç§°è®¾ç½®
                setTimeout(() => {
                    const username = prompt('ğŸ‰ æ¬¢è¿æ¥åˆ° Totofun çªçªç¿»ï¼\n\nè¯·è¾“å…¥ä½ çš„æ¸¸æˆæ˜µç§°ï¼ˆ3-10ä¸ªå­—ç¬¦ï¼‰:', 'å¯»å®æ¢é™©å®¶');
                    if (username && username.length >= 3 && username.length <= 10) {
                        userData.username = username;
                        saveUserData();
                        updateStatus(`æ¬¢è¿ï¼Œ${username}ï¼å¼€å§‹ä½ çš„å¯»å®ä¹‹æ—…å§ï¼`, 'success');
                    } else if (username) {
                        alert('æ˜µç§°é•¿åº¦åº”è¯¥åœ¨3-10ä¸ªå­—ç¬¦ä¹‹é—´');
                        checkFirstTimeUser();
                    }
                }, 1000);
            } else {
                // è€ç”¨æˆ·ï¼Œæ˜¾ç¤ºæ¬¢è¿å›æ¥æ¶ˆæ¯
                if (userData.username) {
                    updateStatus(`æ¬¢è¿å›æ¥ï¼Œ${userData.username}ï¼`, 'success');
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åŠ è½½ç”¨æˆ·æ•°æ®
            loadUserData();
            
            const savedKey = localStorage.getItem('amap-api-key');
            if (savedKey) {
                document.getElementById('api-key').value = savedKey;
                updateStatus('å‘ç°å·²ä¿å­˜çš„API Keyï¼Œç‚¹å‡»å¯åŠ¨å³å¯å¼€å§‹æ¸¸æˆ', 'success');
            }

            // æ£€æŸ¥é¦–æ¬¡ç”¨æˆ·
            checkFirstTimeUser();

            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            if (userData.stats.treasuresDiscovered > 0) {
                setTimeout(() => {
                    updateStatus(`ä½ å·²å‘ç° ${userData.stats.treasuresDiscovered} ä¸ªå®è—ï¼Œç­‰çº§ LV.${userData.level.currentLevel}ï¼Œç»§ç»­åŠ æ²¹ï¼`, 'success');
                }, 2000);
            }

            // æ›´æ–°åˆå§‹ç»Ÿè®¡
            updateStats();
            
            // æ˜¾ç¤ºç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
            updateUserDisplay();
        });

        // æ›´æ–°ç”¨æˆ·æ˜¾ç¤ºä¿¡æ¯
        function updateUserDisplay() {
            const levelInfo = userManager.getLevelInfo();
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            if (document.getElementById('total-treasures')) {
                document.getElementById('total-treasures').textContent = userData.stats.treasuresDiscovered;
            }
            
            // å¦‚æœæœ‰å¾½ç« æ˜¾ç¤ºåŒºåŸŸï¼Œæ›´æ–°å¾½ç« 
            if (userData.level.badges.length > 0) {
                console.log('ğŸ† å·²è·å¾—å¾½ç« :', userData.level.badges.map(b => `${b.icon} ${b.description}`).join(', '));
            }
        }

        // å¯¼å‡ºç”¨æˆ·æ•°æ®ï¼ˆç”¨äºè°ƒè¯•æˆ–å¤‡ä»½ï¼‰
        function exportUserData() {
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'totofun-treasure-userdata.json';
            a.click();
            URL.revokeObjectURL(url);
            updateStatus('ç”¨æˆ·æ•°æ®å·²å¯¼å‡º', 'success');
        }

        // é‡ç½®ç”¨æˆ·æ•°æ®
        function resetUserData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ¸¸æˆæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                storageManager.remove('totofun-treasure-user');
                location.reload();
            }
        }

        // ç§»åŠ¨ç«¯è°ƒè¯•åŠŸèƒ½
        function debugLocationInfo() {
            let debugInfo = `
                <strong>ğŸ”§ è°ƒè¯•ä¿¡æ¯</strong><br>
                ç”¨æˆ·ä»£ç†: ${navigator.userAgent.substring(0, 50)}...<br>
                æ”¯æŒGPS: ${navigator.geolocation ? 'âœ…' : 'âŒ'}<br>
                å½“å‰æ—¶é—´: ${new Date().toLocaleString()}<br>
                åœ°å›¾çŠ¶æ€: ${map ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}<br>
                ç”¨æˆ·ä½ç½®: ${userLocation ? `${userLocation[1].toFixed(4)}, ${userLocation[0].toFixed(4)}` : 'âŒ æœªè·å–'}<br>
                å®è—æ•°é‡: ${treasureMarkers.length}<br>
                HTTPS: ${location.protocol === 'https:' ? 'âœ…' : 'âŒ GPSéœ€è¦HTTPS'}<br>
            `;
            
            // æ£€æŸ¥æƒé™çŠ¶æ€
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    debugInfo += `GPSæƒé™: ${result.state}<br>`;
                    updateGPSData(debugInfo);
                });
            } else {
                updateGPSData(debugInfo);
            }
        }


        // å¼ºåˆ¶ä½¿ç”¨ä¸Šæµ·ä½ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        function useShanghai() {
            userLocation = [121.4737, 31.2304]; // ä¸Šæµ·å¤–æ»©
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            updateStatus('ğŸ—ºï¸ å·²åˆ‡æ¢åˆ°ä¸Šæµ·å¤–æ»©ä½ç½®', 'success');
            updateGPSData(`
                <strong>ğŸ“ ä¸Šæµ·å¤–æ»©ä½ç½®</strong><br>
                çº¬åº¦: 31.230400 âœ…<br>
                ç»åº¦: 121.473700 âœ…<br>
                ç²¾åº¦: æ¨¡æ‹Ÿä½ç½®<br>
                æ—¶é—´: ${new Date().toLocaleString()}<br>
                <small style="color: #666;">ğŸ¯ ä¸Šæµ·åœ°åŒºæ¨¡æ‹Ÿå®šä½</small>
            `);
            
            // ç”Ÿæˆå®è—
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1000);
        }

        // é”®ç›˜å¿«æ·é”®å’Œè§¦æ‘¸äº‹ä»¶
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        if (!map) initMap();
                        else testGPS();
                        break;
                    case 't':
                        e.preventDefault();
                        addTreasure();
                        break;
                    case 's':
                        e.preventDefault();
                        useShanghai();
                        break;
                    case 'd':
                        e.preventDefault();
                        debugLocationInfo();
                        break;
                    case 'Delete':
                    case 'Backspace':
                        e.preventDefault();
                        clearMap();
                        break;
                }
            }
        });

        // ç§»åŠ¨ç«¯é•¿æŒ‰æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        let touchTimer;
        document.addEventListener('touchstart', function(e) {
            if (e.target.id === 'gps-data') {
                touchTimer = setTimeout(() => {
                    debugLocationInfo();
                }, 1000);
            }
        });

        document.addEventListener('touchend', function() {
            clearTimeout(touchTimer);
        });
    </script>
</body>
</html>
