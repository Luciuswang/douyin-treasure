<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totofun çªçªç¿» - GPSå¯»å®æ¸¸æˆ</title>
<meta name="description" content="åŸºäºGPSå®šä½çš„å®æ—¶å¯»å®æ¸¸æˆï¼Œæ¢ç´¢èº«è¾¹çš„å®è—">
    <meta name="keywords" content="GPSå¯»å®,Totofun,çªçªç¿»,é«˜å¾·åœ°å›¾,å®šä½æ¸¸æˆ,å¯»å®æ¸¸æˆ">
    
    <!-- PWAæ”¯æŒ -->
    <meta name="theme-color" content="#4FC3F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Totofun">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/images/icon-16x16.png">
    <link rel="shortcut icon" href="assets/images/icon-32x32.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/images/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="assets/images/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/images/icon-120x120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="assets/images/icon-114x114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/images/icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="assets/images/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="assets/images/icon-60x60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="assets/images/icon-57x57.png">
    <link rel="apple-touch-icon" href="assets/images/icon-180x180.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#4FC3F7">
    <meta name="msapplication-TileImage" content="assets/images/icon-144x144.png">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: system-ui, -apple-system, 'PingFang SC', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 50%, #FFA500 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #333;
            padding: 10px;
            line-height: 1.6;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            color: white;
            margin-bottom: 20px;
        }
        
        .logo-container {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            padding: 20px;
            display: inline-block;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            width: 160px;
            height: 160px;
            margin: 0 auto;
            display: block;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.15));
        }
        
        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) scale(1); 
            }
            50% { 
                transform: translateY(-10px) scale(1.05); 
            }
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            color: #ffffff;
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .stat {
            text-align: center;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .card h3 {
            color: #1E3A8A;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin: 20px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .api-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .api-input:focus {
            border-color: #4FC3F7;
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover:before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(79, 195, 247, 0.5);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn:disabled:before {
            display: none;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status.info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%);
            color: #1976d2;
            border: 1px solid #2196F3;
        }
        
        .status.success {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            color: #2e7d32;
            border: 1px solid #4CAF50;
        }
        
        .status.error {
            background: linear-gradient(135deg, #ffebee 0%, #ffeef0 100%);
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .status.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #fffbf0 100%);
            color: #856404;
            border: 1px solid #ffc107;
        }
        
        #map-container {
            width: 100%;
            height: 60vh;
            min-height: 400px;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid #e1e5e9;
            margin: 20px 0;
            position: relative;
            background: #f8f9fa;
        }
        
        .map-placeholder {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
            color: #666; 
            flex-direction: column;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .map-placeholder-icon {
            font-size: 4rem; 
            margin-bottom: 20px;
            opacity: 0.6;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .controls {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .gps-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .gps-info h4 {
            color: #1E3A8A;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .gps-data {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 0.9rem;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            line-height: 1.5;
        }
        
        .tutorial {
            background: linear-gradient(135deg, #fff3cd 0%, #fffbf0 100%);
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            font-size: 0.95rem;
        }
        
        .tutorial h4 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .tutorial ol {
            margin-left: 20px;
        }
        
        .tutorial li {
            margin: 8px 0;
        }
        
        .tutorial a {
            color: #4FC3F7;
            text-decoration: none;
            font-weight: 600;
        }
        
        .tutorial a:hover {
            text-decoration: underline;
        }
        
        .features {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        @media (min-width: 768px) {
            .features {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .feature {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .feature:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(79, 195, 247, 0.2);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .feature h4 {
            color: #1E3A8A;
            margin-bottom: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4FC3F7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="assets/images/totofun-logo.png" alt="Totofun Logo" class="logo">
            </div>
            <h1 class="title">Totofun çªçªç¿»</h1>
            <p class="subtitle">åŸºäºGPSçš„å®æ—¶å¯»å®æ¸¸æˆ - æ¢ç´¢èº«è¾¹çš„å®è—</p>
            <div class="hero-stats">
                <div class="stat">
                    <span class="stat-number" id="user-name">æ¸¸å®¢</span>
                    <span class="stat-label">ç©å®¶æ˜µç§°</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="user-level">LV.1</span>
                    <span class="stat-label">å½“å‰ç­‰çº§</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="total-treasures">0</span>
                    <span class="stat-label">å‘ç°å®è—</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="accuracy">0m</span>
                    <span class="stat-label">å®šä½ç²¾åº¦</span>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆè¯´æ˜å…¥å£ -->
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="guide.html" style="
                display: inline-block;
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                color: white;
                padding: 12px 30px;
                border-radius: 25px;
                text-decoration: none;
                font-weight: 600;
                border: 2px solid rgba(255, 255, 255, 0.3);
                transition: all 0.3s ease;
                font-size: 1rem;
            " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
               onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                ğŸ“– æ¸¸æˆè¯´æ˜
            </a>
        </div>

        <!-- å¯åŠ¨æŒ‰é’® -->
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn" onclick="initMap()" style="max-width: 400px; margin: 0 auto;">
                <span id="init-btn-text">ğŸš€ å¯åŠ¨å¯»å®ä¹‹æ—…</span>
            </button>
            <div class="status info" id="status" style="max-width: 400px; margin: 15px auto;">
                <span>ğŸ”„</span>
                <span>ç‚¹å‡»"å¯åŠ¨å¯»å®ä¹‹æ—…"å¼€å§‹æ¸¸æˆ...</span>
            </div>
        </div>

        <div class="card">
            <div id="map-container">
                <div class="map-placeholder">
                    <div class="map-placeholder-icon pulse">ğŸ—ºï¸</div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">åœ°å›¾å³å°†åŠ è½½</div>
                        <div style="color: #888;">ç‚¹å‡»å¯åŠ¨æŒ‰é’®å¼€å§‹å¯»å®</div>
                    </div>
                </div>
            </div>
            
            <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
                <button class="btn" onclick="testGPS()" disabled id="gps-btn">
                    ğŸ“ é‡æ–°å®šä½
                </button>
                <button class="btn" onclick="centerToUser()" disabled id="center-btn">
                    ğŸ¯ å›åˆ°ä½ç½®
                </button>
                <button class="btn" onclick="generateNearbyTreasures()" disabled id="generate-btn">
                    ğŸ—ºï¸ ç”Ÿæˆå®è—
                </button>
                <button class="btn" onclick="addTreasure()" disabled id="treasure-btn">
                    âœ¨ æ·»åŠ å®è—
                </button>
                <button class="btn" onclick="clearMap()" disabled id="clear-btn">
                    ğŸ—‘ï¸ åˆ é™¤å®è—
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let map = null;
        let userMarker = null;
        let treasureMarkers = [];
        let userLocation = null;
        let watchId = null;

        // ç”¨æˆ·æ•°æ®ç®¡ç†
        let userData = {
            username: '',
            level: {
                currentLevel: 1,
                experience: 0,
                badges: []
            },
            stats: {
                treasuresCreated: 0,
                treasuresDiscovered: 0,
                totalLikes: 0,
                totalViews: 0
            },
            preferences: {
                interests: [],
                explorationRadius: 5000,
                language: 'zh-CN'
            },
            discoveredTreasures: [],
            createdTreasures: [],
            achievements: [],
            lastActiveAt: new Date()
        };

        // æœ¬åœ°å­˜å‚¨ç®¡ç†
        const storageManager = {
            save: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('å­˜å‚¨å¤±è´¥:', error);
                    return false;
                }
            },
            load: (key) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('è¯»å–å¤±è´¥:', error);
                    return null;
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    return false;
                }
            }
        };

        // å®Œæ•´çš„å®è—ç±»å‹ç³»ç»Ÿï¼ˆåŸºäºæ•°æ®æ¨¡å‹ï¼‰
        const treasureTypes = [
            { 
                icon: 'ğŸ’', 
                name: 'é’»çŸ³å®è—', 
                color: '#e74c3c', 
                rarity: 'legendary',
                category: 'æ‘„å½±',
                rewards: { experience: 100, coins: 50 },
                discoveryRadius: 30
            },
            { 
                icon: 'ğŸ‘‘', 
                name: 'çš‡å† å®è—', 
                color: '#9b59b6', 
                rarity: 'epic',
                category: 'å†å²',
                rewards: { experience: 80, coins: 40 },
                discoveryRadius: 35
            },
            { 
                icon: 'ğŸ’°', 
                name: 'é‡‘å¸å®è—', 
                color: '#f1c40f', 
                rarity: 'rare',
                category: 'è´­ç‰©',
                rewards: { experience: 60, coins: 30 },
                discoveryRadius: 40
            },
            { 
                icon: 'ğŸº', 
                name: 'å¤è‘£å®è—', 
                color: '#e67e22', 
                rarity: 'uncommon',
                category: 'è‰ºæœ¯',
                rewards: { experience: 40, coins: 20 },
                discoveryRadius: 45
            },
            { 
                icon: 'ğŸ’', 
                name: 'æˆ’æŒ‡å®è—', 
                color: '#3498db', 
                rarity: 'common',
                category: 'ç¾é£Ÿ',
                rewards: { experience: 20, coins: 10 },
                discoveryRadius: 50
            },
            { 
                icon: 'ğŸ­', 
                name: 'é¢å…·å®è—', 
                color: '#8e44ad', 
                rarity: 'rare',
                category: 'éŸ³ä¹',
                rewards: { experience: 55, coins: 25 },
                discoveryRadius: 40
            },
            { 
                icon: 'âš”ï¸', 
                name: 'ç¥å™¨å®è—', 
                color: '#2c3e50', 
                rarity: 'legendary',
                category: 'è¿åŠ¨',
                rewards: { experience: 120, coins: 60 },
                discoveryRadius: 25
            },
            { 
                icon: 'ğŸ†', 
                name: 'å¥–æ¯å®è—', 
                color: '#f39c12', 
                rarity: 'epic',
                category: 'æ—…æ¸¸',
                rewards: { experience: 90, coins: 45 },
                discoveryRadius: 30
            }
        ];

        // ç”¨æˆ·ç­‰çº§ç³»ç»Ÿ
        const levelSystem = {
            getLevel: (experience) => Math.floor(Math.sqrt(experience / 100)) + 1,
            getExpForLevel: (level) => Math.pow(level - 1, 2) * 100,
            getExpToNext: (currentExp) => {
                const currentLevel = levelSystem.getLevel(currentExp);
                const nextLevelExp = levelSystem.getExpForLevel(currentLevel + 1);
                return nextLevelExp - currentExp;
            }
        };

        // å¾½ç« ç³»ç»Ÿ
        const badgeSystem = [
            { name: 'first_treasure', icon: 'ğŸ¯', title: 'åˆæ¢è€…', description: 'å‘ç°ç¬¬ä¸€ä¸ªå®è—' },
            { name: 'treasure_hunter', icon: 'ğŸƒ', title: 'å¯»å®çŒäºº', description: 'å‘ç°10ä¸ªå®è—' },
            { name: 'treasure_master', icon: 'ğŸ‘‘', title: 'å¯»å®å¤§å¸ˆ', description: 'å‘ç°50ä¸ªå®è—' },
            { name: 'legendary_finder', icon: 'ğŸ’', title: 'ä¼ å¥‡å‘ç°è€…', description: 'å‘ç°ä¼ å¥‡çº§å®è—' },
            { name: 'category_expert', icon: 'ğŸ“', title: 'åˆ†ç±»ä¸“å®¶', description: 'åœ¨æ¯ä¸ªåˆ†ç±»ä¸­éƒ½å‘ç°å®è—' },
            { name: 'speed_runner', icon: 'âš¡', title: 'é—ªç”µä¾ ', description: '1å°æ—¶å†…å‘ç°5ä¸ªå®è—' },
            { name: 'explorer', icon: 'ğŸ—ºï¸', title: 'æ¢é™©å®¶', description: 'æ¢ç´¢è¶…è¿‡5å…¬é‡ŒèŒƒå›´' },
            { name: 'social_star', icon: 'â­', title: 'ç¤¾äº¤ä¹‹æ˜Ÿ', description: 'åˆ›å»ºçš„å®è—è¢«å‘ç°100æ¬¡' }
        ];

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info', showLoading = false) {
            const status = document.getElementById('status');
            const iconMap = {
                info: 'ğŸ”„',
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸'
            };
            
            const icon = showLoading ? '<span class="loading"></span>' : iconMap[type];
            status.innerHTML = `${icon}<span>${message}</span>`;
            status.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ›´æ–°GPSæ•°æ®æ˜¾ç¤ºï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ç©ºå‡½æ•°é¿å…é”™è¯¯ï¼‰
        function updateGPSData(data) {
            // GPSæ•°æ®é¢æ¿å·²ç§»é™¤åˆ°æ¸¸æˆè¯´æ˜é¡µé¢
            console.log('GPSæ•°æ®:', data);
        }

        // å®è—ç®¡ç†ç³»ç»Ÿ
        const treasureManager = {
            // åˆ›å»ºå®è—æ•°æ®
            createTreasure: (position, type, creator = 'system') => {
                const treasure = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    title: type.name,
                    description: `ä¸€ä¸ªçè´µçš„${type.name}ï¼Œç­‰å¾…ç€å‹‡æ•¢çš„æ¢é™©è€…æ¥å‘ç°ï¼`,
                    creator: creator,
                    location: {
                        coordinates: position,
                        discoveryRadius: type.discoveryRadius
                    },
                    category: type.category,
                    rewards: type.rewards,
                    rarity: type.rarity,
                    icon: type.icon,
                    color: type.color,
                    stats: {
                        views: 0,
                        likes: 0,
                        discoveries: 0
                    },
                    createdAt: new Date(),
                    status: 'active'
                };
                return treasure;
            },

            // å‘ç°å®è—
            discoverTreasure: (treasureId, userPosition) => {
                const treasureIndex = userData.createdTreasures.findIndex(t => t.id === treasureId);
                if (treasureIndex === -1) return { success: false, reason: 'treasure_not_found' };

                const treasure = userData.createdTreasures[treasureIndex];
                const distance = calculateDistance(userPosition, treasure.location.coordinates);

                if (distance > treasure.location.discoveryRadius) {
                    return { 
                        success: false, 
                        reason: 'too_far',
                        distance: distance,
                        requiredDistance: treasure.location.discoveryRadius
                    };
                }

                // æ£€æŸ¥æ˜¯å¦å·²ç»å‘ç°è¿‡
                if (userData.discoveredTreasures.includes(treasureId)) {
                    return { success: false, reason: 'already_discovered' };
                }

                // è®°å½•å‘ç°
                userData.discoveredTreasures.push(treasureId);
                userData.stats.treasuresDiscovered += 1;
                treasure.stats.discoveries += 1;

                // å¥–åŠ±ç»éªŒå’Œé‡‘å¸
                const reward = userManager.addExperience(treasure.rewards.experience);
                userManager.addCoins(treasure.rewards.coins);

                // æ£€æŸ¥æˆå°±
                achievementManager.checkAchievements();

                // ä¿å­˜æ•°æ®
                saveUserData();

                return {
                    success: true,
                    treasure: treasure,
                    rewards: treasure.rewards,
                    levelUp: reward.levelUp
                };
            }
        };

        // ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
        const userManager = {
            // æ·»åŠ ç»éªŒå€¼
            addExperience: (points) => {
                const oldLevel = userData.level.currentLevel;
                userData.level.experience += points;
                
                const newLevel = levelSystem.getLevel(userData.level.experience);
                if (newLevel > oldLevel) {
                    userData.level.currentLevel = newLevel;
                    
                    // ç­‰çº§æå‡å¥–åŠ±
                    const reward = {
                        coins: newLevel * 10,
                        badge: newLevel % 10 === 0 ? `level_${newLevel}` : null
                    };

                    if (reward.badge) {
                        userManager.addBadge(reward.badge, 'ğŸ†', `è¾¾åˆ°ç¬¬${newLevel}çº§`);
                    }

                    return {
                        levelUp: true,
                        oldLevel: oldLevel,
                        newLevel: newLevel,
                        reward: reward
                    };
                }
                
                return { levelUp: false };
            },

            // æ·»åŠ å¾½ç« 
            addBadge: (badgeName, icon, description) => {
                const existingBadge = userData.level.badges.find(badge => badge.name === badgeName);
                if (!existingBadge) {
                    userData.level.badges.push({
                        name: badgeName,
                        icon: icon,
                        description: description,
                        unlockedAt: new Date()
                    });
                    return true;
                }
                return false;
            },

            // æ·»åŠ é‡‘å¸ï¼ˆè™šæ‹Ÿè´§å¸ï¼‰
            addCoins: (amount) => {
                if (!userData.coins) userData.coins = 0;
                userData.coins += amount;
            },

            // è·å–ç”¨æˆ·ç­‰çº§ä¿¡æ¯
            getLevelInfo: () => {
                const currentExp = userData.level.experience;
                const currentLevel = userData.level.currentLevel;
                const expForCurrentLevel = levelSystem.getExpForLevel(currentLevel);
                const expForNextLevel = levelSystem.getExpForLevel(currentLevel + 1);
                const expToNext = expForNextLevel - currentExp;
                const progress = ((currentExp - expForCurrentLevel) / (expForNextLevel - expForCurrentLevel)) * 100;

                return {
                    currentLevel,
                    currentExp,
                    expToNext,
                    progress: Math.max(0, Math.min(100, progress))
                };
            }
        };

        // æˆå°±ç³»ç»Ÿ
        const achievementManager = {
            checkAchievements: () => {
                const achievements = [];

                // ç¬¬ä¸€ä¸ªå®è—
                if (userData.stats.treasuresDiscovered === 1) {
                    achievements.push(userManager.addBadge('first_treasure', 'ğŸ¯', 'å‘ç°ç¬¬ä¸€ä¸ªå®è—'));
                }

                // å¯»å®çŒäºº
                if (userData.stats.treasuresDiscovered === 10) {
                    achievements.push(userManager.addBadge('treasure_hunter', 'ğŸƒ', 'å‘ç°10ä¸ªå®è—'));
                }

                // å¯»å®å¤§å¸ˆ
                if (userData.stats.treasuresDiscovered === 50) {
                    achievements.push(userManager.addBadge('treasure_master', 'ğŸ‘‘', 'å‘ç°50ä¸ªå®è—'));
                }

                // ä¼ å¥‡å‘ç°è€…ï¼ˆå‘ç°ä¼ å¥‡çº§å®è—ï¼‰
                const legendaryFound = userData.createdTreasures.some(t => 
                    userData.discoveredTreasures.includes(t.id) && t.rarity === 'legendary'
                );
                if (legendaryFound) {
                    achievements.push(userManager.addBadge('legendary_finder', 'ğŸ’', 'å‘ç°ä¼ å¥‡çº§å®è—'));
                }

                return achievements.filter(Boolean);
            }
        };

        // è·ç¦»è®¡ç®—å·¥å…·
        function calculateDistance(pos1, pos2) {
            const R = 6371000; // åœ°çƒåŠå¾„(ç±³)
            const lat1 = pos1[1] * Math.PI / 180;
            const lat2 = pos2[1] * Math.PI / 180;
            const deltaLat = (pos2[1] - pos1[1]) * Math.PI / 180;
            const deltaLng = (pos2[0] - pos1[0]) * Math.PI / 180;

            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // ä¿å­˜å’ŒåŠ è½½ç”¨æˆ·æ•°æ®
        function saveUserData() {
            userData.lastActiveAt = new Date();
            storageManager.save('totofun-treasure-user', userData);
            
            // åŒæ­¥æ˜µç§°åˆ°èŠå¤©ç³»ç»Ÿ
            if (userData.username && chatManager.currentUser) {
                chatManager.currentUser.name = userData.username;
                storageManager.save('chatUser', chatManager.currentUser);
            }
        }

        function loadUserData() {
            const saved = storageManager.load('totofun-treasure-user');
            if (saved) {
                userData = { ...userData, ...saved };
                // ç¡®ä¿æ—¥æœŸå­—æ®µæ­£ç¡®è§£æ
                if (saved.lastActiveAt) {
                    userData.lastActiveAt = new Date(saved.lastActiveAt);
                }
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
        function updateStats(accuracy = 0) {
            document.getElementById('total-treasures').textContent = userData.stats.treasuresDiscovered || 0;
            document.getElementById('accuracy').textContent = `${Math.round(accuracy)}m`;
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            if (document.getElementById('user-name')) {
                document.getElementById('user-name').textContent = userData.username || 'æ¸¸å®¢';
            }
            if (document.getElementById('user-level')) {
                document.getElementById('user-level').textContent = `LV.${userData.level.currentLevel}`;
            }
        }

        // é»˜è®¤API Keyï¼ˆé«˜å¾·åœ°å›¾Keyï¼‰
        // å¦‚æœéœ€è¦æ›´æ¢ï¼Œè¯·ä¿®æ”¹ä¸‹é¢è¿™è¡Œ
        const DEFAULT_AMAP_KEY = 'c3e0c33e45ad805025e9ccffbb4e9f37'; // é»˜è®¤æµ‹è¯•Key
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            // ç›´æ¥ä½¿ç”¨é»˜è®¤Key
            const apiKey = DEFAULT_AMAP_KEY;
            
            if (!apiKey) {
                updateStatus('åœ°å›¾é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥API Keyè®¾ç½®', 'error');
                return;
            }

            updateStatus('æ­£åœ¨åŠ è½½é«˜å¾·åœ°å›¾...', 'info', true);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const initBtn = document.getElementById('init-btn-text');
            initBtn.innerHTML = '<span class="loading"></span> æ­£åœ¨åŠ è½½...';

            // åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾APIï¼ˆåŒ…å«åæ ‡è½¬æ¢æ’ä»¶ï¼‰
            const script = document.createElement('script');
            script.src = `https://webapi.amap.com/maps?v=2.0&key=${apiKey}`;
            script.onload = function() {
                console.log('é«˜å¾·åœ°å›¾APIåŠ è½½æˆåŠŸ');
                createMap();
            };
            script.onerror = function() {
                console.error('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥');
                updateStatus('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥Keyæ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œè¿æ¥', 'error');
                document.getElementById('init-btn-text').innerHTML = 'ğŸš€ é‡æ–°å¯åŠ¨';
            };
            document.head.appendChild(script);
        }

        // åˆ›å»ºåœ°å›¾å®ä¾‹ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
        function createMap() {
            try {
                console.log('å¼€å§‹åˆ›å»ºåœ°å›¾å®ä¾‹...');
                updateStatus('æ­£åœ¨åˆ›å»ºåœ°å›¾å®ä¾‹...', 'info', true);
                
                // æ£€æŸ¥AMapæ˜¯å¦å¯ç”¨
                if (typeof AMap === 'undefined') {
                    throw new Error('AMapå¯¹è±¡æœªå®šä¹‰ï¼Œåœ°å›¾APIå¯èƒ½æœªæ­£ç¡®åŠ è½½');
                }
                
                map = new AMap.Map('map-container', {
                    zoom: 15,
                    center: [121.4737, 31.2304], // é»˜è®¤ä¸Šæµ·åæ ‡
                    viewMode: '2D',
                    showLabel: true,
                    mapStyle: 'amap://styles/normal',
                    resizeEnable: true,
                    rotateEnable: false,
                    pitchEnable: false,
                    dragEnable: true,
                    zoomEnable: true,
                    doubleClickZoom: true
                });

                console.log('åœ°å›¾å®ä¾‹åˆ›å»ºæˆåŠŸï¼Œç­‰å¾…åŠ è½½å®Œæˆ...');

                // åœ°å›¾åŠ è½½å®Œæˆäº‹ä»¶
                map.on('complete', function() {
                    console.log('åœ°å›¾åŠ è½½å®Œæˆ');
                    updateStatus('åœ°å›¾åŠ è½½æˆåŠŸï¼æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...', 'success');
                    
                    // é‡ç½®æŒ‰é’®
                    document.getElementById('init-btn-text').innerHTML = 'âœ… åœ°å›¾å·²å¯åŠ¨';
                    
                    // å¯ç”¨æ§åˆ¶æŒ‰é’®
                    document.querySelectorAll('.btn').forEach(btn => {
                        if (!btn.onclick || btn.onclick.toString().includes('initMap')) {
                            return;
                        }
                        btn.disabled = false;
                    });

                    // è‡ªåŠ¨è·å–ä½ç½®
                    setTimeout(() => {
                        console.log('å¼€å§‹è‡ªåŠ¨è·å–GPSä½ç½®...');
                        testGPS();
                    }, 1000);
                });

                // åœ°å›¾ç‚¹å‡»äº‹ä»¶ - æ·»åŠ å®è—
                map.on('click', function(e) {
                    console.log('åœ°å›¾ç‚¹å‡»äº‹ä»¶:', e.lnglat);
                    if (userLocation && confirm('åœ¨æ­¤ä½ç½®æ·»åŠ å®è—ï¼Ÿ')) {
                        addTreasureAtPosition([e.lnglat.lng, e.lnglat.lat]);
                    }
                });
                
                // åœ°å›¾ç§»åŠ¨äº‹ä»¶ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                map.on('moveend', function() {
                    const center = map.getCenter();
                    console.log('åœ°å›¾ä¸­å¿ƒ:', center.lng, center.lat, 'ç¼©æ”¾çº§åˆ«:', map.getZoom());
                });

            } catch (error) {
                console.error('åœ°å›¾åˆ›å»ºå¤±è´¥:', error);
                updateStatus('åœ°å›¾åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                document.getElementById('init-btn-text').innerHTML = 'ğŸš€ é‡æ–°å¯åŠ¨';
            }
        }

        // æµ‹è¯•GPSå®šä½ï¼ˆæ”¹è¿›ç‰ˆæœ¬ - é’ˆå¯¹PCå’Œæ‰‹æœºä¼˜åŒ–ï¼‰
        function testGPS() {
            if (!map) {
                updateStatus('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼', 'warning');
                return;
            }

            console.log('ğŸ¯ å¼€å§‹GPSå®šä½...');

            if (!navigator.geolocation) {
                updateStatus('æµè§ˆå™¨ä¸æ”¯æŒGPSå®šä½åŠŸèƒ½', 'error');
                useDefaultLocation();
                return;
            }

            // ç»Ÿä¸€ä½¿ç”¨é«˜å¾·å®šä½æœåŠ¡ï¼ˆé¿å…åæ ‡ç³»è½¬æ¢é—®é¢˜ï¼‰
            // é«˜å¾·å®šä½ä¼šè‡ªåŠ¨ä½¿ç”¨è®¾å¤‡GPS + IP + WiFi ç­‰å¤šç§å®šä½æ–¹å¼
            // è¿”å›çš„åæ ‡å·²ç»æ˜¯GCJ-02æ ‡å‡†ï¼Œä¸é«˜å¾·åœ°å›¾å®Œå…¨åŒ¹é…
            console.log('ğŸ¯ ä½¿ç”¨é«˜å¾·å®šä½æœåŠ¡ï¼ˆç»Ÿä¸€åæ ‡ç³»ï¼Œç¡®ä¿ç²¾ç¡®ï¼‰');
            useAmapGeolocation();
        }

        // ä½¿ç”¨é«˜å¾·å®šä½æœåŠ¡ï¼ˆæ¨èæ–¹å¼ï¼Œé¿å…åæ ‡ç³»é—®é¢˜ï¼‰
        function useAmapGeolocation() {
            console.log('ğŸš€ å¯åŠ¨é«˜å¾·å®šä½æœåŠ¡ï¼ˆå¼ºåˆ¶ä½¿ç”¨æµè§ˆå™¨GPSï¼‰...');
            updateStatus('æ­£åœ¨è·å–GPSä½ç½®ï¼Œè¯·å…è®¸ä½ç½®æƒé™...', 'info', true);
            
            // è®¾ç½®è¶…æ—¶ä¿æŠ¤ï¼ˆ20ç§’åè‡ªåŠ¨ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼‰
            const timeoutId = setTimeout(() => {
                console.warn('â° GPSå®šä½è¶…æ—¶ï¼Œä½¿ç”¨å¤‡ç”¨å®šä½æ–¹æ¡ˆ');
                updateStatus('GPSå®šä½è¶…æ—¶ï¼Œæ­£åœ¨ä½¿ç”¨å¤‡ç”¨å®šä½æ–¹æ¡ˆ...', 'warning', true);
                useAmapLocationFallback();
            }, 20000);
            
            // å…ˆå°è¯•ä½¿ç”¨æµè§ˆå™¨åŸç”ŸGPSè·å–WGS84åæ ‡
            if (navigator.geolocation) {
                console.log('ğŸ›°ï¸ ä½¿ç”¨æµè§ˆå™¨åŸç”ŸGPSå®šä½...');
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                        const wgs84Lat = position.coords.latitude;
                        const wgs84Lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        console.log('âœ… GPSå®šä½æˆåŠŸ:', { lat: wgs84Lat, lng: wgs84Lng, accuracy });
                        console.log('ğŸ“¡ å®šä½æ–¹å¼:', position.coords.altitude ? 'GPSå«æ˜Ÿ' : 'ç½‘ç»œè¾…åŠ©');
                        console.log('ğŸ“ æµ·æ‹”:', position.coords.altitude);
                        console.log('ğŸ“ ç²¾åº¦:', accuracy, 'ç±³');
                        
                        // âš ï¸ æ£€æŸ¥å®šä½è´¨é‡
                        const isGPSSatellite = position.coords.altitude !== null && position.coords.altitude !== undefined;
                        const isHighAccuracy = accuracy < 50; // ç²¾åº¦è¦æ±‚å°äº50ç±³
                        
                        console.log('ğŸ” GPSå«æ˜Ÿå®šä½?', isGPSSatellite);
                        console.log('ğŸ” é«˜ç²¾åº¦?', isHighAccuracy, `(${accuracy}ç±³)`);
                        
                        // å¦‚æœä¸æ˜¯GPSå«æ˜Ÿå®šä½æˆ–ç²¾åº¦å¤ªå·®ï¼Œæ˜¾ç¤ºè­¦å‘Š
                        if (!isGPSSatellite || accuracy > 100) {
                            console.warn('âš ï¸ å®šä½è´¨é‡è¾ƒå·®ï¼');
                            console.warn('   - GPSå«æ˜Ÿ:', isGPSSatellite ? 'æ˜¯' : 'å¦ï¼ˆä½¿ç”¨ç½‘ç»œè¾…åŠ©ï¼‰');
                            console.warn('   - ç²¾åº¦:', accuracy, 'ç±³');
                            
                            if (!isGPSSatellite) {
                                updateStatus('âš ï¸ æœªä½¿ç”¨GPSå«æ˜Ÿå®šä½ï¼Œä½ç½®å¯èƒ½ä¸å‡†ç¡®ï¼è¯·åˆ°å®¤å¤–ç©ºæ—·å¤„é‡æ–°å®šä½', 'warning');
                            } else if (accuracy > 100) {
                                updateStatus(`âš ï¸ GPSä¿¡å·è¾ƒå¼±ï¼ˆç²¾åº¦${Math.round(accuracy)}ç±³ï¼‰ï¼Œå»ºè®®åˆ°å®¤å¤–é‡æ–°å®šä½`, 'warning');
                            }
                        }
                        
                        console.log('ğŸ“ ç›´æ¥ä½¿ç”¨åæ ‡ï¼ˆä¸­å›½å¢ƒå†…é€šå¸¸ä¸ºGCJ-02ï¼‰');
                        
                        // ç›´æ¥ä½¿ç”¨åæ ‡ï¼Œå…ˆæ˜¾ç¤ºä½ç½®ï¼Œå¼‚æ­¥è·å–åœ°å€
                        const positionData = {
                            coords: {
                                latitude: wgs84Lat,
                                longitude: wgs84Lng,
                                accuracy: accuracy
                            },
                            timestamp: position.timestamp,
                            address: 'è·å–åœ°å€ä¸­...',
                            locationType: position.coords.altitude ? 'GPSå«æ˜Ÿå®šä½' : 'ç½‘ç»œè¾…åŠ©å®šä½'
                        };
                        
                        // ç«‹å³å¤„ç†å®šä½æˆåŠŸï¼Œä¸ç­‰å¾…åœ°å€
                        handleAmapLocationSuccess(positionData);
                        
                        // å¼‚æ­¥è·å–åœ°å€ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                        setTimeout(() => {
                            try {
                                AMap.plugin('AMap.Geocoder', function() {
                                    const geocoder = new AMap.Geocoder({
                                        timeout: 3000  // 3ç§’è¶…æ—¶
                                    });
                                    geocoder.getAddress([wgs84Lng, wgs84Lat], function(status, geoResult) {
                                        let address = 'åœ°å€æœªçŸ¥';
                                        if (status === 'complete' && geoResult.info === 'OK') {
                                            address = geoResult.regeocode.formattedAddress;
                                        }
                                        console.log('ğŸ“® åœ°å€è·å–ç»“æœ:', address);
                                        
                                        // æ›´æ–°æ˜¾ç¤ºçš„åœ°å€
                                        positionData.address = address;
                                        const locationInfo = document.querySelector('.gps-data');
                                        if (locationInfo) {
                                            locationInfo.innerHTML = locationInfo.innerHTML.replace('è·å–åœ°å€ä¸­...', address);
                                        }
                                    });
                                });
                            } catch (error) {
                                console.warn('âš ï¸ è·å–åœ°å€å¤±è´¥:', error);
                            }
                        }, 100);
                    },
                    function(error) {
                        clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                        console.error('âŒ GPSå®šä½å¤±è´¥:', error);
                        
                        // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæç¤º
                        if (error.code === 1) {
                            updateStatus('ä½ç½®æƒé™è¢«æ‹’ç»ï¼Œæ­£åœ¨ä½¿ç”¨å¤‡ç”¨å®šä½...', 'warning', true);
                        } else if (error.code === 2) {
                            updateStatus('ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œæ­£åœ¨ä½¿ç”¨å¤‡ç”¨å®šä½...', 'warning', true);
                        } else if (error.code === 3) {
                            updateStatus('å®šä½è¯·æ±‚è¶…æ—¶ï¼Œæ­£åœ¨ä½¿ç”¨å¤‡ç”¨å®šä½...', 'warning', true);
                        }
                        
                        // GPSå¤±è´¥ï¼Œå›é€€åˆ°é«˜å¾·å®šä½
                        console.log('ğŸ”„ å›é€€åˆ°é«˜å¾·å®šä½æœåŠ¡...');
                        useAmapLocationFallback();
                    },
                    {
                        enableHighAccuracy: true,  // å¼ºåˆ¶é«˜ç²¾åº¦GPS
                        timeout: 15000,
                        maximumAge: 0  // ä¸ä½¿ç”¨ç¼“å­˜
                    }
                );
            } else {
                console.warn('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒGPSï¼Œä½¿ç”¨é«˜å¾·å®šä½');
                useAmapLocationFallback();
            }
        }
        
        // é«˜å¾·å®šä½å›é€€æ–¹æ¡ˆï¼ˆå½“GPSä¸å¯ç”¨æ—¶ï¼‰
        function useAmapLocationFallback() {
            console.log('ğŸ“± ä½¿ç”¨é«˜å¾·å®šä½æœåŠ¡ï¼ˆå¯èƒ½ä½¿ç”¨IP/åŸºç«™ï¼‰...');
            updateStatus('æ­£åœ¨ä½¿ç”¨é«˜å¾·å®šä½æœåŠ¡...', 'info', true);
            
            // è®¾ç½®è¶…æ—¶ä¿æŠ¤ï¼ˆ15ç§’åä½¿ç”¨é»˜è®¤ä½ç½®ï¼‰
            const fallbackTimeoutId = setTimeout(() => {
                console.warn('â° é«˜å¾·å®šä½ä¹Ÿè¶…æ—¶äº†ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·ï¼‰');
                updateStatus('å®šä½æœåŠ¡è¶…æ—¶ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·ï¼‰', 'warning');
                useDefaultLocation();
            }, 15000);
            
            AMap.plugin('AMap.Geolocation', function() {
                const geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    needAddress: true,
                    extensions: 'all',
                    convert: true,
                    GeoLocationFirst: true,  // ä¼˜å…ˆä½¿ç”¨H5å®šä½
                    noIpLocate: 3,  // ğŸ”¥ ç¦ç”¨IPå®šä½ï¼ˆ0=å…è®¸, 3=ç¦ç”¨ï¼‰
                    noGeoLocation: 0,  // å…è®¸ä½¿ç”¨æµè§ˆå™¨å®šä½
                    showButton: false,
                    showMarker: false,
                    showCircle: false,
                    panToLocation: false,
                    zoomToAccuracy: false
                });
                
                geolocation.getCurrentPosition(function(status, result) {
                    clearTimeout(fallbackTimeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                    console.log('ğŸ“ é«˜å¾·å®šä½çŠ¶æ€:', status);
                    console.log('ğŸ“ é«˜å¾·å®šä½ç»“æœ:', result);
                    
                    if (status === 'complete') {
                        // æ£€æŸ¥å®šä½ç±»å‹ï¼Œè­¦å‘Šå¦‚æœæ˜¯IPå®šä½
                        const locationType = result.location_type || 'æœªçŸ¥';
                        console.log('ğŸ“ å®šä½æ–¹å¼:', locationType);
                        
                        if (locationType.includes('IP')) {
                            console.warn('âš ï¸ è­¦å‘Šï¼šä½¿ç”¨äº†IPå®šä½ï¼Œç²¾åº¦è¾ƒä½ï¼ˆè¯¯å·®å¯èƒ½è¾¾åˆ°1-2å…¬é‡Œï¼‰');
                            console.warn('ğŸ’¡ å»ºè®®ï¼šè¯·ç¡®ä¿GPSå·²å¼€å¯ï¼Œå¹¶å…è®¸æµè§ˆå™¨è®¿é—®ä½ç½®ä¿¡æ¯');
                        }
                        
                        const position = {
                            coords: {
                                latitude: result.position.lat,
                                longitude: result.position.lng,
                                accuracy: result.accuracy || 100
                            },
                            timestamp: Date.now(),
                            address: result.formattedAddress || '',
                            addressComponent: result.addressComponent || {},
                            locationType: locationType
                        };
                        
                        console.log('âœ… å®šä½æˆåŠŸ:', position);
                        
                        handleAmapLocationSuccess(position);
                    } else {
                        console.error('âŒ é«˜å¾·å®šä½å¤±è´¥:', result);
                        updateStatus('é«˜å¾·å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·ï¼‰', 'warning');
                        useDefaultLocation();
                    }
                });
            });
        }
        
        // ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·ï¼‰
        function useDefaultLocation() {
            console.log('ğŸ“ ä½¿ç”¨é»˜è®¤ä½ç½®ï¼šä¸Šæµ·å¸‚ä¸­å¿ƒ');
            const defaultPosition = {
                coords: {
                    latitude: 31.230416,
                    longitude: 121.473701,
                    accuracy: 1000
                },
                timestamp: Date.now(),
                address: 'ä¸Šæµ·å¸‚é»„æµ¦åŒºäººæ°‘å¹¿åœº',
                locationType: 'é»˜è®¤ä½ç½®'
            };
            handleAmapLocationSuccess(defaultPosition);
            updateStatus('å·²ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·ï¼‰ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»"é‡æ–°å®šä½"è·å–çœŸå®ä½ç½®', 'warning');
        }

        // å®šä½å®Œæˆæ ‡å¿—
        let isLocationSet = false;
        let userLocationLocked = false;
        
        // å¤„ç†é«˜å¾·å®šä½æˆåŠŸï¼ˆæ— éœ€åæ ‡è½¬æ¢ï¼‰
        function handleAmapLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy || 100;
            const timestamp = new Date(position.timestamp).toLocaleString();
            const address = position.address || 'æœªçŸ¥ä½ç½®';
            
            console.log('========== å®šä½æˆåŠŸå¤„ç†å¼€å§‹ ==========');
            console.log('âœ… å®šä½æˆåŠŸ (GCJ-02):', { lat, lng, accuracy });
            console.log('ğŸ“ å‡†ç¡®åæ ‡ [ç»åº¦, çº¬åº¦]:', [lng, lat]);
            console.log('ğŸ“® è¯¦ç»†åœ°å€:', address);
            console.log('ğŸ“ åæ ‡æ£€æŸ¥: çº¬åº¦åœ¨30-32ä¹‹é—´?', lat > 30 && lat < 32, ', ç»åº¦åœ¨120-122ä¹‹é—´?', lng > 120 && lng < 122);
            
            userLocation = [lng, lat];
            isLocationSet = true;
            console.log('âœ… userLocationå·²è®¾ç½®ä¸º:', userLocation);
            
            // ç«‹å³è®¾ç½®åœ°å›¾ä¸­å¿ƒå’Œç¼©æ”¾ï¼ˆåœ¨åˆ›å»ºæ ‡è®°ä¹‹å‰ï¼‰
            console.log('ğŸ—ºï¸ å‡†å¤‡è®¾ç½®åœ°å›¾ä¸­å¿ƒ...');
            console.log('ğŸ—ºï¸ å½“å‰åœ°å›¾å¯¹è±¡:', map ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
            console.log('ğŸ—ºï¸ è®¾ç½®åœ°å›¾ä¸­å¿ƒåˆ°:', userLocation);
            
            // ï¼ï¼ï¼å¼ºåˆ¶è®¾ç½®åœ°å›¾ä¸­å¿ƒï¼Œå¤šæ¬¡å°è¯•ç¡®ä¿æˆåŠŸ
            if (map) {
                // ç«‹å³è®¾ç½®
                map.setZoomAndCenter(18, userLocation);
                console.log('âœ… åœ°å›¾ä¸­å¿ƒå·²è®¾ç½®ï¼ˆç¬¬1æ¬¡ï¼‰');
                
                // å»¶è¿Ÿè®¾ç½®å¤šæ¬¡ï¼Œå¯¹æŠ—å¯èƒ½çš„åœ°å›¾é‡ç½®
                [100, 300, 600, 1000, 1500].forEach(delay => {
                    setTimeout(() => {
                        map.setCenter(userLocation);
                        if (delay === 100) map.setZoom(18);
                        console.log(`âœ… åœ°å›¾ä¸­å¿ƒå·²è®¾ç½®ï¼ˆå»¶è¿Ÿ${delay}msï¼‰`);
                    }, delay);
                });
                
                // æœ€ç»ˆå¼ºåˆ¶ç¡®è®¤
                setTimeout(() => {
                    const currentCenter = map.getCenter();
                    const distance = calculateDistance(
                        [currentCenter.lng, currentCenter.lat],
                        userLocation
                    );
                    console.log(`ğŸ” æœ€ç»ˆæ£€æŸ¥ï¼šåœ°å›¾ä¸­å¿ƒè·ç¦»ç”¨æˆ·ä½ç½® ${distance.toFixed(2)} ç±³`);
                    
                    if (distance > 1000) {
                        // åç§»è¶…è¿‡1å…¬é‡Œï¼Œé‡æ–°åˆ›å»ºåœ°å›¾ï¼
                        console.error('âŒ åœ°å›¾ä¸­å¿ƒåç§»è¶…è¿‡1å…¬é‡Œï¼å‡†å¤‡é‡æ–°åˆ›å»ºåœ°å›¾...');
                        console.log('ğŸ”„ é”€æ¯æ—§åœ°å›¾...');
                        
                        // ä¿å­˜çŠ¶æ€
                        const oldZoom = map.getZoom();
                        
                        // é”€æ¯åœ°å›¾
                        map.destroy();
                        
                        // ç”¨æ­£ç¡®çš„ä¸­å¿ƒé‡æ–°åˆ›å»º
                        console.log('ğŸ†• ä½¿ç”¨æ­£ç¡®ä¸­å¿ƒé‡æ–°åˆ›å»ºåœ°å›¾:', userLocation);
                        map = new AMap.Map('map-container', {
                            zoom: 18,
                            center: userLocation,  // ç›´æ¥ä½¿ç”¨ç”¨æˆ·ä½ç½®ï¼
                            viewMode: '2D',
                            showLabel: true,
                            mapStyle: 'amap://styles/normal',
                            resizeEnable: true,
                            rotateEnable: false,
                            pitchEnable: false,
                            dragEnable: true,
                            zoomEnable: true,
                            doubleClickZoom: true
                        });
                        
                        map.on('complete', function() {
                            console.log('âœ… æ–°åœ°å›¾åˆ›å»ºå®Œæˆ');
                            const newCenter = map.getCenter();
                            console.log('ğŸ” æ–°åœ°å›¾ä¸­å¿ƒ:', [newCenter.lng, newCenter.lat]);
                            
                            // é‡æ–°åˆ›å»ºç”¨æˆ·æ ‡è®°
                            setTimeout(() => {
                                createUserMarker();
                                // é‡æ–°ç”Ÿæˆå®è—
                                if (treasureMarkers.length === 0) {
                                    generateNearbyTreasures();
                                }
                            }, 500);
                        });
                    } else if (distance > 50) {
                        console.warn('âš ï¸ åœ°å›¾ä¸­å¿ƒåç§»è¿‡å¤§ï¼Œå¼ºåˆ¶é‡æ–°è®¾ç½®');
                        map.setCenter(userLocation);
                        map.setZoom(18);
                    }
                    
                    // é”å®šç”¨æˆ·ä½ç½®ï¼Œé˜²æ­¢åœ°å›¾è¢«ç§»èµ°
                    userLocationLocked = true;
                    console.log('ğŸ”’ ç”¨æˆ·ä½ç½®å·²é”å®š');
                }, 2000);
                
                // ç›‘å¬åœ°å›¾ç§»åŠ¨ç»“æŸäº‹ä»¶ï¼Œå¦‚æœåç§»è¿‡å¤§åˆ™å¼ºåˆ¶å›åˆ°ç”¨æˆ·ä½ç½®
                let isResetting = false; // é˜²æ­¢æ— é™å¾ªç¯
                map.on('moveend', function() {
                    if (userLocationLocked && userLocation && !isResetting) {
                        const currentCenter = map.getCenter();
                        const distance = calculateDistance(
                            [currentCenter.lng, currentCenter.lat],
                            userLocation
                        );
                        
                        // å¦‚æœåç§»è¶…è¿‡100ç±³ï¼Œå¼ºåˆ¶å›åˆ°ç”¨æˆ·ä½ç½®
                        if (distance > 100) {
                            console.warn(`âš ï¸ åœ°å›¾è¢«ç§»åŠ¨äº†${distance.toFixed(2)}ç±³ï¼Œå¼ºåˆ¶å›åˆ°ç”¨æˆ·ä½ç½®`);
                            isResetting = true;
                            map.setCenter(userLocation);
                            setTimeout(() => { isResetting = false; }, 500);
                        }
                    }
                });
            } else {
                console.error('âŒ åœ°å›¾å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•è®¾ç½®ä¸­å¿ƒï¼');
            }
            
            // éªŒè¯åœ°å›¾ä¸­å¿ƒæ˜¯å¦æ­£ç¡®è®¾ç½®
            setTimeout(() => {
                const mapCenter = map.getCenter();
                console.log('ğŸ” éªŒè¯åœ°å›¾ä¸­å¿ƒ:', [mapCenter.lng, mapCenter.lat]);
                console.log('ğŸ” ç›®æ ‡ä½ç½®:', userLocation);
                const distance = calculateDistance(
                    [mapCenter.lng, mapCenter.lat], 
                    userLocation
                );
                console.log('ğŸ” åœ°å›¾ä¸­å¿ƒä¸ç›®æ ‡ä½ç½®è·ç¦»:', distance.toFixed(2), 'ç±³');
            }, 500);
            
            updateStatus(`å®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³`, 'success');
            
            // æ˜¾ç¤ºå®Œæ•´çš„è°ƒè¯•ä¿¡æ¯
            let debugInfo = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ffc107;">
                    <strong style="color: #856404;">ğŸ” è°ƒè¯•ä¿¡æ¯</strong><br>
                    <div style="font-family: monospace; font-size: 12px; margin-top: 10px;">
                        å®šä½åæ ‡: [${lng.toFixed(6)}, ${lat.toFixed(6)}]<br>
                        userLocation: [${userLocation[0].toFixed(6)}, ${userLocation[1].toFixed(6)}]<br>
                        åœ°å›¾å·²åˆå§‹åŒ–: ${map ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>
                        åæ ‡æ˜¯å¦åœ¨ä¸Šæµ·: ${lat > 30 && lat < 32 && lng > 120 && lng < 122 ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>
                    </div>
                </div>
            `;
            
            let locationInfo = debugInfo + `
                <strong>ğŸ“ ä½ç½®ä¿¡æ¯</strong><br>
                å®šä½æ–¹å¼: ${position.locationType || 'GPSå®šä½'}<br>
                <strong style="color: #4FC3F7;">ğŸ“® ${address}</strong><br>
                <br>
                <strong>å½“å‰ä½ç½® (GCJ-02):</strong><br>
                çº¬åº¦: ${lat.toFixed(6)}<br>
                ç»åº¦: ${lng.toFixed(6)}<br>
                ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 50 ? 'âœ… ä¼˜ç§€' : accuracy < 100 ? 'âœ… è‰¯å¥½' : accuracy < 500 ? 'âš ï¸ ä¸€èˆ¬' : 'âŒ è¾ƒå·®'}<br>
                æ—¶é—´: ${timestamp}<br>
            `;
            
            // å¦‚æœæœ‰WGS84åŸå§‹åæ ‡ï¼Œæ˜¾ç¤ºå¯¹æ¯”
            if (position.wgs84) {
                const wgs84 = position.wgs84;
                const offset = calculateDistance([lng, lat], [wgs84.lng, wgs84.lat]);
                locationInfo += `
                    <br>
                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #666;">ğŸ” æŸ¥çœ‹åæ ‡è¯¦æƒ…</summary>
                        <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 8px;">
                            <strong>åŸå§‹GPS (WGS84):</strong><br>
                            çº¬åº¦: ${wgs84.lat.toFixed(6)}<br>
                            ç»åº¦: ${wgs84.lng.toFixed(6)}<br>
                            <br>
                            <strong>åœ°å›¾åæ ‡ (GCJ-02):</strong><br>
                            çº¬åº¦: ${lat.toFixed(6)}<br>
                            ç»åº¦: ${lng.toFixed(6)}<br>
                            <br>
                            <strong>åæ ‡åç§»:</strong> ${offset.toFixed(2)}ç±³<br>
                            <small style="color: #666;">
                                ä¸­å›½GPSå¿…é¡»è½¬æ¢åæ ‡ç³»<br>
                                WGS84 â†’ GCJ-02 (ç«æ˜Ÿåæ ‡)
                            </small>
                        </div>
                    </details>
                `;
            } else {
                locationInfo += `
                    <small style="color: #666;">
                        åæ ‡ç³»: GCJ-02 (é«˜å¾·åœ°å›¾æ ‡å‡†)
                    </small>
                `;
            }
            
            updateGPSData(locationInfo);
            
            updateStats(accuracy);
            
            // å»¶è¿Ÿåˆ›å»ºæ ‡è®°ï¼Œç¡®ä¿åœ°å›¾å·²ç»ç§»åŠ¨åˆ°ä½
            setTimeout(() => {
                console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                createUserMarker();
            }, 600);
            
            setTimeout(() => {
                if (treasureMarkers.length === 0) {
                    console.log('ğŸ å¼€å§‹ç”Ÿæˆå®è—...');
                    generateNearbyTreasures();
                }
            }, 1000);
        }


        // å¤„ç†å®šä½æˆåŠŸï¼ˆæ”¹è¿›ç‰ˆæœ¬ - æ·»åŠ åæ ‡è½¬æ¢ï¼‰
        function handleLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy || 0;
            const timestamp = new Date(position.timestamp).toLocaleString();
            
            console.log('âœ… GPSåæ ‡:', { lat, lng, accuracy });
            
            // åœ¨ä¸­å›½å¢ƒå†…ï¼Œæµè§ˆå™¨é€šå¸¸ç›´æ¥è¿”å›GCJ-02åæ ‡
            // ç›´æ¥ä½¿ç”¨ï¼Œä¸è¿›è¡Œè½¬æ¢ï¼ˆé¿å…è½¬æ¢å¤±è´¥ï¼‰
            console.log('ğŸ“ ç›´æ¥ä½¿ç”¨åæ ‡ï¼ˆä¸­å›½å¢ƒå†…æµè§ˆå™¨é€šå¸¸è¿”å›GCJ-02ï¼‰');
            
            userLocation = [lng, lat];
            
            updateStatus(`GPSå®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³`, 'success');
            updateGPSData(`
                <strong>ğŸ“ ä½ç½®ä¿¡æ¯ (GCJ-02)</strong><br>
                çº¬åº¦: ${lat.toFixed(6)}<br>
                ç»åº¦: ${lng.toFixed(6)}<br>
                ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 50 ? 'âœ… ä¼˜ç§€' : accuracy < 100 ? 'âœ…' : 'âš ï¸'}<br>
                æ—¶é—´: ${timestamp}<br>
                <small style="color: #666;">
                    åæ ‡ç³»: GCJ-02 (é«˜å¾·åœ°å›¾æ ‡å‡†)<br>
                    ${lat > 30 && lat < 32 && lng > 120 && lng < 122 ? 'ğŸ¯ ä¸Šæµ·åœ°åŒºå®šä½æˆåŠŸ' : 'ğŸŒ å…¶ä»–åœ°åŒº'}
                </small>
            `);
            
            updateStats(accuracy);
            
            // è®¾ç½®åœ°å›¾ä¸­å¿ƒ
            console.log('ğŸ—ºï¸ è®¾ç½®åœ°å›¾ä¸­å¿ƒåˆ°:', userLocation);
            map.setZoomAndCenter(17, userLocation);
            
            // åˆ›å»ºç”¨æˆ·æ ‡è®°
            setTimeout(() => {
                console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                createUserMarker();
            }, 300);
            
            // ç”Ÿæˆå®è—
            setTimeout(() => {
                if (treasureMarkers.length === 0) {
                    console.log('ğŸ ç”Ÿæˆå®è—...');
                    generateNearbyTreasures();
                }
            }, 800);
            
            // ä¸‹é¢çš„ä»£ç ä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼ˆå¦‚æœéœ€è¦è½¬æ¢ï¼‰
            if (false && typeof AMap !== 'undefined' && AMap.convertFrom) {
                // è¿™æ®µä»£ç ä¸å†æ‰§è¡Œï¼Œä»…ä¿ç•™ä½œä¸ºå‚è€ƒ
                AMap.convertFrom([lng, lat], 'gps', function(status, result) {
                    console.log('ğŸ“ åæ ‡è½¬æ¢çŠ¶æ€:', status);
                    console.log('ğŸ“ åæ ‡è½¬æ¢ç»“æœ:', result);
                    console.log('ğŸ“ result.info:', result ? result.info : 'undefined');
                    console.log('ğŸ“ result.locations:', result ? result.locations : 'undefined');
                    
                    if (status === 'complete' && result && result.info === 'ok' && result.locations && result.locations.length > 0) {
                        const convertedLocation = result.locations[0];
                        userLocation = [convertedLocation.lng, convertedLocation.lat];
                        
                        console.log('âœ… è½¬æ¢ååæ ‡ (GCJ-02):', userLocation);
                        console.log('ğŸ“ åç§»è·ç¦»:', calculateDistance([lng, lat], userLocation).toFixed(2), 'ç±³');
                        
                        updateStatus(`GPSå®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³ (åæ ‡å·²è½¬æ¢)`, 'success');
                        updateGPSData(`
                            <strong>ğŸ“ ä½ç½®ä¿¡æ¯</strong><br>
                            åŸå§‹ä½ç½® (WGS84):<br>
                            çº¬åº¦: ${lat.toFixed(6)}<br>
                            ç»åº¦: ${lng.toFixed(6)}<br>
                            <br>
                            è½¬æ¢åä½ç½® (GCJ-02):<br>
                            çº¬åº¦: ${convertedLocation.lat.toFixed(6)} ${convertedLocation.lat > 30 && convertedLocation.lat < 32 ? 'âœ…' : 'â“'}<br>
                            ç»åº¦: ${convertedLocation.lng.toFixed(6)} ${convertedLocation.lng > 120 && convertedLocation.lng < 122 ? 'âœ…' : 'â“'}<br>
                            <br>
                            ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 100 ? 'âœ…' : accuracy < 500 ? 'âš ï¸' : 'âŒ'}<br>
                            æ—¶é—´: ${timestamp}<br>
                            <small style="color: #666;">
                                åæ ‡ç³»: WGS84 â†’ GCJ-02 (é«˜å¾·)<br>
                                ${convertedLocation.lat > 30 && convertedLocation.lat < 32 && convertedLocation.lng > 120 && convertedLocation.lng < 122 ? 'ğŸ¯ ä¸Šæµ·åœ°åŒºå®šä½æˆåŠŸ' : 'ğŸŒ éä¸Šæµ·åœ°åŒº'}
                            </small>
                        `);
                        
                        updateStats(accuracy);
                        
                        // å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒå’Œç¼©æ”¾
                        console.log('ğŸ—ºï¸ å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒ...');
                        map.setZoomAndCenter(17, userLocation);
                        
                        // å»¶è¿Ÿåˆ›å»ºæ ‡è®°
                        setTimeout(() => {
                            console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                            createUserMarker();
                        }, 300);
                        
                        // ç«‹å³ç”Ÿæˆå®è—
                        setTimeout(() => {
                            if (treasureMarkers.length === 0) {
                                console.log('ğŸ å¼€å§‹ç”Ÿæˆå®è—...');
                                generateNearbyTreasures();
                            }
                        }, 800);
                    } else {
                        // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹åæ ‡ï¼ˆå¯èƒ½ä¼šæœ‰åç§»ï¼‰
                        console.warn('âš ï¸ åæ ‡è½¬æ¢å¤±è´¥');
                        console.warn('   Status:', status);
                        console.warn('   Result:', result);
                        console.warn('   ä½¿ç”¨åŸå§‹åæ ‡ä½œä¸ºGCJ-02ï¼ˆå¯èƒ½æœ‰50-200ç±³åç§»ï¼‰');
                        
                        // ç›´æ¥ä½¿ç”¨åŸå§‹åæ ‡ï¼Œå‡è®¾å®ƒå·²ç»æ˜¯GCJ-02
                        // ï¼ˆå› ä¸ºè¯Šæ–­å·¥å…·æ˜¾ç¤ºå®šä½æˆåŠŸä¸”åæ ‡æ­£ç¡®ï¼‰
                        userLocation = [lng, lat];
                        
                        console.log('ğŸ“ ä½¿ç”¨åæ ‡:', userLocation);
                        
                        updateStatus(`GPSå®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³`, 'success');
                        updateGPSData(`
                            <strong>ğŸ“ ä½ç½®ä¿¡æ¯ (GCJ-02)</strong><br>
                            çº¬åº¦: ${lat.toFixed(6)}<br>
                            ç»åº¦: ${lng.toFixed(6)}<br>
                            ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 50 ? 'âœ… ä¼˜ç§€' : accuracy < 100 ? 'âœ…' : 'âš ï¸'}<br>
                            æ—¶é—´: ${timestamp}<br>
                            <small style="color: #666;">
                                åæ ‡ç³»: GCJ-02 (é«˜å¾·åœ°å›¾æ ‡å‡†)<br>
                                ${lat > 30 && lat < 32 && lng > 120 && lng < 122 ? 'ğŸ¯ ä¸Šæµ·åœ°åŒºå®šä½æˆåŠŸ' : 'ğŸŒ å…¶ä»–åœ°åŒº'}
                            </small>
                        `);
                        
                        updateStats(accuracy);
                        
                        // è®¾ç½®åœ°å›¾ä¸­å¿ƒ
                        console.log('ğŸ—ºï¸ è®¾ç½®åœ°å›¾ä¸­å¿ƒ...');
                        map.setZoomAndCenter(17, userLocation);
                        
                        // åˆ›å»ºç”¨æˆ·æ ‡è®°
                        setTimeout(() => {
                            console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                            createUserMarker();
                        }, 300);
                        
                        // ç”Ÿæˆå®è—
                        setTimeout(() => {
                            if (treasureMarkers.length === 0) {
                                console.log('ğŸ ç”Ÿæˆå®è—...');
                                generateNearbyTreasures();
                            }
                        }, 800);
                    }
                });
            }
        }

        // ä½¿ç”¨åŸå§‹åæ ‡çš„è¾…åŠ©å‡½æ•°
        function useRawCoordinates(lat, lng, accuracy, timestamp) {
            userLocation = [lng, lat];
            
            console.log('ğŸ“ ä½¿ç”¨åŸå§‹åæ ‡ (WGS84):', userLocation);
            
            updateStatus(`GPSå®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³ (æœªè½¬æ¢åæ ‡ï¼Œå¯èƒ½æœ‰åç§»)`, 'warning');
            updateGPSData(`
                <strong>ğŸ“ ä½ç½®ä¿¡æ¯</strong><br>
                çº¬åº¦: ${lat.toFixed(6)} ${lat > 30 && lat < 32 ? 'âœ…' : 'â“'}<br>
                ç»åº¦: ${lng.toFixed(6)} ${lng > 120 && lng < 122 ? 'âœ…' : 'â“'}<br>
                ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 100 ? 'âœ…' : accuracy < 500 ? 'âš ï¸' : 'âŒ'}<br>
                æ—¶é—´: ${timestamp}<br>
                <small style="color: #666;">
                    åæ ‡ç³»: WGS84 (æœªè½¬æ¢)<br>
                    âš ï¸ åæ ‡è½¬æ¢å¤±è´¥ï¼Œä½ç½®å¯èƒ½æœ‰åç§» 50-500ç±³<br>
                    ${lat > 30 && lat < 32 && lng > 120 && lng < 122 ? 'ğŸ¯ ä¸Šæµ·åœ°åŒºå®šä½æˆåŠŸ' : 'ğŸŒ éä¸Šæµ·åœ°åŒº'}
                </small>
            `);
            
            updateStats(accuracy);
            
            // å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒå’Œç¼©æ”¾
            console.log('ğŸ—ºï¸ å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒ...');
            map.setZoomAndCenter(17, userLocation);
            
            // å»¶è¿Ÿåˆ›å»ºæ ‡è®°
            setTimeout(() => {
                console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                createUserMarker();
            }, 300);
            
            setTimeout(() => {
                if (treasureMarkers.length === 0) {
                    console.log('ğŸ å¼€å§‹ç”Ÿæˆå®è—...');
                    generateNearbyTreasures();
                }
            }, 800);
        }

        // å¤„ç†å®šä½é”™è¯¯
        function handleLocationError(error) {
            let errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'ç”¨æˆ·æ‹’ç»äº†ä½ç½®æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ä½ç½®è®¿é—®';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥GPSæ˜¯å¦å¼€å¯';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'å®šä½è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•';
                    break;
                default:
                    errorMsg = 'æœªçŸ¥å®šä½é”™è¯¯ï¼Œè¯·é‡è¯•';
                    break;
            }
            
            updateStatus(`GPSå®šä½å¤±è´¥: ${errorMsg}`, 'error');
            updateGPSData(`
                <strong>âŒ å®šä½å¤±è´¥</strong><br>
                é”™è¯¯: ${errorMsg}<br>
                <small style="color: #666;">
                    å»ºè®®:<br>
                    â€¢ åœ¨æˆ·å¤–é‡è¯•<br>
                    â€¢ æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®<br>
                    â€¢ ç¡®ä¿GPSåŠŸèƒ½å·²å¼€å¯
                </small>
            `);
            
            // ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·å¤–æ»©ï¼‰
            userLocation = [121.4737, 31.2304];
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            updateStatus('GPSå®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·å¤–æ»©ï¼‰ã€‚å»ºè®®åœ¨æˆ·å¤–é‡æ–°å°è¯•å®šä½ã€‚', 'warning');
            
            // å³ä½¿æ˜¯é»˜è®¤ä½ç½®ä¹Ÿç”Ÿæˆå®è—
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1000);
        }

        // åˆ›å»ºç”¨æˆ·ä½ç½®æ ‡è®°ï¼ˆæ”¹è¿›ç‰ˆæœ¬ - æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼‰
        function createUserMarker() {
            console.log('========== å¼€å§‹åˆ›å»ºç”¨æˆ·æ ‡è®° ==========');
            console.log('å½“å‰åœ°å›¾å¯¹è±¡:', map ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–');
            console.log('å½“å‰ç”¨æˆ·ä½ç½®:', userLocation);
            
            if (!map) {
                console.error('âŒ åœ°å›¾æœªåˆå§‹åŒ–');
                updateStatus('åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ›å»ºæ ‡è®°', 'error');
                return false;
            }
            
            if (!userLocation || !Array.isArray(userLocation) || userLocation.length !== 2) {
                console.error('âŒ ç”¨æˆ·ä½ç½®æ— æ•ˆ:', userLocation);
                updateStatus('ç”¨æˆ·ä½ç½®æ— æ•ˆï¼Œæ— æ³•åˆ›å»ºæ ‡è®°', 'error');
                return false;
            }

            console.log('ğŸ“ å‡†å¤‡åˆ›å»ºæ ‡è®°ï¼Œä½ç½®:', userLocation);
            console.log('ç»åº¦:', userLocation[0], 'çº¬åº¦:', userLocation[1]);

            // ç§»é™¤æ—§æ ‡è®°
            if (userMarker) {
                console.log('ğŸ—‘ï¸ ç§»é™¤æ—§çš„ç”¨æˆ·æ ‡è®°');
                try {
                    map.remove(userMarker);
                    userMarker = null;
                    console.log('âœ… æ—§æ ‡è®°å·²ç§»é™¤');
                } catch (error) {
                    console.error('âŒ ç§»é™¤æ—§æ ‡è®°å¤±è´¥:', error);
                }
            }

            try {
                console.log('ğŸ¨ åˆ›å»ºæ ‡è®°å›¾æ ‡...');
                // ä½¿ç”¨ç®€å•çš„SVGï¼Œä¸åŒ…å«emojiï¼ˆé¿å…btoaç¼–ç é”™è¯¯ï¼‰
                const svgIcon = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60">
                        <defs>
                            <radialGradient id="glow" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#4CAF50;stop-opacity:0.3" />
                            </radialGradient>
                        </defs>
                        <circle cx="30" cy="30" r="25" fill="url(#glow)" opacity="0.6"/>
                        <circle cx="30" cy="30" r="18" fill="#4CAF50" stroke="white" stroke-width="4"/>
                        <circle cx="30" cy="30" r="12" fill="#81C784"/>
                        <circle cx="30" cy="30" r="6" fill="white"/>
                        <path d="M 30 10 L 28 20 L 32 20 Z" fill="white" opacity="0.8"/>
                    </svg>
                `;
                
                console.log('ğŸ“Œ åˆ›å»ºMarkerå¯¹è±¡...');
                console.log('ğŸ” userLocationè¯¦æƒ…:', userLocation);
                console.log('ğŸ” ç»åº¦(lng):', userLocation[0], 'ç±»å‹:', typeof userLocation[0]);
                console.log('ğŸ” çº¬åº¦(lat):', userLocation[1], 'ç±»å‹:', typeof userLocation[1]);
                
                // ç¡®ä¿åæ ‡æ˜¯æ•°å­—
                const markerLng = Number(userLocation[0]);
                const markerLat = Number(userLocation[1]);
                console.log('ğŸ” è½¬æ¢åç»åº¦:', markerLng);
                console.log('ğŸ” è½¬æ¢åçº¬åº¦:', markerLat);
                
                // ä½¿ç”¨encodeURIComponentä»£æ›¿btoaï¼Œé¿å…Unicodeé—®é¢˜
                const encodedSvg = encodeURIComponent(svgIcon);
                
                const markerPosition = new AMap.LngLat(markerLng, markerLat);
                console.log('ğŸ” Markerä½ç½®å¯¹è±¡:', markerPosition);
                console.log('ğŸ” Markerä½ç½® lng:', markerPosition.getLng(), 'lat:', markerPosition.getLat());
                
                userMarker = new AMap.Marker({
                    position: markerPosition,
                    icon: new AMap.Icon({
                        image: 'data:image/svg+xml;charset=utf-8,' + encodedSvg,
                        size: new AMap.Size(60, 60),
                        imageSize: new AMap.Size(60, 60),
                        imageOffset: new AMap.Pixel(0, 0)
                    }),
                    title: `æˆ‘çš„ä½ç½®\nç»åº¦: ${userLocation[0].toFixed(6)}\nçº¬åº¦: ${userLocation[1].toFixed(6)}`,
                    zIndex: 1000,
                    offset: new AMap.Pixel(-30, -30),
                    animation: 'AMAP_ANIMATION_BOUNCE',
                    clickable: true
                });

                console.log('âœ… Markerå¯¹è±¡åˆ›å»ºæˆåŠŸ');
                console.log('ğŸ” åˆ›å»ºåéªŒè¯ Markerä½ç½®:', userMarker.getPosition());
                console.log('â• æ·»åŠ æ ‡è®°åˆ°åœ°å›¾...');
                
                map.add(userMarker);
                
                console.log('âœ… æ ‡è®°å·²æ·»åŠ åˆ°åœ°å›¾');
                console.log('ğŸ” æ·»åŠ åéªŒè¯ Markerä½ç½®:', userMarker.getPosition());
                console.log('ğŸ” åœ°å›¾ä¸­å¿ƒ:', map.getCenter());
                console.log('ğŸ“Š å½“å‰åœ°å›¾ä¸Šçš„æ ‡è®°æ•°:', map.getAllOverlays('marker').length);
                
                // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå¯¹æ¯”ä¿¡æ¯
                const markerPos = userMarker.getPosition();
                const mapCenter = map.getCenter();
                alert(`è°ƒè¯•ä¿¡æ¯:\n\nuserLocation: [${userLocation[0].toFixed(6)}, ${userLocation[1].toFixed(6)}]\n\næ ‡è®°ä½ç½®: [${markerPos.lng.toFixed(6)}, ${markerPos.lat.toFixed(6)}]\n\nåœ°å›¾ä¸­å¿ƒ: [${mapCenter.lng.toFixed(6)}, ${mapCenter.lat.toFixed(6)}]`);
                
                // éªŒè¯æ ‡è®°æ˜¯å¦æ­£ç¡®æ·»åŠ 
                const allMarkers = map.getAllOverlays('marker');
                console.log('åœ°å›¾ä¸Šçš„æ‰€æœ‰æ ‡è®°:', allMarkers);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                userMarker.on('click', function() {
                    console.log('ğŸ‘† ç”¨æˆ·æ ‡è®°è¢«ç‚¹å‡»');
                    const infoWindow = new AMap.InfoWindow({
                        content: `
                            <div style="padding: 10px; text-align: center;">
                                <div style="font-size: 1.5rem; margin-bottom: 5px;">ğŸ“ æˆ‘çš„ä½ç½®</div>
                                <div style="color: #666; font-size: 0.9rem;">ç»åº¦: ${userLocation[0].toFixed(6)}</div>
                                <div style="color: #666; font-size: 0.9rem;">çº¬åº¦: ${userLocation[1].toFixed(6)}</div>
                            </div>
                        `,
                        anchor: 'bottom-center',
                        offset: new AMap.Pixel(0, -5)
                    });
                    infoWindow.open(map, userLocation);
                });
                
                console.log('========== ç”¨æˆ·æ ‡è®°åˆ›å»ºå®Œæˆ âœ… ==========');
                return true;
                
            } catch (error) {
                console.error('âŒ åˆ›å»ºç”¨æˆ·æ ‡è®°å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                updateStatus('åˆ›å»ºç”¨æˆ·æ ‡è®°å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // ç”Ÿæˆå‘¨å›´çš„å®è—
        function generateNearbyTreasures() {
            if (!map || !userLocation) {
                updateStatus('è¯·å…ˆè·å–GPSä½ç½®ï¼', 'warning');
                return;
            }

            // æ¸…ç©ºç°æœ‰å®è—
            if (treasureMarkers.length > 0) {
                clearMap();
            }

            updateStatus('æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆå‘¨å›´çš„å®è—...', 'info', true);

            // ç”Ÿæˆ3-5ä¸ªå®è—
            const treasureCount = Math.floor(Math.random() * 3) + 3;
            
            for (let i = 0; i < treasureCount; i++) {
                setTimeout(() => {
                    const treasureType = getRandomTreasureByRarity();
                    
                    // åœ¨ç”¨æˆ·ä½ç½®å‘¨å›´ç”Ÿæˆ
                    const angle = Math.random() * 2 * Math.PI;
                    const distance = Math.random() * 0.003 + 0.001; // çº¦100-400ç±³
                    
                    const offsetLng = Math.cos(angle) * distance;
                    const offsetLat = Math.sin(angle) * distance;
                    const position = [userLocation[0] + offsetLng, userLocation[1] + offsetLat];

                    addTreasureAtPosition(position, treasureType);
                    
                    if (i === treasureCount - 1) {
                        updateStatus(`ğŸ—ºï¸ å·²ç”Ÿæˆ${treasureCount}ä¸ªå®è—ï¼å¼€å§‹å¯»å®å§ï¼`, 'success');
                    }
                }, i * 200);
            }
        }

        // æ ¹æ®ç¨€æœ‰åº¦éšæœºé€‰æ‹©å®è—ç±»å‹
        function getRandomTreasureByRarity() {
            const rarityWeights = {
                'common': 40,
                'uncommon': 30,
                'rare': 20,
                'epic': 8,
                'legendary': 2
            };

            // åˆ›å»ºåŠ æƒæ•°ç»„
            let weightedArray = [];
            treasureTypes.forEach(type => {
                const weight = rarityWeights[type.rarity] || 10;
                for (let i = 0; i < weight; i++) {
                    weightedArray.push(type);
                }
            });

            return weightedArray[Math.floor(Math.random() * weightedArray.length)];
        }

        // æ‰‹åŠ¨æ·»åŠ å•ä¸ªå®è—
        function addTreasure() {
            if (!map || !userLocation) {
                updateStatus('è¯·å…ˆè·å–GPSä½ç½®ï¼', 'warning');
                return;
            }

            const treasureType = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
            
            // åœ¨ç”¨æˆ·ä½ç½®é™„è¿‘éšæœºç”Ÿæˆå®è—
            const offsetLng = (Math.random() - 0.5) * 0.008; // çº¦400ç±³èŒƒå›´
            const offsetLat = (Math.random() - 0.5) * 0.008;
            const position = [userLocation[0] + offsetLng, userLocation[1] + offsetLat];

            addTreasureAtPosition(position, treasureType);
        }

        // åœ¨æŒ‡å®šä½ç½®æ·»åŠ å®è—
        function addTreasureAtPosition(position, treasureType = null) {
            if (!map || !position) return;

            if (!treasureType) {
                treasureType = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
            }

            // åˆ›å»ºå®è—æ•°æ®
            const treasureData = treasureManager.createTreasure(position, treasureType, 'player');
            userData.createdTreasures.push(treasureData);
            userData.stats.treasuresCreated += 1;

            // åˆ›å»ºåœ°å›¾æ ‡è®°ï¼ˆä½¿ç”¨ç®€å•å›¾å½¢ä»£æ›¿emojiï¼‰
            const treasureSvg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50">
                    <defs>
                        <radialGradient id="glow-${treasureType.name}" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:${treasureType.color};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:${treasureType.color};stop-opacity:0.2" />
                        </radialGradient>
                    </defs>
                    <circle cx="25" cy="25" r="22" fill="url(#glow-${treasureType.name})" opacity="0.6"/>
                    <circle cx="25" cy="25" r="18" fill="${treasureType.color}" stroke="white" stroke-width="3"/>
                    <circle cx="25" cy="25" r="12" fill="${treasureType.color}" opacity="0.8"/>
                    <circle cx="25" cy="25" r="6" fill="white" opacity="0.9"/>
                    <text x="25" y="30" text-anchor="middle" fill="white" font-size="20" font-weight="bold">?</text>
                </svg>
            `;
            const encodedTreasureSvg = encodeURIComponent(treasureSvg);
            
            const treasureMarker = new AMap.Marker({
                position: position,
                icon: new AMap.Icon({
                    image: 'data:image/svg+xml;charset=utf-8,' + encodedTreasureSvg,
                    size: new AMap.Size(50, 50),
                    imageOffset: new AMap.Pixel(-25, -25)
                }),
                title: `${treasureType.name} (${treasureType.rarity})`,
                zIndex: 500
            });

            // å­˜å‚¨å®è—IDåˆ°æ ‡è®°ä¸Š
            treasureMarker.treasureId = treasureData.id;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            treasureMarker.on('click', function() {
                if (userLocation) {
                    const distance = calculateDistance(userLocation, position);
                    const requiredDistance = treasureData.location.discoveryRadius;
                    
                    if (distance <= requiredDistance) {
                        // å°è¯•å‘ç°å®è—
                        const result = treasureManager.discoverTreasure(treasureData.id, userLocation);
                        
                        if (result.success) {
                            // å‘ç°æˆåŠŸ
                            map.remove(treasureMarker);
                            treasureMarkers = treasureMarkers.filter(m => m !== treasureMarker);
                            
                            let message = `ğŸ‰ æ­å–œï¼æ‚¨å‘ç°äº†${result.treasure.title}ï¼\n`;
                            message += `ğŸ’° è·å¾— ${result.rewards.coins} é‡‘å¸\n`;
                            message += `â­ è·å¾— ${result.rewards.experience} ç»éªŒ`;
                            
                            if (result.levelUp) {
                                message += `\nğŸŠ ç­‰çº§æå‡ï¼LV.${result.levelUp.oldLevel} â†’ LV.${result.levelUp.newLevel}`;
                            }
                            
                            updateStatus(message, 'success');
                            
                            // æ£€æŸ¥æ–°æˆå°±
                            const newAchievements = achievementManager.checkAchievements();
                            if (newAchievements.length > 0) {
                                setTimeout(() => {
                                    updateStatus('ğŸ† è·å¾—æ–°æˆå°±ï¼æŸ¥çœ‹å¾½ç« ç³»ç»Ÿäº†è§£è¯¦æƒ…', 'success');
                                }, 2000);
                            }
                            
                        } else {
                            // å‘ç°å¤±è´¥
                            if (result.reason === 'already_discovered') {
                                updateStatus('æ‚¨å·²ç»å‘ç°è¿‡è¿™ä¸ªå®è—äº†', 'warning');
                            } else if (result.reason === 'too_far') {
                                updateStatus(`è·ç¦»å¤ªè¿œï¼è¿˜éœ€è¦é è¿‘${Math.round(result.distance - result.requiredDistance)}ç±³`, 'warning');
                            }
                        }
                    } else {
                        updateStatus(`${treasureType.name}è·ç¦»æ‚¨è¿˜æœ‰${Math.round(distance)}ç±³ï¼ˆéœ€è¦åœ¨${requiredDistance}ç±³å†…ï¼‰`, 'info');
                        
                        // æ˜¾ç¤ºè·ç¦»æŒ‡ç¤º
                        const infoWindow = new AMap.InfoWindow({
                            content: `
                                <div style="padding: 10px; text-align: center;">
                                    <div style="font-size: 1.2rem; margin-bottom: 5px;">${treasureType.icon} ${treasureType.name}</div>
                                    <div style="color: #666; font-size: 0.9rem;">è·ç¦»: ${Math.round(distance)}ç±³</div>
                                    <div style="color: #666; font-size: 0.9rem;">éœ€è¦: ${requiredDistance}ç±³å†…</div>
                                    <div style="color: #4FC3F7; font-size: 0.8rem; margin-top: 5px;">
                                        ğŸ’° ${treasureType.rewards.coins} é‡‘å¸ | â­ ${treasureType.rewards.experience} ç»éªŒ
                                    </div>
                                </div>
                            `,
                            anchor: 'bottom-center',
                            offset: new AMap.Pixel(0, -5)
                        });
                        infoWindow.open(map, position);
                        
                        // 3ç§’åè‡ªåŠ¨å…³é—­
                        setTimeout(() => {
                            infoWindow.close();
                        }, 3000);
                    }
                }
            });

            // æ·»åŠ åˆ°åœ°å›¾
            map.add(treasureMarker);
            treasureMarkers.push(treasureMarker);
            
            // ä¿å­˜æ•°æ®
            saveUserData();
            updateStats();
        }

        // å›åˆ°æˆ‘çš„ä½ç½®
        function centerToUser() {
            if (!map) {
                updateStatus('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼', 'warning');
                return;
            }
            
            if (!userLocation) {
                updateStatus('è¿˜æ²¡æœ‰è·å–åˆ°ä½ç½®ï¼Œè¯·å…ˆç‚¹å‡»"é‡æ–°å®šä½"', 'warning');
                return;
            }
            
            console.log('ğŸ¯ å¼ºåˆ¶ç§»åŠ¨åœ°å›¾åˆ°ç”¨æˆ·ä½ç½®:', userLocation);
            console.log('å½“å‰åœ°å›¾ä¸­å¿ƒ:', map.getCenter());
            
            // å¤šæ¬¡å¼ºåˆ¶è®¾ç½®ï¼Œç¡®ä¿ç”Ÿæ•ˆ
            map.setZoomAndCenter(18, userLocation);
            
            setTimeout(() => {
                map.setCenter(userLocation);
                map.setZoom(18);
                console.log('âœ… åœ°å›¾ä¸­å¿ƒå·²æ›´æ–°');
            }, 200);
            
            setTimeout(() => {
                map.setCenter(userLocation);
                console.log('âœ… åœ°å›¾ä¸­å¿ƒæœ€ç»ˆç¡®è®¤');
                
                const newCenter = map.getCenter();
                console.log('éªŒè¯æ–°ä¸­å¿ƒ:', [newCenter.lng, newCenter.lat]);
                
                // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæç¤º
                alert(`åœ°å›¾å·²ç§»åŠ¨åˆ°:\nç»åº¦: ${newCenter.lng.toFixed(6)}\nçº¬åº¦: ${newCenter.lat.toFixed(6)}\n\nä½ çš„ä½ç½®:\nç»åº¦: ${userLocation[0].toFixed(6)}\nçº¬åº¦: ${userLocation[1].toFixed(6)}`);
            }, 500);
            
            // å¦‚æœç”¨æˆ·æ ‡è®°å­˜åœ¨ï¼Œè§¦å‘å¼¹è·³åŠ¨ç”»
            if (userMarker) {
                userMarker.setAnimation('AMAP_ANIMATION_BOUNCE');
                setTimeout(() => {
                    userMarker.setAnimation('AMAP_ANIMATION_NONE');
                }, 1000);
            }
            
            updateStatus('ğŸ¯ æ­£åœ¨å›åˆ°æ‚¨çš„ä½ç½®...', 'info');
        }

        // æ¸…ç©ºåœ°å›¾
        function clearMap() {
            if (treasureMarkers.length === 0) {
                updateStatus('åœ°å›¾ä¸Šæ²¡æœ‰å®è—', 'info');
                return;
            }

            map.remove(treasureMarkers);
            treasureMarkers = [];
            updateStatus('ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰å®è—', 'success');
            updateStats();
        }

        // é¦–æ¬¡ä½¿ç”¨æ£€æŸ¥
        function checkFirstTimeUser() {
            const isFirstTime = !localStorage.getItem('totofun-treasure-user');
            if (isFirstTime) {
                // é¦–æ¬¡ä½¿ç”¨ï¼Œæ˜¾ç¤ºæ¬¢è¿å’Œæ˜µç§°è®¾ç½®
                setTimeout(() => {
                    const username = prompt('ğŸ‰ æ¬¢è¿æ¥åˆ° Totofun çªçªç¿»ï¼\n\nè¯·è¾“å…¥ä½ çš„æ¸¸æˆæ˜µç§°ï¼ˆ3-10ä¸ªå­—ç¬¦ï¼‰:\n\nğŸ’¡ æç¤ºï¼šæ˜µç§°ä¼šè‡ªåŠ¨ä¿å­˜ï¼Œä¸‹æ¬¡è®¿é—®æ—¶æ— éœ€é‡æ–°è¾“å…¥', 'å¯»å®æ¢é™©å®¶');
                    if (username && username.length >= 3 && username.length <= 10) {
                        userData.username = username;
                        saveUserData();
                        updateStatus(`æ¬¢è¿ï¼Œ${username}ï¼ä½ çš„æ˜µç§°å·²ä¿å­˜`, 'success');
                        
                        // æ›´æ–°æ˜¾ç¤º
                        document.getElementById('user-name').textContent = username;
                        
                        // æ˜¾ç¤ºç”¨æˆ·IDæç¤º
                        setTimeout(() => {
                            if (chatManager.currentUser) {
                                alert(`âœ… ä½ çš„æ¸¸æˆæ˜µç§°ï¼š${username}\nğŸ†” ä½ çš„ç”¨æˆ·IDï¼š${chatManager.currentUser.id}\n\nğŸ’¡ ç”¨æˆ·IDæ˜¯æ°¸ä¹…çš„ï¼Œå¥½å‹å¯ä»¥é€šè¿‡è¿™ä¸ªIDæ·»åŠ ä½ ï¼\n\nä½ å¯ä»¥åœ¨"æˆ‘çš„ä¿¡æ¯"ä¸­æŸ¥çœ‹å’Œåˆ†äº«ä½ çš„IDã€‚`);
                            }
                        }, 1000);
                    } else if (username) {
                        alert('æ˜µç§°é•¿åº¦åº”è¯¥åœ¨3-10ä¸ªå­—ç¬¦ä¹‹é—´');
                        checkFirstTimeUser();
                    }
                }, 1000);
            } else {
                // è€ç”¨æˆ·ï¼Œæ˜¾ç¤ºæ¬¢è¿å›æ¥æ¶ˆæ¯
                if (userData.username) {
                    updateStatus(`æ¬¢è¿å›æ¥ï¼Œ${userData.username}ï¼`, 'success');
                    document.getElementById('user-name').textContent = userData.username;
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åŠ è½½ç”¨æˆ·æ•°æ®
            loadUserData();

            // æ£€æŸ¥é¦–æ¬¡ç”¨æˆ·
            checkFirstTimeUser();
            
            // è‡ªåŠ¨å¯åŠ¨åœ°å›¾ï¼ˆå»¶è¿Ÿ1ç§’ï¼Œè®©é¡µé¢å…ˆæ¸²æŸ“ï¼‰
            setTimeout(() => {
                initMap();
            }, 1000);

            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            if (userData.stats.treasuresDiscovered > 0) {
                setTimeout(() => {
                    updateStatus(`ä½ å·²å‘ç° ${userData.stats.treasuresDiscovered} ä¸ªå®è—ï¼Œç­‰çº§ LV.${userData.level.currentLevel}ï¼Œç»§ç»­åŠ æ²¹ï¼`, 'success');
                }, 2000);
            }

            // æ›´æ–°åˆå§‹ç»Ÿè®¡
            updateStats();
            
            // æ˜¾ç¤ºç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
            updateUserDisplay();
        });

        // æ›´æ–°ç”¨æˆ·æ˜¾ç¤ºä¿¡æ¯
        function updateUserDisplay() {
            const levelInfo = userManager.getLevelInfo();
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            if (document.getElementById('total-treasures')) {
                document.getElementById('total-treasures').textContent = userData.stats.treasuresDiscovered;
            }
            
            // å¦‚æœæœ‰å¾½ç« æ˜¾ç¤ºåŒºåŸŸï¼Œæ›´æ–°å¾½ç« 
            if (userData.level.badges.length > 0) {
                console.log('ğŸ† å·²è·å¾—å¾½ç« :', userData.level.badges.map(b => `${b.icon} ${b.description}`).join(', '));
            }
        }

        // å¯¼å‡ºç”¨æˆ·æ•°æ®ï¼ˆç”¨äºè°ƒè¯•æˆ–å¤‡ä»½ï¼‰
        function exportUserData() {
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'totofun-treasure-userdata.json';
            a.click();
            URL.revokeObjectURL(url);
            updateStatus('ç”¨æˆ·æ•°æ®å·²å¯¼å‡º', 'success');
        }

        // é‡ç½®ç”¨æˆ·æ•°æ®
        function resetUserData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ¸¸æˆæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                storageManager.remove('totofun-treasure-user');
                location.reload();
            }
        }

        // ç§»åŠ¨ç«¯è°ƒè¯•åŠŸèƒ½
        function debugLocationInfo() {
            let debugInfo = `
                <strong>ğŸ”§ è°ƒè¯•ä¿¡æ¯</strong><br>
                ç”¨æˆ·ä»£ç†: ${navigator.userAgent.substring(0, 50)}...<br>
                æ”¯æŒGPS: ${navigator.geolocation ? 'âœ…' : 'âŒ'}<br>
                å½“å‰æ—¶é—´: ${new Date().toLocaleString()}<br>
                åœ°å›¾çŠ¶æ€: ${map ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}<br>
                ç”¨æˆ·ä½ç½®: ${userLocation ? `${userLocation[1].toFixed(4)}, ${userLocation[0].toFixed(4)}` : 'âŒ æœªè·å–'}<br>
                å®è—æ•°é‡: ${treasureMarkers.length}<br>
                HTTPS: ${location.protocol === 'https:' ? 'âœ…' : 'âŒ GPSéœ€è¦HTTPS'}<br>
            `;
            
            // æ£€æŸ¥æƒé™çŠ¶æ€
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    debugInfo += `GPSæƒé™: ${result.state}<br>`;
                    updateGPSData(debugInfo);
                });
            } else {
                updateGPSData(debugInfo);
            }
        }


        // å¼ºåˆ¶ä½¿ç”¨ä¸Šæµ·ä½ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        function useShanghai() {
            userLocation = [121.4737, 31.2304]; // ä¸Šæµ·å¤–æ»©
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            updateStatus('ğŸ—ºï¸ å·²åˆ‡æ¢åˆ°ä¸Šæµ·å¤–æ»©ä½ç½®', 'success');
            updateGPSData(`
                <strong>ğŸ“ ä¸Šæµ·å¤–æ»©ä½ç½®</strong><br>
                çº¬åº¦: 31.230400 âœ…<br>
                ç»åº¦: 121.473700 âœ…<br>
                ç²¾åº¦: æ¨¡æ‹Ÿä½ç½®<br>
                æ—¶é—´: ${new Date().toLocaleString()}<br>
                <small style="color: #666;">ğŸ¯ ä¸Šæµ·åœ°åŒºæ¨¡æ‹Ÿå®šä½</small>
            `);
            
            // ç”Ÿæˆå®è—
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1000);
        }

        // é”®ç›˜å¿«æ·é”®å’Œè§¦æ‘¸äº‹ä»¶
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        if (!map) initMap();
                        else testGPS();
                        break;
                    case 't':
                        e.preventDefault();
                        addTreasure();
                        break;
                    case 's':
                        e.preventDefault();
                        useShanghai();
                        break;
                    case 'd':
                        e.preventDefault();
                        debugLocationInfo();
                        break;
                    case 'Delete':
                    case 'Backspace':
                        e.preventDefault();
                        clearMap();
                        break;
                }
            }
        });

        // ç§»åŠ¨ç«¯é•¿æŒ‰æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        let touchTimer;
        document.addEventListener('touchstart', function(e) {
            if (e.target.id === 'gps-data') {
                touchTimer = setTimeout(() => {
                    debugLocationInfo();
                }, 1000);
            }
        });

        document.addEventListener('touchend', function() {
            clearTimeout(touchTimer);
        });

        // æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
                        
                        // æ£€æŸ¥æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('ğŸ”„ Service Worker æ›´æ–°ä¸­...');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('âœ¨ æ–°ç‰ˆæœ¬å¯ç”¨ï¼');
                                    // å¯ä»¥æç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢
                                    if (confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('âŒ Service Worker æ³¨å†Œå¤±è´¥:', error);
                    });
                
                // ç›‘å¬ Service Worker æ§åˆ¶æƒå˜åŒ–
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('ğŸ”„ Service Worker å·²æ›´æ–°');
                });
            });
        }

        // PWA å®‰è£…æç¤º
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('ğŸ“± PWA å¯å®‰è£…');
            e.preventDefault();
            deferredPrompt = e;
            
            // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºè‡ªå®šä¹‰å®‰è£…æŒ‰é’®
            // ä¾‹å¦‚ï¼šshowInstallButton();
        });

        window.addEventListener('appinstalled', () => {
            console.log('ğŸ‰ PWA å·²å®‰è£…ï¼');
            deferredPrompt = null;
        });

        // ==================== èŠå¤©åŠŸèƒ½ ====================
        
        // èŠå¤©æ•°æ®ç®¡ç†
        const chatManager = {
            currentUser: null,
            friends: [],
            conversations: {},
            unreadCount: 0,

            // åˆå§‹åŒ–å½“å‰ç”¨æˆ·
            init() {
                // å°è¯•åŠ è½½å·²æœ‰çš„èŠå¤©ç”¨æˆ·
                let savedChatUser = storageManager.load('chatUser');
                
                if (!savedChatUser) {
                    // å¦‚æœæ²¡æœ‰èŠå¤©ç”¨æˆ·ï¼Œåˆ›å»ºä¸€ä¸ªæŒä¹…çš„ID
                    // ä½¿ç”¨å›ºå®šçš„IDç”Ÿæˆæ–¹å¼ï¼Œç¡®ä¿ç”¨æˆ·IDä¸ä¼šæ”¹å˜
                    const userId = this.generatePersistentUserId();
                    
                    // å°è¯•ä»æ¸¸æˆæ•°æ®ä¸­è·å–æ˜µç§°
                    const gameUserData = storageManager.load('totofun-treasure-user');
                    const username = gameUserData?.username || 'æ¸¸å®¢';
                    
                    savedChatUser = {
                        id: userId,
                        name: username,
                        avatar: 'ğŸ‘¤',
                        online: true,
                        createdAt: new Date().toISOString()
                    };
                    
                    storageManager.save('chatUser', savedChatUser);
                } else {
                    // åŒæ­¥æ¸¸æˆæ˜µç§°åˆ°èŠå¤©æ˜µç§°
                    const gameUserData = storageManager.load('totofun-treasure-user');
                    if (gameUserData?.username && gameUserData.username !== savedChatUser.name) {
                        savedChatUser.name = gameUserData.username;
                        storageManager.save('chatUser', savedChatUser);
                    }
                }
                
                this.currentUser = savedChatUser;
                
                // åŠ è½½å¥½å‹åˆ—è¡¨
                this.friends = storageManager.load('chatFriends') || this.getDefaultFriends();
                storageManager.save('chatFriends', this.friends);
                
                // åŠ è½½å¯¹è¯è®°å½•
                this.conversations = storageManager.load('chatConversations') || {};
                
                this.updateUnreadCount();
            },
            
            // ç”ŸæˆæŒä¹…çš„ç”¨æˆ·IDï¼ˆåŸºäºæµè§ˆå™¨æŒ‡çº¹ï¼‰
            generatePersistentUserId() {
                // å°è¯•ä»localStorageè·å–å·²å­˜åœ¨çš„ID
                let userId = localStorage.getItem('totofun-user-id');
                
                if (!userId) {
                    // ç”Ÿæˆæ–°çš„æŒä¹…ID
                    // ä½¿ç”¨æ—¶é—´æˆ³ + éšæœºæ•° + æµè§ˆå™¨ä¿¡æ¯
                    const timestamp = Date.now();
                    const random = Math.random().toString(36).substring(2, 15);
                    const browserInfo = navigator.userAgent.substring(0, 20).replace(/[^a-zA-Z0-9]/g, '');
                    userId = `user_${timestamp}_${random}_${browserInfo}`.substring(0, 50);
                    
                    // æ°¸ä¹…ä¿å­˜
                    localStorage.setItem('totofun-user-id', userId);
                }
                
                return userId;
            },

            // è·å–é»˜è®¤å¥½å‹ï¼ˆæ¼”ç¤ºç”¨ï¼‰- ç°åœ¨è¿”å›ç©ºæ•°ç»„ï¼Œè®©ç”¨æˆ·è‡ªå·±æ·»åŠ 
            getDefaultFriends() {
                return [];
            },

            // æ˜¾ç¤ºæ·»åŠ å¥½å‹é¢æ¿
            showAddFriend() {
                document.getElementById('add-friend-panel').style.display = 'flex';
                document.getElementById('my-profile-panel').style.display = 'none';
                document.getElementById('chat-container').style.display = 'none';
                document.getElementById('my-id-display').value = this.currentUser.id;
            },

            // å…³é—­æ·»åŠ å¥½å‹é¢æ¿
            closeAddFriend() {
                document.getElementById('add-friend-panel').style.display = 'none';
            },

            // é€šè¿‡IDæ·»åŠ å¥½å‹
            addFriendById() {
                const friendId = document.getElementById('friend-id-input').value.trim();
                if (!friendId) {
                    alert('è¯·è¾“å…¥å¥½å‹ID');
                    return;
                }

                if (friendId === this.currentUser.id) {
                    alert('ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹');
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¥½å‹
                if (this.friends.find(f => f.id === friendId)) {
                    alert('è¯¥ç”¨æˆ·å·²ç»æ˜¯ä½ çš„å¥½å‹äº†');
                    return;
                }

                // åˆ›å»ºæ–°å¥½å‹ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥ä»æœåŠ¡å™¨è·å–ç”¨æˆ·ä¿¡æ¯ï¼‰
                const newFriend = {
                    id: friendId,
                    name: 'æ–°å¥½å‹',
                    avatar: 'ğŸ‘¤',
                    online: true,
                    lastMessage: '',
                    lastTime: new Date().toISOString()
                };

                this.friends.push(newFriend);
                this.saveData();
                
                alert('âœ… æ·»åŠ å¥½å‹æˆåŠŸï¼\n\nè¯·è®©ä½ çš„æœ‹å‹ä¹Ÿæ·»åŠ ä½ çš„IDï¼š\n' + this.currentUser.id);
                
                document.getElementById('friend-id-input').value = '';
                this.closeAddFriend();
                this.toggleChat();
                this.updateFriendsList();
            },

            // å¤åˆ¶æˆ‘çš„ID
            copyMyId() {
                const idInput = document.getElementById('my-id-display');
                idInput.select();
                document.execCommand('copy');
                
                // æ˜¾ç¤ºæç¤º
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ å·²å¤åˆ¶';
                btn.style.background = '#22C55E';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#4FC3F7';
                }, 2000);
            },

            // ç”Ÿæˆåˆ†äº«é“¾æ¥
            generateShareLink() {
                const baseUrl = window.location.href.split('?')[0];
                const shareUrl = `${baseUrl}?addFriend=${this.currentUser.id}`;
                
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                const tempInput = document.createElement('input');
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                alert('ğŸ”— åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n' + shareUrl + '\n\nå°†æ­¤é“¾æ¥å‘é€ç»™æœ‹å‹ï¼Œä»–ä»¬ç‚¹å‡»åä¼šè‡ªåŠ¨æ·»åŠ ä½ ä¸ºå¥½å‹ã€‚');
            },

            // æ˜¾ç¤ºæˆ‘çš„ä¿¡æ¯é¢æ¿
            showMyProfile() {
                document.getElementById('my-profile-panel').style.display = 'flex';
                document.getElementById('add-friend-panel').style.display = 'none';
                document.getElementById('chat-container').style.display = 'none';
                
                // å¡«å……ä¿¡æ¯
                document.getElementById('profile-avatar').textContent = this.currentUser.avatar;
                document.getElementById('profile-name-input').value = this.currentUser.name;
                document.getElementById('profile-my-id').textContent = this.currentUser.id;
                document.getElementById('profile-friends-count').textContent = this.friends.length;
                
                // è®¡ç®—æ¶ˆæ¯æ€»æ•°
                let totalMessages = 0;
                Object.values(this.conversations).forEach(conv => {
                    totalMessages += conv.length;
                });
                document.getElementById('profile-messages-count').textContent = totalMessages;
                
                // ç”Ÿæˆå¤´åƒé€‰æ‹©å™¨
                this.generateAvatarSelector();
            },

            // å…³é—­æˆ‘çš„ä¿¡æ¯é¢æ¿
            closeMyProfile() {
                document.getElementById('my-profile-panel').style.display = 'none';
            },

            // æ›´æ–°ä¸ªäººèµ„æ–™
            updateProfile() {
                const newName = document.getElementById('profile-name-input').value.trim();
                if (newName && newName.length >= 3 && newName.length <= 10) {
                    this.currentUser.name = newName;
                    storageManager.save('chatUser', this.currentUser);
                    
                    // åŒæ­¥åˆ°æ¸¸æˆæ˜µç§°
                    userData.username = newName;
                    saveUserData();
                    
                    // æ›´æ–°ä¸»é¡µæ˜¾ç¤º
                    document.getElementById('user-name').textContent = newName;
                    
                    alert('âœ… ä¸ªäººä¿¡æ¯å·²æ›´æ–°ï¼\n\næ˜µç§°å·²åŒæ­¥åˆ°æ¸¸æˆå’ŒèŠå¤©ç³»ç»Ÿã€‚');
                } else if (newName) {
                    alert('âŒ æ˜µç§°é•¿åº¦åº”è¯¥åœ¨3-10ä¸ªå­—ç¬¦ä¹‹é—´');
                }
            },

            // ç”Ÿæˆå¤´åƒé€‰æ‹©å™¨
            generateAvatarSelector() {
                const avatars = ['ğŸ‘¤', 'ğŸ‘¨', 'ğŸ‘©', 'ğŸ§‘', 'ğŸ‘¨â€ğŸ’¼', 'ğŸ‘©â€ğŸ’¼', 'ğŸ‘¨â€ğŸ“', 'ğŸ‘©â€ğŸ“', 'ğŸ‘¨â€ğŸš€', 'ğŸ‘©â€ğŸš€', 
                                'ğŸ§‘â€ğŸš€', 'ğŸ‘¨â€ğŸ¨', 'ğŸ‘©â€ğŸ¨', 'ğŸ‘¨â€ğŸ”§', 'ğŸ‘©â€ğŸ”§', 'ğŸ˜€', 'ğŸ˜', 'ğŸ¤“', 'ğŸ¥³', 'ğŸ¤ '];
                
                const selector = document.getElementById('avatar-selector');
                selector.innerHTML = '';
                
                avatars.forEach(avatar => {
                    const btn = document.createElement('button');
                    btn.textContent = avatar;
                    btn.style.cssText = `
                        font-size: 32px;
                        padding: 10px;
                        border: 2px solid ${this.currentUser.avatar === avatar ? '#4FC3F7' : '#e0e0e0'};
                        border-radius: 10px;
                        background: ${this.currentUser.avatar === avatar ? '#e3f2fd' : 'white'};
                        cursor: pointer;
                        transition: all 0.2s;
                    `;
                    btn.onclick = () => {
                        this.currentUser.avatar = avatar;
                        storageManager.save('chatUser', this.currentUser);
                        document.getElementById('profile-avatar').textContent = avatar;
                        this.generateAvatarSelector();
                    };
                    selector.appendChild(btn);
                });
            },

            // æ£€æŸ¥URLå‚æ•°ï¼Œè‡ªåŠ¨æ·»åŠ å¥½å‹å’Œæ¥æ”¶æ¶ˆæ¯
            checkUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                
                // 1. å¤„ç†æ·»åŠ å¥½å‹
                const friendId = urlParams.get('addFriend');
                if (friendId && friendId !== this.currentUser.id) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¥½å‹
                    if (!this.friends.find(f => f.id === friendId)) {
                        const newFriend = {
                            id: friendId,
                            name: 'æ–°å¥½å‹',
                            avatar: 'ğŸ‘¤',
                            online: true,
                            lastMessage: '',
                            lastTime: new Date().toISOString()
                        };
                        this.friends.push(newFriend);
                        this.saveData();
                        
                        alert('ğŸ‰ å·²è‡ªåŠ¨æ·»åŠ å¥½å‹ï¼\n\nè¯·åˆ†äº«ä½ çš„IDç»™å¯¹æ–¹ï¼š\n' + this.currentUser.id);
                        this.toggleChat();
                    }
                }
                
                // 2. å¤„ç†æ¥æ”¶æ¶ˆæ¯
                const receiveMessage = urlParams.get('receiveMessage');
                if (receiveMessage) {
                    try {
                        // è§£ç æ¶ˆæ¯æ•°æ®
                        const messageData = JSON.parse(atob(receiveMessage));
                        
                        // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æ˜¯å‘ç»™å½“å‰ç”¨æˆ·çš„
                        if (messageData.to === this.currentUser.id) {
                            // ç¡®ä¿å‘é€è€…æ˜¯å¥½å‹
                            let sender = this.friends.find(f => f.id === messageData.from);
                            if (!sender) {
                                // å¦‚æœä¸æ˜¯å¥½å‹ï¼Œå…ˆæ·»åŠ ä¸ºå¥½å‹
                                sender = {
                                    id: messageData.from,
                                    name: messageData.fromName || 'æ–°å¥½å‹',
                                    avatar: 'ğŸ‘¤',
                                    online: true,
                                    lastMessage: '',
                                    lastTime: new Date().toISOString()
                                };
                                this.friends.push(sender);
                                this.saveData();
                            }
                            
                            // ä¿å­˜æ¶ˆæ¯
                            if (!this.conversations[messageData.from]) {
                                this.conversations[messageData.from] = [];
                            }
                            
                            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤ï¼‰
                            const messageExists = this.conversations[messageData.from].some(
                                m => m.timestamp === messageData.timestamp && m.content === messageData.content
                            );
                            
                            if (!messageExists) {
                                const receivedMessage = {
                                    id: 'msg_' + Date.now(),
                                    from: messageData.from,
                                    to: this.currentUser.id,
                                    content: messageData.content,
                                    type: messageData.type || 'text',
                                    timestamp: messageData.timestamp,
                                    read: false
                                };
                                
                                this.conversations[messageData.from].push(receivedMessage);
                                
                                // æ›´æ–°å¥½å‹æœ€åæ¶ˆæ¯
                                sender.lastMessage = messageData.type === 'location' ? 'ğŸ“ ä½ç½®' : messageData.content;
                                sender.lastTime = messageData.timestamp;
                                
                                this.updateUnreadCount();
                                this.saveData();
                                
                                // æ¸…é™¤URLå‚æ•°
                                window.history.replaceState({}, document.title, window.location.pathname);
                                
                                // æ˜¾ç¤ºé€šçŸ¥
                                alert(`ğŸ’¬ æ”¶åˆ°æ¥è‡ª ${sender.name} çš„æ¶ˆæ¯ï¼\n\næ¶ˆæ¯å†…å®¹ï¼š${messageData.content}\n\nç‚¹å‡»ğŸ’¬æŒ‰é’®æŸ¥çœ‹æ¶ˆæ¯`);
                                
                                // å¦‚æœèŠå¤©çª—å£å·²æ‰“å¼€ï¼Œæ›´æ–°æ˜¾ç¤º
                                if (document.getElementById('chat-container').style.display !== 'none') {
                                    this.updateFriendsList();
                                }
                            }
                        } else {
                            // æ¶ˆæ¯ä¸æ˜¯å‘ç»™å½“å‰ç”¨æˆ·çš„
                            window.history.replaceState({}, document.title, window.location.pathname);
                            alert('âš ï¸ è¿™æ¡æ¶ˆæ¯ä¸æ˜¯å‘ç»™ä½ çš„ï¼Œè¯·ç¡®è®¤é“¾æ¥æ˜¯å¦æ­£ç¡®ã€‚');
                        }
                    } catch (error) {
                        console.error('è§£ææ¶ˆæ¯å¤±è´¥:', error);
                        window.history.replaceState({}, document.title, window.location.pathname);
                        alert('âŒ æ¶ˆæ¯æ ¼å¼é”™è¯¯ï¼Œæ— æ³•æ¥æ”¶ã€‚');
                    }
                }
            },

            // å‘é€æ¶ˆæ¯
            sendMessage(friendId, content, type = 'text') {
                const message = {
                    id: 'msg_' + Date.now(),
                    from: this.currentUser.id,
                    to: friendId,
                    content: content,
                    type: type,
                    timestamp: new Date().toISOString(),
                    read: false
                };

                if (!this.conversations[friendId]) {
                    this.conversations[friendId] = [];
                }
                this.conversations[friendId].push(message);
                
                // æ›´æ–°å¥½å‹æœ€åæ¶ˆæ¯
                const friend = this.friends.find(f => f.id === friendId);
                if (friend) {
                    friend.lastMessage = type === 'text' ? content : 'ğŸ“ ä½ç½®';
                    friend.lastTime = message.timestamp;
                }

                this.saveData();
                
                return message;
            },
            
            // ç”Ÿæˆæ¶ˆæ¯åˆ†äº«é“¾æ¥ï¼ˆç”¨äºè·¨è®¾å¤‡é€šä¿¡ï¼‰
            generateMessageLink(friendId, message) {
                // å°†æ¶ˆæ¯ç¼–ç åˆ°URLä¸­
                const messageData = {
                    from: message.from,
                    fromName: this.currentUser.name,
                    to: friendId,
                    content: message.content,
                    type: message.type,
                    timestamp: message.timestamp
                };
                
                // ä½¿ç”¨Base64ç¼–ç æ¶ˆæ¯æ•°æ®
                const encodedData = btoa(JSON.stringify(messageData));
                const baseUrl = window.location.href.split('?')[0];
                const messageUrl = `${baseUrl}?receiveMessage=${encodedData}`;
                
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                const tempInput = document.createElement('input');
                tempInput.value = messageUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                return messageUrl;
            },

            // å·²ç§»é™¤æœºå™¨äººå›å¤åŠŸèƒ½ - ç°åœ¨åªæ”¯æŒçœŸäººä¹‹é—´çš„é€šä¿¡

            // æ›´æ–°æœªè¯»æ¶ˆæ¯æ•°
            updateUnreadCount() {
                this.unreadCount = 0;
                Object.keys(this.conversations).forEach(friendId => {
                    const messages = this.conversations[friendId];
                    this.unreadCount += messages.filter(m => m.from !== this.currentUser.id && !m.read).length;
                });
                
                const badge = document.getElementById('chat-badge');
                if (this.unreadCount > 0) {
                    badge.textContent = this.unreadCount > 99 ? '99+' : this.unreadCount;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            },

            // æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
            markAsRead(friendId) {
                if (this.conversations[friendId]) {
                    this.conversations[friendId].forEach(m => {
                        if (m.from === friendId) {
                            m.read = true;
                        }
                    });
                    this.updateUnreadCount();
                    this.saveData();
                }
            },

            // ä¿å­˜æ•°æ®
            saveData() {
                storageManager.save('chatConversations', this.conversations);
                storageManager.save('chatFriends', this.friends);
            },

            // æ‰“å¼€èŠå¤©çª—å£
            openChat(friendId) {
                const friend = this.friends.find(f => f.id === friendId);
                if (!friend) return;

                this.markAsRead(friendId);

                const chatPanel = document.getElementById('chat-panel');
                chatPanel.dataset.friendId = friendId;
                chatPanel.style.display = 'flex';

                // æ›´æ–°èŠå¤©å¤´éƒ¨
                document.getElementById('chat-friend-name').textContent = friend.name;
                document.getElementById('chat-friend-avatar').textContent = friend.avatar;
                document.getElementById('chat-friend-status').textContent = friend.online ? 'åœ¨çº¿' : 'ç¦»çº¿';
                document.getElementById('chat-friend-status').style.color = friend.online ? '#22C55E' : '#999';

                // æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨
                const messagesList = document.getElementById('chat-messages-list');
                messagesList.innerHTML = '';

                const messages = this.conversations[friendId] || [];
                messages.forEach(msg => {
                    const isMe = msg.from === this.currentUser.id;
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'chat-message ' + (isMe ? 'chat-message-me' : 'chat-message-other');
                    
                    if (msg.type === 'text') {
                        messageDiv.innerHTML = `
                            <div class="chat-message-avatar">${isMe ? this.currentUser.avatar : friend.avatar}</div>
                            <div class="chat-message-content">
                                <div class="chat-message-bubble">${this.escapeHtml(msg.content)}</div>
                                <div class="chat-message-time">${this.formatTime(msg.timestamp)}</div>
                            </div>
                        `;
                    } else if (msg.type === 'location') {
                        messageDiv.innerHTML = `
                            <div class="chat-message-avatar">${isMe ? this.currentUser.avatar : friend.avatar}</div>
                            <div class="chat-message-content">
                                <div class="chat-message-bubble chat-location-message">
                                    <div style="font-size: 24px; margin-bottom: 5px;">ğŸ“</div>
                                    <div><strong>ä½ç½®åˆ†äº«</strong></div>
                                    <div style="font-size: 0.9em; opacity: 0.8;">${msg.content}</div>
                                    <button onclick="chatManager.viewLocation(${msg.content})" class="chat-location-btn">æŸ¥çœ‹ä½ç½®</button>
                                </div>
                                <div class="chat-message-time">${this.formatTime(msg.timestamp)}</div>
                            </div>
                        `;
                    }
                    
                    messagesList.appendChild(messageDiv);
                });

                // æ»šåŠ¨åˆ°åº•éƒ¨
                messagesList.scrollTop = messagesList.scrollHeight;

                // éšè—å¥½å‹åˆ—è¡¨
                document.getElementById('friends-panel').style.display = 'none';
            },

            // å…³é—­èŠå¤©çª—å£
            closeChat() {
                document.getElementById('chat-panel').style.display = 'none';
                document.getElementById('friends-panel').style.display = 'block';
            },

            // å‘é€æ–‡æœ¬æ¶ˆæ¯
            sendTextMessage() {
                const input = document.getElementById('chat-input');
                const content = input.value.trim();
                if (!content) return;

                const friendId = document.getElementById('chat-panel').dataset.friendId;
                const message = this.sendMessage(friendId, content, 'text');
                input.value = '';

                // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢
                this.openChat(friendId);
                
                // æç¤ºç”¨æˆ·å¦‚ä½•åˆ†äº«æ¶ˆæ¯ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡å‘é€æ—¶æ˜¾ç¤ºï¼‰
                if (!localStorage.getItem('messageShareTipShown')) {
                    setTimeout(() => {
                        const share = confirm('ğŸ’¬ æ¶ˆæ¯å·²å‘é€åˆ°æœ¬åœ°ï¼\n\nğŸ“± ç”±äºæ˜¯çº¯å‰ç«¯åº”ç”¨ï¼Œå¥½å‹éœ€è¦æ‰“å¼€ä½ å‘é€çš„æ¶ˆæ¯é“¾æ¥æ‰èƒ½çœ‹åˆ°ã€‚\n\næ˜¯å¦ç”Ÿæˆæ¶ˆæ¯åˆ†äº«é“¾æ¥ï¼Ÿ\n\nï¼ˆç‚¹å‡»"ç¡®å®š"ç”Ÿæˆé“¾æ¥ï¼Œç‚¹å‡»"å–æ¶ˆ"è·³è¿‡ï¼‰');
                        if (share) {
                            const messageUrl = this.generateMessageLink(friendId, message);
                            alert('âœ… æ¶ˆæ¯é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nğŸ“‹ é“¾æ¥ï¼š' + messageUrl.substring(0, 80) + '...\n\nğŸ’¡ ä½¿ç”¨æ–¹æ³•ï¼š\n1. å°†é“¾æ¥é€šè¿‡å¾®ä¿¡/QQç­‰å‘é€ç»™å¥½å‹\n2. å¥½å‹ç‚¹å‡»é“¾æ¥åä¼šè‡ªåŠ¨æ¥æ”¶æ¶ˆæ¯\n3. å¥½å‹éœ€è¦å…ˆæ·»åŠ ä½ ä¸ºå¥½å‹ï¼ˆé€šè¿‡ä½ çš„IDï¼‰');
                        }
                        localStorage.setItem('messageShareTipShown', 'true');
                    }, 300);
                }
            },

            // åˆ†äº«å½“å‰ä½ç½®
            shareLocation() {
                const friendId = document.getElementById('chat-panel').dataset.friendId;
                if (!currentPosition) {
                    alert('è¯·å…ˆè·å–GPSå®šä½');
                    return;
                }

                const locationText = `${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}`;
                this.sendMessage(friendId, locationText, 'location');
                this.openChat(friendId);
            },

            // æŸ¥çœ‹ä½ç½®
            viewLocation(coords) {
                alert('æŸ¥çœ‹ä½ç½®ï¼š' + coords + '\nï¼ˆå°†åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºï¼‰');
                // è¿™é‡Œå¯ä»¥å…³é—­èŠå¤©çª—å£å¹¶åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºä½ç½®
                this.toggleChat();
            },

            // æ›´æ–°å¥½å‹åˆ—è¡¨
            updateFriendsList() {
                const friendsList = document.getElementById('friends-list');
                friendsList.innerHTML = '';

                // æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´æ’åº
                const sortedFriends = [...this.friends].sort((a, b) => {
                    return new Date(b.lastTime || 0) - new Date(a.lastTime || 0);
                });

                sortedFriends.forEach(friend => {
                    const unread = this.conversations[friend.id] ? 
                        this.conversations[friend.id].filter(m => m.from === friend.id && !m.read).length : 0;

                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'friend-item';
                    friendDiv.onclick = () => this.openChat(friend.id);
                    friendDiv.innerHTML = `
                        <div class="friend-avatar">${friend.avatar}</div>
                        <div class="friend-info">
                            <div class="friend-name">
                                ${friend.name}
                                <span class="friend-status" style="color: ${friend.online ? '#22C55E' : '#999'}">
                                    ${friend.online ? 'â—' : 'â—‹'}
                                </span>
                            </div>
                            <div class="friend-last-message">${friend.lastMessage || 'æš‚æ— æ¶ˆæ¯'}</div>
                        </div>
                        <div class="friend-meta">
                            <div class="friend-time">${this.formatTime(friend.lastTime)}</div>
                            ${unread > 0 ? `<div class="friend-unread">${unread}</div>` : ''}
                        </div>
                    `;
                    friendsList.appendChild(friendDiv);
                });
            },

            // åˆ‡æ¢èŠå¤©é¢æ¿æ˜¾ç¤º
            toggleChat() {
                const chatContainer = document.getElementById('chat-container');
                if (chatContainer.style.display === 'none' || !chatContainer.style.display) {
                    chatContainer.style.display = 'block';
                    this.updateFriendsList();
                } else {
                    chatContainer.style.display = 'none';
                    document.getElementById('chat-panel').style.display = 'none';
                    document.getElementById('friends-panel').style.display = 'block';
                }
            },

            // æ ¼å¼åŒ–æ—¶é—´
            formatTime(timestamp) {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;

                if (diff < 60000) return 'åˆšåˆš';
                if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
                if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
                if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
                
                return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
            },

            // HTMLè½¬ä¹‰
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // åˆå§‹åŒ–èŠå¤©ç³»ç»Ÿ
        chatManager.init();
        chatManager.checkUrlParams();
    </script>

    <!-- èŠå¤©æµ®åŠ¨æŒ‰é’® -->
    <div id="chat-fab" onclick="chatManager.toggleChat()" style="
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(79, 195, 247, 0.5);
        z-index: 9999;
        transition: all 0.3s ease;
        font-size: 28px;
    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        ğŸ’¬
        <div id="chat-badge" style="
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f44336;
            color: white;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            display: none;
            min-width: 20px;
            text-align: center;
        "></div>
    </div>

    <!-- èŠå¤©å®¹å™¨ -->
    <div id="chat-container" style="
        display: none;
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 380px;
        height: 600px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        z-index: 9998;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    ">
        <!-- å¥½å‹åˆ—è¡¨é¢æ¿ -->
        <div id="friends-panel" style="
            display: flex;
            flex-direction: column;
            height: 100%;
        ">
            <div style="
                background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
                color: white;
                padding: 20px;
                font-weight: bold;
                font-size: 18px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <span>ğŸ’¬ å¥½å‹èŠå¤©</span>
                <div style="display: flex; gap: 10px;">
                    <button onclick="chatManager.showAddFriend()" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: none;
                        color: white;
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 18px;
                        line-height: 1;
                    " title="æ·»åŠ å¥½å‹">+</button>
                    <button onclick="chatManager.showMyProfile()" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: none;
                        color: white;
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 16px;
                        line-height: 1;
                    " title="æˆ‘çš„ä¿¡æ¯">ğŸ‘¤</button>
                    <button onclick="chatManager.toggleChat()" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: none;
                        color: white;
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 20px;
                        line-height: 1;
                    ">Ã—</button>
                </div>
            </div>
            <div id="friends-list" style="
                flex: 1;
                overflow-y: auto;
                padding: 10px;
            "></div>
        </div>

        <!-- èŠå¤©é¢æ¿ -->
        <div id="chat-panel" style="
            display: none;
            flex-direction: column;
            height: 100%;
        ">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div style="
                background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
                color: white;
                padding: 15px 20px;
                display: flex;
                align-items: center;
                gap: 15px;
            ">
                <button onclick="chatManager.closeChat()" style="
                    background: rgba(255, 255, 255, 0.2);
                    border: none;
                    color: white;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 18px;
                    line-height: 1;
                ">â†</button>
                <div id="chat-friend-avatar" style="font-size: 24px;"></div>
                <div style="flex: 1;">
                    <div id="chat-friend-name" style="font-weight: bold; font-size: 16px;"></div>
                    <div id="chat-friend-status" style="font-size: 12px; opacity: 0.9;"></div>
                </div>
            </div>

            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <div id="chat-messages-list" style="
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                background: #f5f5f5;
            "></div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div style="
                padding: 15px;
                background: white;
                border-top: 1px solid #e0e0e0;
                display: flex;
                gap: 10px;
                align-items: center;
            ">
                <button onclick="chatManager.shareLocation()" style="
                    background: #4FC3F7;
                    border: none;
                    color: white;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 20px;
                    flex-shrink: 0;
                ">ğŸ“</button>
                <input id="chat-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." style="
                    flex: 1;
                    padding: 10px 15px;
                    border: 1px solid #e0e0e0;
                    border-radius: 20px;
                    outline: none;
                    font-size: 14px;
                " onkeypress="if(event.key==='Enter') chatManager.sendTextMessage()">
                <button onclick="chatManager.sendTextMessage()" style="
                    background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
                    border: none;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-weight: bold;
                    flex-shrink: 0;
                ">å‘é€</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¥½å‹é¢æ¿ -->
    <div id="add-friend-panel" style="
        display: none;
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 380px;
        height: 500px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        overflow: hidden;
        flex-direction: column;
    ">
        <div style="
            background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
            color: white;
            padding: 20px;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        ">
            <span>â• æ·»åŠ å¥½å‹</span>
            <button onclick="chatManager.closeAddFriend()" style="
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 20px;
                line-height: 1;
            ">Ã—</button>
        </div>
        
        <div style="padding: 20px; flex: 1; overflow-y: auto;">
            <!-- è¾“å…¥å¥½å‹ID -->
            <div style="margin-bottom: 25px;">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">é€šè¿‡IDæ·»åŠ </h3>
                <input id="friend-id-input" type="text" placeholder="è¾“å…¥å¥½å‹ID" style="
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #e0e0e0;
                    border-radius: 10px;
                    font-size: 14px;
                    margin-bottom: 10px;
                    box-sizing: border-box;
                ">
                <button onclick="chatManager.addFriendById()" style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 14px;
                ">æ·»åŠ å¥½å‹</button>
            </div>

            <!-- åˆ†äº«æˆ‘çš„ID -->
            <div style="margin-bottom: 25px;">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">åˆ†äº«æˆ‘çš„ID</h3>
                <div style="
                    background: #f5f5f5;
                    padding: 15px;
                    border-radius: 10px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                ">
                    <input id="my-id-display" type="text" readonly style="
                        flex: 1;
                        padding: 10px;
                        border: 1px solid #e0e0e0;
                        border-radius: 8px;
                        font-family: monospace;
                        font-size: 13px;
                        background: white;
                    ">
                    <button onclick="chatManager.copyMyId()" style="
                        padding: 10px 15px;
                        background: #4FC3F7;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 13px;
                        white-space: nowrap;
                    ">å¤åˆ¶</button>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 8px;">
                    ğŸ’¡ å°†æ­¤IDå‘é€ç»™æœ‹å‹ï¼Œè®©ä»–ä»¬æ·»åŠ ä½ 
                </p>
            </div>

            <!-- ç”Ÿæˆåˆ†äº«é“¾æ¥ -->
            <div style="margin-bottom: 25px;">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">ç”Ÿæˆåˆ†äº«é“¾æ¥</h3>
                <button onclick="chatManager.generateShareLink()" style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, #22C55E 0%, #4FC3F7 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 14px;
                ">ğŸ”— ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
                <p style="font-size: 12px; color: #666; margin-top: 8px;">
                    ğŸ’¡ ç”Ÿæˆä¸€ä¸ªé“¾æ¥ï¼Œæœ‹å‹ç‚¹å‡»åè‡ªåŠ¨æ·»åŠ ä½ ä¸ºå¥½å‹
                </p>
            </div>

            <!-- æ‰«æäºŒç»´ç ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰ -->
            <div style="
                background: #f9f9f9;
                padding: 15px;
                border-radius: 10px;
                text-align: center;
                border: 2px dashed #ddd;
            ">
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“±</div>
                <p style="color: #999; font-size: 13px;">æ‰«æäºŒç»´ç æ·»åŠ å¥½å‹</p>
                <p style="color: #999; font-size: 12px; margin-top: 5px;">ï¼ˆå³å°†æ¨å‡ºï¼‰</p>
            </div>
        </div>
    </div>

    <!-- æˆ‘çš„ä¿¡æ¯é¢æ¿ -->
    <div id="my-profile-panel" style="
        display: none;
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 380px;
        height: 500px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        overflow: hidden;
        flex-direction: column;
    ">
        <div style="
            background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
            color: white;
            padding: 20px;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        ">
            <span>ğŸ‘¤ æˆ‘çš„ä¿¡æ¯</span>
            <button onclick="chatManager.closeMyProfile()" style="
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 20px;
                line-height: 1;
            ">Ã—</button>
        </div>
        
        <div style="padding: 20px; flex: 1; overflow-y: auto;">
            <!-- å¤´åƒå’Œæ˜µç§° -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div id="profile-avatar" style="
                    font-size: 80px;
                    margin-bottom: 15px;
                ">ğŸ‘¤</div>
                <input id="profile-name-input" type="text" placeholder="è¾“å…¥æ˜µç§°" style="
                    width: 200px;
                    padding: 10px;
                    border: 2px solid #e0e0e0;
                    border-radius: 10px;
                    font-size: 16px;
                    text-align: center;
                    font-weight: bold;
                ">
                <button onclick="chatManager.updateProfile()" style="
                    display: block;
                    margin: 10px auto 0;
                    padding: 8px 20px;
                    background: #4FC3F7;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 13px;
                ">ä¿å­˜</button>
            </div>

            <!-- æˆ‘çš„ID -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 14px;">æˆ‘çš„ID</h3>
                <div style="
                    background: #f5f5f5;
                    padding: 12px;
                    border-radius: 8px;
                    font-family: monospace;
                    font-size: 13px;
                    word-break: break-all;
                " id="profile-my-id"></div>
            </div>

            <!-- é€‰æ‹©å¤´åƒ -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 14px;">é€‰æ‹©å¤´åƒ</h3>
                <div id="avatar-selector" style="
                    display: grid;
                    grid-template-columns: repeat(5, 1fr);
                    gap: 10px;
                ">
                    <!-- å¤´åƒé€‰é¡¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div style="
                background: linear-gradient(135deg, #f5f5f5 0%, #e9ecef 100%);
                padding: 15px;
                border-radius: 10px;
            ">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 14px;">ç»Ÿè®¡</h3>
                <div style="display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #4FC3F7;" id="profile-friends-count">0</div>
                        <div style="font-size: 12px; color: #666;">å¥½å‹</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #22C55E;" id="profile-messages-count">0</div>
                        <div style="font-size: 12px; color: #666;">æ¶ˆæ¯</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* å¥½å‹åˆ—è¡¨é¡¹æ ·å¼ */
        .friend-item {
            display: flex;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            border-radius: 10px;
            transition: background 0.2s;
            gap: 12px;
        }
        .friend-item:hover {
            background: #f5f5f5;
        }
        .friend-avatar {
            font-size: 32px;
            flex-shrink: 0;
        }
        .friend-info {
            flex: 1;
            min-width: 0;
        }
        .friend-name {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .friend-status {
            font-size: 12px;
        }
        .friend-last-message {
            font-size: 13px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .friend-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
            flex-shrink: 0;
        }
        .friend-time {
            font-size: 11px;
            color: #999;
        }
        .friend-unread {
            background: #f44336;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
        }

        /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
        .chat-message {
            display: flex;
            margin-bottom: 15px;
            gap: 10px;
        }
        .chat-message-me {
            flex-direction: row-reverse;
        }
        .chat-message-avatar {
            font-size: 28px;
            flex-shrink: 0;
        }
        .chat-message-content {
            max-width: 70%;
        }
        .chat-message-me .chat-message-content {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .chat-message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .chat-message-other .chat-message-bubble {
            background: white;
            color: #333;
        }
        .chat-message-me .chat-message-bubble {
            background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
            color: white;
        }
        .chat-message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 5px;
        }
        .chat-location-message {
            text-align: center;
            padding: 15px !important;
        }
        .chat-location-btn {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: inherit;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
        }
        .chat-location-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            #chat-container {
                width: 100vw;
                height: 100vh;
                bottom: 0;
                right: 0;
                left: 0;
                top: 0;
                border-radius: 0;
                max-width: 100%;
                max-height: 100%;
            }
            
            /* æ·»åŠ å¥½å‹é¢æ¿ç§»åŠ¨ç«¯é€‚é… */
            #add-friend-panel {
                width: 100vw !important;
                height: 100vh !important;
                bottom: 0 !important;
                right: 0 !important;
                left: 0 !important;
                top: 0 !important;
                border-radius: 0 !important;
                max-width: 100%;
                max-height: 100%;
            }
            
            /* æˆ‘çš„ä¿¡æ¯é¢æ¿ç§»åŠ¨ç«¯é€‚é… */
            #my-profile-panel {
                width: 100vw !important;
                height: 100vh !important;
                bottom: 0 !important;
                right: 0 !important;
                left: 0 !important;
                top: 0 !important;
                border-radius: 0 !important;
                max-width: 100%;
                max-height: 100%;
            }
            
            #chat-fab {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
                font-size: 24px;
                z-index: 10000;
            }
            
            /* ç§»åŠ¨ç«¯åœ°å›¾æ§åˆ¶æŒ‰é’®ä¼˜åŒ– */
            .controls {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px;
            }
            
            /* ç§»åŠ¨ç«¯å¡ç‰‡ä¼˜åŒ– */
            .card {
                padding: 15px;
                margin: 15px 0;
            }
            
            /* ç§»åŠ¨ç«¯å¤´éƒ¨ä¼˜åŒ– */
            .header {
                padding: 20px 0;
            }
            
            .logo {
                width: 120px;
                height: 120px;
            }
            
            .title {
                font-size: 1.8rem;
            }
            
            .hero-stats {
                gap: 15px;
            }
            
            .stat {
                padding: 10px 15px;
            }
        }
    </style>
</body>
</html>
