<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totofun çªçªç¿» - GPSå¯»å®æ¸¸æˆ</title>
<meta name="description" content="åŸºäºGPSå®šä½çš„å®æ—¶å¯»å®æ¸¸æˆï¼Œæ¢ç´¢èº«è¾¹çš„å®è—">
    <meta name="keywords" content="GPSå¯»å®,Totofun,çªçªç¿»,é«˜å¾·åœ°å›¾,å®šä½æ¸¸æˆ,å¯»å®æ¸¸æˆ">
    
    <!-- PWAæ”¯æŒ -->
    <meta name="theme-color" content="#4FC3F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Totofun">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/images/icon-16x16.png">
    <link rel="shortcut icon" href="assets/images/icon-32x32.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/images/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="assets/images/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/images/icon-120x120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="assets/images/icon-114x114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/images/icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="assets/images/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="assets/images/icon-60x60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="assets/images/icon-57x57.png">
    <link rel="apple-touch-icon" href="assets/images/icon-180x180.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#4FC3F7">
    <meta name="msapplication-TileImage" content="assets/images/icon-144x144.png">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- å¤–éƒ¨æ ·å¼è¡¨ -->
    <link rel="stylesheet" href="src/css/main.css">
    <link rel="stylesheet" href="src/css/components.css">
    <link rel="stylesheet" href="src/css/chat.css">
    <link rel="stylesheet" href="src/css/responsive.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- ç”¨æˆ·ä¿¡æ¯æ ï¼ˆå³ä¸Šè§’ï¼‰ -->
            <div id="user-info-bar" style="
                position: absolute;
                top: 20px;
                right: 20px;
                display: none;
                align-items: center;
                gap: 15px;
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                padding: 10px 20px;
                border-radius: 25px;
                border: 1px solid rgba(255, 255, 255, 0.3);
                z-index: 1000;
            ">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="user-avatar-display" style="
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 20px;
                        color: white;
                        border: 2px solid rgba(255, 255, 255, 0.5);
                    ">ğŸ‘¤</div>
                    <div>
                        <div id="user-display-name" style="color: white; font-weight: 600; font-size: 14px;">æ¸¸å®¢</div>
                        <div id="user-display-level" style="color: rgba(255, 255, 255, 0.8); font-size: 12px;">LV.1</div>
                    </div>
                </div>
                <button onclick="authManager.handleLogout()" style="
                    background: rgba(255, 255, 255, 0.2);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    color: white;
                    padding: 8px 16px;
                    border-radius: 15px;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">ç™»å‡º</button>
            </div>
            
            <!-- ç™»å½•æŒ‰é’®ï¼ˆæœªç™»å½•æ—¶æ˜¾ç¤ºï¼‰ -->
            <div id="login-button-container" style="
                position: absolute;
                top: 20px;
                right: 20px;
                z-index: 1000;
            ">
                <button onclick="authManager.showModal()" style="
                    background: rgba(255, 255, 255, 0.2);
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 25px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">ğŸ” ç™»å½•/æ³¨å†Œ</button>
            </div>
            
            <div class="logo-container">
                <img src="assets/images/totofun-logo.png" alt="Totofun Logo" class="logo">
            </div>
            <h1 class="title">Totofun çªçªç¿»</h1>
            <p class="subtitle">åŸºäºGPSçš„å®æ—¶å¯»å®æ¸¸æˆ - æ¢ç´¢èº«è¾¹çš„å®è—</p>
            <div class="hero-stats">
                <div class="stat">
                    <span class="stat-number" id="user-name">æ¸¸å®¢</span>
                    <span class="stat-label">ç©å®¶æ˜µç§°</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="user-level">LV.1</span>
                    <span class="stat-label">å½“å‰ç­‰çº§</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="total-treasures">0</span>
                    <span class="stat-label">å‘ç°å®è—</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="accuracy">0m</span>
                    <span class="stat-label">å®šä½ç²¾åº¦</span>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆè¯´æ˜å…¥å£ -->
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="guide.html" style="
                display: inline-block;
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                color: white;
                padding: 12px 30px;
                border-radius: 25px;
                text-decoration: none;
                font-weight: 600;
                border: 2px solid rgba(255, 255, 255, 0.3);
                transition: all 0.3s ease;
                font-size: 1rem;
            " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
               onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                ğŸ“– æ¸¸æˆè¯´æ˜
            </a>
        </div>

        <!-- å¯åŠ¨æŒ‰é’® -->
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn" onclick="initMap()" style="max-width: 400px; margin: 0 auto;">
                <span id="init-btn-text">ğŸš€ å¯åŠ¨å¯»å®ä¹‹æ—…</span>
            </button>
            <div class="status info" id="status" style="max-width: 400px; margin: 15px auto;">
                <span>ğŸ”„</span>
                <span>ç‚¹å‡»"å¯åŠ¨å¯»å®ä¹‹æ—…"å¼€å§‹æ¸¸æˆ...</span>
            </div>
        </div>

        <div class="card">
            <div id="map-container">
                <div class="map-placeholder">
                    <div class="map-placeholder-icon pulse">ğŸ—ºï¸</div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">åœ°å›¾å³å°†åŠ è½½</div>
                        <div style="color: #888;">ç‚¹å‡»å¯åŠ¨æŒ‰é’®å¼€å§‹å¯»å®</div>
                    </div>
                </div>
            </div>
            
            <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
                <button class="btn" onclick="testGPS()" disabled id="gps-btn">
                    ğŸ“ é‡æ–°å®šä½
                </button>
                <button class="btn" onclick="centerToUser()" disabled id="center-btn">
                    ğŸ¯ å›åˆ°ä½ç½®
                </button>
                <button class="btn" onclick="enableManualCalibration()" id="calibration-btn" style="background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%);">
                    âœï¸ æ‰‹åŠ¨æ ¡å‡†ä½ç½®
                </button>
                <button class="btn" onclick="generateNearbyTreasures()" disabled id="generate-btn">
                    ğŸ—ºï¸ ç”Ÿæˆå®è—
                </button>
                <button class="btn" onclick="addTreasure()" disabled id="treasure-btn">
                    âœ¨ æ·»åŠ å®è—
                </button>
                <button class="btn" onclick="clearMap()" disabled id="clear-btn">
                    ğŸ—‘ï¸ åˆ é™¤å®è—
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== Firebaseé…ç½® ====================
        // âš ï¸ é‡è¦ï¼šè¯·å…ˆæŒ‰ç…§ FIREBASE_SETUP.md ä¸­çš„è¯´æ˜é…ç½®Firebase
        // ç„¶ååœ¨è¿™é‡Œå¡«å…¥ä½ çš„Firebaseé…ç½®ä¿¡æ¯
        
        const firebaseConfig = {
            // âœ… Firebaseé…ç½®ä¿¡æ¯ï¼ˆå·²é…ç½®ï¼‰
            apiKey: "AIzaSyAKsaHi4_VIRgCVR3_ZzkQdrkx91Iwq_u4",
            authDomain: "totofun-treasure.firebaseapp.com",
            databaseURL: "https://totofun-treasure-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "totofun-treasure",
            storageBucket: "totofun-treasure.firebasestorage.app",
            messagingSenderId: "453399218753",
            appId: "1:453399218753:web:b269ff4a436b98f011d4c0",
            measurementId: "G-LYVWQW487S"
        };
        
        // Firebaseåˆå§‹åŒ–
        let firebaseApp = null;
        let database = null;
        let firebaseEnabled = false;
        
        try {
            // æ£€æŸ¥æ˜¯å¦é…ç½®äº†Firebase
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                firebaseEnabled = true;
                console.log('âœ… Firebaseè¿æ¥æˆåŠŸï¼å®æ—¶é€šä¿¡å·²å¯ç”¨');
            } else {
                console.warn('âš ï¸ Firebaseæœªé…ç½®ï¼Œå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼ˆéœ€è¦æ‰‹åŠ¨åˆ†äº«æ¶ˆæ¯é“¾æ¥ï¼‰');
                console.log('ğŸ’¡ è¯·æŒ‰ç…§ FIREBASE_SETUP.md ä¸­çš„è¯´æ˜é…ç½®Firebaseä»¥å¯ç”¨å®æ—¶é€šä¿¡');
            }
        } catch (error) {
            console.error('âŒ Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
            console.log('ğŸ’¡ å°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼ˆéœ€è¦æ‰‹åŠ¨åˆ†äº«æ¶ˆæ¯é“¾æ¥ï¼‰');
        }
        
        // ==================== å…¨å±€å˜é‡ ====================
        let map = null;
        let userMarker = null;
        let treasureMarkers = [];
        let userLocation = null;
        let watchId = null;

        // ç”¨æˆ·æ•°æ®ç®¡ç†
        let userData = {
            username: '',
            level: {
                currentLevel: 1,
                experience: 0,
                badges: []
            },
            stats: {
                treasuresCreated: 0,
                treasuresDiscovered: 0,
                totalLikes: 0,
                totalViews: 0
            },
            preferences: {
                interests: [],
                explorationRadius: 5000,
                language: 'zh-CN'
            },
            discoveredTreasures: [],
            createdTreasures: [],
            achievements: [],
            lastActiveAt: new Date()
        };

        // æœ¬åœ°å­˜å‚¨ç®¡ç†
        const storageManager = {
            save: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('å­˜å‚¨å¤±è´¥:', error);
                    return false;
                }
            },
            load: (key) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('è¯»å–å¤±è´¥:', error);
                    return null;
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    return false;
                }
            }
        };

        // APIé…ç½®
        const API_CONFIG = {
            // äº‘æœåŠ¡åœ°å€é…ç½®ï¼ˆéƒ¨ç½²åˆ°äº‘æœåŠ¡åï¼Œåœ¨è¿™é‡Œè®¾ç½®ä½ çš„æœåŠ¡å™¨åœ°å€ï¼‰
            // ä¾‹å¦‚ï¼š'https://totofun-server.railway.app' æˆ– 'https://totofun-server.onrender.com'
            CLOUD_API_URL: 'https://totofun-server-production.up.railway.app', // Railwayéƒ¨ç½²åœ°å€
            
            // è‡ªåŠ¨æ£€æµ‹APIåœ°å€
            get BASE_URL() {
                // ä¼˜å…ˆæ£€æŸ¥localStorageä¸­çš„é…ç½®ï¼ˆç”¨äºä¸´æ—¶è¦†ç›–ï¼‰
                const localStorageApiUrl = localStorage.getItem('API_BASE_URL');
                if (localStorageApiUrl && localStorageApiUrl !== 'your-api-domain.com') {
                    console.log('ğŸ“Œ ä½¿ç”¨localStorageä¸­çš„APIåœ°å€:', localStorageApiUrl);
                    return localStorageApiUrl;
                }
                
                // æ£€æŸ¥windowå…¨å±€å˜é‡
                if (window.API_BASE_URL && window.API_BASE_URL !== 'your-api-domain.com') {
                    console.log('ğŸ“Œ ä½¿ç”¨windowä¸­çš„APIåœ°å€:', window.API_BASE_URL);
                    return window.API_BASE_URL;
                }
                
                // å¦‚æœè®¾ç½®äº†äº‘æœåŠ¡åœ°å€ï¼Œä¼˜å…ˆä½¿ç”¨
                if (this.CLOUD_API_URL && this.CLOUD_API_URL !== 'your-api-domain.com') {
                    console.log('ğŸ“Œ ä½¿ç”¨CLOUD_API_URL:', this.CLOUD_API_URL);
                    return this.CLOUD_API_URL;
                }
                
                const hostname = window.location.hostname;
                const protocol = window.location.protocol;
                const port = window.location.port;
                
                // å¦‚æœæ˜¯localhostæˆ–127.0.0.1ï¼Œä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return 'http://localhost:5000';
                }
                
                // å¦‚æœæ˜¯file://åè®®ï¼ˆæœ¬åœ°æ–‡ä»¶ï¼‰ï¼Œä¹Ÿä½¿ç”¨localhost
                if (window.location.protocol === 'file:') {
                    return 'http://localhost:5000';
                }
                
                // GitHub Pageséƒ¨ç½²ï¼šä½¿ç”¨é…ç½®çš„äº‘æœåŠ¡åœ°å€
                if (this.CLOUD_API_URL) {
                    return this.CLOUD_API_URL;
                }
                
                // å…¶ä»–æƒ…å†µï¼Œå°è¯•ä½¿ç”¨ç›¸åŒåŸŸåå’Œ5000ç«¯å£
                return `${protocol}//${hostname}${port ? ':5000' : ''}`;
            },
            ENDPOINTS: {
                REGISTER: '/api/auth/register',
                LOGIN: '/api/auth/login',
                REFRESH: '/api/auth/refresh',
                PROFILE: '/api/users/profile',
                FRIENDS: '/api/users/friends',
                CONVERSATIONS: '/api/users/conversations'
            }
        };

        // ç”¨æˆ·è®¤è¯æœåŠ¡
        const authService = {
            // è·å–å½“å‰token
            getToken() {
                return storageManager.load('auth_token');
            },

            // ä¿å­˜token
            saveToken(token) {
                storageManager.save('auth_token', token);
            },

            // è·å–ç”¨æˆ·ä¿¡æ¯
            getUser() {
                return storageManager.load('auth_user');
            },

            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            saveUser(user) {
                storageManager.save('auth_user', user);
            },

            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            isLoggedIn() {
                const token = this.getToken();
                const user = this.getUser();
                return !!(token && user);
            },

            // æ³¨å†Œ
            async register(username, email, password) {
                try {
                    const baseUrl = API_CONFIG.BASE_URL;
                    const apiUrl = baseUrl + API_CONFIG.ENDPOINTS.REGISTER;
                    console.log('ğŸ“¡ APIé…ç½®ä¿¡æ¯:');
                    console.log('  - CLOUD_API_URL:', API_CONFIG.CLOUD_API_URL);
                    console.log('  - BASE_URL:', baseUrl);
                    console.log('  - å®Œæ•´è¯·æ±‚URL:', apiUrl);
                    console.log('  - å½“å‰é¡µé¢:', window.location.href);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, email, password })
                    });

                    // æ£€æŸ¥å“åº”çŠ¶æ€
                    if (!response.ok) {
                        // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
                        let errorMessage = 'æ³¨å†Œå¤±è´¥';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorData.errors?.join(', ') || `æœåŠ¡å™¨é”™è¯¯ (${response.status})`;
                        } catch (e) {
                            errorMessage = `æœåŠ¡å™¨é”™è¯¯ (${response.status} ${response.statusText})`;
                        }
                        return { success: false, message: errorMessage };
                    }

                    const data = await response.json();
                    
                    if (data.success) {
                        // ä¿å­˜tokenå’Œç”¨æˆ·ä¿¡æ¯
                        this.saveToken(data.data.tokens.accessToken);
                        if (data.data.tokens.refreshToken) {
                            this.saveRefreshToken(data.data.tokens.refreshToken);
                        }
                        this.saveUser(data.data.user);
                        return { success: true, user: data.data.user };
                    } else {
                        return { success: false, message: data.message || data.errors?.join(', ') || 'æ³¨å†Œå¤±è´¥' };
                    }
                } catch (error) {
                    console.error('æ³¨å†Œé”™è¯¯:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', {
                        name: error.name,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    const baseUrl = API_CONFIG.BASE_URL;
                    let errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥';
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                            errorMessage = `CORSé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ (${baseUrl})ã€‚\n\nå¯èƒ½çš„åŸå› ï¼š\n1. æœåŠ¡å™¨æœªæ­£ç¡®é…ç½®CORS\n2. æœåŠ¡å™¨åœ°å€ä¸æ­£ç¡®\n3. ç½‘ç»œè¿æ¥é—®é¢˜\n\nè¯·æ£€æŸ¥æ§åˆ¶å°ä¸­çš„APIé…ç½®ä¿¡æ¯ã€‚`;
                        } else {
                            errorMessage = `æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ (${baseUrl})ã€‚\n\nè¯·ç¡®ä¿ï¼š\n1. åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ\n2. APIåœ°å€é…ç½®æ­£ç¡®\n3. ç½‘ç»œè¿æ¥æ­£å¸¸`;
                        }
                    } else {
                        errorMessage = `ç½‘ç»œé”™è¯¯: ${error.message}`;
                    }
                    
                    return { success: false, message: errorMessage };
                }
            },

            // ç™»å½•
            async login(email, password) {
                try {
                    const apiUrl = API_CONFIG.BASE_URL + API_CONFIG.ENDPOINTS.LOGIN;
                    console.log('ğŸ“¡ ç™»å½•è¯·æ±‚URL:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email, password })
                    });

                    // æ£€æŸ¥å“åº”çŠ¶æ€
                    if (!response.ok) {
                        // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
                        let errorMessage = 'ç™»å½•å¤±è´¥';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorData.errors?.join(', ') || `æœåŠ¡å™¨é”™è¯¯ (${response.status})`;
                        } catch (e) {
                            errorMessage = `æœåŠ¡å™¨é”™è¯¯ (${response.status} ${response.statusText})`;
                        }
                        return { success: false, message: errorMessage };
                    }

                    const data = await response.json();
                    
                    if (data.success) {
                        // ä¿å­˜tokenå’Œç”¨æˆ·ä¿¡æ¯
                        this.saveToken(data.data.tokens.accessToken);
                        if (data.data.tokens.refreshToken) {
                            this.saveRefreshToken(data.data.tokens.refreshToken);
                        }
                        this.saveUser(data.data.user);
                        return { success: true, user: data.data.user };
                    } else {
                        return { success: false, message: data.message || data.errors?.join(', ') || 'ç™»å½•å¤±è´¥' };
                    }
                } catch (error) {
                    console.error('ç™»å½•é”™è¯¯:', error);
                    const apiUrl = API_CONFIG.BASE_URL;
                    let errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥';
                    
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        errorMessage = `æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ (${apiUrl})ã€‚è¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œåœ¨ç«¯å£5000ã€‚`;
                    } else {
                        errorMessage = `ç½‘ç»œé”™è¯¯: ${error.message}`;
                    }
                    
                    return { success: false, message: errorMessage };
                }
            },

            // ç™»å‡º
            async logout() {
                try {
                    const token = this.getToken();
                    if (token) {
                        // è°ƒç”¨åç«¯ç™»å‡ºAPI
                        try {
                            await fetch(API_CONFIG.BASE_URL + '/api/auth/logout', {
                                method: 'POST',
                                headers: this.getAuthHeaders()
                            });
                        } catch (error) {
                            console.error('ç™»å‡ºAPIè°ƒç”¨å¤±è´¥:', error);
                            // å³ä½¿APIè°ƒç”¨å¤±è´¥ï¼Œä¹Ÿæ¸…é™¤æœ¬åœ°æ•°æ®
                        }
                    }
                    
                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                    storageManager.remove('auth_token');
                    storageManager.remove('auth_user');
                    storageManager.remove('refresh_token');
                    
                    // åˆ·æ–°é¡µé¢
                    location.reload();
                } catch (error) {
                    console.error('ç™»å‡ºé”™è¯¯:', error);
                    // å³ä½¿å‡ºé”™ä¹Ÿæ¸…é™¤æœ¬åœ°æ•°æ®
                    storageManager.remove('auth_token');
                    storageManager.remove('auth_user');
                    storageManager.remove('refresh_token');
                    location.reload();
                }
            },

            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆä»æœåŠ¡å™¨ï¼‰
            async getCurrentUser() {
                try {
                    const token = this.getToken();
                    if (!token) {
                        return null;
                    }

                    const response = await fetch(API_CONFIG.BASE_URL + '/api/auth/me', {
                        method: 'GET',
                        headers: this.getAuthHeaders()
                    });

                    const data = await response.json();
                    
                    if (data.success && data.data.user) {
                        // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
                        this.saveUser(data.data.user);
                        return data.data.user;
                    } else {
                        // tokenå¯èƒ½å·²è¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°æ•°æ®
                        if (response.status === 401) {
                            this.logout();
                        }
                        return null;
                    }
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error);
                    return null;
                }
            },

            // åˆ·æ–°token
            async refreshToken() {
                try {
                    const refreshToken = storageManager.load('refresh_token');
                    if (!refreshToken) {
                        return false;
                    }

                    const response = await fetch(API_CONFIG.BASE_URL + API_CONFIG.ENDPOINTS.REFRESH, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ refreshToken })
                    });

                    const data = await response.json();
                    
                    if (data.success && data.data.accessToken) {
                        this.saveToken(data.data.accessToken);
                        return true;
                    } else {
                        // åˆ·æ–°å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç™»å½•
                        this.logout();
                        return false;
                    }
                } catch (error) {
                    console.error('åˆ·æ–°tokené”™è¯¯:', error);
                    return false;
                }
            },

            // ä¿å­˜åˆ·æ–°token
            saveRefreshToken(token) {
                storageManager.save('refresh_token', token);
            },

            // è·å–è®¤è¯è¯·æ±‚å¤´
            getAuthHeaders() {
                const token = this.getToken();
                return {
                    'Content-Type': 'application/json',
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                };
            }
        };

        // å®Œæ•´çš„å®è—ç±»å‹ç³»ç»Ÿï¼ˆåŸºäºæ•°æ®æ¨¡å‹ï¼‰
        const treasureTypes = [
            { 
                icon: 'ğŸ’', 
                name: 'é’»çŸ³å®è—', 
                color: '#e74c3c', 
                rarity: 'legendary',
                category: 'æ‘„å½±',
                rewards: { experience: 100, coins: 50 },
                discoveryRadius: 30
            },
            { 
                icon: 'ğŸ‘‘', 
                name: 'çš‡å† å®è—', 
                color: '#9b59b6', 
                rarity: 'epic',
                category: 'å†å²',
                rewards: { experience: 80, coins: 40 },
                discoveryRadius: 35
            },
            { 
                icon: 'ğŸ’°', 
                name: 'é‡‘å¸å®è—', 
                color: '#f1c40f', 
                rarity: 'rare',
                category: 'è´­ç‰©',
                rewards: { experience: 60, coins: 30 },
                discoveryRadius: 40
            },
            { 
                icon: 'ğŸº', 
                name: 'å¤è‘£å®è—', 
                color: '#e67e22', 
                rarity: 'uncommon',
                category: 'è‰ºæœ¯',
                rewards: { experience: 40, coins: 20 },
                discoveryRadius: 45
            },
            { 
                icon: 'ğŸ’', 
                name: 'æˆ’æŒ‡å®è—', 
                color: '#3498db', 
                rarity: 'common',
                category: 'ç¾é£Ÿ',
                rewards: { experience: 20, coins: 10 },
                discoveryRadius: 50
            },
            { 
                icon: 'ğŸ­', 
                name: 'é¢å…·å®è—', 
                color: '#8e44ad', 
                rarity: 'rare',
                category: 'éŸ³ä¹',
                rewards: { experience: 55, coins: 25 },
                discoveryRadius: 40
            },
            { 
                icon: 'âš”ï¸', 
                name: 'ç¥å™¨å®è—', 
                color: '#2c3e50', 
                rarity: 'legendary',
                category: 'è¿åŠ¨',
                rewards: { experience: 120, coins: 60 },
                discoveryRadius: 25
            },
            { 
                icon: 'ğŸ†', 
                name: 'å¥–æ¯å®è—', 
                color: '#f39c12', 
                rarity: 'epic',
                category: 'æ—…æ¸¸',
                rewards: { experience: 90, coins: 45 },
                discoveryRadius: 30
            }
        ];

        // ç”¨æˆ·ç­‰çº§ç³»ç»Ÿ
        const levelSystem = {
            getLevel: (experience) => Math.floor(Math.sqrt(experience / 100)) + 1,
            getExpForLevel: (level) => Math.pow(level - 1, 2) * 100,
            getExpToNext: (currentExp) => {
                const currentLevel = levelSystem.getLevel(currentExp);
                const nextLevelExp = levelSystem.getExpForLevel(currentLevel + 1);
                return nextLevelExp - currentExp;
            }
        };

        // å¾½ç« ç³»ç»Ÿ
        const badgeSystem = [
            { name: 'first_treasure', icon: 'ğŸ¯', title: 'åˆæ¢è€…', description: 'å‘ç°ç¬¬ä¸€ä¸ªå®è—' },
            { name: 'treasure_hunter', icon: 'ğŸƒ', title: 'å¯»å®çŒäºº', description: 'å‘ç°10ä¸ªå®è—' },
            { name: 'treasure_master', icon: 'ğŸ‘‘', title: 'å¯»å®å¤§å¸ˆ', description: 'å‘ç°50ä¸ªå®è—' },
            { name: 'legendary_finder', icon: 'ğŸ’', title: 'ä¼ å¥‡å‘ç°è€…', description: 'å‘ç°ä¼ å¥‡çº§å®è—' },
            { name: 'category_expert', icon: 'ğŸ“', title: 'åˆ†ç±»ä¸“å®¶', description: 'åœ¨æ¯ä¸ªåˆ†ç±»ä¸­éƒ½å‘ç°å®è—' },
            { name: 'speed_runner', icon: 'âš¡', title: 'é—ªç”µä¾ ', description: '1å°æ—¶å†…å‘ç°5ä¸ªå®è—' },
            { name: 'explorer', icon: 'ğŸ—ºï¸', title: 'æ¢é™©å®¶', description: 'æ¢ç´¢è¶…è¿‡5å…¬é‡ŒèŒƒå›´' },
            { name: 'social_star', icon: 'â­', title: 'ç¤¾äº¤ä¹‹æ˜Ÿ', description: 'åˆ›å»ºçš„å®è—è¢«å‘ç°100æ¬¡' }
        ];

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info', showLoading = false) {
            const status = document.getElementById('status');
            const iconMap = {
                info: 'ğŸ”„',
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸'
            };
            
            const icon = showLoading ? '<span class="loading"></span>' : iconMap[type];
            status.innerHTML = `${icon}<span>${message}</span>`;
            status.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ›´æ–°GPSæ•°æ®æ˜¾ç¤ºï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ç©ºå‡½æ•°é¿å…é”™è¯¯ï¼‰
        function updateGPSData(data) {
            // GPSæ•°æ®é¢æ¿å·²ç§»é™¤åˆ°æ¸¸æˆè¯´æ˜é¡µé¢
            console.log('GPSæ•°æ®:', data);
        }

        // å®è—ç®¡ç†ç³»ç»Ÿ
        const treasureManager = {
            // åˆ›å»ºå®è—æ•°æ®
            createTreasure: (position, type, creator = 'system') => {
                const treasure = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    title: type.name,
                    description: `ä¸€ä¸ªçè´µçš„${type.name}ï¼Œç­‰å¾…ç€å‹‡æ•¢çš„æ¢é™©è€…æ¥å‘ç°ï¼`,
                    creator: creator,
                    location: {
                        coordinates: position,
                        discoveryRadius: type.discoveryRadius
                    },
                    category: type.category,
                    rewards: type.rewards,
                    rarity: type.rarity,
                    icon: type.icon,
                    color: type.color,
                    stats: {
                        views: 0,
                        likes: 0,
                        discoveries: 0
                    },
                    createdAt: new Date(),
                    status: 'active'
                };
                return treasure;
            },

            // å‘ç°å®è—
            discoverTreasure: (treasureId, userPosition) => {
                const treasureIndex = userData.createdTreasures.findIndex(t => t.id === treasureId);
                if (treasureIndex === -1) return { success: false, reason: 'treasure_not_found' };

                const treasure = userData.createdTreasures[treasureIndex];
                const distance = calculateDistance(userPosition, treasure.location.coordinates);

                if (distance > treasure.location.discoveryRadius) {
                    return { 
                        success: false, 
                        reason: 'too_far',
                        distance: distance,
                        requiredDistance: treasure.location.discoveryRadius
                    };
                }

                // æ£€æŸ¥æ˜¯å¦å·²ç»å‘ç°è¿‡
                if (userData.discoveredTreasures.includes(treasureId)) {
                    return { success: false, reason: 'already_discovered' };
                }

                // è®°å½•å‘ç°
                userData.discoveredTreasures.push(treasureId);
                userData.stats.treasuresDiscovered += 1;
                treasure.stats.discoveries += 1;

                // å¥–åŠ±ç»éªŒå’Œé‡‘å¸
                const reward = userManager.addExperience(treasure.rewards.experience);
                userManager.addCoins(treasure.rewards.coins);

                // æ£€æŸ¥æˆå°±
                achievementManager.checkAchievements();

                // ä¿å­˜æ•°æ®
                saveUserData();

                return {
                    success: true,
                    treasure: treasure,
                    rewards: treasure.rewards,
                    levelUp: reward.levelUp
                };
            }
        };

        // ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
        const userManager = {
            // æ·»åŠ ç»éªŒå€¼
            addExperience: (points) => {
                const oldLevel = userData.level.currentLevel;
                userData.level.experience += points;
                
                const newLevel = levelSystem.getLevel(userData.level.experience);
                if (newLevel > oldLevel) {
                    userData.level.currentLevel = newLevel;
                    
                    // ç­‰çº§æå‡å¥–åŠ±
                    const reward = {
                        coins: newLevel * 10,
                        badge: newLevel % 10 === 0 ? `level_${newLevel}` : null
                    };

                    if (reward.badge) {
                        userManager.addBadge(reward.badge, 'ğŸ†', `è¾¾åˆ°ç¬¬${newLevel}çº§`);
                    }

                    return {
                        levelUp: true,
                        oldLevel: oldLevel,
                        newLevel: newLevel,
                        reward: reward
                    };
                }
                
                return { levelUp: false };
            },

            // æ·»åŠ å¾½ç« 
            addBadge: (badgeName, icon, description) => {
                const existingBadge = userData.level.badges.find(badge => badge.name === badgeName);
                if (!existingBadge) {
                    userData.level.badges.push({
                        name: badgeName,
                        icon: icon,
                        description: description,
                        unlockedAt: new Date()
                    });
                    return true;
                }
                return false;
            },

            // æ·»åŠ é‡‘å¸ï¼ˆè™šæ‹Ÿè´§å¸ï¼‰
            addCoins: (amount) => {
                if (!userData.coins) userData.coins = 0;
                userData.coins += amount;
            },

            // è·å–ç”¨æˆ·ç­‰çº§ä¿¡æ¯
            getLevelInfo: () => {
                const currentExp = userData.level.experience;
                const currentLevel = userData.level.currentLevel;
                const expForCurrentLevel = levelSystem.getExpForLevel(currentLevel);
                const expForNextLevel = levelSystem.getExpForLevel(currentLevel + 1);
                const expToNext = expForNextLevel - currentExp;
                const progress = ((currentExp - expForCurrentLevel) / (expForNextLevel - expForCurrentLevel)) * 100;

                return {
                    currentLevel,
                    currentExp,
                    expToNext,
                    progress: Math.max(0, Math.min(100, progress))
                };
            }
        };

        // æˆå°±ç³»ç»Ÿ
        const achievementManager = {
            checkAchievements: () => {
                const achievements = [];

                // ç¬¬ä¸€ä¸ªå®è—
                if (userData.stats.treasuresDiscovered === 1) {
                    achievements.push(userManager.addBadge('first_treasure', 'ğŸ¯', 'å‘ç°ç¬¬ä¸€ä¸ªå®è—'));
                }

                // å¯»å®çŒäºº
                if (userData.stats.treasuresDiscovered === 10) {
                    achievements.push(userManager.addBadge('treasure_hunter', 'ğŸƒ', 'å‘ç°10ä¸ªå®è—'));
                }

                // å¯»å®å¤§å¸ˆ
                if (userData.stats.treasuresDiscovered === 50) {
                    achievements.push(userManager.addBadge('treasure_master', 'ğŸ‘‘', 'å‘ç°50ä¸ªå®è—'));
                }

                // ä¼ å¥‡å‘ç°è€…ï¼ˆå‘ç°ä¼ å¥‡çº§å®è—ï¼‰
                const legendaryFound = userData.createdTreasures.some(t => 
                    userData.discoveredTreasures.includes(t.id) && t.rarity === 'legendary'
                );
                if (legendaryFound) {
                    achievements.push(userManager.addBadge('legendary_finder', 'ğŸ’', 'å‘ç°ä¼ å¥‡çº§å®è—'));
                }

                return achievements.filter(Boolean);
            }
        };

        // è·ç¦»è®¡ç®—å·¥å…·
        function calculateDistance(pos1, pos2) {
            const R = 6371000; // åœ°çƒåŠå¾„(ç±³)
            const lat1 = pos1[1] * Math.PI / 180;
            const lat2 = pos2[1] * Math.PI / 180;
            const deltaLat = (pos2[1] - pos1[1]) * Math.PI / 180;
            const deltaLng = (pos2[0] - pos1[0]) * Math.PI / 180;

            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // ä¿å­˜å’ŒåŠ è½½ç”¨æˆ·æ•°æ®
        function saveUserData() {
            userData.lastActiveAt = new Date();
            storageManager.save('totofun-treasure-user', userData);
            
            // åŒæ­¥æ˜µç§°åˆ°èŠå¤©ç³»ç»Ÿ
            if (userData.username && chatManager.currentUser) {
                chatManager.currentUser.name = userData.username;
                storageManager.save('chatUser', chatManager.currentUser);
                
                // åŒæ­¥åˆ°Firebase
                if (firebaseEnabled && database && chatManager.currentUser.id) {
                    try {
                        const userRef = database.ref(`users/${chatManager.currentUser.id}`);
                        userRef.update({
                            name: userData.username,
                            updatedAt: firebase.database.ServerValue.TIMESTAMP
                        });
                        console.log('âœ… æ˜µç§°å·²åŒæ­¥åˆ°Firebase:', userData.username);
                    } catch (error) {
                        console.error('âŒ FirebaseåŒæ­¥æ˜µç§°å¤±è´¥:', error);
                    }
                }
            }
        }

        function loadUserData() {
            const saved = storageManager.load('totofun-treasure-user');
            if (saved) {
                userData = { ...userData, ...saved };
                // ç¡®ä¿æ—¥æœŸå­—æ®µæ­£ç¡®è§£æ
                if (saved.lastActiveAt) {
                    userData.lastActiveAt = new Date(saved.lastActiveAt);
                }
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
        function updateStats(accuracy = 0) {
            document.getElementById('total-treasures').textContent = userData.stats.treasuresDiscovered || 0;
            document.getElementById('accuracy').textContent = `${Math.round(accuracy)}m`;
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            if (document.getElementById('user-name')) {
                document.getElementById('user-name').textContent = userData.username || 'æ¸¸å®¢';
            }
            if (document.getElementById('user-level')) {
                document.getElementById('user-level').textContent = `LV.${userData.level.currentLevel}`;
            }
        }

        // é»˜è®¤API Keyï¼ˆé«˜å¾·åœ°å›¾Keyï¼‰
        // å¦‚æœéœ€è¦æ›´æ¢ï¼Œè¯·ä¿®æ”¹ä¸‹é¢è¿™è¡Œ
        const DEFAULT_AMAP_KEY = 'a4fdcddda4024a6a4df12431a7e6c536'; // é«˜å¾·åœ°å›¾Key
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            // ç›´æ¥ä½¿ç”¨é»˜è®¤Key
            const apiKey = DEFAULT_AMAP_KEY;
            
            if (!apiKey) {
                updateStatus('åœ°å›¾é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥API Keyè®¾ç½®', 'error');
                return;
            }

            updateStatus('æ­£åœ¨åŠ è½½é«˜å¾·åœ°å›¾...', 'info', true);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const initBtn = document.getElementById('init-btn-text');
            initBtn.innerHTML = '<span class="loading"></span> æ­£åœ¨åŠ è½½...';

            // åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾APIï¼ˆåŒ…å«åæ ‡è½¬æ¢æ’ä»¶ï¼‰
            const script = document.createElement('script');
            script.src = `https://webapi.amap.com/maps?v=2.0&key=${apiKey}&plugin=AMap.Geocoder,AMap.Geolocation,AMap.ConvertFrom`;
            script.onload = function() {
                console.log('é«˜å¾·åœ°å›¾APIåŠ è½½æˆåŠŸ');
                createMap();
            };
            script.onerror = function() {
                console.error('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥');
                updateStatus('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥Keyæ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œè¿æ¥', 'error');
                document.getElementById('init-btn-text').innerHTML = 'ğŸš€ é‡æ–°å¯åŠ¨';
            };
            document.head.appendChild(script);
        }

        // åˆ›å»ºåœ°å›¾å®ä¾‹ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
        function createMap() {
            try {
                console.log('å¼€å§‹åˆ›å»ºåœ°å›¾å®ä¾‹...');
                updateStatus('æ­£åœ¨åˆ›å»ºåœ°å›¾å®ä¾‹...', 'info', true);
                
                // æ£€æŸ¥AMapæ˜¯å¦å¯ç”¨
                if (typeof AMap === 'undefined') {
                    throw new Error('AMapå¯¹è±¡æœªå®šä¹‰ï¼Œåœ°å›¾APIå¯èƒ½æœªæ­£ç¡®åŠ è½½');
                }
                
                // ç§»é™¤å ä½ç¬¦å¹¶è®¾ç½®åœ°å›¾å®¹å™¨
                const mapContainer = document.getElementById('map-container');
                if (mapContainer) {
                    // ç§»é™¤å ä½ç¬¦
                    const placeholder = mapContainer.querySelector('.map-placeholder');
                    if (placeholder) {
                        placeholder.remove();
                        console.log('å·²ç§»é™¤åœ°å›¾å ä½ç¬¦');
                    }
                    
                    // ç¡®ä¿åœ°å›¾å®¹å™¨æœ‰æ­£ç¡®çš„é«˜åº¦
                    mapContainer.style.height = '60vh';
                    mapContainer.style.minHeight = '400px';
                    console.log('åœ°å›¾å®¹å™¨é«˜åº¦å·²è®¾ç½®:', mapContainer.offsetHeight);
                }
                
                map = new AMap.Map('map-container', {
                    zoom: 15,
                    center: [121.4737, 31.2304], // é»˜è®¤ä¸Šæµ·åæ ‡
                    viewMode: '2D',
                    showLabel: true,
                    mapStyle: 'amap://styles/normal',
                    resizeEnable: true,
                    rotateEnable: false,
                    pitchEnable: false,
                    dragEnable: true,
                    zoomEnable: true,
                    doubleClickZoom: true
                });

                console.log('åœ°å›¾å®ä¾‹åˆ›å»ºæˆåŠŸï¼Œç­‰å¾…åŠ è½½å®Œæˆ...');
                
                // åœ°å›¾åŠ è½½é”™è¯¯å¤„ç†
                map.on('error', function(e) {
                    console.error('åœ°å›¾åŠ è½½é”™è¯¯:', e);
                    updateStatus('åœ°å›¾åŠ è½½å‡ºé”™ï¼Œå¯èƒ½æ˜¯API Keyæ— æ•ˆã€‚è¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯', 'error');
                });

                // åœ°å›¾åŠ è½½å®Œæˆäº‹ä»¶
                map.on('complete', function() {
                    console.log('åœ°å›¾åŠ è½½å®Œæˆ');
                    updateStatus('åœ°å›¾åŠ è½½æˆåŠŸï¼æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...', 'success');
                    
                    // é‡ç½®æŒ‰é’®
                    document.getElementById('init-btn-text').innerHTML = 'âœ… åœ°å›¾å·²å¯åŠ¨';
                    
                    // å¯ç”¨æ§åˆ¶æŒ‰é’®
                    document.querySelectorAll('.btn').forEach(btn => {
                        if (!btn.onclick || btn.onclick.toString().includes('initMap')) {
                            return;
                        }
                        btn.disabled = false;
                    });

                    // è‡ªåŠ¨è·å–ä½ç½®
                    setTimeout(() => {
                        console.log('å¼€å§‹è‡ªåŠ¨è·å–GPSä½ç½®...');
                        testGPS();
                    }, 1000);
                });

                // åœ°å›¾ç‚¹å‡»äº‹ä»¶ - æ‰‹åŠ¨æ ¡å‡†ä½ç½®æˆ–æ·»åŠ å®è—
                let manualCalibrationMode = false;
                map.on('click', function(e) {
                    console.log('åœ°å›¾ç‚¹å‡»äº‹ä»¶:', e.lnglat);
                    
                    // å¦‚æœå¤„äºæ‰‹åŠ¨æ ¡å‡†æ¨¡å¼ï¼Œåˆ™æ ¡å‡†ä½ç½®
                    if (manualCalibrationMode) {
                        const clickedLng = e.lnglat.lng;
                        const clickedLat = e.lnglat.lat;
                        console.log('ğŸ“ æ‰‹åŠ¨æ ¡å‡†ä½ç½®:', { lng: clickedLng, lat: clickedLat });
                        
                        // æ›´æ–°ç”¨æˆ·ä½ç½®
                        userLocation = [clickedLng, clickedLat];
                        isLocationSet = true;
                        
                        // æ›´æ–°ç”¨æˆ·æ ‡è®°
                        if (userMarker) {
                            userMarker.setPosition([clickedLng, clickedLat]);
                        } else {
                            createUserMarker();
                        }
                        
                        // ç§»åŠ¨åœ°å›¾åˆ°æ–°ä½ç½®
                        map.setCenter([clickedLng, clickedLat]);
                        map.setZoom(18);
                        
                        // è·å–åœ°å€
                        AMap.plugin('AMap.Geocoder', function() {
                            const geocoder = new AMap.Geocoder({ timeout: 3000 });
                            geocoder.getAddress([clickedLng, clickedLat], function(status, geoResult) {
                                let address = 'åœ°å€è·å–ä¸­...';
                                if (status === 'complete' && geoResult.info === 'OK') {
                                    address = geoResult.regeocode.formattedAddress;
                                }
                                updateStatus(`âœ… ä½ç½®å·²æ‰‹åŠ¨æ ¡å‡†: ${address}`, 'success');
                                console.log('ğŸ“® æ ¡å‡†ä½ç½®åœ°å€:', address);
                            });
                        });
                        
                        manualCalibrationMode = false;
                        const calBtn = document.getElementById('calibration-btn');
                        if (calBtn) {
                            calBtn.style.background = 'linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%)';
                        }
                        return;
                    }
                    
                    // æ™®é€šç‚¹å‡» - æ·»åŠ å®è—
                    if (userLocation && confirm('åœ¨æ­¤ä½ç½®æ·»åŠ å®è—ï¼Ÿ')) {
                        addTreasureAtPosition([e.lnglat.lng, e.lnglat.lat]);
                    }
                });
                
                // æ‰‹åŠ¨æ ¡å‡†åŠŸèƒ½
                window.enableManualCalibration = function() {
                    if (!map) {
                        updateStatus('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼', 'warning');
                        return;
                    }
                    manualCalibrationMode = true;
                    const calBtn = document.getElementById('calibration-btn');
                    if (calBtn) {
                        calBtn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                    }
                    updateStatus('ğŸ“ æ‰‹åŠ¨æ ¡å‡†æ¨¡å¼å·²å¯ç”¨ï¼šè¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»æ‚¨çš„çœŸå®ä½ç½®', 'info');
                    setTimeout(() => {
                        if (manualCalibrationMode) {
                            manualCalibrationMode = false;
                            if (calBtn) {
                                calBtn.style.background = 'linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%)';
                            }
                            updateStatus('æ‰‹åŠ¨æ ¡å‡†æ¨¡å¼å·²è‡ªåŠ¨å…³é—­', 'info');
                        }
                    }, 30000); // 30ç§’åè‡ªåŠ¨å…³é—­
                };
                
                // åœ°å›¾ç§»åŠ¨äº‹ä»¶ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                map.on('moveend', function() {
                    const center = map.getCenter();
                    console.log('åœ°å›¾ä¸­å¿ƒ:', center.lng, center.lat, 'ç¼©æ”¾çº§åˆ«:', map.getZoom());
                });

            } catch (error) {
                console.error('åœ°å›¾åˆ›å»ºå¤±è´¥:', error);
                updateStatus('åœ°å›¾åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                document.getElementById('init-btn-text').innerHTML = 'ğŸš€ é‡æ–°å¯åŠ¨';
            }
        }

        // æµ‹è¯•GPSå®šä½ï¼ˆæ”¹è¿›ç‰ˆæœ¬ - é’ˆå¯¹PCå’Œæ‰‹æœºä¼˜åŒ–ï¼‰
        function testGPS() {
            if (!map) {
                updateStatus('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼', 'warning');
                return;
            }

            console.log('ğŸ¯ å¼€å§‹GPSå®šä½...');

            if (!navigator.geolocation) {
                updateStatus('æµè§ˆå™¨ä¸æ”¯æŒGPSå®šä½åŠŸèƒ½ã€‚è¯·ä½¿ç”¨"æ‰‹åŠ¨æ ¡å‡†ä½ç½®"åŠŸèƒ½è®¾ç½®æ‚¨çš„ä½ç½®', 'error');
                return;
            }

            // ğŸ”¥ ä¼˜å…ˆä½¿ç”¨æµè§ˆå™¨GPSï¼ˆç²¾åº¦æ›´é«˜ï¼‰ï¼Œç„¶åè½¬æ¢åæ ‡
            // æµè§ˆå™¨GPSé€šå¸¸æ¯”é«˜å¾·å®šä½ç²¾åº¦æ›´é«˜ï¼Œç‰¹åˆ«æ˜¯åœ¨æˆ·å¤–
            console.log('ğŸ¯ ä¼˜å…ˆä½¿ç”¨æµè§ˆå™¨GPSå®šä½ï¼ˆç²¾åº¦æ›´é«˜ï¼‰');
            useBrowserGPSFallback();
        }

        // ä½¿ç”¨é«˜å¾·å®šä½æœåŠ¡ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼šå¼ºåˆ¶GPSï¼Œæ‹’ç»ä½ç²¾åº¦å®šä½ï¼‰
        function useAmapGeolocation() {
            console.log('ğŸš€ å¯åŠ¨é«˜å¾·å®šä½æœåŠ¡ï¼ˆå¼ºåˆ¶GPSé«˜ç²¾åº¦å®šä½ï¼‰...');
            updateStatus('æ­£åœ¨è·å–GPSä½ç½®ï¼Œè¯·å…è®¸ä½ç½®æƒé™...', 'info', true);
            
            // ä¼˜å…ˆä½¿ç”¨é«˜å¾·åœ°å›¾å®˜æ–¹å®šä½æœåŠ¡ï¼ˆä¸APPä¸€è‡´ï¼Œæ›´å‡†ç¡®ï¼‰
            if (typeof AMap !== 'undefined') {
                AMap.plugin('AMap.Geolocation', function() {
                    const geolocation = new AMap.Geolocation({
                        enableHighAccuracy: true,  // å¯ç”¨é«˜ç²¾åº¦å®šä½
                        timeout: isMobile ? 60000 : 30000,  // æ‰‹æœºç«¯60ç§’ï¼ŒPCç«¯30ç§’
                        maximumAge: 0,            // ä¸ä½¿ç”¨ç¼“å­˜
                        convert: true,            // è‡ªåŠ¨åç§»åæ ‡ï¼Œåç§»çš„åæ ‡è½¬æ¢ä¸ºé«˜å¾·åæ ‡
                        GeoLocationFirst: true,   // ä¼˜å…ˆä½¿ç”¨H5å®šä½ï¼ˆGPSï¼‰
                        noIpLocate: 3,            // ğŸ”¥ å¼ºåˆ¶ç¦ç”¨IPå®šä½ï¼ˆ0=å…è®¸, 3=ç¦ç”¨ï¼‰
                        noGeoLocation: 0,         // å…è®¸ä½¿ç”¨æµè§ˆå™¨å®šä½
                        needAddress: true,        // éœ€è¦åœ°å€ä¿¡æ¯
                        extensions: 'all',        // è·å–æ‰€æœ‰æ‰©å±•ä¿¡æ¯
                        showButton: false,        // ä¸æ˜¾ç¤ºå®šä½æŒ‰é’®
                        showMarker: false,        // ä¸æ˜¾ç¤ºå®šä½æ ‡è®°
                        showCircle: false,        // ä¸æ˜¾ç¤ºå®šä½ç²¾åº¦åœ†åœˆ
                        panToLocation: false,     // ä¸è‡ªåŠ¨ç§»åŠ¨åœ°å›¾
                        zoomToAccuracy: false     // ä¸è‡ªåŠ¨ç¼©æ”¾
                    });
                    
                    // ä½¿ç”¨å¤šæ¬¡getCurrentPositionè°ƒç”¨æ¨¡æ‹ŸæŒç»­å®šä½
                    const isMobile = isMobileDevice();
                    let bestPosition = null;
                    let positionCount = 0;
                    let isCompleted = false;
                    let lastAccuracy = Infinity;
                    const idealAccuracy = 50; // ç†æƒ³ç²¾åº¦è¦æ±‚ï¼ˆç±³ï¼‰
                    const acceptableAccuracy = 200; // å¯æ¥å—ç²¾åº¦ï¼ˆç±³ï¼‰
                    const maxPositions = isMobile ? 10 : 5; // æ‰‹æœºç«¯æœ€å¤š10ä¸ªï¼ŒPCç«¯5ä¸ª
                    const watchTimeout = isMobile ? 60000 : 30000; // æ‰‹æœºç«¯60ç§’ï¼ŒPCç«¯30ç§’
                    const positionInterval = isMobile ? 2000 : 2000; // æ¯2ç§’è·å–ä¸€æ¬¡ä½ç½®
                    
                    console.log(`ğŸ“¡ å¼€å§‹å®šä½ï¼ˆ${isMobile ? 'æ‰‹æœºç«¯ï¼šç­‰å¾…GPSå«æ˜Ÿï¼Œç›®æ ‡ç²¾åº¦5ç±³å†…' : 'PCç«¯ï¼šç­‰å¾…æ¨¡å¼'}ï¼‰...`);
                    updateStatus(isMobile ? 'æ­£åœ¨ç­‰å¾…GPSå«æ˜Ÿå®šä½ï¼Œç›®æ ‡ç²¾åº¦5ç±³å†…...' : 'æ­£åœ¨ç­‰å¾…GPSä¿¡å·ç¨³å®šï¼Œè¯·ä¿æŒè®¾å¤‡é™æ­¢...', 'info', true);
                    
                    // è®¾ç½®è¶…æ—¶ä¿æŠ¤
                    const watchTimeoutId = setTimeout(() => {
                        isCompleted = true;
                        if (bestPosition) {
                            console.log('âœ… å®šä½å®Œæˆï¼Œä½¿ç”¨æœ€ä½³ä½ç½®ï¼ˆç²¾åº¦:', bestPosition.coords.accuracy, 'ç±³ï¼‰');
                            handleAmapLocationSuccess(bestPosition);
                        } else {
                            console.warn('âš ï¸ æŒç»­å®šä½è¶…æ—¶ï¼Œæœªè·å¾—ä½ç½®');
                            updateStatus('å®šä½è¶…æ—¶ã€‚è¯·ç‚¹å‡»"æ‰‹åŠ¨æ ¡å‡†ä½ç½®"æŒ‰é’®åœ¨åœ°å›¾ä¸Šè®¾ç½®æ‚¨çš„ä½ç½®', 'warning');
                        }
                    }, watchTimeout);
                    
                    // é€’å½’è°ƒç”¨getCurrentPositionæ¥æ¨¡æ‹ŸæŒç»­å®šä½
                    function tryGetPosition() {
                        if (isCompleted) return;
                        
                        geolocation.getCurrentPosition(function(status, result) {
                            if (isCompleted) return;
                            
                            if (status === 'complete') {
                                positionCount++;
                                const lat = result.position.lat;
                                const lng = result.position.lng;
                                const accuracy = result.accuracy || 9999;
                                const locationType = result.location_type || 'æœªçŸ¥';
                                
                                console.log(`ğŸ“ å®šä½ç»“æœ #${positionCount}:`, {
                                    lat, lng, accuracy,
                                    locationType: locationType
                                });
                                
                                // ğŸ”¥ æ‰‹æœºç«¯ï¼šå¼ºåˆ¶ç­‰å¾…GPSå«æ˜Ÿå®šä½ï¼Œç²¾åº¦è¾¾åˆ°5ç±³å†…
                                if (isMobile) {
                                    // æ£€æŸ¥æ˜¯å¦æ˜¯GPSå«æ˜Ÿå®šä½
                                    const isGPSSatellite = locationType.includes('GPS') || locationType.includes('å«æ˜Ÿ') || 
                                                          locationType.includes('H5') || locationType === 'html5';
                                    
                                    // å¿…é¡»ä½¿ç”¨GPSå«æ˜Ÿå®šä½
                                    if (!isGPSSatellite && positionCount < 3) {
                                        console.warn('âš ï¸ æœªä½¿ç”¨GPSå«æ˜Ÿå®šä½ï¼Œç»§ç»­ç­‰å¾…...');
                                        updateStatus('ç­‰å¾…GPSå«æ˜Ÿä¿¡å·...', 'info', true);
                                        setTimeout(tryGetPosition, positionInterval);
                                        return;
                                    }
                                    
                                    // è®°å½•æœ€ä½³ä½ç½®
                                    if (!bestPosition || accuracy < bestPosition.coords.accuracy) {
                                        bestPosition = {
                                            coords: {
                                                latitude: lat,
                                                longitude: lng,
                                                accuracy: accuracy
                                            },
                                            timestamp: Date.now(),
                                            address: result.formattedAddress || 'è·å–åœ°å€ä¸­...',
                                            locationType: locationType
                                        };
                                        console.log('âœ… æ›´æ–°æœ€ä½³ä½ç½®ï¼Œç²¾åº¦:', accuracy, 'ç±³');
                                        
                                        if (accuracy < 5) {
                                            updateStatus(`ğŸ¯ GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ï¼ˆæé«˜ç²¾åº¦ï¼‰`, 'success', true);
                                        } else if (accuracy < 10) {
                                            updateStatus(`âœ… GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ï¼ˆé«˜ç²¾åº¦ï¼‰`, 'success', true);
                                        } else if (accuracy < 20) {
                                            updateStatus(`GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ï¼Œç»§ç»­ä¼˜åŒ–ä¸­...`, 'info', true);
                                        } else {
                                            updateStatus(`GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ï¼Œç­‰å¾…æ›´é«˜ç²¾åº¦...`, 'warning', true);
                                        }
                                    }
                                    
                                    // å¦‚æœç²¾åº¦è¾¾åˆ°5ç±³å†…ï¼Œç«‹å³ä½¿ç”¨
                                    if (accuracy < 5) {
                                        console.log('ğŸ¯ è·å¾—æé«˜ç²¾åº¦ä½ç½®ï¼ˆç²¾åº¦:', accuracy, 'ç±³ï¼‰ï¼Œç«‹å³ä½¿ç”¨');
                                        isCompleted = true;
                                        clearTimeout(watchTimeoutId);
                                        handleAmapLocationSuccess(bestPosition);
                                        return;
                                    }
                                    
                                    // å¦‚æœç²¾åº¦è¾¾åˆ°10ç±³å†…ï¼Œä¸”å·²ç»ç¨³å®šï¼Œä½¿ç”¨
                                    if (accuracy < 10 && positionCount >= 3 && accuracy >= lastAccuracy * 0.95) {
                                        console.log('âœ… ç²¾åº¦å·²ç¨³å®šï¼ˆç²¾åº¦:', accuracy, 'ç±³ï¼‰ï¼Œä½¿ç”¨æœ€ä½³ä½ç½®');
                                        isCompleted = true;
                                        clearTimeout(watchTimeoutId);
                                        handleAmapLocationSuccess(bestPosition);
                                        return;
                                    }
                                    
                                    // å¦‚æœç²¾åº¦è¾¾åˆ°20ç±³å†…ï¼Œä¸”å·²ç»æ”¶é›†è¶³å¤Ÿæ•°æ®ï¼Œä½¿ç”¨
                                    if (accuracy < 20 && positionCount >= 5) {
                                        console.log('âœ… å·²æ”¶é›†è¶³å¤Ÿæ•°æ®ï¼ˆç²¾åº¦:', accuracy, 'ç±³ï¼‰ï¼Œä½¿ç”¨æœ€ä½³ä½ç½®');
                                        isCompleted = true;
                                        clearTimeout(watchTimeoutId);
                                        handleAmapLocationSuccess(bestPosition);
                                        return;
                                    }
                                    
                                    lastAccuracy = accuracy;
                                    // ç»§ç»­å°è¯•è·å–æ›´é«˜ç²¾åº¦
                                    setTimeout(tryGetPosition, positionInterval);
                                    return;
                                }
                                
                                // PCç«¯ï¼šæ‹’ç»IPå®šä½
                                if (!isMobile && locationType.includes('IP')) {
                                    console.warn('âš ï¸ æ‹’ç»IPå®šä½ï¼Œç»§ç»­ç­‰å¾…GPS...');
                                    updateStatus('æ£€æµ‹åˆ°IPå®šä½ï¼Œç»§ç»­ç­‰å¾…GPSä¿¡å·...', 'warning', true);
                                    // ç»§ç»­å°è¯•
                                    if (positionCount < maxPositions) {
                                        setTimeout(tryGetPosition, positionInterval);
                                    } else {
                                        // å¦‚æœå·²ç»å°è¯•å¤šæ¬¡è¿˜æ˜¯IPå®šä½ï¼Œä½¿ç”¨å½“å‰ä½ç½®
                                        if (bestPosition) {
                                            console.log('âœ… å·²å°è¯•å¤šæ¬¡ï¼Œä½¿ç”¨æœ€ä½³ä½ç½®');
                                            isCompleted = true;
                                            clearTimeout(watchTimeoutId);
                                            handleAmapLocationSuccess(bestPosition);
                                        } else {
                                            setTimeout(tryGetPosition, positionInterval);
                                        }
                                    }
                                    return;
                                }
                                
                                // è®°å½•æœ€ä½³ä½ç½®ï¼ˆæ€»æ˜¯è®°å½•ï¼Œä¸ç®¡ç²¾åº¦å¦‚ä½•ï¼‰
                                if (!bestPosition || accuracy < bestPosition.coords.accuracy) {
                                    bestPosition = {
                                        coords: {
                                            latitude: lat,
                                            longitude: lng,
                                            accuracy: accuracy
                                        },
                                        timestamp: Date.now(),
                                        address: result.formattedAddress || 'è·å–åœ°å€ä¸­...',
                                        locationType: locationType
                                    };
                                    console.log('âœ… æ›´æ–°æœ€ä½³ä½ç½®ï¼Œç²¾åº¦:', accuracy, 'ç±³');
                                    
                                    if (accuracy < idealAccuracy) {
                                        updateStatus(`GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ âœ“`, 'success', true);
                                    } else if (accuracy < acceptableAccuracy) {
                                        updateStatus(`GPSç²¾åº¦: ${Math.round(accuracy)}ç±³`, 'info', true);
                                    } else {
                                        updateStatus(`GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ï¼Œç»§ç»­ä¼˜åŒ–ä¸­...`, 'warning', true);
                                    }
                                }
                                
                                // å¦‚æœç²¾åº¦è¶³å¤Ÿå¥½ï¼ˆ<20ç±³ï¼‰ï¼Œç«‹å³ä½¿ç”¨
                                if (accuracy < 20) {
                                    console.log('ğŸ¯ è·å¾—é«˜ç²¾åº¦ä½ç½®ï¼ˆç²¾åº¦:', accuracy, 'ç±³ï¼‰ï¼Œç«‹å³ä½¿ç”¨');
                                    isCompleted = true;
                                    clearTimeout(watchTimeoutId);
                                    handleAmapLocationSuccess(bestPosition);
                                    return;
                                }
                                
                                // å¦‚æœç²¾åº¦æ²¡æœ‰æ”¹å–„ï¼Œä½¿ç”¨å½“å‰æœ€ä½³ä½ç½®
                                if (positionCount >= 3 && accuracy >= lastAccuracy * 0.9) {
                                    console.log('âœ… ç²¾åº¦å·²ç¨³å®šï¼Œä½¿ç”¨æœ€ä½³ä½ç½®ï¼ˆç²¾åº¦:', bestPosition.coords.accuracy, 'ç±³ï¼‰');
                                    isCompleted = true;
                                    clearTimeout(watchTimeoutId);
                                    handleAmapLocationSuccess(bestPosition);
                                    return;
                                }
                                
                                // æ”¶é›†è¶³å¤Ÿçš„ä½ç½®åï¼Œä½¿ç”¨æœ€ä½³ä½ç½®
                                if (positionCount >= maxPositions) {
                                    console.log('âœ… å·²æ”¶é›†è¶³å¤Ÿå®šä½æ•°æ®ï¼Œä½¿ç”¨æœ€ä½³ä½ç½®ï¼ˆç²¾åº¦:', bestPosition.coords.accuracy, 'ç±³ï¼‰');
                                    isCompleted = true;
                                    clearTimeout(watchTimeoutId);
                                    handleAmapLocationSuccess(bestPosition);
                                    return;
                                }
                                
                                lastAccuracy = accuracy;
                                // ç»§ç»­å°è¯•è·å–æ›´ç²¾ç¡®çš„ä½ç½®
                                setTimeout(tryGetPosition, positionInterval);
                            } else {
                                console.warn('âš ï¸ é«˜å¾·å®šä½çŠ¶æ€:', status, result);
                                // å¦‚æœæŒç»­å¤±è´¥ï¼Œå›é€€åˆ°æµè§ˆå™¨GPS
                                if (positionCount === 0) {
                                    isCompleted = true;
                                    clearTimeout(watchTimeoutId);
                                    console.warn('âš ï¸ é«˜å¾·å®šä½å¤±è´¥ï¼Œå›é€€åˆ°æµè§ˆå™¨GPS');
                                    useBrowserGPSFallback();
                                } else if (bestPosition) {
                                    // å·²æœ‰ä½ç½®æ•°æ®ï¼Œä½¿ç”¨å®ƒ
                                    console.log('âœ… ä½¿ç”¨å·²è·å¾—çš„æœ€ä½³ä½ç½®');
                                    isCompleted = true;
                                    clearTimeout(watchTimeoutId);
                                    handleAmapLocationSuccess(bestPosition);
                                } else {
                                    // ç»§ç»­å°è¯•
                                    setTimeout(tryGetPosition, positionInterval);
                                }
                            }
                        });
                    }
                    
                    // å¼€å§‹ç¬¬ä¸€æ¬¡å®šä½
                    tryGetPosition();
                });
            } else {
                console.warn('âš ï¸ é«˜å¾·åœ°å›¾APIæœªåŠ è½½ï¼Œä½¿ç”¨æµè§ˆå™¨GPS');
                useBrowserGPSFallback();
            }
        }
        
        // æµè§ˆå™¨GPSå¤‡ç”¨æ–¹æ¡ˆï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼šä½¿ç”¨watchPositionæŒç»­å®šä½ï¼‰
        function useBrowserGPSFallback() {
            console.log('ğŸ›°ï¸ ä½¿ç”¨æµè§ˆå™¨åŸç”ŸGPSå®šä½ï¼ˆæŒç»­å®šä½ä¼˜åŒ–ï¼‰...');
            updateStatus('æ­£åœ¨è·å–GPSä½ç½®ï¼Œè¯·å…è®¸ä½ç½®æƒé™...', 'info', true);
            
            // ä½¿ç”¨æµè§ˆå™¨åŸç”ŸGPSè·å–WGS84åæ ‡
            if (navigator.geolocation) {
                console.log('ğŸ›°ï¸ å¼€å§‹æŒç»­GPSå®šä½ï¼Œç­‰å¾…ä¿¡å·ç¨³å®š...');
                updateStatus('æ­£åœ¨ç­‰å¾…GPSä¿¡å·ç¨³å®šï¼Œè¯·ä¿æŒè®¾å¤‡é™æ­¢...', 'info', true);
                
                let watchId = null;
                let bestPosition = null;
                let positionCount = 0;
                let lastAccuracy = Infinity;
                const maxPositions = 5; // æœ€å¤šæ”¶é›†5ä¸ªå®šä½ç»“æœ
                const idealAccuracy = 50; // ç†æƒ³ç²¾åº¦è¦æ±‚ï¼ˆç±³ï¼‰
                const acceptableAccuracy = 200; // å¯æ¥å—ç²¾åº¦ï¼ˆç±³ï¼‰
                const watchTimeout = 30000; // 30ç§’ååœæ­¢watch
                
                // è®¾ç½®è¶…æ—¶ä¿æŠ¤
                const watchTimeoutId = setTimeout(() => {
                    if (watchId !== null) {
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                    }
                    
                    if (bestPosition) {
                        console.log('âœ… å®šä½å®Œæˆï¼Œä½¿ç”¨æœ€ä½³ä½ç½®ï¼ˆç²¾åº¦:', bestPosition.coords.accuracy, 'ç±³ï¼‰');
                        convertAndUsePosition(bestPosition);
                    } else {
                        console.warn('â° GPSå®šä½è¶…æ—¶ï¼Œæœªè·å¾—ä½ç½®');
                        updateStatus('GPSå®šä½è¶…æ—¶ã€‚è¯·ç‚¹å‡»"æ‰‹åŠ¨æ ¡å‡†ä½ç½®"æŒ‰é’®åœ¨åœ°å›¾ä¸Šè®¾ç½®æ‚¨çš„ä½ç½®', 'warning');
                    }
                }, watchTimeout);
                
                // ä½¿ç”¨watchPositionæŒç»­å®šä½
                watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        positionCount++;
                        const wgs84Lat = position.coords.latitude;
                        const wgs84Lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        const altitude = position.coords.altitude;
                        const heading = position.coords.heading;
                        const speed = position.coords.speed;
                        const isGPSSatellite = altitude !== null && altitude !== undefined;
                        
                        console.log(`ğŸ“ GPSå®šä½ç»“æœ #${positionCount}:`, {
                            lat: wgs84Lat,
                            lng: wgs84Lng,
                            accuracy: accuracy,
                            altitude: altitude,
                            heading: heading,
                            speed: speed,
                            isGPSSatellite: isGPSSatellite,
                            timestamp: new Date(position.timestamp).toLocaleString()
                        });
                        
                        // è¯¦ç»†æ—¥å¿—ï¼šæ£€æŸ¥å®šä½æ–¹å¼
                        if (isGPSSatellite) {
                            console.log('âœ… ç¡®è®¤ï¼šä½¿ç”¨GPSå«æ˜Ÿå®šä½');
                        } else {
                            console.warn('âš ï¸ è­¦å‘Šï¼šæœªä½¿ç”¨GPSå«æ˜Ÿå®šä½ï¼ˆaltitudeä¸ºç©ºï¼‰');
                            console.warn('   è¿™å¯èƒ½æ˜¯å› ä¸ºï¼š1) GPSæœªå¼€å¯ 2) åœ¨å®¤å†…GPSä¿¡å·å¼± 3) æµè§ˆå™¨ä½¿ç”¨ç½‘ç»œå®šä½');
                        }
                        
                        // ğŸ”¥ æ‰‹æœºç«¯ï¼šå¼ºåˆ¶ç­‰å¾…GPSå«æ˜Ÿå®šä½ï¼Œç²¾åº¦è¾¾åˆ°5ç±³å†…
                        if (isMobileDevice()) {
                            // å¿…é¡»ä½¿ç”¨GPSå«æ˜Ÿå®šä½ï¼ˆaltitudeä¸ä¸ºnullï¼‰
                            if (!isGPSSatellite) {
                                console.warn('âš ï¸ æœªä½¿ç”¨GPSå«æ˜Ÿå®šä½ï¼Œç»§ç»­ç­‰å¾…...');
                                updateStatus('ç­‰å¾…GPSå«æ˜Ÿä¿¡å·...', 'info', true);
                                return; // ç»§ç»­ç­‰å¾…GPSå«æ˜Ÿ
                            }
                            
                            // è®°å½•æœ€ä½³ä½ç½®
                            if (!bestPosition || accuracy < bestPosition.coords.accuracy) {
                                bestPosition = {
                                    coords: {
                                        latitude: wgs84Lat,
                                        longitude: wgs84Lng,
                                        accuracy: accuracy,
                                        altitude: position.coords.altitude
                                    },
                                    timestamp: position.timestamp
                                };
                                console.log('âœ… æ›´æ–°æœ€ä½³ä½ç½®ï¼Œç²¾åº¦:', accuracy, 'ç±³');
                                
                                if (accuracy < 5) {
                                    updateStatus(`ğŸ¯ GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ï¼ˆæé«˜ç²¾åº¦ï¼‰`, 'success', true);
                                } else if (accuracy < 10) {
                                    updateStatus(`âœ… GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ï¼ˆé«˜ç²¾åº¦ï¼‰`, 'success', true);
                                } else if (accuracy < 20) {
                                    updateStatus(`GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ï¼Œç»§ç»­ä¼˜åŒ–ä¸­...`, 'info', true);
                                } else {
                                    updateStatus(`GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ï¼Œç­‰å¾…æ›´é«˜ç²¾åº¦...`, 'warning', true);
                                }
                            }
                            
                            // å¦‚æœç²¾åº¦è¾¾åˆ°5ç±³å†…ï¼Œç«‹å³ä½¿ç”¨
                            if (accuracy < 5) {
                                console.log('ğŸ¯ è·å¾—æé«˜ç²¾åº¦ä½ç½®ï¼ˆç²¾åº¦:', accuracy, 'ç±³ï¼‰ï¼Œç«‹å³ä½¿ç”¨');
                                clearTimeout(watchTimeoutId);
                                if (watchId !== null) {
                                    navigator.geolocation.clearWatch(watchId);
                                    watchId = null;
                                }
                                convertAndUsePosition(bestPosition);
                                return;
                            }
                            
                            // å¦‚æœç²¾åº¦è¾¾åˆ°10ç±³å†…ï¼Œä¸”å·²ç»ç¨³å®šï¼Œä½¿ç”¨
                            if (accuracy < 10 && positionCount >= 3 && accuracy >= lastAccuracy * 0.95) {
                                console.log('âœ… ç²¾åº¦å·²ç¨³å®šï¼ˆç²¾åº¦:', accuracy, 'ç±³ï¼‰ï¼Œä½¿ç”¨æœ€ä½³ä½ç½®');
                                clearTimeout(watchTimeoutId);
                                if (watchId !== null) {
                                    navigator.geolocation.clearWatch(watchId);
                                    watchId = null;
                                }
                                convertAndUsePosition(bestPosition);
                                return;
                            }
                            
                            // å¦‚æœç²¾åº¦è¾¾åˆ°20ç±³å†…ï¼Œä¸”å·²ç»æ”¶é›†è¶³å¤Ÿæ•°æ®ï¼Œä½¿ç”¨
                            if (accuracy < 20 && positionCount >= 5) {
                                console.log('âœ… å·²æ”¶é›†è¶³å¤Ÿæ•°æ®ï¼ˆç²¾åº¦:', accuracy, 'ç±³ï¼‰ï¼Œä½¿ç”¨æœ€ä½³ä½ç½®');
                                clearTimeout(watchTimeoutId);
                                if (watchId !== null) {
                                    navigator.geolocation.clearWatch(watchId);
                                    watchId = null;
                                }
                                convertAndUsePosition(bestPosition);
                                return;
                            }
                            
                            lastAccuracy = accuracy;
                            return; // ç»§ç»­ç­‰å¾…æ›´é«˜ç²¾åº¦
                        } else {
                            // PCç«¯ï¼šå¯ä»¥ç­‰å¾…æ›´ç²¾ç¡®çš„ä½ç½®
                            if (!isGPSSatellite && positionCount < 2) {
                                console.warn('âš ï¸ æœªä½¿ç”¨GPSå«æ˜Ÿå®šä½ï¼Œç»§ç»­ç­‰å¾…...');
                                updateStatus('æ£€æµ‹åˆ°ç½‘ç»œå®šä½ï¼Œç»§ç»­ç­‰å¾…GPSå«æ˜Ÿä¿¡å·...', 'warning', true);
                                return; // ç»§ç»­ç­‰å¾…
                            }
                            
                            // PCç«¯ï¼šå¦‚æœç²¾åº¦å¾ˆå·®ä½†å·²ç»å°è¯•å¤šæ¬¡ï¼Œä¹Ÿæ¥å—
                            if (accuracy > acceptableAccuracy && positionCount < 2) {
                                console.warn(`âš ï¸ ç²¾åº¦ä¸è¶³ï¼ˆ${accuracy}ç±³ï¼‰ï¼Œç»§ç»­ç­‰å¾…æ›´ç²¾ç¡®çš„ä½ç½®...`);
                                updateStatus(`GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ï¼Œç»§ç»­ä¼˜åŒ–ä¸­...`, 'info', true);
                                return; // ç»§ç»­ç­‰å¾…
                            }
                        }
                        
                        // è®°å½•æœ€ä½³ä½ç½®ï¼ˆæ€»æ˜¯è®°å½•ï¼Œä¸ç®¡ç²¾åº¦å¦‚ä½•ï¼‰
                        if (!bestPosition || accuracy < bestPosition.coords.accuracy) {
                            bestPosition = {
                                coords: {
                                    latitude: wgs84Lat,
                                    longitude: wgs84Lng,
                                    accuracy: accuracy,
                                    altitude: position.coords.altitude
                                },
                                timestamp: position.timestamp
                            };
                            console.log('âœ… æ›´æ–°æœ€ä½³ä½ç½®ï¼Œç²¾åº¦:', accuracy, 'ç±³');
                            
                            if (accuracy < idealAccuracy) {
                                updateStatus(`GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ âœ“`, 'success', true);
                            } else if (accuracy < acceptableAccuracy) {
                                updateStatus(`GPSç²¾åº¦: ${Math.round(accuracy)}ç±³`, 'info', true);
                            } else {
                                updateStatus(`GPSç²¾åº¦: ${Math.round(accuracy)}ç±³ï¼Œç»§ç»­ä¼˜åŒ–ä¸­...`, 'warning', true);
                            }
                        }
                        
                        // å¦‚æœç²¾åº¦è¶³å¤Ÿå¥½ï¼ˆ<20ç±³ï¼‰ï¼Œç«‹å³ä½¿ç”¨
                        if (accuracy < 20) {
                            console.log('ğŸ¯ è·å¾—é«˜ç²¾åº¦ä½ç½®ï¼ˆç²¾åº¦:', accuracy, 'ç±³ï¼‰ï¼Œç«‹å³ä½¿ç”¨');
                            clearTimeout(watchTimeoutId);
                            if (watchId !== null) {
                                navigator.geolocation.clearWatch(watchId);
                                watchId = null;
                            }
                            convertAndUsePosition(bestPosition);
                            return;
                        }
                        
                        // å¦‚æœç²¾åº¦æ²¡æœ‰æ”¹å–„ï¼Œä½¿ç”¨å½“å‰æœ€ä½³ä½ç½®
                        if (positionCount >= 3 && accuracy >= lastAccuracy * 0.9) {
                            console.log('âœ… ç²¾åº¦å·²ç¨³å®šï¼Œä½¿ç”¨æœ€ä½³ä½ç½®ï¼ˆç²¾åº¦:', bestPosition.coords.accuracy, 'ç±³ï¼‰');
                            clearTimeout(watchTimeoutId);
                            if (watchId !== null) {
                                navigator.geolocation.clearWatch(watchId);
                                watchId = null;
                            }
                            convertAndUsePosition(bestPosition);
                            return;
                        }
                        
                        // æ”¶é›†è¶³å¤Ÿçš„ä½ç½®åï¼Œä½¿ç”¨æœ€ä½³ä½ç½®
                        if (positionCount >= maxPositions) {
                            console.log('âœ… å·²æ”¶é›†è¶³å¤Ÿå®šä½æ•°æ®ï¼Œä½¿ç”¨æœ€ä½³ä½ç½®ï¼ˆç²¾åº¦:', bestPosition.coords.accuracy, 'ç±³ï¼‰');
                            clearTimeout(watchTimeoutId);
                            if (watchId !== null) {
                                navigator.geolocation.clearWatch(watchId);
                                watchId = null;
                            }
                            convertAndUsePosition(bestPosition);
                            return;
                        }
                        
                        lastAccuracy = accuracy;
                    },
                    function(error) {
                        console.error('âŒ GPSå®šä½é”™è¯¯:', error);
                        
                        // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæç¤º
                        if (error.code === 1) {
                            updateStatus('ä½ç½®æƒé™è¢«æ‹’ç»ï¼Œæ­£åœ¨ä½¿ç”¨å¤‡ç”¨å®šä½...', 'warning', true);
                        } else if (error.code === 2) {
                            updateStatus('ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œæ­£åœ¨ä½¿ç”¨å¤‡ç”¨å®šä½...', 'warning', true);
                        } else if (error.code === 3) {
                            // è¶…æ—¶é”™è¯¯ï¼Œç»§ç»­ç­‰å¾…
                            console.warn('â° GPSå®šä½è¶…æ—¶ï¼Œç»§ç»­ç­‰å¾…...');
                            return;
                        }
                        
                        // å¦‚æœæŒç»­å¤±è´¥ï¼Œå°è¯•é«˜å¾·å®šä½
                        if (positionCount === 0 && watchId !== null) {
                            clearTimeout(watchTimeoutId);
                            navigator.geolocation.clearWatch(watchId);
                            watchId = null;
                            console.log('ğŸ”„ æµè§ˆå™¨GPSå¤±è´¥ï¼Œå°è¯•é«˜å¾·å®šä½æœåŠ¡...');
                            useAmapLocationFallback();
                        } else if (positionCount === 0) {
                            // å¦‚æœå®Œå…¨æ²¡æœ‰å®šä½ç»“æœï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨æ ¡å‡†
                            console.warn('âš ï¸ æ— æ³•è·å–GPSä½ç½®');
                            updateStatus('æ— æ³•è·å–GPSä½ç½®ã€‚è¯·ç‚¹å‡»"æ‰‹åŠ¨æ ¡å‡†ä½ç½®"æŒ‰é’®åœ¨åœ°å›¾ä¸Šè®¾ç½®æ‚¨çš„ä½ç½®', 'warning');
                        }
                    },
                    {
                        enableHighAccuracy: true,  // å¼ºåˆ¶é«˜ç²¾åº¦GPS
                        timeout: 30000,            // 30ç§’è¶…æ—¶
                        maximumAge: 0              // ä¸ä½¿ç”¨ç¼“å­˜
                    }
                );
            } else {
                console.warn('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒGPSï¼Œä½¿ç”¨é«˜å¾·å®šä½');
                useAmapLocationFallback();
            }
        }
        
        // è½¬æ¢åæ ‡å¹¶ä½¿ç”¨ä½ç½®ï¼ˆWGS84 â†’ GCJ-02ï¼‰
        function convertAndUsePosition(position) {
            const wgs84Lat = position.coords.latitude;
            const wgs84Lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            console.log('ğŸ“ GPSè¿”å›WGS84åæ ‡ï¼Œéœ€è¦è½¬æ¢ä¸ºGCJ-02');
            console.log('ğŸ“ åŸå§‹åæ ‡ (WGS84):', { lat: wgs84Lat, lng: wgs84Lng });
            
            // ä½¿ç”¨é«˜å¾·åœ°å›¾APIè¿›è¡Œåæ ‡è½¬æ¢
            if (typeof AMap !== 'undefined' && AMap.convertFrom) {
                AMap.convertFrom([wgs84Lng, wgs84Lat], 'gps', function(status, result) {
                    if (status === 'complete' && result.info === 'ok' && result.locations && result.locations.length > 0) {
                        const converted = result.locations[0];
                        const gcj02Lat = converted.lat;
                        const gcj02Lng = converted.lng;
                        
                        console.log('âœ… åæ ‡è½¬æ¢æˆåŠŸ (WGS84 â†’ GCJ-02)');
                        console.log('ğŸ“ è½¬æ¢ååæ ‡ (GCJ-02):', { lat: gcj02Lat, lng: gcj02Lng });
                        
                        // è®¡ç®—åç§»è·ç¦»
                        const offset = Math.sqrt(
                            Math.pow((gcj02Lng - wgs84Lng) * 111000, 2) + 
                            Math.pow((gcj02Lat - wgs84Lat) * 111000, 2)
                        );
                        console.log('ğŸ“ åæ ‡åç§»:', Math.round(offset), 'ç±³');
                        
                        // ä½¿ç”¨è½¬æ¢åçš„åæ ‡
                        const positionData = {
                            coords: {
                                latitude: gcj02Lat,
                                longitude: gcj02Lng,
                                accuracy: accuracy
                            },
                            timestamp: position.timestamp,
                            address: 'è·å–åœ°å€ä¸­...',
                            locationType: 'GPSå«æ˜Ÿå®šä½',
                            wgs84: { lat: wgs84Lat, lng: wgs84Lng } // ä¿å­˜åŸå§‹åæ ‡ç”¨äºå¯¹æ¯”
                        };
                        
                        // ç«‹å³å¤„ç†å®šä½æˆåŠŸï¼Œä¸ç­‰å¾…åœ°å€
                        handleAmapLocationSuccess(positionData);
                        
                        // å¼‚æ­¥è·å–åœ°å€ï¼ˆä½¿ç”¨è½¬æ¢åçš„åæ ‡ï¼‰
                        setTimeout(() => {
                            try {
                                AMap.plugin('AMap.Geocoder', function() {
                                    const geocoder = new AMap.Geocoder({
                                        timeout: 3000  // 3ç§’è¶…æ—¶
                                    });
                                    geocoder.getAddress([gcj02Lng, gcj02Lat], function(status, geoResult) {
                                        let address = 'åœ°å€æœªçŸ¥';
                                        if (status === 'complete' && geoResult.info === 'OK') {
                                            address = geoResult.regeocode.formattedAddress;
                                        }
                                        console.log('ğŸ“® åœ°å€è·å–ç»“æœ:', address);
                                        
                                        // æ›´æ–°æ˜¾ç¤ºçš„åœ°å€
                                        positionData.address = address;
                                        const locationInfo = document.querySelector('.gps-data');
                                        if (locationInfo) {
                                            locationInfo.innerHTML = locationInfo.innerHTML.replace('è·å–åœ°å€ä¸­...', address);
                                        }
                                    });
                                });
                            } catch (error) {
                                console.warn('âš ï¸ è·å–åœ°å€å¤±è´¥:', error);
                            }
                        }, 100);
                    } else {
                        console.warn('âš ï¸ åæ ‡è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹åæ ‡ï¼ˆå¯èƒ½æœ‰åç§»ï¼‰');
                        // è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹åæ ‡
                        const positionData = {
                            coords: {
                                latitude: wgs84Lat,
                                longitude: wgs84Lng,
                                accuracy: accuracy
                            },
                            timestamp: position.timestamp,
                            address: 'è·å–åœ°å€ä¸­...',
                            locationType: 'GPSå«æ˜Ÿå®šä½ï¼ˆæœªè½¬æ¢ï¼‰'
                        };
                        handleAmapLocationSuccess(positionData);
                        
                        // å¼‚æ­¥è·å–åœ°å€
                        setTimeout(() => {
                            try {
                                AMap.plugin('AMap.Geocoder', function() {
                                    const geocoder = new AMap.Geocoder({
                                        timeout: 3000
                                    });
                                    geocoder.getAddress([wgs84Lng, wgs84Lat], function(status, geoResult) {
                                        let address = 'åœ°å€æœªçŸ¥';
                                        if (status === 'complete' && geoResult.info === 'OK') {
                                            address = geoResult.regeocode.formattedAddress;
                                        }
                                        console.log('ğŸ“® åœ°å€è·å–ç»“æœ:', address);
                                        positionData.address = address;
                                        const locationInfo = document.querySelector('.gps-data');
                                        if (locationInfo) {
                                            locationInfo.innerHTML = locationInfo.innerHTML.replace('è·å–åœ°å€ä¸­...', address);
                                        }
                                    });
                                });
                            } catch (error) {
                                console.warn('âš ï¸ è·å–åœ°å€å¤±è´¥:', error);
                            }
                        }, 100);
                    }
                });
            } else {
                console.warn('âš ï¸ AMap.convertFromä¸å¯ç”¨ï¼Œä½¿ç”¨åŸå§‹åæ ‡ï¼ˆå¯èƒ½æœ‰åç§»ï¼‰');
                // APIä¸å¯ç”¨ï¼Œä½¿ç”¨åŸå§‹åæ ‡
                const positionData = {
                    coords: {
                        latitude: wgs84Lat,
                        longitude: wgs84Lng,
                        accuracy: accuracy
                    },
                    timestamp: position.timestamp,
                    address: 'è·å–åœ°å€ä¸­...',
                    locationType: 'GPSå«æ˜Ÿå®šä½ï¼ˆæœªè½¬æ¢ï¼‰'
                };
                handleAmapLocationSuccess(positionData);
                
                // å¼‚æ­¥è·å–åœ°å€
                setTimeout(() => {
                    try {
                        AMap.plugin('AMap.Geocoder', function() {
                            const geocoder = new AMap.Geocoder({
                                timeout: 3000
                            });
                            geocoder.getAddress([wgs84Lng, wgs84Lat], function(status, geoResult) {
                                let address = 'åœ°å€æœªçŸ¥';
                                if (status === 'complete' && geoResult.info === 'OK') {
                                    address = geoResult.regeocode.formattedAddress;
                                }
                                console.log('ğŸ“® åœ°å€è·å–ç»“æœ:', address);
                                positionData.address = address;
                                const locationInfo = document.querySelector('.gps-data');
                                if (locationInfo) {
                                    locationInfo.innerHTML = locationInfo.innerHTML.replace('è·å–åœ°å€ä¸­...', address);
                                }
                            });
                        });
                    } catch (error) {
                        console.warn('âš ï¸ è·å–åœ°å€å¤±è´¥:', error);
                    }
                }, 100);
            }
        }
        
        // é«˜å¾·å®šä½å›é€€æ–¹æ¡ˆï¼ˆå½“GPSä¸å¯ç”¨æ—¶ï¼Œä½†ä»æ‹’ç»IPå®šä½ï¼‰
        function useAmapLocationFallback() {
            console.log('ğŸ“± ä½¿ç”¨é«˜å¾·å®šä½æœåŠ¡ï¼ˆå›é€€æ–¹æ¡ˆï¼Œä½†ä»è¦æ±‚GPSï¼‰...');
            updateStatus('æ­£åœ¨ä½¿ç”¨é«˜å¾·å®šä½æœåŠ¡...', 'info', true);
            
            // è®¾ç½®è¶…æ—¶ä¿æŠ¤ï¼ˆ30ç§’åæç¤ºæ‰‹åŠ¨æ ¡å‡†ï¼‰
            const fallbackTimeoutId = setTimeout(() => {
                console.warn('â° é«˜å¾·å®šä½ä¹Ÿè¶…æ—¶äº†');
                updateStatus('å®šä½æœåŠ¡è¶…æ—¶ã€‚è¯·ç‚¹å‡»"æ‰‹åŠ¨æ ¡å‡†ä½ç½®"æŒ‰é’®åœ¨åœ°å›¾ä¸Šè®¾ç½®æ‚¨çš„ä½ç½®', 'warning');
            }, 30000);
            
            AMap.plugin('AMap.Geolocation', function() {
                const geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 30000,  // 30ç§’è¶…æ—¶
                    needAddress: true,
                    extensions: 'all',
                    convert: true,
                    GeoLocationFirst: true,  // ä¼˜å…ˆä½¿ç”¨H5å®šä½
                    noIpLocate: 3,  // ğŸ”¥ å¼ºåˆ¶ç¦ç”¨IPå®šä½ï¼ˆ0=å…è®¸, 3=ç¦ç”¨ï¼‰
                    noGeoLocation: 0,  // å…è®¸ä½¿ç”¨æµè§ˆå™¨å®šä½
                    showButton: false,
                    showMarker: false,
                    showCircle: false,
                    panToLocation: false,
                    zoomToAccuracy: false
                });
                
                geolocation.getCurrentPosition(function(status, result) {
                    clearTimeout(fallbackTimeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                    console.log('ğŸ“ é«˜å¾·å®šä½çŠ¶æ€:', status);
                    console.log('ğŸ“ é«˜å¾·å®šä½ç»“æœ:', result);
                    
                    if (status === 'complete') {
                        // æ£€æŸ¥å®šä½ç±»å‹ï¼Œæ‹’ç»IPå®šä½
                        const locationType = result.location_type || 'æœªçŸ¥';
                        const accuracy = result.accuracy || 999;
                        console.log('ğŸ“ å®šä½æ–¹å¼:', locationType);
                        console.log('ğŸ“ å®šä½ç²¾åº¦:', accuracy, 'ç±³');
                        
                        // ğŸ”¥ æ‹’ç»IPå®šä½
                        if (locationType.includes('IP')) {
                            console.warn('âš ï¸ æ‹’ç»IPå®šä½ï¼Œç²¾åº¦å¤ªä½ï¼ˆè¯¯å·®å¯èƒ½è¾¾åˆ°1-2å…¬é‡Œï¼‰');
                            console.warn('ğŸ’¡ å»ºè®®ï¼šè¯·ç¡®ä¿GPSå·²å¼€å¯ï¼Œå¹¶å…è®¸æµè§ˆå™¨è®¿é—®ä½ç½®ä¿¡æ¯');
                            updateStatus('æ£€æµ‹åˆ°IPå®šä½ï¼Œç²¾åº¦å¤ªä½ã€‚è¯·å¼€å¯GPSå¹¶åˆ°å®¤å¤–é‡æ–°å®šä½', 'error');
                            // å°è¯•ä½¿ç”¨æµè§ˆå™¨GPS
                            setTimeout(() => {
                                console.log('ğŸ”„ å°è¯•ä½¿ç”¨æµè§ˆå™¨GPS...');
                                useBrowserGPSFallback();
                            }, 2000);
                            return;
                        }
                        
                        // ğŸ”¥ æ‹’ç»ä½ç²¾åº¦å®šä½ï¼ˆ>100ç±³ï¼‰
                        if (accuracy > 100) {
                            console.warn(`âš ï¸ å®šä½ç²¾åº¦å¤ªä½ï¼ˆ${accuracy}ç±³ï¼‰ï¼Œå»ºè®®åˆ°å®¤å¤–é‡æ–°å®šä½`);
                            updateStatus(`å®šä½ç²¾åº¦: ${Math.round(accuracy)}ç±³ï¼Œç²¾åº¦è¾ƒä½`, 'warning');
                        }
                        
                        const position = {
                            coords: {
                                latitude: result.position.lat,
                                longitude: result.position.lng,
                                accuracy: accuracy
                            },
                            timestamp: Date.now(),
                            address: result.formattedAddress || '',
                            addressComponent: result.addressComponent || {},
                            locationType: locationType
                        };
                        
                        console.log('âœ… å®šä½æˆåŠŸ:', position);
                        
                        handleAmapLocationSuccess(position);
                    } else {
                        console.error('âŒ é«˜å¾·å®šä½å¤±è´¥:', result);
                        updateStatus('é«˜å¾·å®šä½å¤±è´¥ã€‚è¯·ç‚¹å‡»"æ‰‹åŠ¨æ ¡å‡†ä½ç½®"æŒ‰é’®åœ¨åœ°å›¾ä¸Šè®¾ç½®æ‚¨çš„ä½ç½®', 'warning');
                    }
                });
            });
        }
        
        // ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·ï¼‰
        function useDefaultLocation() {
            console.log('ğŸ“ ä½¿ç”¨é»˜è®¤ä½ç½®ï¼šä¸Šæµ·å¸‚ä¸­å¿ƒ');
            const defaultPosition = {
                coords: {
                    latitude: 31.230416,
                    longitude: 121.473701,
                    accuracy: 1000
                },
                timestamp: Date.now(),
                address: 'ä¸Šæµ·å¸‚é»„æµ¦åŒºäººæ°‘å¹¿åœº',
                locationType: 'é»˜è®¤ä½ç½®'
            };
            handleAmapLocationSuccess(defaultPosition);
            updateStatus('å·²ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·ï¼‰ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»"é‡æ–°å®šä½"è·å–çœŸå®ä½ç½®', 'warning');
        }

        // å®šä½å®Œæˆæ ‡å¿—
        let isLocationSet = false;
        let userLocationLocked = false;
        
        // æ£€æµ‹è®¾å¤‡ç±»å‹
        function isMobileDevice() {
            const ua = navigator.userAgent;
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
        }
        
        // å¤„ç†é«˜å¾·å®šä½æˆåŠŸï¼ˆæ— éœ€åæ ‡è½¬æ¢ï¼‰
        function handleAmapLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy || 100;
            const timestamp = new Date(position.timestamp).toLocaleString();
            const address = position.address || 'æœªçŸ¥ä½ç½®';
            const isMobile = isMobileDevice();
            
            console.log('========== å®šä½æˆåŠŸå¤„ç†å¼€å§‹ ==========');
            console.log('âœ… å®šä½æˆåŠŸ (GCJ-02):', { lat, lng, accuracy });
            console.log('ğŸ“ å‡†ç¡®åæ ‡ [ç»åº¦, çº¬åº¦]:', [lng, lat]);
            console.log('ğŸ“® è¯¦ç»†åœ°å€:', address);
            console.log('ğŸ“± è®¾å¤‡ç±»å‹:', isMobile ? 'ç§»åŠ¨è®¾å¤‡' : 'PC');
            console.log('ğŸ“ åæ ‡æ£€æŸ¥: çº¬åº¦åœ¨30-32ä¹‹é—´?', lat > 30 && lat < 32, ', ç»åº¦åœ¨120-122ä¹‹é—´?', lng > 120 && lng < 122);
            
            // PCè®¾å¤‡ä¸”ç²¾åº¦è¾ƒä½æ—¶ï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
            if (!isMobile && accuracy > 200) {
                console.warn('âš ï¸ PCè®¾å¤‡å®šä½ç²¾åº¦è¾ƒä½ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼ˆPCé€šå¸¸æ²¡æœ‰GPSèŠ¯ç‰‡ï¼‰');
                setTimeout(() => {
                    updateStatus(`ğŸ’¡ PCå®šä½ç²¾åº¦è¾ƒä½ï¼ˆ${Math.round(accuracy)}ç±³ï¼‰æ˜¯æ­£å¸¸çš„ã€‚å»ºè®®ï¼š1) ä½¿ç”¨æ‰‹æœºæµè§ˆå™¨è·å¾—æ›´é«˜ç²¾åº¦ 2) ç‚¹å‡»"æ‰‹åŠ¨æ ¡å‡†ä½ç½®"æŒ‰é’®ç²¾ç¡®è®¾ç½®ä½ç½®`, 'warning');
                }, 2000);
            }
            
            userLocation = [lng, lat];
            isLocationSet = true;
            console.log('âœ… userLocationå·²è®¾ç½®ä¸º:', userLocation);
            
            // ç«‹å³è®¾ç½®åœ°å›¾ä¸­å¿ƒå’Œç¼©æ”¾ï¼ˆåœ¨åˆ›å»ºæ ‡è®°ä¹‹å‰ï¼‰
            console.log('ğŸ—ºï¸ å‡†å¤‡è®¾ç½®åœ°å›¾ä¸­å¿ƒ...');
            console.log('ğŸ—ºï¸ å½“å‰åœ°å›¾å¯¹è±¡:', map ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
            console.log('ğŸ—ºï¸ è®¾ç½®åœ°å›¾ä¸­å¿ƒåˆ°:', userLocation);
            
            // ï¼ï¼ï¼å¼ºåˆ¶è®¾ç½®åœ°å›¾ä¸­å¿ƒï¼Œå¤šæ¬¡å°è¯•ç¡®ä¿æˆåŠŸ
            if (map) {
                // ç«‹å³è®¾ç½®
                map.setZoomAndCenter(18, userLocation);
                console.log('âœ… åœ°å›¾ä¸­å¿ƒå·²è®¾ç½®ï¼ˆç¬¬1æ¬¡ï¼‰');
                
                // å»¶è¿Ÿè®¾ç½®å¤šæ¬¡ï¼Œå¯¹æŠ—å¯èƒ½çš„åœ°å›¾é‡ç½®
                [100, 300, 600, 1000, 1500].forEach(delay => {
                    setTimeout(() => {
                        map.setCenter(userLocation);
                        if (delay === 100) map.setZoom(18);
                        console.log(`âœ… åœ°å›¾ä¸­å¿ƒå·²è®¾ç½®ï¼ˆå»¶è¿Ÿ${delay}msï¼‰`);
                    }, delay);
                });
                
                // æœ€ç»ˆå¼ºåˆ¶ç¡®è®¤
                setTimeout(() => {
                    const currentCenter = map.getCenter();
                    const distance = calculateDistance(
                        [currentCenter.lng, currentCenter.lat],
                        userLocation
                    );
                    console.log(`ğŸ” æœ€ç»ˆæ£€æŸ¥ï¼šåœ°å›¾ä¸­å¿ƒè·ç¦»ç”¨æˆ·ä½ç½® ${distance.toFixed(2)} ç±³`);
                    
                    if (distance > 1000) {
                        // åç§»è¶…è¿‡1å…¬é‡Œï¼Œé‡æ–°åˆ›å»ºåœ°å›¾ï¼
                        console.error('âŒ åœ°å›¾ä¸­å¿ƒåç§»è¶…è¿‡1å…¬é‡Œï¼å‡†å¤‡é‡æ–°åˆ›å»ºåœ°å›¾...');
                        console.log('ğŸ”„ é”€æ¯æ—§åœ°å›¾...');
                        
                        // ä¿å­˜çŠ¶æ€
                        const oldZoom = map.getZoom();
                        
                        // é”€æ¯åœ°å›¾
                        map.destroy();
                        
                        // ç”¨æ­£ç¡®çš„ä¸­å¿ƒé‡æ–°åˆ›å»º
                        console.log('ğŸ†• ä½¿ç”¨æ­£ç¡®ä¸­å¿ƒé‡æ–°åˆ›å»ºåœ°å›¾:', userLocation);
                        map = new AMap.Map('map-container', {
                            zoom: 18,
                            center: userLocation,  // ç›´æ¥ä½¿ç”¨ç”¨æˆ·ä½ç½®ï¼
                            viewMode: '2D',
                            showLabel: true,
                            mapStyle: 'amap://styles/normal',
                            resizeEnable: true,
                            rotateEnable: false,
                            pitchEnable: false,
                            dragEnable: true,
                            zoomEnable: true,
                            doubleClickZoom: true
                        });
                        
                        map.on('complete', function() {
                            console.log('âœ… æ–°åœ°å›¾åˆ›å»ºå®Œæˆ');
                            const newCenter = map.getCenter();
                            console.log('ğŸ” æ–°åœ°å›¾ä¸­å¿ƒ:', [newCenter.lng, newCenter.lat]);
                            
                            // é‡æ–°åˆ›å»ºç”¨æˆ·æ ‡è®°
                            setTimeout(() => {
                                createUserMarker();
                                // é‡æ–°ç”Ÿæˆå®è—
                                if (treasureMarkers.length === 0) {
                                    generateNearbyTreasures();
                                }
                            }, 500);
                        });
                    } else if (distance > 50) {
                        console.warn('âš ï¸ åœ°å›¾ä¸­å¿ƒåç§»è¿‡å¤§ï¼Œå¼ºåˆ¶é‡æ–°è®¾ç½®');
                        map.setCenter(userLocation);
                        map.setZoom(18);
                    }
                    
                    // ä¸å†é”å®šç”¨æˆ·ä½ç½®ï¼Œå…è®¸ç”¨æˆ·è‡ªç”±ç§»åŠ¨åœ°å›¾
                    console.log('âœ… ç”¨æˆ·ä½ç½®å·²è®¾ç½®ï¼Œå¯ä»¥è‡ªç”±ç§»åŠ¨åœ°å›¾');
                }, 2000);
            } else {
                console.error('âŒ åœ°å›¾å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•è®¾ç½®ä¸­å¿ƒï¼');
            }
            
            // éªŒè¯åœ°å›¾ä¸­å¿ƒæ˜¯å¦æ­£ç¡®è®¾ç½®
            setTimeout(() => {
                const mapCenter = map.getCenter();
                console.log('ğŸ” éªŒè¯åœ°å›¾ä¸­å¿ƒ:', [mapCenter.lng, mapCenter.lat]);
                console.log('ğŸ” ç›®æ ‡ä½ç½®:', userLocation);
                const distance = calculateDistance(
                    [mapCenter.lng, mapCenter.lat], 
                    userLocation
                );
                console.log('ğŸ” åœ°å›¾ä¸­å¿ƒä¸ç›®æ ‡ä½ç½®è·ç¦»:', distance.toFixed(2), 'ç±³');
            }, 500);
            
            // æ ¹æ®ç²¾åº¦æ˜¾ç¤ºä¸åŒçš„çŠ¶æ€æ¶ˆæ¯
            let accuracyStatus = '';
            let accuracyColor = '#4FC3F7';
            let accuracyIcon = 'âœ…';
            let accuracyTip = '';
            
            if (accuracy < 10) {
                accuracyStatus = 'ğŸ¯ æé«˜ç²¾åº¦';
                accuracyColor = '#4CAF50';
                accuracyIcon = 'ğŸ¯';
                accuracyTip = 'GPSä¿¡å·æä½³ï¼Œå®šä½éå¸¸å‡†ç¡®ï¼';
            } else if (accuracy < 20) {
                accuracyStatus = 'âœ… é«˜ç²¾åº¦';
                accuracyColor = '#4CAF50';
                accuracyIcon = 'âœ…';
                accuracyTip = 'GPSä¿¡å·è‰¯å¥½ï¼Œå®šä½å‡†ç¡®ï¼';
            } else if (accuracy < 50) {
                accuracyStatus = 'âœ… è‰¯å¥½';
                accuracyColor = '#4FC3F7';
                accuracyIcon = 'âœ…';
                accuracyTip = 'GPSä¿¡å·æ­£å¸¸ï¼Œå®šä½è‰¯å¥½ã€‚';
            } else if (accuracy < 100) {
                accuracyStatus = 'âš ï¸ ä¸€èˆ¬';
                accuracyColor = '#FF9800';
                accuracyIcon = 'âš ï¸';
                accuracyTip = 'GPSä¿¡å·è¾ƒå¼±ï¼Œå»ºè®®åˆ°å®¤å¤–ç©ºæ—·å¤„é‡æ–°å®šä½ä»¥è·å¾—æ›´å‡†ç¡®çš„ä½ç½®ã€‚';
            } else {
                accuracyStatus = 'âŒ è¾ƒå·®';
                accuracyColor = '#F44336';
                accuracyIcon = 'âŒ';
                accuracyTip = 'GPSä¿¡å·å¾ˆå¼±ï¼Œå®šä½ç²¾åº¦è¾ƒä½ã€‚å¼ºçƒˆå»ºè®®åˆ°å®¤å¤–ç©ºæ—·å¤„é‡æ–°å®šä½ï¼';
            }
            
            updateStatus(`å®šä½æˆåŠŸï¼${accuracyStatus} ç²¾åº¦: ${Math.round(accuracy)}ç±³`, 'success');
            
            let locationInfo = `
                <strong>ğŸ“ ä½ç½®ä¿¡æ¯</strong><br>
                å®šä½æ–¹å¼: ${position.locationType || 'GPSå®šä½'}<br>
                <strong style="color: #4FC3F7;">ğŸ“® ${address}</strong><br>
                <br>
                <strong>å½“å‰ä½ç½® (GCJ-02):</strong><br>
                çº¬åº¦: ${lat.toFixed(6)}<br>
                ç»åº¦: ${lng.toFixed(6)}<br>
                <strong style="color: ${accuracyColor};">
                    ${accuracyIcon} ç²¾åº¦: ${Math.round(accuracy)}ç±³ (${accuracyStatus})
                </strong><br>
                <small style="color: ${accuracyColor};">${accuracyTip}</small><br>
                æ—¶é—´: ${timestamp}<br>
            `;
            
            // å¦‚æœæœ‰WGS84åŸå§‹åæ ‡ï¼Œæ˜¾ç¤ºå¯¹æ¯”
            if (position.wgs84) {
                const wgs84 = position.wgs84;
                const offset = calculateDistance([lng, lat], [wgs84.lng, wgs84.lat]);
                locationInfo += `
                    <br>
                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #666;">ğŸ” æŸ¥çœ‹åæ ‡è¯¦æƒ…</summary>
                        <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 8px;">
                            <strong>åŸå§‹GPS (WGS84):</strong><br>
                            çº¬åº¦: ${wgs84.lat.toFixed(6)}<br>
                            ç»åº¦: ${wgs84.lng.toFixed(6)}<br>
                            <br>
                            <strong>åœ°å›¾åæ ‡ (GCJ-02):</strong><br>
                            çº¬åº¦: ${lat.toFixed(6)}<br>
                            ç»åº¦: ${lng.toFixed(6)}<br>
                            <br>
                            <strong>åæ ‡åç§»:</strong> ${offset.toFixed(2)}ç±³<br>
                            <small style="color: #666;">
                                ä¸­å›½GPSå¿…é¡»è½¬æ¢åæ ‡ç³»<br>
                                WGS84 â†’ GCJ-02 (ç«æ˜Ÿåæ ‡)
                            </small>
                        </div>
                    </details>
                `;
            } else {
                locationInfo += `
                    <small style="color: #666;">
                        åæ ‡ç³»: GCJ-02 (é«˜å¾·åœ°å›¾æ ‡å‡†)
                    </small>
                `;
            }
            
            updateGPSData(locationInfo);
            
            updateStats(accuracy);
            
            // å»¶è¿Ÿåˆ›å»ºæ ‡è®°ï¼Œç¡®ä¿åœ°å›¾å·²ç»ç§»åŠ¨åˆ°ä½
            setTimeout(() => {
                console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                createUserMarker();
            }, 600);
            
            setTimeout(() => {
                if (treasureMarkers.length === 0) {
                    console.log('ğŸ å¼€å§‹ç”Ÿæˆå®è—...');
                    generateNearbyTreasures();
                }
            }, 1000);
        }


        // å¤„ç†å®šä½æˆåŠŸï¼ˆæ”¹è¿›ç‰ˆæœ¬ - æ·»åŠ åæ ‡è½¬æ¢ï¼‰
        function handleLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy || 0;
            const timestamp = new Date(position.timestamp).toLocaleString();
            
            console.log('âœ… GPSåæ ‡:', { lat, lng, accuracy });
            
            // åœ¨ä¸­å›½å¢ƒå†…ï¼Œæµè§ˆå™¨é€šå¸¸ç›´æ¥è¿”å›GCJ-02åæ ‡
            // ç›´æ¥ä½¿ç”¨ï¼Œä¸è¿›è¡Œè½¬æ¢ï¼ˆé¿å…è½¬æ¢å¤±è´¥ï¼‰
            console.log('ğŸ“ ç›´æ¥ä½¿ç”¨åæ ‡ï¼ˆä¸­å›½å¢ƒå†…æµè§ˆå™¨é€šå¸¸è¿”å›GCJ-02ï¼‰');
            
            userLocation = [lng, lat];
            
            updateStatus(`GPSå®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³`, 'success');
            updateGPSData(`
                <strong>ğŸ“ ä½ç½®ä¿¡æ¯ (GCJ-02)</strong><br>
                çº¬åº¦: ${lat.toFixed(6)}<br>
                ç»åº¦: ${lng.toFixed(6)}<br>
                ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 50 ? 'âœ… ä¼˜ç§€' : accuracy < 100 ? 'âœ…' : 'âš ï¸'}<br>
                æ—¶é—´: ${timestamp}<br>
                <small style="color: #666;">
                    åæ ‡ç³»: GCJ-02 (é«˜å¾·åœ°å›¾æ ‡å‡†)<br>
                    ${lat > 30 && lat < 32 && lng > 120 && lng < 122 ? 'ğŸ¯ ä¸Šæµ·åœ°åŒºå®šä½æˆåŠŸ' : 'ğŸŒ å…¶ä»–åœ°åŒº'}
                </small>
            `);
            
            updateStats(accuracy);
            
            // è®¾ç½®åœ°å›¾ä¸­å¿ƒ
            console.log('ğŸ—ºï¸ è®¾ç½®åœ°å›¾ä¸­å¿ƒåˆ°:', userLocation);
            map.setZoomAndCenter(17, userLocation);
            
            // åˆ›å»ºç”¨æˆ·æ ‡è®°
            setTimeout(() => {
                console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                createUserMarker();
            }, 300);
            
            // ç”Ÿæˆå®è—
            setTimeout(() => {
                if (treasureMarkers.length === 0) {
                    console.log('ğŸ ç”Ÿæˆå®è—...');
                    generateNearbyTreasures();
                }
            }, 800);
            
            // ä¸‹é¢çš„ä»£ç ä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼ˆå¦‚æœéœ€è¦è½¬æ¢ï¼‰
            if (false && typeof AMap !== 'undefined' && AMap.convertFrom) {
                // è¿™æ®µä»£ç ä¸å†æ‰§è¡Œï¼Œä»…ä¿ç•™ä½œä¸ºå‚è€ƒ
                AMap.convertFrom([lng, lat], 'gps', function(status, result) {
                    console.log('ğŸ“ åæ ‡è½¬æ¢çŠ¶æ€:', status);
                    console.log('ğŸ“ åæ ‡è½¬æ¢ç»“æœ:', result);
                    console.log('ğŸ“ result.info:', result ? result.info : 'undefined');
                    console.log('ğŸ“ result.locations:', result ? result.locations : 'undefined');
                    
                    if (status === 'complete' && result && result.info === 'ok' && result.locations && result.locations.length > 0) {
                        const convertedLocation = result.locations[0];
                        userLocation = [convertedLocation.lng, convertedLocation.lat];
                        
                        console.log('âœ… è½¬æ¢ååæ ‡ (GCJ-02):', userLocation);
                        console.log('ğŸ“ åç§»è·ç¦»:', calculateDistance([lng, lat], userLocation).toFixed(2), 'ç±³');
                        
                        updateStatus(`GPSå®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³ (åæ ‡å·²è½¬æ¢)`, 'success');
                        updateGPSData(`
                            <strong>ğŸ“ ä½ç½®ä¿¡æ¯</strong><br>
                            åŸå§‹ä½ç½® (WGS84):<br>
                            çº¬åº¦: ${lat.toFixed(6)}<br>
                            ç»åº¦: ${lng.toFixed(6)}<br>
                            <br>
                            è½¬æ¢åä½ç½® (GCJ-02):<br>
                            çº¬åº¦: ${convertedLocation.lat.toFixed(6)} ${convertedLocation.lat > 30 && convertedLocation.lat < 32 ? 'âœ…' : 'â“'}<br>
                            ç»åº¦: ${convertedLocation.lng.toFixed(6)} ${convertedLocation.lng > 120 && convertedLocation.lng < 122 ? 'âœ…' : 'â“'}<br>
                            <br>
                            ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 100 ? 'âœ…' : accuracy < 500 ? 'âš ï¸' : 'âŒ'}<br>
                            æ—¶é—´: ${timestamp}<br>
                            <small style="color: #666;">
                                åæ ‡ç³»: WGS84 â†’ GCJ-02 (é«˜å¾·)<br>
                                ${convertedLocation.lat > 30 && convertedLocation.lat < 32 && convertedLocation.lng > 120 && convertedLocation.lng < 122 ? 'ğŸ¯ ä¸Šæµ·åœ°åŒºå®šä½æˆåŠŸ' : 'ğŸŒ éä¸Šæµ·åœ°åŒº'}
                            </small>
                        `);
                        
                        updateStats(accuracy);
                        
                        // å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒå’Œç¼©æ”¾
                        console.log('ğŸ—ºï¸ å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒ...');
                        map.setZoomAndCenter(17, userLocation);
                        
                        // å»¶è¿Ÿåˆ›å»ºæ ‡è®°
                        setTimeout(() => {
                            console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                            createUserMarker();
                        }, 300);
                        
                        // ç«‹å³ç”Ÿæˆå®è—
                        setTimeout(() => {
                            if (treasureMarkers.length === 0) {
                                console.log('ğŸ å¼€å§‹ç”Ÿæˆå®è—...');
                                generateNearbyTreasures();
                            }
                        }, 800);
                    } else {
                        // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹åæ ‡ï¼ˆå¯èƒ½ä¼šæœ‰åç§»ï¼‰
                        console.warn('âš ï¸ åæ ‡è½¬æ¢å¤±è´¥');
                        console.warn('   Status:', status);
                        console.warn('   Result:', result);
                        console.warn('   ä½¿ç”¨åŸå§‹åæ ‡ä½œä¸ºGCJ-02ï¼ˆå¯èƒ½æœ‰50-200ç±³åç§»ï¼‰');
                        
                        // ç›´æ¥ä½¿ç”¨åŸå§‹åæ ‡ï¼Œå‡è®¾å®ƒå·²ç»æ˜¯GCJ-02
                        // ï¼ˆå› ä¸ºè¯Šæ–­å·¥å…·æ˜¾ç¤ºå®šä½æˆåŠŸä¸”åæ ‡æ­£ç¡®ï¼‰
                        userLocation = [lng, lat];
                        
                        console.log('ğŸ“ ä½¿ç”¨åæ ‡:', userLocation);
                        
                        updateStatus(`GPSå®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³`, 'success');
                        updateGPSData(`
                            <strong>ğŸ“ ä½ç½®ä¿¡æ¯ (GCJ-02)</strong><br>
                            çº¬åº¦: ${lat.toFixed(6)}<br>
                            ç»åº¦: ${lng.toFixed(6)}<br>
                            ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 50 ? 'âœ… ä¼˜ç§€' : accuracy < 100 ? 'âœ…' : 'âš ï¸'}<br>
                            æ—¶é—´: ${timestamp}<br>
                            <small style="color: #666;">
                                åæ ‡ç³»: GCJ-02 (é«˜å¾·åœ°å›¾æ ‡å‡†)<br>
                                ${lat > 30 && lat < 32 && lng > 120 && lng < 122 ? 'ğŸ¯ ä¸Šæµ·åœ°åŒºå®šä½æˆåŠŸ' : 'ğŸŒ å…¶ä»–åœ°åŒº'}
                            </small>
                        `);
                        
                        updateStats(accuracy);
                        
                        // è®¾ç½®åœ°å›¾ä¸­å¿ƒ
                        console.log('ğŸ—ºï¸ è®¾ç½®åœ°å›¾ä¸­å¿ƒ...');
                        map.setZoomAndCenter(17, userLocation);
                        
                        // åˆ›å»ºç”¨æˆ·æ ‡è®°
                        setTimeout(() => {
                            console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                            createUserMarker();
                        }, 300);
                        
                        // ç”Ÿæˆå®è—
                        setTimeout(() => {
                            if (treasureMarkers.length === 0) {
                                console.log('ğŸ ç”Ÿæˆå®è—...');
                                generateNearbyTreasures();
                            }
                        }, 800);
                    }
                });
            }
        }

        // ä½¿ç”¨åŸå§‹åæ ‡çš„è¾…åŠ©å‡½æ•°
        function useRawCoordinates(lat, lng, accuracy, timestamp) {
            userLocation = [lng, lat];
            
            console.log('ğŸ“ ä½¿ç”¨åŸå§‹åæ ‡ (WGS84):', userLocation);
            
            updateStatus(`GPSå®šä½æˆåŠŸï¼ç²¾åº¦: ${Math.round(accuracy)}ç±³ (æœªè½¬æ¢åæ ‡ï¼Œå¯èƒ½æœ‰åç§»)`, 'warning');
            updateGPSData(`
                <strong>ğŸ“ ä½ç½®ä¿¡æ¯</strong><br>
                çº¬åº¦: ${lat.toFixed(6)} ${lat > 30 && lat < 32 ? 'âœ…' : 'â“'}<br>
                ç»åº¦: ${lng.toFixed(6)} ${lng > 120 && lng < 122 ? 'âœ…' : 'â“'}<br>
                ç²¾åº¦: ${Math.round(accuracy)}ç±³ ${accuracy < 100 ? 'âœ…' : accuracy < 500 ? 'âš ï¸' : 'âŒ'}<br>
                æ—¶é—´: ${timestamp}<br>
                <small style="color: #666;">
                    åæ ‡ç³»: WGS84 (æœªè½¬æ¢)<br>
                    âš ï¸ åæ ‡è½¬æ¢å¤±è´¥ï¼Œä½ç½®å¯èƒ½æœ‰åç§» 50-500ç±³<br>
                    ${lat > 30 && lat < 32 && lng > 120 && lng < 122 ? 'ğŸ¯ ä¸Šæµ·åœ°åŒºå®šä½æˆåŠŸ' : 'ğŸŒ éä¸Šæµ·åœ°åŒº'}
                </small>
            `);
            
            updateStats(accuracy);
            
            // å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒå’Œç¼©æ”¾
            console.log('ğŸ—ºï¸ å…ˆè®¾ç½®åœ°å›¾ä¸­å¿ƒ...');
            map.setZoomAndCenter(17, userLocation);
            
            // å»¶è¿Ÿåˆ›å»ºæ ‡è®°
            setTimeout(() => {
                console.log('ğŸ“Œ åˆ›å»ºç”¨æˆ·æ ‡è®°...');
                createUserMarker();
            }, 300);
            
            setTimeout(() => {
                if (treasureMarkers.length === 0) {
                    console.log('ğŸ å¼€å§‹ç”Ÿæˆå®è—...');
                    generateNearbyTreasures();
                }
            }, 800);
        }

        // å¤„ç†å®šä½é”™è¯¯
        function handleLocationError(error) {
            let errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'ç”¨æˆ·æ‹’ç»äº†ä½ç½®æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ä½ç½®è®¿é—®';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥GPSæ˜¯å¦å¼€å¯';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'å®šä½è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•';
                    break;
                default:
                    errorMsg = 'æœªçŸ¥å®šä½é”™è¯¯ï¼Œè¯·é‡è¯•';
                    break;
            }
            
            updateStatus(`GPSå®šä½å¤±è´¥: ${errorMsg}`, 'error');
            updateGPSData(`
                <strong>âŒ å®šä½å¤±è´¥</strong><br>
                é”™è¯¯: ${errorMsg}<br>
                <small style="color: #666;">
                    å»ºè®®:<br>
                    â€¢ åœ¨æˆ·å¤–é‡è¯•<br>
                    â€¢ æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®<br>
                    â€¢ ç¡®ä¿GPSåŠŸèƒ½å·²å¼€å¯
                </small>
            `);
            
            // ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·å¤–æ»©ï¼‰
            userLocation = [121.4737, 31.2304];
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            updateStatus('GPSå®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·å¤–æ»©ï¼‰ã€‚å»ºè®®åœ¨æˆ·å¤–é‡æ–°å°è¯•å®šä½ã€‚', 'warning');
            
            // å³ä½¿æ˜¯é»˜è®¤ä½ç½®ä¹Ÿç”Ÿæˆå®è—
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1000);
        }

        // åˆ›å»ºç”¨æˆ·ä½ç½®æ ‡è®°ï¼ˆæ”¹è¿›ç‰ˆæœ¬ - æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼‰
        function createUserMarker() {
            console.log('========== å¼€å§‹åˆ›å»ºç”¨æˆ·æ ‡è®° ==========');
            console.log('å½“å‰åœ°å›¾å¯¹è±¡:', map ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–');
            console.log('å½“å‰ç”¨æˆ·ä½ç½®:', userLocation);
            
            if (!map) {
                console.error('âŒ åœ°å›¾æœªåˆå§‹åŒ–');
                updateStatus('åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ›å»ºæ ‡è®°', 'error');
                return false;
            }
            
            if (!userLocation || !Array.isArray(userLocation) || userLocation.length !== 2) {
                console.error('âŒ ç”¨æˆ·ä½ç½®æ— æ•ˆ:', userLocation);
                updateStatus('ç”¨æˆ·ä½ç½®æ— æ•ˆï¼Œæ— æ³•åˆ›å»ºæ ‡è®°', 'error');
                return false;
            }

            console.log('ğŸ“ å‡†å¤‡åˆ›å»ºæ ‡è®°ï¼Œä½ç½®:', userLocation);
            console.log('ç»åº¦:', userLocation[0], 'çº¬åº¦:', userLocation[1]);

            // ç§»é™¤æ—§æ ‡è®°
            if (userMarker) {
                console.log('ğŸ—‘ï¸ ç§»é™¤æ—§çš„ç”¨æˆ·æ ‡è®°');
                try {
                    map.remove(userMarker);
                    userMarker = null;
                    console.log('âœ… æ—§æ ‡è®°å·²ç§»é™¤');
                } catch (error) {
                    console.error('âŒ ç§»é™¤æ—§æ ‡è®°å¤±è´¥:', error);
                }
            }

            try {
                console.log('ğŸ¨ åˆ›å»ºæ ‡è®°å›¾æ ‡...');
                // ä½¿ç”¨ç®€å•çš„SVGï¼Œä¸åŒ…å«emojiï¼ˆé¿å…btoaç¼–ç é”™è¯¯ï¼‰
                const svgIcon = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60">
                        <defs>
                            <radialGradient id="glow" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#4CAF50;stop-opacity:0.3" />
                            </radialGradient>
                        </defs>
                        <circle cx="30" cy="30" r="25" fill="url(#glow)" opacity="0.6"/>
                        <circle cx="30" cy="30" r="18" fill="#4CAF50" stroke="white" stroke-width="4"/>
                        <circle cx="30" cy="30" r="12" fill="#81C784"/>
                        <circle cx="30" cy="30" r="6" fill="white"/>
                        <path d="M 30 10 L 28 20 L 32 20 Z" fill="white" opacity="0.8"/>
                    </svg>
                `;
                
                console.log('ğŸ“Œ åˆ›å»ºMarkerå¯¹è±¡...');
                console.log('ğŸ” userLocationè¯¦æƒ…:', userLocation);
                console.log('ğŸ” ç»åº¦(lng):', userLocation[0], 'ç±»å‹:', typeof userLocation[0]);
                console.log('ğŸ” çº¬åº¦(lat):', userLocation[1], 'ç±»å‹:', typeof userLocation[1]);
                
                // ç¡®ä¿åæ ‡æ˜¯æ•°å­—
                const markerLng = Number(userLocation[0]);
                const markerLat = Number(userLocation[1]);
                console.log('ğŸ” è½¬æ¢åç»åº¦:', markerLng);
                console.log('ğŸ” è½¬æ¢åçº¬åº¦:', markerLat);
                
                // ä½¿ç”¨encodeURIComponentä»£æ›¿btoaï¼Œé¿å…Unicodeé—®é¢˜
                const encodedSvg = encodeURIComponent(svgIcon);
                
                const markerPosition = new AMap.LngLat(markerLng, markerLat);
                console.log('ğŸ” Markerä½ç½®å¯¹è±¡:', markerPosition);
                console.log('ğŸ” Markerä½ç½® lng:', markerPosition.getLng(), 'lat:', markerPosition.getLat());
                
                userMarker = new AMap.Marker({
                    position: markerPosition,
                    icon: new AMap.Icon({
                        image: 'data:image/svg+xml;charset=utf-8,' + encodedSvg,
                        size: new AMap.Size(60, 60),
                        imageSize: new AMap.Size(60, 60),
                        imageOffset: new AMap.Pixel(0, 0)
                    }),
                    title: `æˆ‘çš„ä½ç½®\nç»åº¦: ${userLocation[0].toFixed(6)}\nçº¬åº¦: ${userLocation[1].toFixed(6)}`,
                    zIndex: 1000,
                    offset: new AMap.Pixel(-30, -30),
                    animation: 'AMAP_ANIMATION_BOUNCE',
                    clickable: true
                });

                console.log('âœ… Markerå¯¹è±¡åˆ›å»ºæˆåŠŸ');
                console.log('ğŸ” åˆ›å»ºåéªŒè¯ Markerä½ç½®:', userMarker.getPosition());
                console.log('â• æ·»åŠ æ ‡è®°åˆ°åœ°å›¾...');
                
                map.add(userMarker);
                
                console.log('âœ… æ ‡è®°å·²æ·»åŠ åˆ°åœ°å›¾');
                console.log('ğŸ” æ·»åŠ åéªŒè¯ Markerä½ç½®:', userMarker.getPosition());
                console.log('ğŸ” åœ°å›¾ä¸­å¿ƒ:', map.getCenter());
                console.log('ğŸ“Š å½“å‰åœ°å›¾ä¸Šçš„æ ‡è®°æ•°:', map.getAllOverlays('marker').length);
                
                // éªŒè¯æ ‡è®°æ˜¯å¦æ­£ç¡®æ·»åŠ 
                const allMarkers = map.getAllOverlays('marker');
                console.log('åœ°å›¾ä¸Šçš„æ‰€æœ‰æ ‡è®°:', allMarkers);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                userMarker.on('click', function() {
                    console.log('ğŸ‘† ç”¨æˆ·æ ‡è®°è¢«ç‚¹å‡»');
                    const infoWindow = new AMap.InfoWindow({
                        content: `
                            <div style="padding: 10px; text-align: center;">
                                <div style="font-size: 1.5rem; margin-bottom: 5px;">ğŸ“ æˆ‘çš„ä½ç½®</div>
                                <div style="color: #666; font-size: 0.9rem;">ç»åº¦: ${userLocation[0].toFixed(6)}</div>
                                <div style="color: #666; font-size: 0.9rem;">çº¬åº¦: ${userLocation[1].toFixed(6)}</div>
                            </div>
                        `,
                        anchor: 'bottom-center',
                        offset: new AMap.Pixel(0, -5)
                    });
                    infoWindow.open(map, userLocation);
                });
                
                console.log('========== ç”¨æˆ·æ ‡è®°åˆ›å»ºå®Œæˆ âœ… ==========');
                return true;
                
            } catch (error) {
                console.error('âŒ åˆ›å»ºç”¨æˆ·æ ‡è®°å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                updateStatus('åˆ›å»ºç”¨æˆ·æ ‡è®°å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // ç”Ÿæˆå‘¨å›´çš„å®è—
        function generateNearbyTreasures() {
            if (!map || !userLocation) {
                updateStatus('è¯·å…ˆè·å–GPSä½ç½®ï¼', 'warning');
                return;
            }

            // æ¸…ç©ºç°æœ‰å®è—
            if (treasureMarkers.length > 0) {
                clearMap();
            }

            updateStatus('æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆå‘¨å›´çš„å®è—...', 'info', true);

            // ç”Ÿæˆ3-5ä¸ªå®è—
            const treasureCount = Math.floor(Math.random() * 3) + 3;
            
            for (let i = 0; i < treasureCount; i++) {
                setTimeout(() => {
                    const treasureType = getRandomTreasureByRarity();
                    
                    // åœ¨ç”¨æˆ·ä½ç½®å‘¨å›´ç”Ÿæˆ
                    const angle = Math.random() * 2 * Math.PI;
                    const distance = Math.random() * 0.003 + 0.001; // çº¦100-400ç±³
                    
                    const offsetLng = Math.cos(angle) * distance;
                    const offsetLat = Math.sin(angle) * distance;
                    const position = [userLocation[0] + offsetLng, userLocation[1] + offsetLat];

                    addTreasureAtPosition(position, treasureType);
                    
                    if (i === treasureCount - 1) {
                        updateStatus(`ğŸ—ºï¸ å·²ç”Ÿæˆ${treasureCount}ä¸ªå®è—ï¼å¼€å§‹å¯»å®å§ï¼`, 'success');
                    }
                }, i * 200);
            }
        }

        // æ ¹æ®ç¨€æœ‰åº¦éšæœºé€‰æ‹©å®è—ç±»å‹
        function getRandomTreasureByRarity() {
            const rarityWeights = {
                'common': 40,
                'uncommon': 30,
                'rare': 20,
                'epic': 8,
                'legendary': 2
            };

            // åˆ›å»ºåŠ æƒæ•°ç»„
            let weightedArray = [];
            treasureTypes.forEach(type => {
                const weight = rarityWeights[type.rarity] || 10;
                for (let i = 0; i < weight; i++) {
                    weightedArray.push(type);
                }
            });

            return weightedArray[Math.floor(Math.random() * weightedArray.length)];
        }

        // æ‰‹åŠ¨æ·»åŠ å•ä¸ªå®è—
        function addTreasure() {
            if (!map || !userLocation) {
                updateStatus('è¯·å…ˆè·å–GPSä½ç½®ï¼', 'warning');
                return;
            }

            const treasureType = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
            
            // åœ¨ç”¨æˆ·ä½ç½®é™„è¿‘éšæœºç”Ÿæˆå®è—
            const offsetLng = (Math.random() - 0.5) * 0.008; // çº¦400ç±³èŒƒå›´
            const offsetLat = (Math.random() - 0.5) * 0.008;
            const position = [userLocation[0] + offsetLng, userLocation[1] + offsetLat];

            addTreasureAtPosition(position, treasureType);
        }

        // åœ¨æŒ‡å®šä½ç½®æ·»åŠ å®è—
        function addTreasureAtPosition(position, treasureType = null) {
            if (!map || !position) return;

            if (!treasureType) {
                treasureType = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
            }

            // åˆ›å»ºå®è—æ•°æ®
            const treasureData = treasureManager.createTreasure(position, treasureType, 'player');
            userData.createdTreasures.push(treasureData);
            userData.stats.treasuresCreated += 1;

            // åˆ›å»ºåœ°å›¾æ ‡è®°ï¼ˆä½¿ç”¨ç®€å•å›¾å½¢ä»£æ›¿emojiï¼‰
            const treasureSvg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50">
                    <defs>
                        <radialGradient id="glow-${treasureType.name}" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:${treasureType.color};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:${treasureType.color};stop-opacity:0.2" />
                        </radialGradient>
                    </defs>
                    <circle cx="25" cy="25" r="22" fill="url(#glow-${treasureType.name})" opacity="0.6"/>
                    <circle cx="25" cy="25" r="18" fill="${treasureType.color}" stroke="white" stroke-width="3"/>
                    <circle cx="25" cy="25" r="12" fill="${treasureType.color}" opacity="0.8"/>
                    <circle cx="25" cy="25" r="6" fill="white" opacity="0.9"/>
                    <text x="25" y="30" text-anchor="middle" fill="white" font-size="20" font-weight="bold">?</text>
                </svg>
            `;
            const encodedTreasureSvg = encodeURIComponent(treasureSvg);
            
            const treasureMarker = new AMap.Marker({
                position: position,
                icon: new AMap.Icon({
                    image: 'data:image/svg+xml;charset=utf-8,' + encodedTreasureSvg,
                    size: new AMap.Size(50, 50),
                    imageOffset: new AMap.Pixel(-25, -25)
                }),
                title: `${treasureType.name} (${treasureType.rarity})`,
                zIndex: 500
            });

            // å­˜å‚¨å®è—IDåˆ°æ ‡è®°ä¸Š
            treasureMarker.treasureId = treasureData.id;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            treasureMarker.on('click', function() {
                if (userLocation) {
                    const distance = calculateDistance(userLocation, position);
                    const requiredDistance = treasureData.location.discoveryRadius;
                    
                    if (distance <= requiredDistance) {
                        // å°è¯•å‘ç°å®è—
                        const result = treasureManager.discoverTreasure(treasureData.id, userLocation);
                        
                        if (result.success) {
                            // å‘ç°æˆåŠŸ
                            map.remove(treasureMarker);
                            treasureMarkers = treasureMarkers.filter(m => m !== treasureMarker);
                            
                            let message = `ğŸ‰ æ­å–œï¼æ‚¨å‘ç°äº†${result.treasure.title}ï¼\n`;
                            message += `ğŸ’° è·å¾— ${result.rewards.coins} é‡‘å¸\n`;
                            message += `â­ è·å¾— ${result.rewards.experience} ç»éªŒ`;
                            
                            if (result.levelUp) {
                                message += `\nğŸŠ ç­‰çº§æå‡ï¼LV.${result.levelUp.oldLevel} â†’ LV.${result.levelUp.newLevel}`;
                            }
                            
                            updateStatus(message, 'success');
                            
                            // æ£€æŸ¥æ–°æˆå°±
                            const newAchievements = achievementManager.checkAchievements();
                            if (newAchievements.length > 0) {
                                setTimeout(() => {
                                    updateStatus('ğŸ† è·å¾—æ–°æˆå°±ï¼æŸ¥çœ‹å¾½ç« ç³»ç»Ÿäº†è§£è¯¦æƒ…', 'success');
                                }, 2000);
                            }
                            
                        } else {
                            // å‘ç°å¤±è´¥
                            if (result.reason === 'already_discovered') {
                                updateStatus('æ‚¨å·²ç»å‘ç°è¿‡è¿™ä¸ªå®è—äº†', 'warning');
                            } else if (result.reason === 'too_far') {
                                updateStatus(`è·ç¦»å¤ªè¿œï¼è¿˜éœ€è¦é è¿‘${Math.round(result.distance - result.requiredDistance)}ç±³`, 'warning');
                            }
                        }
                    } else {
                        updateStatus(`${treasureType.name}è·ç¦»æ‚¨è¿˜æœ‰${Math.round(distance)}ç±³ï¼ˆéœ€è¦åœ¨${requiredDistance}ç±³å†…ï¼‰`, 'info');
                        
                        // æ˜¾ç¤ºè·ç¦»æŒ‡ç¤º
                        const infoWindow = new AMap.InfoWindow({
                            content: `
                                <div style="padding: 10px; text-align: center;">
                                    <div style="font-size: 1.2rem; margin-bottom: 5px;">${treasureType.icon} ${treasureType.name}</div>
                                    <div style="color: #666; font-size: 0.9rem;">è·ç¦»: ${Math.round(distance)}ç±³</div>
                                    <div style="color: #666; font-size: 0.9rem;">éœ€è¦: ${requiredDistance}ç±³å†…</div>
                                    <div style="color: #4FC3F7; font-size: 0.8rem; margin-top: 5px;">
                                        ğŸ’° ${treasureType.rewards.coins} é‡‘å¸ | â­ ${treasureType.rewards.experience} ç»éªŒ
                                    </div>
                                </div>
                            `,
                            anchor: 'bottom-center',
                            offset: new AMap.Pixel(0, -5)
                        });
                        infoWindow.open(map, position);
                        
                        // 3ç§’åè‡ªåŠ¨å…³é—­
                        setTimeout(() => {
                            infoWindow.close();
                        }, 3000);
                    }
                }
            });

            // æ·»åŠ åˆ°åœ°å›¾
            map.add(treasureMarker);
            treasureMarkers.push(treasureMarker);
            
            // ä¿å­˜æ•°æ®
            saveUserData();
            updateStats();
        }

        // å›åˆ°æˆ‘çš„ä½ç½®
        function centerToUser() {
            if (!map) {
                updateStatus('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼', 'warning');
                return;
            }
            
            if (!userLocation) {
                updateStatus('è¿˜æ²¡æœ‰è·å–åˆ°ä½ç½®ï¼Œè¯·å…ˆç‚¹å‡»"é‡æ–°å®šä½"', 'warning');
                return;
            }
            
            console.log('ğŸ¯ å¼ºåˆ¶ç§»åŠ¨åœ°å›¾åˆ°ç”¨æˆ·ä½ç½®:', userLocation);
            console.log('å½“å‰åœ°å›¾ä¸­å¿ƒ:', map.getCenter());
            
            // å¤šæ¬¡å¼ºåˆ¶è®¾ç½®ï¼Œç¡®ä¿ç”Ÿæ•ˆ
            map.setZoomAndCenter(18, userLocation);
            
            setTimeout(() => {
                map.setCenter(userLocation);
                map.setZoom(18);
                console.log('âœ… åœ°å›¾ä¸­å¿ƒå·²æ›´æ–°');
            }, 200);
            
            setTimeout(() => {
                map.setCenter(userLocation);
                console.log('âœ… åœ°å›¾ä¸­å¿ƒæœ€ç»ˆç¡®è®¤');
                
                const newCenter = map.getCenter();
                console.log('éªŒè¯æ–°ä¸­å¿ƒ:', [newCenter.lng, newCenter.lat]);
            }, 500);
            
            // å¦‚æœç”¨æˆ·æ ‡è®°å­˜åœ¨ï¼Œè§¦å‘å¼¹è·³åŠ¨ç”»
            if (userMarker && typeof userMarker.setAnimation === 'function') {
                try {
                    userMarker.setAnimation('AMAP_ANIMATION_BOUNCE');
                    setTimeout(() => {
                        if (userMarker && typeof userMarker.setAnimation === 'function') {
                            userMarker.setAnimation('AMAP_ANIMATION_NONE');
                        }
                    }, 1000);
                } catch (e) {
                    console.warn('âš ï¸ æ ‡è®°åŠ¨ç”»ä¸å¯ç”¨:', e.message);
                }
            }
            
            updateStatus('ğŸ¯ æ­£åœ¨å›åˆ°æ‚¨çš„ä½ç½®...', 'info');
        }

        // æ¸…ç©ºåœ°å›¾
        function clearMap() {
            if (treasureMarkers.length === 0) {
                updateStatus('åœ°å›¾ä¸Šæ²¡æœ‰å®è—', 'info');
                return;
            }

            map.remove(treasureMarkers);
            treasureMarkers = [];
            updateStatus('ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰å®è—', 'success');
            updateStats();
        }

        // é¦–æ¬¡ä½¿ç”¨æ£€æŸ¥
        function checkFirstTimeUser() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ¸¸æˆæ•°æ®ï¼ˆæ›´å¯é çš„æ£€æŸ¥æ–¹å¼ï¼‰
            const gameData = storageManager.load('totofun-treasure-user');
            const isFirstTime = !gameData || !gameData.username;
            
            if (isFirstTime) {
                // é¦–æ¬¡ä½¿ç”¨ï¼Œæ˜¾ç¤ºæ¬¢è¿å’Œæ˜µç§°è®¾ç½®
                setTimeout(() => {
                    // ç¡®ä¿èŠå¤©ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼ˆè·å–ç”¨æˆ·IDï¼‰
                    if (!chatManager.currentUser) {
                        console.warn('âš ï¸ èŠå¤©ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œç­‰å¾…åˆå§‹åŒ–...');
                        setTimeout(() => checkFirstTimeUser(), 500);
                        return;
                    }
                    
                    const currentUserId = chatManager.currentUser.id;
                    console.log('ğŸ“ é¦–æ¬¡ä½¿ç”¨ï¼Œå½“å‰ç”¨æˆ·ID:', currentUserId);
                    
                    const username = prompt('ğŸ‰ æ¬¢è¿æ¥åˆ° Totofun çªçªç¿»ï¼\n\nè¯·è¾“å…¥ä½ çš„æ¸¸æˆæ˜µç§°ï¼ˆ3-10ä¸ªå­—ç¬¦ï¼‰:\n\nğŸ’¡ æç¤ºï¼šæ˜µç§°ä¼šè‡ªåŠ¨ä¿å­˜ï¼Œä¸‹æ¬¡è®¿é—®æ—¶æ— éœ€é‡æ–°è¾“å…¥', 'å¯»å®æ¢é™©å®¶');
                    if (username && username.length >= 3 && username.length <= 10) {
                        userData.username = username;
                        saveUserData();
                        updateStatus(`æ¬¢è¿ï¼Œ${username}ï¼ä½ çš„æ˜µç§°å·²ä¿å­˜`, 'success');
                        
                        // æ›´æ–°æ˜¾ç¤º
                        document.getElementById('user-name').textContent = username;
                        
                        // ç¡®ä¿ç”¨æˆ·IDä¸€è‡´æ€§ï¼ˆé‡è¦ï¼ï¼‰
                        if (chatManager.currentUser.id !== currentUserId) {
                            console.warn('âš ï¸ ç”¨æˆ·IDä¸ä¸€è‡´ï¼Œä¿®å¤ä¸­...');
                            chatManager.currentUser.id = currentUserId;
                            storageManager.save('chatUser', chatManager.currentUser);
                        }
                        
                        // åŒæ­¥åˆ°Firebase
                        if (firebaseEnabled && database) {
                            try {
                                const userRef = database.ref(`users/${currentUserId}`);
                                userRef.set({
                                    id: currentUserId,
                                    name: username,
                                    avatar: chatManager.currentUser.avatar || 'ğŸ‘¤',
                                    online: true,
                                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                                });
                                console.log('âœ… ç”¨æˆ·ä¿¡æ¯å·²åŒæ­¥åˆ°Firebase');
                            } catch (error) {
                                console.error('âŒ FirebaseåŒæ­¥å¤±è´¥:', error);
                            }
                        }
                        
                        // æ˜¾ç¤ºç”¨æˆ·IDæç¤º
                        setTimeout(() => {
                            if (chatManager.currentUser) {
                                alert(`âœ… ä½ çš„æ¸¸æˆæ˜µç§°ï¼š${username}\nğŸ†” ä½ çš„ç”¨æˆ·IDï¼š${chatManager.currentUser.id}\n\nğŸ’¡ ç”¨æˆ·IDæ˜¯æ°¸ä¹…çš„ï¼Œå¥½å‹å¯ä»¥é€šè¿‡è¿™ä¸ªIDæ·»åŠ ä½ ï¼\n\nä½ å¯ä»¥åœ¨"æˆ‘çš„ä¿¡æ¯"ä¸­æŸ¥çœ‹å’Œåˆ†äº«ä½ çš„IDã€‚`);
                            }
                        }, 1000);
                    } else if (username) {
                        alert('æ˜µç§°é•¿åº¦åº”è¯¥åœ¨3-10ä¸ªå­—ç¬¦ä¹‹é—´');
                        checkFirstTimeUser();
                    }
                }, 1000);
            } else {
                // è€ç”¨æˆ·ï¼Œæ˜¾ç¤ºæ¬¢è¿å›æ¥æ¶ˆæ¯
                if (userData.username) {
                    updateStatus(`æ¬¢è¿å›æ¥ï¼Œ${userData.username}ï¼`, 'success');
                    document.getElementById('user-name').textContent = userData.username;
                    
                    // ç¡®ä¿ç”¨æˆ·IDä¸€è‡´æ€§
                    if (chatManager.currentUser) {
                        const currentUserId = chatManager.currentUser.id;
                        console.log('âœ… è€ç”¨æˆ·ï¼Œç”¨æˆ·ID:', currentUserId);
                        
                        // åŒæ­¥åˆ°Firebaseï¼ˆç¡®ä¿Firebaseä¸­æœ‰æœ€æ–°ä¿¡æ¯ï¼‰
                        if (firebaseEnabled && database) {
                            try {
                                const userRef = database.ref(`users/${currentUserId}`);
                                userRef.update({
                                    name: userData.username,
                                    avatar: chatManager.currentUser.avatar || 'ğŸ‘¤',
                                    online: true,
                                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                                });
                                console.log('âœ… ç”¨æˆ·ä¿¡æ¯å·²åŒæ­¥åˆ°Firebase');
                            } catch (error) {
                                console.error('âŒ FirebaseåŒæ­¥å¤±è´¥:', error);
                            }
                        }
                    }
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        // åˆå§‹åŒ–ç”¨æˆ·è®¤è¯çŠ¶æ€
        async function initAuth() {
            try {
                if (authService.isLoggedIn()) {
                    // å·²ç™»å½•ï¼Œè·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
                    const user = await authService.getCurrentUser();
                    if (user) {
                        authManager.updateUserDisplay();
                        console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', user.username);
                    } else {
                        // è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œå¯èƒ½tokenå·²è¿‡æœŸ
                        console.log('âš ï¸ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç™»å½•');
                        authManager.updateUserDisplay();
                    }
                } else {
                    // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æŒ‰é’®
                    authManager.updateUserDisplay();
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–è®¤è¯çŠ¶æ€é”™è¯¯:', error);
                authManager.updateUserDisplay();
            }
        }

        // Tokenè‡ªåŠ¨åˆ·æ–°æœºåˆ¶
        function setupTokenRefresh() {
            // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡tokenæ˜¯å¦å³å°†è¿‡æœŸï¼ˆæå‰1å°æ—¶åˆ·æ–°ï¼‰
            setInterval(async () => {
                if (authService.isLoggedIn()) {
                    try {
                        // å°è¯•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœå¤±è´¥åˆ™åˆ·æ–°token
                        const user = await authService.getCurrentUser();
                        if (!user) {
                            // å°è¯•åˆ·æ–°token
                            const refreshed = await authService.refreshToken();
                            if (refreshed) {
                                console.log('âœ… Tokenå·²è‡ªåŠ¨åˆ·æ–°');
                                // é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯
                                await authService.getCurrentUser();
                                authManager.updateUserDisplay();
                            }
                        }
                    } catch (error) {
                        console.error('Tokenè‡ªåŠ¨åˆ·æ–°é”™è¯¯:', error);
                    }
                }
            }, 5 * 60 * 1000); // 5åˆ†é’Ÿ
        }

        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–è®¤è¯çŠ¶æ€
            initAuth();
            // è®¾ç½®tokenè‡ªåŠ¨åˆ·æ–°
            setupTokenRefresh();
            // åŠ è½½ç”¨æˆ·æ•°æ®
            loadUserData();
            
            // ç­‰å¾…èŠå¤©ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆåå†æ£€æŸ¥é¦–æ¬¡ç”¨æˆ·
            // chatManager.init()åœ¨é¡µé¢åº•éƒ¨æ‰§è¡Œï¼Œéœ€è¦å»¶è¿Ÿæ£€æŸ¥
            setTimeout(() => {
                checkFirstTimeUser();
            }, 500);
            
            // è‡ªåŠ¨å¯åŠ¨åœ°å›¾ï¼ˆå»¶è¿Ÿ1ç§’ï¼Œè®©é¡µé¢å…ˆæ¸²æŸ“ï¼‰
            setTimeout(() => {
                initMap();
            }, 1000);

            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            if (userData.stats.treasuresDiscovered > 0) {
                setTimeout(() => {
                    updateStatus(`ä½ å·²å‘ç° ${userData.stats.treasuresDiscovered} ä¸ªå®è—ï¼Œç­‰çº§ LV.${userData.level.currentLevel}ï¼Œç»§ç»­åŠ æ²¹ï¼`, 'success');
                }, 2000);
            }

            // æ›´æ–°åˆå§‹ç»Ÿè®¡
            updateStats();
            
            // æ˜¾ç¤ºç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
            updateUserDisplay();
        });

        // æ›´æ–°ç”¨æˆ·æ˜¾ç¤ºä¿¡æ¯
        function updateUserDisplay() {
            const levelInfo = userManager.getLevelInfo();
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            if (document.getElementById('total-treasures')) {
                document.getElementById('total-treasures').textContent = userData.stats.treasuresDiscovered;
            }
            
            // å¦‚æœæœ‰å¾½ç« æ˜¾ç¤ºåŒºåŸŸï¼Œæ›´æ–°å¾½ç« 
            if (userData.level.badges.length > 0) {
                console.log('ğŸ† å·²è·å¾—å¾½ç« :', userData.level.badges.map(b => `${b.icon} ${b.description}`).join(', '));
            }
        }

        // å¯¼å‡ºç”¨æˆ·æ•°æ®ï¼ˆç”¨äºè°ƒè¯•æˆ–å¤‡ä»½ï¼‰
        function exportUserData() {
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'totofun-treasure-userdata.json';
            a.click();
            URL.revokeObjectURL(url);
            updateStatus('ç”¨æˆ·æ•°æ®å·²å¯¼å‡º', 'success');
        }

        // é‡ç½®ç”¨æˆ·æ•°æ®
        function resetUserData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ¸¸æˆæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                storageManager.remove('totofun-treasure-user');
                location.reload();
            }
        }

        // ç§»åŠ¨ç«¯è°ƒè¯•åŠŸèƒ½
        function debugLocationInfo() {
            let debugInfo = `
                <strong>ğŸ”§ è°ƒè¯•ä¿¡æ¯</strong><br>
                ç”¨æˆ·ä»£ç†: ${navigator.userAgent.substring(0, 50)}...<br>
                æ”¯æŒGPS: ${navigator.geolocation ? 'âœ…' : 'âŒ'}<br>
                å½“å‰æ—¶é—´: ${new Date().toLocaleString()}<br>
                åœ°å›¾çŠ¶æ€: ${map ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}<br>
                ç”¨æˆ·ä½ç½®: ${userLocation ? `${userLocation[1].toFixed(4)}, ${userLocation[0].toFixed(4)}` : 'âŒ æœªè·å–'}<br>
                å®è—æ•°é‡: ${treasureMarkers.length}<br>
                HTTPS: ${location.protocol === 'https:' ? 'âœ…' : 'âŒ GPSéœ€è¦HTTPS'}<br>
            `;
            
            // æ£€æŸ¥æƒé™çŠ¶æ€
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    debugInfo += `GPSæƒé™: ${result.state}<br>`;
                    updateGPSData(debugInfo);
                });
            } else {
                updateGPSData(debugInfo);
            }
        }


        // å¼ºåˆ¶ä½¿ç”¨ä¸Šæµ·ä½ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        function useShanghai() {
            userLocation = [121.4737, 31.2304]; // ä¸Šæµ·å¤–æ»©
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            updateStatus('ğŸ—ºï¸ å·²åˆ‡æ¢åˆ°ä¸Šæµ·å¤–æ»©ä½ç½®', 'success');
            updateGPSData(`
                <strong>ğŸ“ ä¸Šæµ·å¤–æ»©ä½ç½®</strong><br>
                çº¬åº¦: 31.230400 âœ…<br>
                ç»åº¦: 121.473700 âœ…<br>
                ç²¾åº¦: æ¨¡æ‹Ÿä½ç½®<br>
                æ—¶é—´: ${new Date().toLocaleString()}<br>
                <small style="color: #666;">ğŸ¯ ä¸Šæµ·åœ°åŒºæ¨¡æ‹Ÿå®šä½</small>
            `);
            
            // ç”Ÿæˆå®è—
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1000);
        }

        // é”®ç›˜å¿«æ·é”®å’Œè§¦æ‘¸äº‹ä»¶
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        if (!map) initMap();
                        else testGPS();
                        break;
                    case 't':
                        e.preventDefault();
                        addTreasure();
                        break;
                    case 's':
                        e.preventDefault();
                        useShanghai();
                        break;
                    case 'd':
                        e.preventDefault();
                        debugLocationInfo();
                        break;
                    case 'Delete':
                    case 'Backspace':
                        e.preventDefault();
                        clearMap();
                        break;
                }
            }
        });

        // ç§»åŠ¨ç«¯é•¿æŒ‰æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        let touchTimer;
        document.addEventListener('touchstart', function(e) {
            if (e.target.id === 'gps-data') {
                touchTimer = setTimeout(() => {
                    debugLocationInfo();
                }, 1000);
            }
        });

        document.addEventListener('touchend', function() {
            clearTimeout(touchTimer);
        });

        // æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
                        
                        // æ£€æŸ¥æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('ğŸ”„ Service Worker æ›´æ–°ä¸­...');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('âœ¨ æ–°ç‰ˆæœ¬å¯ç”¨ï¼');
                                    // å¯ä»¥æç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢
                                    if (confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('âŒ Service Worker æ³¨å†Œå¤±è´¥:', error);
                    });
                
                // ç›‘å¬ Service Worker æ§åˆ¶æƒå˜åŒ–
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('ğŸ”„ Service Worker å·²æ›´æ–°');
                });
            });
        }

        // PWA å®‰è£…æç¤º
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('ğŸ“± PWA å¯å®‰è£…');
            e.preventDefault();
            deferredPrompt = e;
            
            // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºè‡ªå®šä¹‰å®‰è£…æŒ‰é’®
            // ä¾‹å¦‚ï¼šshowInstallButton();
        });

        window.addEventListener('appinstalled', () => {
            console.log('ğŸ‰ PWA å·²å®‰è£…ï¼');
            deferredPrompt = null;
        });

        // ==================== èŠå¤©åŠŸèƒ½ ====================
        
        // èŠå¤©æ•°æ®ç®¡ç†
        // è®¤è¯ç®¡ç†å™¨
        const authManager = {
            // æ˜¾ç¤ºç™»å½•è¡¨å•
            showLoginForm() {
                document.getElementById('auth-login-form').style.display = 'block';
                document.getElementById('auth-register-form').style.display = 'none';
                document.getElementById('auth-login-error').style.display = 'none';
                document.getElementById('auth-register-error').style.display = 'none';
            },

            // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
            showRegisterForm() {
                document.getElementById('auth-login-form').style.display = 'none';
                document.getElementById('auth-register-form').style.display = 'block';
                document.getElementById('auth-login-error').style.display = 'none';
                document.getElementById('auth-register-error').style.display = 'none';
            },

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            showModal() {
                const modal = document.getElementById('auth-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    this.showLoginForm();
                }
            },

            // å…³é—­æ¨¡æ€æ¡†
            closeModal() {
                const modal = document.getElementById('auth-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            },

            // å¤„ç†ç™»å½•
            async handleLogin() {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('auth-login-error');

                if (!email || !password) {
                    errorDiv.textContent = 'è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ';
                    errorDiv.style.display = 'block';
                    return;
                }

                errorDiv.style.display = 'none';
                errorDiv.textContent = 'ç™»å½•ä¸­...';
                errorDiv.style.background = '#e3f2fd';
                errorDiv.style.color = '#1976d2';
                errorDiv.style.display = 'block';

                const result = await authService.login(email, password);

                if (result.success) {
                    errorDiv.textContent = 'ç™»å½•æˆåŠŸï¼';
                    errorDiv.style.background = '#e8f5e9';
                    errorDiv.style.color = '#2e7d32';
                    
                    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                    this.updateUserDisplay();
                    
                    // å»¶è¿Ÿå…³é—­ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        this.closeModal();
                        // åˆ·æ–°é¡µé¢ä»¥åŠ è½½ç”¨æˆ·æ•°æ®
                        location.reload();
                    }, 1000);
                } else {
                    errorDiv.textContent = result.message || 'ç™»å½•å¤±è´¥';
                    errorDiv.style.background = '#fee';
                    errorDiv.style.color = '#c33';
                }
            },

            // å¤„ç†æ³¨å†Œ
            async handleRegister() {
                const username = document.getElementById('register-username').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const errorDiv = document.getElementById('auth-register-error');

                if (!username || !email || !password) {
                    errorDiv.textContent = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ';
                    errorDiv.style.display = 'block';
                    return;
                }

                if (username.length < 3 || username.length > 20) {
                    errorDiv.textContent = 'ç”¨æˆ·åé•¿åº¦åº”åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´';
                    errorDiv.style.display = 'block';
                    return;
                }

                if (password.length < 6) {
                    errorDiv.textContent = 'å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦';
                    errorDiv.style.display = 'block';
                    return;
                }

                errorDiv.style.display = 'none';
                errorDiv.textContent = 'æ³¨å†Œä¸­...';
                errorDiv.style.background = '#e3f2fd';
                errorDiv.style.color = '#1976d2';
                errorDiv.style.display = 'block';

                const result = await authService.register(username, email, password);

                if (result.success) {
                    errorDiv.textContent = 'æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨ç™»å½•...';
                    errorDiv.style.background = '#e8f5e9';
                    errorDiv.style.color = '#2e7d32';
                    
                    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                    this.updateUserDisplay();
                    
                    // å»¶è¿Ÿå…³é—­ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        this.closeModal();
                        // åˆ·æ–°é¡µé¢ä»¥åŠ è½½ç”¨æˆ·æ•°æ®
                        location.reload();
                    }, 1500);
                } else {
                    errorDiv.textContent = result.message || 'æ³¨å†Œå¤±è´¥';
                    errorDiv.style.background = '#fee';
                    errorDiv.style.color = '#c33';
                }
            },

            // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œå¦‚æœæœªç™»å½•åˆ™æ˜¾ç¤ºç™»å½•æ¡†
            checkLoginStatus() {
                if (!authService.isLoggedIn()) {
                    // å»¶è¿Ÿæ˜¾ç¤ºï¼Œè®©é¡µé¢å…ˆåŠ è½½
                    setTimeout(() => {
                        this.showModal();
                    }, 500);
                    return false;
                }
                return true;
            },

            // å¤„ç†ç™»å‡º
            async handleLogout() {
                if (confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                    await authService.logout();
                }
            },

            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            updateUserDisplay() {
                const user = authService.getUser();
                const userInfoBar = document.getElementById('user-info-bar');
                const loginButtonContainer = document.getElementById('login-button-container');
                
                if (user && authService.isLoggedIn()) {
                    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯æ ï¼Œéšè—ç™»å½•æŒ‰é’®
                    if (userInfoBar) {
                        userInfoBar.style.display = 'flex';
                    }
                    if (loginButtonContainer) {
                        loginButtonContainer.style.display = 'none';
                    }
                    
                    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
                    const avatarDisplay = document.getElementById('user-avatar-display');
                    const displayName = document.getElementById('user-display-name');
                    const displayLevel = document.getElementById('user-display-level');
                    
                    if (avatarDisplay) {
                        avatarDisplay.textContent = user.avatar || 'ğŸ‘¤';
                        if (user.avatar && user.avatar.startsWith('http')) {
                            avatarDisplay.style.backgroundImage = `url(${user.avatar})`;
                            avatarDisplay.style.backgroundSize = 'cover';
                            avatarDisplay.style.backgroundPosition = 'center';
                            avatarDisplay.textContent = '';
                        }
                    }
                    if (displayName) {
                        displayName.textContent = user.username || 'æ¸¸å®¢';
                    }
                    if (displayLevel) {
                        displayLevel.textContent = `LV.${user.level?.currentLevel || 1}`;
                    }
                    
                    // æ›´æ–°é¡µé¢ä¸­çš„ç”¨æˆ·ä¿¡æ¯
                    if (document.getElementById('user-name')) {
                        document.getElementById('user-name').textContent = user.username || 'æ¸¸å®¢';
                    }
                    if (document.getElementById('user-level')) {
                        document.getElementById('user-level').textContent = `LV.${user.level?.currentLevel || 1}`;
                    }
                } else {
                    // éšè—ç”¨æˆ·ä¿¡æ¯æ ï¼Œæ˜¾ç¤ºç™»å½•æŒ‰é’®
                    if (userInfoBar) {
                        userInfoBar.style.display = 'none';
                    }
                    if (loginButtonContainer) {
                        loginButtonContainer.style.display = 'block';
                    }
                }
            }
        };

        const chatManager = {
            currentUser: null,
            friends: [],
            conversations: {},
            unreadCount: 0,

            // åˆå§‹åŒ–å½“å‰ç”¨æˆ·
            async init() {
                console.log('ğŸ”§ å¼€å§‹åˆå§‹åŒ–èŠå¤©ç³»ç»Ÿ...');
                
                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                if (authService.isLoggedIn()) {
                    console.log('âœ… ç”¨æˆ·å·²ç™»å½•ï¼Œä½¿ç”¨æœåŠ¡å™¨æ•°æ®');
                    const serverUser = authService.getUser();
                    this.currentUser = {
                        id: serverUser._id || serverUser.id,
                        name: serverUser.username,
                        avatar: serverUser.avatar || 'ğŸ‘¤',
                        online: true,
                        createdAt: serverUser.createdAt || new Date().toISOString()
                    };
                    
                    // ä»æœåŠ¡å™¨åŠ è½½å¥½å‹åˆ—è¡¨å’ŒèŠå¤©è®°å½•ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
                    this.loadServerData();
                } else {
                    console.log('ğŸ“ ç”¨æˆ·æœªç™»å½•ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                    // å°è¯•åŠ è½½å·²æœ‰çš„èŠå¤©ç”¨æˆ·
                    let savedChatUser = storageManager.load('chatUser');
                    
                    if (!savedChatUser) {
                        console.log('ğŸ“ æœªæ‰¾åˆ°å·²æœ‰ç”¨æˆ·ï¼Œåˆ›å»ºæ–°ç”¨æˆ·...');
                        // å¦‚æœæ²¡æœ‰èŠå¤©ç”¨æˆ·ï¼Œåˆ›å»ºä¸€ä¸ªæŒä¹…çš„ID
                        // ä½¿ç”¨å›ºå®šçš„IDç”Ÿæˆæ–¹å¼ï¼Œç¡®ä¿ç”¨æˆ·IDä¸ä¼šæ”¹å˜
                        const userId = this.generatePersistentUserId();
                        
                        // å°è¯•ä»æ¸¸æˆæ•°æ®ä¸­è·å–æ˜µç§°
                        const gameUserData = storageManager.load('totofun-treasure-user');
                        const username = gameUserData?.username || 'æ¸¸å®¢';
                        
                        savedChatUser = {
                            id: userId,
                            name: username,
                            avatar: 'ğŸ‘¤',
                            online: true,
                            createdAt: new Date().toISOString()
                        };
                        
                        storageManager.save('chatUser', savedChatUser);
                        console.log('âœ… æ–°ç”¨æˆ·å·²åˆ›å»º:', userId, 'æ˜µç§°:', username);
                    } else {
                        console.log('âœ… æ¢å¤å·²æœ‰ç”¨æˆ·:', savedChatUser.id, 'æ˜µç§°:', savedChatUser.name);
                        
                        // æ£€æŸ¥IDæ ¼å¼ï¼Œå¦‚æœæ˜¯æ—§çš„é•¿IDï¼Œæç¤ºç”¨æˆ·ï¼ˆä½†ä¸å¼ºåˆ¶è¿ç§»ï¼Œé¿å…ç ´åå¥½å‹å…³ç³»ï¼‰
                        if (savedChatUser.id && (savedChatUser.id.length > 10 || !/^\d+$/.test(savedChatUser.id))) {
                            console.log('âš ï¸ æ£€æµ‹åˆ°æ—§æ ¼å¼IDï¼ˆé•¿åº¦>10æˆ–åŒ…å«éæ•°å­—å­—ç¬¦ï¼‰:', savedChatUser.id);
                            // å¯é€‰ï¼šåœ¨è¿™é‡Œå¯ä»¥æç¤ºç”¨æˆ·è¿ç§»åˆ°çŸ­IDï¼Œä½†ä¸ºäº†ä¸ç ´åå¥½å‹å…³ç³»ï¼Œæš‚æ—¶ä¿æŒåŸID
                        }
                        
                        // åŒæ­¥æ¸¸æˆæ˜µç§°åˆ°èŠå¤©æ˜µç§°
                        const gameUserData = storageManager.load('totofun-treasure-user');
                        if (gameUserData?.username && gameUserData.username !== savedChatUser.name) {
                            savedChatUser.name = gameUserData.username;
                            storageManager.save('chatUser', savedChatUser);
                            console.log('âœ… æ˜µç§°å·²åŒæ­¥:', gameUserData.username);
                        }
                    }
                    
                    this.currentUser = savedChatUser;
                }
                
                console.log('ğŸ‘¤ å½“å‰ç”¨æˆ·:', this.currentUser.id, this.currentUser.name);
                
                // å¦‚æœIDæ˜¯çŸ­IDï¼ˆ10ä½æ•°å­—ï¼‰ï¼Œåœ¨æ§åˆ¶å°æ˜¾ç¤ºå‹å¥½æç¤º
                if (this.currentUser.id && /^\d{10}$/.test(this.currentUser.id)) {
                    console.log('âœ… ç”¨æˆ·IDæ ¼å¼æ­£ç¡®ï¼ˆ10ä½æ•°å­—ï¼‰');
                }
                
                // åŠ è½½å¥½å‹åˆ—è¡¨å’Œå¯¹è¯è®°å½•
                if (authService.isLoggedIn()) {
                    // å·²ç™»å½•ï¼šä»æœåŠ¡å™¨åŠ è½½ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
                    this.loadServerData();
                    // å…ˆä½¿ç”¨é»˜è®¤å¥½å‹åˆ—è¡¨ï¼ˆåŒ…å«æœºå™¨äººï¼‰
                    this.friends = this.getDefaultFriends();
                    this.conversations = {};
                } else {
                    // æœªç™»å½•ï¼šä½¿ç”¨æœ¬åœ°æ•°æ®
                    const savedFriends = storageManager.load('chatFriends');
                    if (savedFriends && Array.isArray(savedFriends) && savedFriends.length > 0) {
                        this.friends = savedFriends;
                    } else {
                        this.friends = this.getDefaultFriends();
                    }
                    this.conversations = storageManager.load('chatConversations') || {};
                }
                
                // æœºå™¨äººä¸å†æ·»åŠ åˆ°å¥½å‹åˆ—è¡¨ï¼Œé€šè¿‡å·¦ä¸‹è§’å¤´åƒæŒ‰é’®è®¿é—®
                // ä»å¥½å‹åˆ—è¡¨ä¸­ç§»é™¤æœºå™¨äººï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                this.friends = this.friends.filter(f => f.id !== 'totofun_bot');
                
                // ç¡®ä¿æœºå™¨äººå¯¹è¯è®°å½•å­˜åœ¨
                    if (!this.conversations['totofun_bot']) {
                        this.conversations['totofun_bot'] = [];
                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ¬¢è¿æ¶ˆæ¯
                    const hasWelcomeMsg = this.conversations['totofun_bot'].some(m => m.id === 'welcome_msg');
                    if (!hasWelcomeMsg) {
                        this.conversations['totofun_bot'].push({
                            id: 'welcome_msg',
                            from: 'totofun_bot',
                            to: this.currentUser.id,
                            content: 'ä½ å¥½ï¼æˆ‘æ˜¯å°çªï¼Œä½ çš„å¯»å®ä¼™ä¼´ï¼ğŸ˜Š\n\næˆ‘å¯ä»¥å¸®ä½ ï¼š\nâ€¢ è§£ç­”æ¸¸æˆé—®é¢˜\nâ€¢ å¼•å¯¼æ–°æ‰‹æ“ä½œ\nâ€¢ é™ªä½ èŠå¤©\nâ€¢ åˆ†äº«å¯»å®æŠ€å·§\n\næœ‰ä»€ä¹ˆé—®é¢˜éƒ½å¯ä»¥é—®æˆ‘å“¦~',
                            type: 'text',
                            timestamp: new Date().toISOString(),
                            read: false,
                            status: 'received'
                        });
                        console.log('âœ… å·²æ·»åŠ æœºå™¨äººæ¬¢è¿æ¶ˆæ¯');
                        this.saveData();
                    }
                }
                
                if (!authService.isLoggedIn()) {
                    storageManager.save('chatFriends', this.friends);
                }

                // åˆå§‹åŒ–æœºå™¨äººèŠå¤©çª—å£
                this.initBotChat();
                
                this.updateUnreadCount();
                
                // ä¿®å¤å¯èƒ½çš„é”™è¯¯æœªè¯»è®¡æ•°
                setTimeout(() => {
                    this.fixUnreadCount();
                }, 1000); // å»¶è¿Ÿ1ç§’æ‰§è¡Œï¼Œç¡®ä¿æ•°æ®åŠ è½½å®Œæˆ
                
                // ä¿å­˜åŸå§‹æ ‡é¢˜
                this.originalTitle = document.title;
                
                // åˆå§‹åŒ–å¥½å‹åˆ—è¡¨æ˜¾ç¤ºï¼ˆå»¶è¿Ÿæ‰§è¡Œç¡®ä¿DOMå·²åŠ è½½ï¼‰
                setTimeout(() => {
                    this.updateFriendsList();
                }, 200);
                
                // è¯·æ±‚é€šçŸ¥æƒé™
                this.requestNotificationPermission();
                
                // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œæ¢å¤æ ‡é¢˜
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œåœæ­¢æ ‡é¢˜é—ªçƒï¼Œæ›´æ–°æ ‡é¢˜
                        this.stopTitleBlink();
                        this.updatePageTitle();
                    }
                });
                
                // ç›‘å¬çª—å£ç„¦ç‚¹å˜åŒ–
                window.addEventListener('focus', () => {
                    this.stopTitleBlink();
                    this.updatePageTitle();
                });
                
                // åˆå§‹åŒ–Firebaseå®æ—¶é€šä¿¡
                if (firebaseEnabled && database) {
                    console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–Firebaseå®æ—¶é€šä¿¡ï¼Œç”¨æˆ·ID:', this.currentUser.id);
                    this.initFirebaseRealtime();
                } else {
                    console.warn('âš ï¸ Firebaseæœªå¯ç”¨ï¼Œæ— æ³•ä½¿ç”¨å®æ—¶é€šä¿¡');
                }
            },
            
            // åˆå§‹åŒ–Firebaseå®æ—¶é€šä¿¡
            initFirebaseRealtime() {
                if (!firebaseEnabled || !database) return;
                
                const userId = this.currentUser.id;
                
                // 1. å°†ç”¨æˆ·ä¿¡æ¯åŒæ­¥åˆ°Firebase
                const userRef = database.ref(`users/${userId}`);
                userRef.set({
                    id: userId,
                    name: this.currentUser.name,
                    avatar: this.currentUser.avatar,
                    online: true,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // 2. ç›‘å¬å‘é€ç»™å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯
                const messagesRef = database.ref(`messages/${userId}`);
                console.log('ğŸ”” è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨ï¼Œè·¯å¾„:', `messages/${userId}`);
                
                // 2.1 ç›‘å¬è‡ªå·±å‘é€çš„æ¶ˆæ¯çŠ¶æ€å˜åŒ–ï¼ˆå·²è¯»çŠ¶æ€ï¼‰
                // å½“æ¥æ”¶æ–¹æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»æ—¶ï¼Œä¼šæ›´æ–°å‘é€æ–¹æ¶ˆæ¯è®°å½•ä¸­çš„çŠ¶æ€
                messagesRef.on('child_changed', (snapshot) => {
                    const messageKey = snapshot.key;
                    const messageData = snapshot.val();
                    console.log('ğŸ“¬ æ¶ˆæ¯çŠ¶æ€å˜åŒ–:', { key: messageKey, data: messageData });
                    
                    if (messageData) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±çš„æ¶ˆæ¯ä¸”çŠ¶æ€å˜ä¸ºå·²è¯»
                        if (messageData.from === userId && messageData.status === 'read') {
                            const receiverId = messageData.to;
                            const messageId = messageData.id || messageKey;
                            console.log('ğŸ“– æ¶ˆæ¯å·²è¢«å¯¹æ–¹è¯»å–:', messageId, 'æ¥æ”¶æ–¹:', receiverId);
                            this.updateMessageStatus(receiverId, messageId, 'read');
                        }
                        // ä¹Ÿæ£€æŸ¥é€šè¿‡keyç›´æ¥åŒ¹é…çš„æ¶ˆæ¯ï¼ˆå› ä¸ºæ¶ˆæ¯å¯èƒ½ç”¨IDä½œä¸ºkeyï¼‰
                        else if (messageKey && messageKey.startsWith('msg_') && messageData.status === 'read') {
                            // æŸ¥æ‰¾è¿™ä¸ªæ¶ˆæ¯å¯¹åº”çš„æ¥æ”¶æ–¹
                            const receiverId = messageData.to;
                            if (receiverId && messageData.from === userId) {
                                console.log('ğŸ“– æ¶ˆæ¯å·²è¢«å¯¹æ–¹è¯»å–ï¼ˆé€šè¿‡keyåŒ¹é…ï¼‰:', messageKey, 'æ¥æ”¶æ–¹:', receiverId);
                                this.updateMessageStatus(receiverId, messageKey, 'read');
                            }
                        }
                    }
                });
                
                // å…ˆåŠ è½½å†å²æ¶ˆæ¯ï¼ˆåªåŠ è½½ä¸€æ¬¡ï¼‰
                messagesRef.once('value', (snapshot) => {
                    const allMessages = snapshot.val();
                    if (allMessages) {
                        console.log('ğŸ“š åŠ è½½å†å²æ¶ˆæ¯ï¼Œå…±', Object.keys(allMessages).length, 'æ¡');
                        const messageKeys = Object.keys(allMessages);
                        messageKeys.forEach((messageKey, index) => {
                            const messageData = allMessages[messageKey];
                            if (messageData && messageData.from !== userId) {
                                // æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²æœ‰è¯¥å¥½å‹çš„å¯¹è¯è®°å½•
                                // å¦‚æœæœ¬åœ°æ²¡æœ‰å¯¹è¯è®°å½•ï¼ˆconversationsä¸­æ²¡æœ‰è¯¥å¥½å‹çš„è®°å½•ï¼‰ï¼Œè¯´æ˜å¯èƒ½è¢«æ¸…ç©ºäº†ï¼Œä¸åŠ è½½å†å²æ¶ˆæ¯
                                if (!this.conversations[messageData.from]) {
                                    console.log(`âš ï¸ [${index + 1}/${messageKeys.length}] è·³è¿‡å·²æ¸…ç©ºçš„èŠå¤©è®°å½•ï¼ˆæœ¬åœ°æ— å¯¹è¯ï¼‰:`, messageData.from);
                                    return;
                                }
                                
                                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤
                                const exists = this.conversations[messageData.from] && 
                                    this.conversations[messageData.from].some(m => 
                                        m.id === messageData.id || 
                                        (m.timestamp === messageData.timestamp && m.content === messageData.content)
                                    );
                                if (!exists) {
                                    const content = messageData.content || '(æ— å†…å®¹)';
                                    const fromName = messageData.fromName || messageData.from || '(æœªçŸ¥ç”¨æˆ·)';
                                    console.log(`ğŸ“¥ [${index + 1}/${messageKeys.length}] åŠ è½½å†å²æ¶ˆæ¯:`, content, 'æ¥è‡ª:', fromName);
                                    // ç›´æ¥æ·»åŠ åˆ°å¯¹è¯ï¼Œä¸è§¦å‘æ˜¾ç¤ºæ›´æ–°ï¼ˆé¿å…é¢‘ç¹åˆ·æ–°ï¼‰
                                    // å†å²æ¶ˆæ¯åº”è¯¥æ ‡è®°ä¸ºå·²è¯»ï¼ˆå› ä¸ºç”¨æˆ·ä¹‹å‰å·²ç»çœ‹è¿‡ï¼‰
                                    const added = this.addMessageToConversation(messageData, false);
                                    // å¦‚æœæ˜¯å†å²æ¶ˆæ¯ï¼Œæ ‡è®°ä¸ºå·²è¯»
                                    if (added && this.conversations[messageData.from]) {
                                        const lastMessage = this.conversations[messageData.from][this.conversations[messageData.from].length - 1];
                                        if (lastMessage && lastMessage.id === (messageData.id || messageKey)) {
                                            lastMessage.read = true;
                                        }
                                    }
                                } else {
                                    console.log(`âš ï¸ [${index + 1}/${messageKeys.length}] å†å²æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡:`, messageData.id || messageKey);
                                }
                            }
                        });
                        console.log('âœ… å†å²æ¶ˆæ¯åŠ è½½å®Œæˆ');
                    } else {
                        console.log('ğŸ“š æ²¡æœ‰å†å²æ¶ˆæ¯');
                    }
                });
                
                // ç›‘å¬æ–°æ¶ˆæ¯ï¼ˆå®æ—¶æ¥æ”¶ï¼‰- ä½¿ç”¨valueç›‘å¬ç¡®ä¿å®æ—¶æ›´æ–°
                let lastMessageKeys = new Set();
                let isFirstLoad = true;
                
                messagesRef.on('value', (snapshot) => {
                    const allMessages = snapshot.val();
                    const currentMessageKeys = allMessages ? new Set(Object.keys(allMessages)) : new Set();
                    
                    if (isFirstLoad) {
                        // ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œè®°å½•æ‰€æœ‰æ¶ˆæ¯é”®
                        lastMessageKeys = currentMessageKeys;
                        isFirstLoad = false;
                        console.log('ğŸ“š é¦–æ¬¡åŠ è½½æ¶ˆæ¯å®Œæˆï¼Œå…±', currentMessageKeys.size, 'æ¡');
                        return;
                    }
                    
                    // æ‰¾å‡ºæ–°å¢çš„æ¶ˆæ¯é”®
                    const newMessageKeys = [...currentMessageKeys].filter(key => !lastMessageKeys.has(key));
                    
                    if (newMessageKeys.length > 0) {
                        console.log('ğŸ“¬ æ£€æµ‹åˆ°', newMessageKeys.length, 'æ¡æ–°æ¶ˆæ¯');
                        newMessageKeys.forEach(messageKey => {
                            const messageData = allMessages[messageKey];
                            if (messageData && messageData.from !== userId) {
                                console.log('ğŸ“¨ å¤„ç†æ–°æ¶ˆæ¯:', {
                                    key: messageKey,
                                    from: messageData.from,
                                    content: messageData.content,
                                    id: messageData.id
                                });
                                
                                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                                const exists = this.conversations[messageData.from] && 
                                    this.conversations[messageData.from].some(m => 
                                        m.id === messageData.id || 
                                        (m.timestamp === messageData.timestamp && m.content === messageData.content)
                                    );
                                if (!exists) {
                                    console.log('âœ… å‘ç°æ–°æ¶ˆæ¯ï¼Œå¤„ç†ä¸­:', messageData.content);
                                    this.handleFirebaseMessage(messageData);
                                } else {
                                    console.log('âš ï¸ æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡:', messageData.id);
                                }
                            } else {
                                console.log('âš ï¸ æ¶ˆæ¯è¿‡æ»¤ï¼ˆè‡ªå·±å‘é€çš„æˆ–æ— æ•ˆï¼‰:', {
                                    hasData: !!messageData,
                                    from: messageData?.from,
                                    userId: userId
                                });
                            }
                        });
                    }
                    
                    lastMessageKeys = currentMessageKeys;
                });
                
                // åŒæ—¶ä½¿ç”¨child_addedä½œä¸ºå¤‡ç”¨ç›‘å¬ï¼ˆç¡®ä¿ä¸é—æ¼ï¼‰
                // æ³¨æ„ï¼šchild_addedä¼šåœ¨å†å²æ¶ˆæ¯åŠ è½½æ—¶ä¹Ÿè§¦å‘ï¼Œæ‰€ä»¥éœ€è¦è·³è¿‡å†å²æ¶ˆæ¯
                let historyLoaded = false;
                messagesRef.once('value', () => {
                    // å†å²æ¶ˆæ¯åŠ è½½å®Œæˆåï¼Œå†å¯ç”¨child_addedç›‘å¬
                    setTimeout(() => {
                        historyLoaded = true;
                        console.log('âœ… å†å²æ¶ˆæ¯åŠ è½½å®Œæˆï¼Œå¯ç”¨child_addedå®æ—¶ç›‘å¬');
                    }, 1000);
                });
                
                messagesRef.on('child_added', (snapshot) => {
                    // è·³è¿‡å†å²æ¶ˆæ¯åŠ è½½é˜¶æ®µ
                    if (!historyLoaded) {
                        return;
                    }
                    
                    const messageData = snapshot.val();
                    console.log('ğŸ“¨ child_addedè§¦å‘ï¼Œæ”¶åˆ°æ¶ˆæ¯:', {
                        from: messageData?.from,
                        content: messageData?.content,
                        id: messageData?.id
                    });
                    
                    if (messageData && messageData.from !== userId) {
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                        const exists = this.conversations[messageData.from] && 
                            this.conversations[messageData.from].some(m => 
                                m.id === messageData.id || 
                                (m.timestamp === messageData.timestamp && m.content === messageData.content)
                            );
                        if (!exists) {
                            console.log('âœ… child_addedå¤„ç†æ–°æ¶ˆæ¯:', messageData.content);
                            this.handleFirebaseMessage(messageData);
                        } else {
                            console.log('âš ï¸ child_addedæ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡:', messageData.id);
                        }
                    } else {
                        console.log('âš ï¸ child_addedæ¶ˆæ¯è¿‡æ»¤:', { 
                            hasData: !!messageData, 
                            from: messageData?.from, 
                            userId: userId 
                        });
                    }
                });
                
                // 3. ç›‘å¬ç”¨æˆ·åœ¨çº¿çŠ¶æ€
                const onlineRef = database.ref(`users/${userId}/online`);
                onlineRef.onDisconnect().set(false);
                onlineRef.set(true);
                
                // 4. å®šæœŸæ›´æ–°æœ€ååœ¨çº¿æ—¶é—´
                setInterval(() => {
                    userRef.update({
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
                
                // 5. ä»FirebaseåŠ è½½å¥½å‹åˆ—è¡¨
                this.loadFriendsFromFirebase();
                
                // 6. ç›‘å¬å¥½å‹åœ¨çº¿çŠ¶æ€å˜åŒ–
                this.watchFriendsOnlineStatus();
                
                console.log('âœ… Firebaseå®æ—¶é€šä¿¡å·²å¯åŠ¨');
            },
            
            // ä»FirebaseåŠ è½½å¥½å‹åˆ—è¡¨
            loadFriendsFromFirebase() {
                if (!firebaseEnabled || !database) return;
                
                const userId = this.currentUser.id;
                const friendshipsRef = database.ref(`friendships/${userId}`);
                
                friendshipsRef.once('value', (snapshot) => {
                    const friendships = snapshot.val();
                    if (friendships) {
                        // å¦‚æœæœ¬åœ°å·²æœ‰å¥½å‹åˆ—è¡¨ï¼ŒåªåŒæ­¥æ›´æ–°å·²å­˜åœ¨å¥½å‹çš„ä¿¡æ¯ï¼Œä¸æ·»åŠ æ–°å¥½å‹
                        // è¿™æ ·å¯ä»¥é¿å…é‡æ–°åŠ è½½å·²åˆ é™¤çš„å¥½å‹
                        const hasLocalFriends = this.friends.length > 0;
                        
                        Object.keys(friendships).forEach(friendId => {
                            const friendship = friendships[friendId];
                            const existingFriend = this.friends.find(f => f.id === friendId);
                            
                            if (existingFriend) {
                                // æ›´æ–°å·²å­˜åœ¨å¥½å‹çš„ä¿¡æ¯ï¼ˆåœ¨çº¿çŠ¶æ€ã€å¤´åƒã€æ˜µç§°ç­‰ï¼‰
                                const friendUserRef = database.ref(`users/${friendId}`);
                                friendUserRef.once('value', (friendSnapshot) => {
                                    const friendUserData = friendSnapshot.val();
                                    if (friendUserData) {
                                        existingFriend.online = friendUserData.online || false;
                                        if (friendUserData.name) existingFriend.name = friendUserData.name;
                                        if (friendUserData.avatar) existingFriend.avatar = friendUserData.avatar;
                                        this.saveData();
                                        this.updateFriendsList();
                                        console.log('âœ… å·²æ›´æ–°å¥½å‹ä¿¡æ¯:', existingFriend.name);
                                    }
                                });
                            } else if (!hasLocalFriends) {
                                // åªæœ‰åœ¨æœ¬åœ°å¥½å‹åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œæ‰ä»Firebaseæ·»åŠ æ–°å¥½å‹
                                // è¿™æ ·å¯ä»¥é¿å…é‡æ–°åŠ è½½å·²åˆ é™¤çš„å¥½å‹
                                const friendUserRef = database.ref(`users/${friendId}`);
                                friendUserRef.once('value', (friendSnapshot) => {
                                    const friendUserData = friendSnapshot.val();
                                    if (friendUserData) {
                                        // å†æ¬¡æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¥½å‹ï¼ˆé˜²æ­¢å¹¶å‘æ·»åŠ ï¼‰
                                        if (!this.friends.find(f => f.id === friendId)) {
                                            const newFriend = {
                                                id: friendId,
                                                name: friendUserData.name || friendship.friendName || 'æ–°å¥½å‹',
                                                avatar: friendUserData.avatar || friendship.friendAvatar || 'ğŸ‘¤',
                                                online: friendUserData.online || false,
                                                lastMessage: '',
                                                lastTime: new Date().toISOString()
                                            };
                                            
                                            this.friends.push(newFriend);
                                            this.saveData();
                                            this.updateFriendsList();
                                            console.log('âœ… ä»FirebaseåŠ è½½å¥½å‹:', newFriend.name);
                                        }
                                    }
                                });
                            } else {
                                console.log('âš ï¸ è·³è¿‡Firebaseä¸­çš„å¥½å‹ï¼ˆæœ¬åœ°å·²åˆ é™¤ï¼‰:', friendId);
                            }
                        });
                    } else {
                        console.log('ğŸ“‹ Firebaseä¸­æ²¡æœ‰å¥½å‹å…³ç³»');
                    }
                });
            },
            
            // ä»æœåŠ¡å™¨åŠ è½½å¥½å‹åˆ—è¡¨å’ŒèŠå¤©è®°å½•
            async loadServerData() {
                if (!authService.isLoggedIn()) {
                    console.warn('âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•åŠ è½½æœåŠ¡å™¨æ•°æ®');
                    return;
                }
                
                try {
                    console.log('ğŸ“¡ å¼€å§‹ä»æœåŠ¡å™¨åŠ è½½æ•°æ®...');
                    const baseUrl = API_CONFIG.BASE_URL;
                    const authHeaders = authService.getAuthHeaders();
                    
                    // 1. åŠ è½½å¥½å‹åˆ—è¡¨
                    try {
                        const friendsResponse = await fetch(baseUrl + API_CONFIG.ENDPOINTS.FRIENDS, {
                            method: 'GET',
                            headers: authHeaders
                        });
                        
                        if (friendsResponse.ok) {
                            const friendsData = await friendsResponse.json();
                            if (friendsData.success && Array.isArray(friendsData.data)) {
                                console.log('âœ… ä»æœåŠ¡å™¨åŠ è½½åˆ°', friendsData.data.length, 'ä¸ªå¥½å‹');
                                
                                // è½¬æ¢æœåŠ¡å™¨æ•°æ®æ ¼å¼ä¸ºæœ¬åœ°æ ¼å¼
                                const serverFriends = friendsData.data.map(friend => {
                                    const friendUser = friend.user || friend;
                                    return {
                                        id: friendUser._id || friendUser.id,
                                        name: friendUser.username || friendUser.name || 'æœªçŸ¥ç”¨æˆ·',
                                        avatar: friendUser.avatar || 'ğŸ‘¤',
                                        online: false, // æœåŠ¡å™¨æ•°æ®å¯èƒ½ä¸åŒ…å«åœ¨çº¿çŠ¶æ€
                                        lastMessage: '',
                                        lastTime: new Date().toISOString()
                                    };
                                });
                                
                                // åˆå¹¶æœåŠ¡å™¨å¥½å‹åˆ—è¡¨ï¼ˆä¸åŒ…å«æœºå™¨äººï¼Œæœºå™¨äººé€šè¿‡å·¦ä¸‹è§’å¤´åƒæŒ‰é’®è®¿é—®ï¼‰
                                this.friends = serverFriends;
                                
                                // ä»å¥½å‹åˆ—è¡¨ä¸­ç§»é™¤æœºå™¨äººï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                                this.friends = this.friends.filter(f => f.id !== 'totofun_bot');
                                
                                this.updateFriendsList();
                                console.log('âœ… å¥½å‹åˆ—è¡¨å·²æ›´æ–°');
                            }
                        } else {
                            console.warn('âš ï¸ åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:', friendsResponse.status);
                        }
                    } catch (error) {
                        console.error('âŒ åŠ è½½å¥½å‹åˆ—è¡¨å‡ºé”™:', error);
                    }
                    
                    // 2. åŠ è½½å¯¹è¯è®°å½•
                    try {
                        const conversationsResponse = await fetch(baseUrl + API_CONFIG.ENDPOINTS.CONVERSATIONS, {
                            method: 'GET',
                            headers: authHeaders
                        });
                        
                        if (conversationsResponse.ok) {
                            const conversationsData = await conversationsResponse.json();
                            if (conversationsData.success && conversationsData.data) {
                                console.log('âœ… ä»æœåŠ¡å™¨åŠ è½½åˆ°å¯¹è¯è®°å½•');
                                
                                // è½¬æ¢æœåŠ¡å™¨æ•°æ®æ ¼å¼ä¸ºæœ¬åœ°æ ¼å¼
                                // æœåŠ¡å™¨è¿”å›çš„æ ¼å¼å¯èƒ½æ˜¯æ•°ç»„æˆ–å¯¹è±¡
                                if (Array.isArray(conversationsData.data)) {
                                    // å¦‚æœæ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼
                                    const conversationsObj = {};
                                    conversationsData.data.forEach(conv => {
                                        const friendId = conv.friendId || conv.userId;
                                        if (friendId && conv.messages && Array.isArray(conv.messages)) {
                                            conversationsObj[friendId] = conv.messages.map(msg => ({
                                                id: msg.id || 'msg_' + Date.now(),
                                                from: msg.from || friendId,
                                                to: msg.to || this.currentUser.id,
                                                content: msg.content || '',
                                                type: msg.type || 'text',
                                                timestamp: msg.timestamp || new Date().toISOString(),
                                                read: msg.read || false,
                                                status: msg.status || 'received'
                                            }));
                                        }
                                    });
                                    this.conversations = conversationsObj;
                                } else if (typeof conversationsData.data === 'object') {
                                    // å¦‚æœå·²ç»æ˜¯å¯¹è±¡æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                                    this.conversations = conversationsData.data;
                                }
                                
                                // ç¡®ä¿æœºå™¨äººå¯¹è¯å­˜åœ¨
                                if (!this.conversations['totofun_bot']) {
                                    this.conversations['totofun_bot'] = [];
                                }
                                
                                this.updateUnreadCount();
                                console.log('âœ… å¯¹è¯è®°å½•å·²æ›´æ–°');
                            }
                        } else {
                            console.warn('âš ï¸ åŠ è½½å¯¹è¯è®°å½•å¤±è´¥:', conversationsResponse.status);
                        }
                    } catch (error) {
                        console.error('âŒ åŠ è½½å¯¹è¯è®°å½•å‡ºé”™:', error);
                    }
                    
                    // ä¿å­˜æ•°æ®
                    this.saveData();
                    console.log('âœ… æœåŠ¡å™¨æ•°æ®åŠ è½½å®Œæˆ');
                    
                } catch (error) {
                    console.error('âŒ åŠ è½½æœåŠ¡å™¨æ•°æ®å¤±è´¥:', error);
                }
            },
            
            // ç›‘å¬å¥½å‹åœ¨çº¿çŠ¶æ€å˜åŒ–
            watchFriendsOnlineStatus() {
                if (!firebaseEnabled || !database) return;
                
                this.friends.forEach(friend => {
                    this.watchFriendOnlineStatus(friend.id);
                });
            },
            
            // ç›‘å¬å•ä¸ªå¥½å‹çš„åœ¨çº¿çŠ¶æ€å’Œç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…æ‹¬å¤´åƒï¼‰
            watchFriendOnlineStatus(friendId) {
                if (!firebaseEnabled || !database) return;
                
                // ç›‘å¬å¥½å‹çš„å®Œæ•´ç”¨æˆ·ä¿¡æ¯å˜åŒ–ï¼ˆåŒ…æ‹¬å¤´åƒã€æ˜µç§°ç­‰ï¼‰
                const friendUserRef = database.ref(`users/${friendId}`);
                friendUserRef.on('value', (snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        const friendIndex = this.friends.findIndex(f => f.id === friendId);
                        if (friendIndex !== -1) {
                            // æ›´æ–°å¥½å‹ä¿¡æ¯
                            const oldAvatar = this.friends[friendIndex].avatar;
                            const oldName = this.friends[friendIndex].name;
                            
                            this.friends[friendIndex].online = userData.online || false;
                            this.friends[friendIndex].name = userData.name || this.friends[friendIndex].name;
                            this.friends[friendIndex].avatar = userData.avatar || this.friends[friendIndex].avatar;
                            
                            // å¦‚æœå¤´åƒæˆ–åç§°å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°æ˜¾ç¤º
                            if (oldAvatar !== this.friends[friendIndex].avatar || oldName !== this.friends[friendIndex].name) {
                                console.log('ğŸ”„ å¥½å‹ä¿¡æ¯å·²æ›´æ–°:', {
                                    friendId,
                                    oldAvatar,
                                    newAvatar: this.friends[friendIndex].avatar,
                                    oldName,
                                    newName: this.friends[friendIndex].name
                                });
                                this.saveData();
                                this.updateFriendsList();
                                
                                // å¦‚æœæ­£åœ¨å’Œè¯¥å¥½å‹èŠå¤©ï¼Œæ›´æ–°èŠå¤©çª—å£å¤´éƒ¨
                                const chatPanel = document.getElementById('chat-panel');
                                if (chatPanel && chatPanel.dataset.friendId === friendId) {
                                    document.getElementById('chat-friend-name').textContent = this.friends[friendIndex].name;
                                    const chatFriendAvatarUpdateEl = document.getElementById('chat-friend-avatar');
                                    if (chatFriendAvatarUpdateEl) {
                                        chatFriendAvatarUpdateEl.innerHTML = this.renderAvatar(this.friends[friendIndex].avatar, 24);
                                    }
                                    
                                    // æ›´æ–°èŠå¤©æ¶ˆæ¯ä¸­çš„å¤´åƒ
                                    const messagesList = document.getElementById('chat-messages-list');
                                    if (messagesList) {
                                        const messageAvatars = messagesList.querySelectorAll('.chat-message-avatar');
                                        messageAvatars.forEach(avatarEl => {
                                            // åªæ›´æ–°å¯¹æ–¹æ¶ˆæ¯çš„å¤´åƒï¼ˆä¸æ˜¯è‡ªå·±çš„ï¼‰
                                            const messageDiv = avatarEl.closest('.chat-message');
                                            if (messageDiv && messageDiv.classList.contains('chat-message-other')) {
                                                avatarEl.innerHTML = this.renderAvatar(this.friends[friendIndex].avatar, 40);
                                            }
                                        });
                                    }
                                }
                                
                                // å¦‚æœç”¨æˆ·ä¿¡æ¯é¢æ¿æ‰“å¼€ï¼Œä¹Ÿæ›´æ–°æ˜¾ç¤º
                                if (document.getElementById('my-profile-panel').style.display === 'flex') {
                                    this.updateProfileFriendsList();
                                }
                            } else {
                                // åªæ›´æ–°åœ¨çº¿çŠ¶æ€
                                this.updateFriendsList();
                            }
                        }
                    }
                });
            },
            
            // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯è®°å½•
            addMessageToConversation(messageData, updateDisplay = true) {
                const friendId = messageData.from;
                
                // æ£€æŸ¥å‘é€è€…æ˜¯å¦æ˜¯å¥½å‹ï¼ˆæœºå™¨äººå…è®¸é€šè¿‡ï¼Œå³ä½¿ä¸åœ¨å¥½å‹åˆ—è¡¨ä¸­ï¼‰
                const friend = this.friends.find(f => f.id === friendId);
                const isBot = friendId === 'totofun_bot';
                
                if (!friend && !isBot) {
                    console.warn('âš ï¸ æ”¶åˆ°æ¥è‡ªéå¥½å‹çš„æ¶ˆæ¯ï¼Œå·²å¿½ç•¥:', friendId, messageData.content);
                    // ä¸è‡ªåŠ¨æ·»åŠ ï¼Œåªè®°å½•æ—¥å¿—
                    return false;
                }
                
                // ä¿å­˜æ¶ˆæ¯
                if (!this.conversations[friendId]) {
                    this.conversations[friendId] = [];
                }
                
                // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤ï¼‰
                const messageExists = this.conversations[friendId].some(
                    m => m.id === messageData.id || (m.timestamp === messageData.timestamp && m.content === messageData.content)
                );
                
                if (!messageExists) {
                    const receivedMessage = {
                        id: messageData.id || 'msg_' + Date.now(),
                        from: friendId,
                        to: this.currentUser.id,
                        content: messageData.content,
                        type: messageData.type || 'text',
                        timestamp: messageData.timestamp || new Date().toISOString(),
                        read: false,
                        status: 'received' // æ¥æ”¶åˆ°çš„æ¶ˆæ¯çŠ¶æ€
                    };
                    
                    this.conversations[friendId].push(receivedMessage);
                    
                    // æ›´æ–°å¥½å‹æœ€åæ¶ˆæ¯ï¼ˆå¦‚æœå¥½å‹å­˜åœ¨ï¼‰
                    if (friend) {
                    friend.lastMessage = messageData.type === 'location' ? 'ğŸ“ ä½ç½®' : messageData.content;
                    friend.lastTime = receivedMessage.timestamp;
                    }
                    
                    this.updateUnreadCount();
                    this.saveData();
                    
                    if (updateDisplay) {
                        // å¦‚æœæ˜¯æœºå™¨äººæ¶ˆæ¯ï¼Œæ›´æ–°æœºå™¨äººèŠå¤©çª—å£
                        if (isBot) {
                            this.updateBotChatMessages();
                        } else if (friend) {
                        // æ£€æŸ¥èŠå¤©çª—å£çŠ¶æ€å¹¶æ›´æ–°æ˜¾ç¤º
                        this.updateChatDisplayAfterMessage(friendId, friend, messageData);
                        }
                    }
                    
                    return true; // æ¶ˆæ¯å·²æ·»åŠ 
                } else {
                    return false; // æ¶ˆæ¯å·²å­˜åœ¨
                }
            },
            
            // å¤„ç†ä»Firebaseæ¥æ”¶çš„æ¶ˆæ¯
            handleFirebaseMessage(messageData) {
                console.log('ğŸ’¬ å¤„ç†Firebaseæ¶ˆæ¯:', messageData);
                const added = this.addMessageToConversation(messageData, true);
                if (added) {
                    console.log('âœ… æ¶ˆæ¯å·²æ·»åŠ åˆ°å¯¹è¯:', messageData.content);
                } else {
                    console.log('âš ï¸ æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡:', messageData.id);
                }
            },
            
            // æ¶ˆæ¯æ¥æ”¶åæ›´æ–°èŠå¤©æ˜¾ç¤º
            updateChatDisplayAfterMessage(friendId, friend, messageData) {
                console.log('ğŸ”„ å¼€å§‹æ›´æ–°èŠå¤©æ˜¾ç¤ºï¼Œå¥½å‹:', friend.name, friendId);
                
                const chatContainer = document.getElementById('chat-container');
                const chatPanel = document.getElementById('chat-panel');
                
                if (!chatContainer || !chatPanel) {
                    console.error('âŒ æ‰¾ä¸åˆ°èŠå¤©å®¹å™¨æˆ–é¢æ¿');
                    return;
                }
                
                // æ£€æŸ¥èŠå¤©çª—å£æ˜¯å¦æ‰“å¼€ï¼ˆä½¿ç”¨å¤šç§æ–¹å¼æ£€æµ‹ï¼‰
                const containerDisplay = chatContainer.style.display;
                const containerComputed = window.getComputedStyle(chatContainer).display;
                const isChatOpen = containerDisplay !== 'none' && 
                                   containerDisplay !== '' &&
                                   containerComputed !== 'none';
                
                const activeFriendId = chatPanel.dataset ? chatPanel.dataset.friendId : null;
                
                console.log('ğŸ’¬ èŠå¤©çŠ¶æ€æ£€æŸ¥:', { 
                    isChatOpen, 
                    activeFriendId, 
                    friendId,
                    containerDisplay: containerDisplay,
                    containerComputed: containerComputed,
                    panelDisplay: chatPanel.style.display
                });
                
                // å¼ºåˆ¶æ›´æ–°å¥½å‹åˆ—è¡¨ï¼ˆç¡®ä¿æœ€åæ¶ˆæ¯æ˜¾ç¤ºï¼‰
                this.updateFriendsList();
                
                if (isChatOpen && activeFriendId === friendId) {
                    // å¦‚æœæ­£åœ¨å’Œè¿™ä¸ªå¥½å‹èŠå¤©ï¼Œç«‹å³è¿½åŠ æ¶ˆæ¯åˆ°ç•Œé¢ï¼ˆå¾®ä¿¡å¼å®æ—¶æ˜¾ç¤ºï¼‰
                    console.log('ğŸ’¬ å®æ—¶æ˜¾ç¤ºæ–°æ¶ˆæ¯ - æ­£åœ¨å’Œ', friend.name, 'èŠå¤©');
                    const messagesList = document.getElementById('chat-messages-list');
                    if (messagesList) {
                        // æ„å»ºæ¶ˆæ¯å¯¹è±¡
                        const receivedMessage = {
                            id: messageData.id || 'msg_' + Date.now(),
                            from: friendId,
                            to: this.currentUser.id,
                            content: messageData.content,
                            type: messageData.type || 'text',
                            timestamp: messageData.timestamp || new Date().toISOString()
                        };
                        // ç›´æ¥è¿½åŠ åˆ°èŠå¤©åˆ—è¡¨ï¼Œå®ç°å¾®ä¿¡å¼å®æ—¶æ˜¾ç¤ºæ•ˆæœ
                        this.appendMessageToChatList(receivedMessage, friend, messagesList, true);
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°æ¶ˆæ¯åˆ—è¡¨ï¼Œé‡æ–°æ¸²æŸ“
                        this.openChat(friendId);
                    }
                } else if (isChatOpen) {
                    // å¦‚æœèŠå¤©çª—å£æ‰“å¼€ä½†ä¸æ˜¯è¿™ä¸ªå¥½å‹ï¼Œåªæ›´æ–°å¥½å‹åˆ—è¡¨ï¼ˆå·²æ›´æ–°ï¼‰
                    console.log('ğŸ”„ æ›´æ–°å¥½å‹åˆ—è¡¨ - æ­£åœ¨å’Œå…¶ä»–äººèŠå¤©');
                } else {
                    // å¦‚æœèŠå¤©çª—å£æœªæ‰“å¼€ï¼Œæˆ–è€…ä¸åœ¨å½“å‰èŠå¤©çª—å£ï¼Œæ˜¾ç¤ºé€šçŸ¥
                    console.log('ğŸ”” æ˜¾ç¤ºé€šçŸ¥ - èŠå¤©çª—å£æœªæ‰“å¼€æˆ–ä¸åœ¨å½“å‰èŠå¤©');
                    // æ£€æŸ¥é¡µé¢æ˜¯å¦åœ¨å‰å°
                    const isPageVisible = !document.hidden;
                    // å¦‚æœé¡µé¢ä¸åœ¨å‰å°ï¼Œæˆ–è€…ä¸åœ¨å½“å‰èŠå¤©çª—å£ï¼Œéƒ½æ˜¾ç¤ºé€šçŸ¥
                    if (!isPageVisible || activeFriendId !== friendId) {
                        this.showNotification(friend.name, messageData.content);
                    }
                }
                
                // å¦‚æœç”¨æˆ·ä¿¡æ¯é¢æ¿æ‰“å¼€ï¼Œä¹Ÿæ›´æ–°å¥½å‹åˆ—è¡¨
                const profilePanel = document.getElementById('my-profile-panel');
                if (profilePanel && profilePanel.style.display === 'flex') {
                    this.updateProfileFriendsList();
                }
                
                console.log('âœ… èŠå¤©æ˜¾ç¤ºæ›´æ–°å®Œæˆ');
            },
            
            // é¡µé¢æ ‡é¢˜é—ªçƒç›¸å…³å˜é‡
            titleBlinkInterval: null,
            originalTitle: document.title,
            
            // æ˜¾ç¤ºæ¶ˆæ¯é€šçŸ¥ï¼ˆå¢å¼ºç‰ˆï¼‰
            showNotification(friendName, message) {
                // æ£€æŸ¥é¡µé¢æ˜¯å¦åœ¨å‰å°
                const isPageVisible = !document.hidden;
                
                // 1. æµè§ˆå™¨æ¡Œé¢é€šçŸ¥ï¼ˆåªåœ¨é¡µé¢ä¸åœ¨å‰å°æ—¶æ˜¾ç¤ºï¼Œæˆ–æ€»æ˜¯æ˜¾ç¤ºï¼‰
                if ('Notification' in window) {
                    if (Notification.permission === 'granted') {
                        // åˆ›å»ºé€šçŸ¥
                        const notification = new Notification(`ğŸ’¬ æ¥è‡ª ${friendName} çš„æ¶ˆæ¯`, {
                            body: message.length > 50 ? message.substring(0, 50) + '...' : message,
                            icon: './assets/images/icon-192x192.png',
                            badge: './assets/images/icon-96x96.png',
                            tag: `chat-${friendName}`, // ä½¿ç”¨tagé¿å…é‡å¤é€šçŸ¥
                            requireInteraction: false,
                            vibrate: [200, 100, 200] // éœ‡åŠ¨æ¨¡å¼ï¼ˆå¦‚æœè®¾å¤‡æ”¯æŒï¼‰
                        });
                        
                        // ç‚¹å‡»é€šçŸ¥æ—¶èšç„¦çª—å£
                        notification.onclick = () => {
                            window.focus();
                            notification.close();
                            // æ‰“å¼€èŠå¤©çª—å£
                            this.toggleChat();
                            // æ‰“å¼€è¯¥å¥½å‹çš„èŠå¤©
                            const friend = this.friends.find(f => f.name === friendName);
                            if (friend) {
                                this.openChat(friend.id);
                            }
                        };
                        
                        // 4ç§’åè‡ªåŠ¨å…³é—­é€šçŸ¥
                        setTimeout(() => {
                            notification.close();
                        }, 4000);
                    } else if (Notification.permission !== 'denied') {
                        // è¯·æ±‚é€šçŸ¥æƒé™
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                this.showNotification(friendName, message);
                            }
                        });
                    }
                }
                
                // 2. é¡µé¢æ ‡é¢˜é—ªçƒæé†’ï¼ˆå¦‚æœé¡µé¢åœ¨å‰å°ï¼‰
                if (isPageVisible) {
                    this.startTitleBlink(`ğŸ’¬ ${friendName}: ${message.substring(0, 20)}...`);
                } else {
                    // å¦‚æœé¡µé¢ä¸åœ¨å‰å°ï¼Œæ›´æ–°æ ‡é¢˜æ˜¾ç¤ºæœªè¯»æ¶ˆæ¯æ•°
                    this.updatePageTitle();
                }
                
                // 3. å£°éŸ³æé†’ï¼ˆå¯é€‰ï¼‰
                this.playNotificationSound();
            },
            
            // é¡µé¢æ ‡é¢˜é—ªçƒ
            startTitleBlink(text) {
                // æ¸…é™¤ä¹‹å‰çš„é—ªçƒ
                if (this.titleBlinkInterval) {
                    clearInterval(this.titleBlinkInterval);
                }
                
                let isBlinking = false;
                this.titleBlinkInterval = setInterval(() => {
                    if (isBlinking) {
                        document.title = this.originalTitle;
                    } else {
                        document.title = text;
                    }
                    isBlinking = !isBlinking;
                }, 1000); // æ¯ç§’åˆ‡æ¢ä¸€æ¬¡
                
                // 10ç§’ååœæ­¢é—ªçƒ
                setTimeout(() => {
                    this.stopTitleBlink();
                }, 10000);
            },
            
            // åœæ­¢æ ‡é¢˜é—ªçƒ
            stopTitleBlink() {
                if (this.titleBlinkInterval) {
                    clearInterval(this.titleBlinkInterval);
                    this.titleBlinkInterval = null;
                }
                document.title = this.originalTitle;
            },
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜ï¼ˆæ˜¾ç¤ºæœªè¯»æ¶ˆæ¯æ•°ï¼‰
            updatePageTitle() {
                if (this.unreadCount > 0) {
                    document.title = `(${this.unreadCount}) ${this.originalTitle}`;
                } else {
                    document.title = this.originalTitle;
                }
            },
            
            // æ’­æ”¾é€šçŸ¥å£°éŸ³
            playNotificationSound() {
                try {
                    // ä½¿ç”¨ Web Audio API ç”Ÿæˆç®€å•çš„æç¤ºéŸ³
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // è®¾ç½®éŸ³è°ƒï¼ˆ800Hzï¼Œç±»ä¼¼æ¶ˆæ¯æç¤ºéŸ³ï¼‰
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    // è®¾ç½®éŸ³é‡ï¼ˆ0.1ï¼Œé¿å…å¤ªå¤§å£°ï¼‰
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    // æ’­æ”¾200æ¯«ç§’
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                } catch (error) {
                    // å¦‚æœéŸ³é¢‘APIä¸å¯ç”¨ï¼Œé™é»˜å¤±è´¥
                    console.log('éŸ³é¢‘æé†’ä¸å¯ç”¨:', error);
                }
            },
            
            // è¯·æ±‚é€šçŸ¥æƒé™ï¼ˆåœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼‰
            requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    // å»¶è¿Ÿè¯·æ±‚ï¼Œé¿å…åœ¨é¡µé¢åŠ è½½æ—¶ç«‹å³å¼¹å‡º
                    setTimeout(() => {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                console.log('âœ… é€šçŸ¥æƒé™å·²æˆäºˆ');
                                // æ˜¾ç¤ºä¸€ä¸ªæµ‹è¯•é€šçŸ¥
                                new Notification('Totofun æ¶ˆæ¯æé†’', {
                                    body: 'æ‚¨å·²å¯ç”¨æ¶ˆæ¯é€šçŸ¥ï¼Œæœ‰æ–°æ¶ˆæ¯æ—¶ä¼šåŠæ—¶æé†’æ‚¨ï¼',
                                    icon: './assets/images/icon-192x192.png',
                                    tag: 'permission-granted'
                                });
                            } else {
                                console.log('âŒ é€šçŸ¥æƒé™è¢«æ‹’ç»');
                            }
                        });
                    }, 3000); // 3ç§’åè¯·æ±‚æƒé™
                }
            },
            
            // ç”ŸæˆæŒä¹…çš„ç”¨æˆ·IDï¼ˆåŸºäºæµè§ˆå™¨æŒ‡çº¹ï¼‰
            generatePersistentUserId() {
                // å°è¯•ä»å¤šä¸ªåœ°æ–¹è·å–å·²å­˜åœ¨çš„IDï¼ˆå¢å¼ºæŒä¹…æ€§ï¼‰
                let userId = localStorage.getItem('totofun-user-id');
                
                // å¦‚æœlocalStorageä¸­æ²¡æœ‰ï¼Œå°è¯•ä»sessionStorageè·å–ï¼ˆä½œä¸ºå¤‡ä»½ï¼‰
                if (!userId) {
                    userId = sessionStorage.getItem('totofun-user-id');
                    if (userId) {
                        // å¦‚æœsessionStorageä¸­æœ‰ï¼ŒåŒæ­¥åˆ°localStorage
                        try {
                            localStorage.setItem('totofun-user-id', userId);
                        } catch (e) {
                            console.warn('localStorageå†™å…¥å¤±è´¥ï¼Œä½¿ç”¨sessionStorage:', e);
                        }
                    }
                }
                
                // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå°è¯•ä»å·²æœ‰çš„èŠå¤©ç”¨æˆ·æ•°æ®ä¸­æ¢å¤
                if (!userId) {
                    const savedChatUser = storageManager.load('chatUser');
                    if (savedChatUser && savedChatUser.id) {
                        userId = savedChatUser.id;
                        // ä¿å­˜åˆ°localStorageå’ŒsessionStorage
                        try {
                            localStorage.setItem('totofun-user-id', userId);
                            sessionStorage.setItem('totofun-user-id', userId);
                        } catch (e) {
                            console.warn('ä¿å­˜ç”¨æˆ·IDå¤±è´¥:', e);
                        }
                    }
                }
                
                if (!userId) {
                    // ç”Ÿæˆæ–°çš„çŸ­IDï¼ˆ10ä½æ•°å­—ï¼‰
                    // ä½¿ç”¨æ—¶é—´æˆ³çš„å8ä½ + 2ä½éšæœºæ•°ï¼Œç¡®ä¿å”¯ä¸€æ€§
                    const timestamp = Date.now().toString();
                    const timestampSuffix = timestamp.substring(timestamp.length - 8); // å–æ—¶é—´æˆ³å8ä½
                    const random = Math.floor(Math.random() * 100).toString().padStart(2, '0'); // 2ä½éšæœºæ•°
                    userId = timestampSuffix + random; // æ€»å…±10ä½æ•°å­—
                    
                    // æ°¸ä¹…ä¿å­˜åˆ°å¤šä¸ªä½ç½®
                    try {
                        localStorage.setItem('totofun-user-id', userId);
                        sessionStorage.setItem('totofun-user-id', userId);
                        console.log('âœ… æ–°ç”¨æˆ·IDå·²ç”Ÿæˆï¼ˆ10ä½æ•°å­—ï¼‰:', userId);
                    } catch (e) {
                        console.error('âŒ ä¿å­˜ç”¨æˆ·IDå¤±è´¥:', e);
                        // å¦‚æœlocalStorageå¤±è´¥ï¼Œè‡³å°‘ä¿å­˜åˆ°sessionStorage
                        try {
                            sessionStorage.setItem('totofun-user-id', userId);
                        } catch (e2) {
                            console.error('âŒ sessionStorageä¹Ÿå¤±è´¥:', e2);
                        }
                    }
                } else {
                    // å¦‚æœå·²æœ‰IDï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æ—§çš„é•¿IDæ ¼å¼
                    // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼ˆé•¿åº¦>10æˆ–åŒ…å«éæ•°å­—å­—ç¬¦ï¼‰ï¼Œå¯ä»¥é€‰æ‹©è¿ç§»åˆ°çŸ­ID
                    // ä½†ä¸ºäº†å…¼å®¹æ€§ï¼Œå…ˆä¿æŒåŸIDä¸å˜
                    if (userId.length > 10 || !/^\d+$/.test(userId)) {
                        console.log('âš ï¸ æ£€æµ‹åˆ°æ—§æ ¼å¼IDï¼Œä¿æŒåŸID:', userId);
                        // å¯é€‰ï¼šå¦‚æœéœ€è¦è¿ç§»åˆ°çŸ­IDï¼Œå¯ä»¥åœ¨è¿™é‡Œå®ç°
                        // ä½†ä¸ºäº†ä¸ç ´åå·²æœ‰ç”¨æˆ·çš„å¥½å‹å…³ç³»ï¼Œæš‚æ—¶ä¿æŒåŸID
                    } else {
                        console.log('âœ… æ¢å¤ç”¨æˆ·IDï¼ˆ10ä½æ•°å­—ï¼‰:', userId);
                    }
                }
                
                return userId;
            },

            // æ¸²æŸ“å¤´åƒï¼ˆæ”¯æŒå›¾ç‰‡å’Œemojiï¼‰
            renderAvatar(avatar, size = 40) {
                if (!avatar) {
                    return `<span style="font-size: ${size * 0.7}px; display: block; text-align: center; line-height: ${size}px;">ğŸ‘¤</span>`;
                }
                
                // å¦‚æœæ˜¯å›¾ç‰‡è·¯å¾„ï¼ˆä»¥ http://ã€https://ã€./ æˆ– / å¼€å¤´ï¼Œæˆ–ä»¥å›¾ç‰‡æ‰©å±•åç»“å°¾ï¼‰ï¼Œä½¿ç”¨imgæ ‡ç­¾
                const isImagePath = avatar.startsWith('http://') || 
                                   avatar.startsWith('https://') || 
                                   avatar.startsWith('./') || 
                                   avatar.startsWith('/') || 
                                   avatar.endsWith('.png') || 
                                   avatar.endsWith('.jpg') || 
                                   avatar.endsWith('.jpeg') || 
                                   avatar.endsWith('.gif') || 
                                   avatar.endsWith('.svg') ||
                                   avatar.endsWith('.webp');
                
                if (isImagePath) {
                    // è§„èŒƒåŒ–è·¯å¾„ï¼šå¦‚æœè·¯å¾„ä¸ä»¥ ./ æˆ– / å¼€å¤´ï¼Œä¸”ä¸æ˜¯http/httpsï¼Œåˆ™æ·»åŠ  ./
                    let imagePath = avatar;
                    if (!avatar.startsWith('http://') && 
                        !avatar.startsWith('https://') && 
                        !avatar.startsWith('./') && 
                        !avatar.startsWith('/')) {
                        imagePath = './' + avatar;
                    }
                    
                    // è°ƒè¯•æ—¥å¿—
                    console.log('ğŸ–¼ï¸ æ¸²æŸ“å¤´åƒå›¾ç‰‡:', { avatar, imagePath, size });
                    
                    // è·å–fallback emojiï¼ˆå¦‚æœæ˜¯æœºå™¨äººï¼Œä½¿ç”¨ğŸ¤–ï¼Œå¦åˆ™ä½¿ç”¨ğŸ‘¤ï¼‰
                    const fallbackEmoji = avatar.includes('xiaotu') || avatar.includes('totofun_bot') ? 'ğŸ¤–' : 'ğŸ‘¤';
                    
                    // æ£€æµ‹æ˜¯å¦æ˜¯æœºå™¨äººå¤´åƒï¼ˆéœ€è¦é€æ˜èƒŒæ™¯ï¼‰
                    const isBotAvatar = avatar.includes('xiaotu') || avatar.includes('totofun_bot');
                    
                    // æœºå™¨äººå¤´åƒæ”¾å¤§ä¸€å€
                    const actualSize = isBotAvatar ? size * 2 : size;
                    
                    // æœºå™¨äººå¤´åƒä½¿ç”¨é€æ˜èƒŒæ™¯å’Œcontainæ¨¡å¼ï¼Œæ™®é€šå¤´åƒä½¿ç”¨ç°è‰²èƒŒæ™¯å’Œcoveræ¨¡å¼
                    const containerBg = isBotAvatar ? 'transparent' : '#f0f0f0';
                    const objectFit = isBotAvatar ? 'contain' : 'cover';
                    
                    // ä½¿ç”¨onerrorå¤„ç†å›¾ç‰‡åŠ è½½å¤±è´¥çš„æƒ…å†µï¼Œè‡ªåŠ¨fallbackåˆ°emoji
                    return `<div style="position: relative; width: ${actualSize}px; height: ${actualSize}px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: ${containerBg};">
                        <img src="${imagePath}" alt="å¤´åƒ" style="width: 100%; height: 100%; object-fit: ${objectFit}; display: block; background: transparent;" 
                             onerror="console.error('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥:', '${imagePath}'); this.style.display='none'; const fallback = this.parentElement.querySelector('.avatar-fallback'); if(fallback) fallback.style.display='flex';" 
                             onload="console.log('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ:', '${imagePath}'); const fallback = this.parentElement.querySelector('.avatar-fallback'); if(fallback) fallback.style.display='none';">
                        <span class="avatar-fallback" style="font-size: ${actualSize * 0.7}px; display: flex; text-align: center; line-height: ${actualSize}px; width: ${actualSize}px; height: ${actualSize}px; align-items: center; justify-content: center;">${fallbackEmoji}</span>
                    </div>`;
                }
                
                // å¦åˆ™ä½¿ç”¨emojiæˆ–æ–‡å­—
                return `<span style="font-size: ${size * 0.7}px; display: block; text-align: center; line-height: ${size}px;">${avatar}</span>`;
            },
            
            // è·å–é»˜è®¤å¥½å‹ï¼ˆåŒ…å«AIæœºå™¨äºº"å°çª"ï¼‰
            getDefaultFriends() {
                // æœºå™¨äººä¸å†æ˜¾ç¤ºåœ¨å¥½å‹åˆ—è¡¨ä¸­ï¼Œé€šè¿‡å·¦ä¸‹è§’çš„å¤´åƒæŒ‰é’®è®¿é—®
                return [];
            },

            // æ˜¾ç¤ºæ·»åŠ å¥½å‹é¢æ¿
            showAddFriend() {
                document.getElementById('add-friend-panel').style.display = 'flex';
                document.getElementById('my-profile-panel').style.display = 'none';
                document.getElementById('chat-container').style.display = 'none';
                document.getElementById('my-id-display').value = this.currentUser.id;
            },

            // å…³é—­æ·»åŠ å¥½å‹é¢æ¿
            closeAddFriend() {
                document.getElementById('add-friend-panel').style.display = 'none';
            },

            // é€šè¿‡IDæ·»åŠ å¥½å‹
            addFriendById() {
                const friendId = document.getElementById('friend-id-input').value.trim();
                if (!friendId) {
                    alert('è¯·è¾“å…¥å¥½å‹ID');
                    return;
                }

                if (friendId === this.currentUser.id) {
                    alert('ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹');
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¥½å‹
                if (this.friends.find(f => f.id === friendId)) {
                    alert('è¯¥ç”¨æˆ·å·²ç»æ˜¯ä½ çš„å¥½å‹äº†');
                    return;
                }

                // å¦‚æœFirebaseå·²å¯ç”¨ï¼Œä»Firebaseè·å–ç”¨æˆ·ä¿¡æ¯
                if (firebaseEnabled && database) {
                    const userRef = database.ref(`users/${friendId}`);
                    userRef.once('value', (snapshot) => {
                        const userData = snapshot.val();
                        if (userData) {
                            // ä»Firebaseè·å–ç”¨æˆ·ä¿¡æ¯
                            const newFriend = {
                                id: friendId,
                                name: userData.name || 'æ–°å¥½å‹',
                                avatar: userData.avatar || 'ğŸ‘¤',
                                online: userData.online || false,
                                lastMessage: '',
                                lastTime: new Date().toISOString()
                            };

                            this.friends.push(newFriend);
                            this.saveData();
                            
                            // åŒæ­¥åˆ°Firebase
                            this.syncFriendshipToFirebase(friendId, newFriend);
                            
                            // å¼€å§‹ç›‘å¬æ–°å¥½å‹çš„åœ¨çº¿çŠ¶æ€
                            if (firebaseEnabled && database) {
                                this.watchFriendOnlineStatus(friendId);
                            }
                            
                            alert(`âœ… æ·»åŠ å¥½å‹æˆåŠŸï¼\n\nå¥½å‹åç§°ï¼š${newFriend.name}\n\nè¯·è®©ä½ çš„æœ‹å‹ä¹Ÿæ·»åŠ ä½ çš„IDï¼š\n${this.currentUser.id}`);
                            
                            document.getElementById('friend-id-input').value = '';
                            this.closeAddFriend();
                            this.toggleChat();
                            this.updateFriendsList();
                            
                            // å¦‚æœç”¨æˆ·ä¿¡æ¯é¢æ¿æ‰“å¼€ï¼Œæ›´æ–°å¥½å‹åˆ—è¡¨
                            if (document.getElementById('my-profile-panel').style.display === 'flex') {
                                this.updateProfileFriendsList();
                                document.getElementById('profile-friends-count').textContent = this.friends.length;
                            }
                        } else {
                            alert('âŒ æœªæ‰¾åˆ°è¯¥ç”¨æˆ·ï¼\n\nè¯·ç¡®è®¤ï¼š\n1. ç”¨æˆ·IDæ˜¯å¦æ­£ç¡®\n2. è¯¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•è¿‡æ¸¸æˆ\n3. è¯¥ç”¨æˆ·æ˜¯å¦åœ¨Firebaseä¸­æ³¨å†Œ');
                        }
                    }, (error) => {
                        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                        alert('âŒ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    });
                } else {
                    // Firebaseæœªå¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼
                    const newFriend = {
                        id: friendId,
                        name: 'æ–°å¥½å‹',
                        avatar: 'ğŸ‘¤',
                        online: true,
                        lastMessage: '',
                        lastTime: new Date().toISOString()
                    };

                    this.friends.push(newFriend);
                    this.saveData();
                    
                    alert('âœ… æ·»åŠ å¥½å‹æˆåŠŸï¼\n\nè¯·è®©ä½ çš„æœ‹å‹ä¹Ÿæ·»åŠ ä½ çš„IDï¼š\n' + this.currentUser.id);
                    
                    document.getElementById('friend-id-input').value = '';
                    this.closeAddFriend();
                    this.toggleChat();
                    this.updateFriendsList();
                }
            },
            
            // åŒæ­¥å¥½å‹å…³ç³»åˆ°Firebase
            syncFriendshipToFirebase(friendId, friendData) {
                if (!firebaseEnabled || !database) return;
                
                try {
                    const friendshipRef = database.ref(`friendships/${this.currentUser.id}/${friendId}`);
                    friendshipRef.set({
                        friendId: friendId,
                        friendName: friendData.name,
                        friendAvatar: friendData.avatar,
                        addedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                } catch (error) {
                    console.error('åŒæ­¥å¥½å‹å…³ç³»å¤±è´¥:', error);
                }
            },

            // å¤åˆ¶æˆ‘çš„ID
            copyMyId() {
                const idInput = document.getElementById('my-id-display');
                idInput.select();
                document.execCommand('copy');
                
                // æ˜¾ç¤ºæç¤º
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ å·²å¤åˆ¶';
                btn.style.background = '#22C55E';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#4FC3F7';
                }, 2000);
            },

            // ç”Ÿæˆåˆ†äº«é“¾æ¥
            generateShareLink() {
                const baseUrl = window.location.href.split('?')[0];
                const shareUrl = `${baseUrl}?addFriend=${this.currentUser.id}`;
                
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                const tempInput = document.createElement('input');
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                alert('ğŸ”— åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n' + shareUrl + '\n\nå°†æ­¤é“¾æ¥å‘é€ç»™æœ‹å‹ï¼Œä»–ä»¬ç‚¹å‡»åä¼šè‡ªåŠ¨æ·»åŠ ä½ ä¸ºå¥½å‹ã€‚');
            },

            // æ˜¾ç¤ºæˆ‘çš„ä¿¡æ¯é¢æ¿
            showMyProfile() {
                document.getElementById('my-profile-panel').style.display = 'flex';
                document.getElementById('add-friend-panel').style.display = 'none';
                document.getElementById('chat-container').style.display = 'none';
                
                // å¡«å……ä¿¡æ¯
                document.getElementById('profile-avatar').textContent = this.currentUser.avatar;
                document.getElementById('profile-name-input').value = this.currentUser.name;
                document.getElementById('profile-my-id').textContent = this.currentUser.id;
                document.getElementById('profile-friends-count').textContent = this.friends.length;
                
                // è®¡ç®—æ¶ˆæ¯æ€»æ•°
                let totalMessages = 0;
                Object.values(this.conversations).forEach(conv => {
                    totalMessages += conv.length;
                });
                document.getElementById('profile-messages-count').textContent = totalMessages;
                
                // æ›´æ–°å¥½å‹åˆ—è¡¨æ˜¾ç¤º
                this.updateProfileFriendsList();
                
                // ç”Ÿæˆå¤´åƒé€‰æ‹©å™¨
                this.generateAvatarSelector();
                
                // æ›´æ–°DeepSeek APIé…ç½®çŠ¶æ€
                this.updateDeepSeekApiStatus();
            },
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯é¢æ¿ä¸­çš„å¥½å‹åˆ—è¡¨
            updateProfileFriendsList() {
                const friendsList = document.getElementById('profile-friends-list');
                if (!friendsList) return;
                
                friendsList.innerHTML = '';
                
                if (this.friends.length === 0) {
                    friendsList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— å¥½å‹<br><small>ç‚¹å‡»ğŸ’¬æŒ‰é’®æ·»åŠ å¥½å‹</small></div>';
                    return;
                }
                
                // æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´æ’åº
                const sortedFriends = [...this.friends].sort((a, b) => {
                    return new Date(b.lastTime || 0) - new Date(a.lastTime || 0);
                });
                
                sortedFriends.forEach(friend => {
                    const friendDiv = document.createElement('div');
                    friendDiv.style.cssText = `
                        display: flex;
                        align-items: center;
                        padding: 10px;
                        margin-bottom: 8px;
                        background: white;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                        gap: 10px;
                    `;
                    friendDiv.onmouseover = function() { this.style.background = '#f0f0f0'; };
                    friendDiv.onmouseout = function() { this.style.background = 'white'; };
                    friendDiv.onclick = () => {
                        // å…³é—­ç”¨æˆ·ä¿¡æ¯é¢æ¿ï¼Œæ‰“å¼€èŠå¤©
                        this.closeMyProfile();
                        this.toggleChat();
                        this.openChat(friend.id);
                    };
                    
                    friendDiv.innerHTML = `
                        <div style="font-size: 28px; flex-shrink: 0;">${friend.avatar}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 2px;">
                                ${friend.name}
                                <span style="color: ${friend.online ? '#22C55E' : '#999'}; font-size: 10px;">
                                    ${friend.online ? 'â—' : 'â—‹'}
                                </span>
                            </div>
                            <div style="font-size: 12px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${friend.lastMessage || 'æš‚æ— æ¶ˆæ¯'}
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #999; flex-shrink: 0;">
                            ${this.formatTime(friend.lastTime)}
                        </div>
                    `;
                    
                    friendsList.appendChild(friendDiv);
                });
            },

            // å…³é—­æˆ‘çš„ä¿¡æ¯é¢æ¿
            closeMyProfile() {
                document.getElementById('my-profile-panel').style.display = 'none';
            },

            // æ›´æ–°ä¸ªäººèµ„æ–™
            updateProfile() {
                const newName = document.getElementById('profile-name-input').value.trim();
                if (newName && newName.length >= 3 && newName.length <= 10) {
                    this.currentUser.name = newName;
                    storageManager.save('chatUser', this.currentUser);
                    
                    // åŒæ­¥åˆ°æ¸¸æˆæ˜µç§°
                    userData.username = newName;
                    saveUserData();
                    
                    // æ›´æ–°ä¸»é¡µæ˜¾ç¤º
                    document.getElementById('user-name').textContent = newName;
                    
                    // åŒæ­¥åˆ°Firebase
                    if (firebaseEnabled && database) {
                        const userRef = database.ref(`users/${this.currentUser.id}`);
                        userRef.update({
                            name: newName,
                            avatar: this.currentUser.avatar,
                            updatedAt: firebase.database.ServerValue.TIMESTAMP
                        }, (error) => {
                            if (error) {
                                console.error('âŒ åŒæ­¥ç”¨æˆ·ä¿¡æ¯åˆ°Firebaseå¤±è´¥:', error);
                            } else {
                                console.log('âœ… ç”¨æˆ·ä¿¡æ¯å·²åŒæ­¥åˆ°Firebase');
                            }
                        });
                    }
                    
                    alert('âœ… ä¸ªäººä¿¡æ¯å·²æ›´æ–°ï¼\n\næ˜µç§°å·²åŒæ­¥åˆ°æ¸¸æˆå’ŒèŠå¤©ç³»ç»Ÿã€‚');
                } else if (newName) {
                    alert('âŒ æ˜µç§°é•¿åº¦åº”è¯¥åœ¨3-10ä¸ªå­—ç¬¦ä¹‹é—´');
                }
            },

            // ç”Ÿæˆå¤´åƒé€‰æ‹©å™¨
            generateAvatarSelector() {
                const avatars = ['ğŸ‘¤', 'ğŸ‘¨', 'ğŸ‘©', 'ğŸ§‘', 'ğŸ‘¨â€ğŸ’¼', 'ğŸ‘©â€ğŸ’¼', 'ğŸ‘¨â€ğŸ“', 'ğŸ‘©â€ğŸ“', 'ğŸ‘¨â€ğŸš€', 'ğŸ‘©â€ğŸš€', 
                                'ğŸ§‘â€ğŸš€', 'ğŸ‘¨â€ğŸ¨', 'ğŸ‘©â€ğŸ¨', 'ğŸ‘¨â€ğŸ”§', 'ğŸ‘©â€ğŸ”§', 'ğŸ˜€', 'ğŸ˜', 'ğŸ¤“', 'ğŸ¥³', 'ğŸ¤ '];
                
                const selector = document.getElementById('avatar-selector');
                selector.innerHTML = '';
                
                avatars.forEach(avatar => {
                    const btn = document.createElement('button');
                    btn.textContent = avatar;
                    btn.style.cssText = `
                        font-size: 32px;
                        padding: 10px;
                        border: 2px solid ${this.currentUser.avatar === avatar ? '#4FC3F7' : '#e0e0e0'};
                        border-radius: 10px;
                        background: ${this.currentUser.avatar === avatar ? '#e3f2fd' : 'white'};
                        cursor: pointer;
                        transition: all 0.2s;
                    `;
                    btn.onclick = () => {
                        this.currentUser.avatar = avatar;
                        storageManager.save('chatUser', this.currentUser);
                        document.getElementById('profile-avatar').textContent = avatar;
                        this.generateAvatarSelector();
                        
                        // åŒæ­¥å¤´åƒåˆ°Firebase
                        if (firebaseEnabled && database) {
                            const userRef = database.ref(`users/${this.currentUser.id}`);
                            userRef.update({
                                avatar: avatar,
                                updatedAt: firebase.database.ServerValue.TIMESTAMP
                            }, (error) => {
                                if (error) {
                                    console.error('âŒ åŒæ­¥å¤´åƒåˆ°Firebaseå¤±è´¥:', error);
                                } else {
                                    console.log('âœ… å¤´åƒå·²åŒæ­¥åˆ°Firebase:', avatar);
                                }
                            });
                        }
                    };
                    selector.appendChild(btn);
                });
            },

            // æ£€æŸ¥URLå‚æ•°ï¼Œè‡ªåŠ¨æ·»åŠ å¥½å‹å’Œæ¥æ”¶æ¶ˆæ¯
            checkUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                
                // 1. å¤„ç†æ·»åŠ å¥½å‹
                const friendId = urlParams.get('addFriend');
                if (friendId && friendId !== this.currentUser.id) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¥½å‹
                    if (!this.friends.find(f => f.id === friendId)) {
                        const newFriend = {
                            id: friendId,
                            name: 'æ–°å¥½å‹',
                            avatar: 'ğŸ‘¤',
                            online: true,
                            lastMessage: '',
                            lastTime: new Date().toISOString()
                        };
                        this.friends.push(newFriend);
                        this.saveData();
                        
                        alert('ğŸ‰ å·²è‡ªåŠ¨æ·»åŠ å¥½å‹ï¼\n\nè¯·åˆ†äº«ä½ çš„IDç»™å¯¹æ–¹ï¼š\n' + this.currentUser.id);
                        this.toggleChat();
                    }
                }
                
                // 2. å¤„ç†æ¥æ”¶æ¶ˆæ¯
                const receiveMessage = urlParams.get('receiveMessage');
                if (receiveMessage) {
                    try {
                        // è§£ç æ¶ˆæ¯æ•°æ®
                        const messageData = JSON.parse(atob(receiveMessage));
                        
                        // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æ˜¯å‘ç»™å½“å‰ç”¨æˆ·çš„
                        if (messageData.to === this.currentUser.id) {
                            // ç¡®ä¿å‘é€è€…æ˜¯å¥½å‹
                            let sender = this.friends.find(f => f.id === messageData.from);
                            if (!sender) {
                                // å¦‚æœä¸æ˜¯å¥½å‹ï¼Œå…ˆæ·»åŠ ä¸ºå¥½å‹
                                sender = {
                                    id: messageData.from,
                                    name: messageData.fromName || 'æ–°å¥½å‹',
                                    avatar: 'ğŸ‘¤',
                                    online: true,
                                    lastMessage: '',
                                    lastTime: new Date().toISOString()
                                };
                                this.friends.push(sender);
                                this.saveData();
                            }
                            
                            // ä¿å­˜æ¶ˆæ¯
                            if (!this.conversations[messageData.from]) {
                                this.conversations[messageData.from] = [];
                            }
                            
                            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤ï¼‰
                            const messageExists = this.conversations[messageData.from].some(
                                m => m.timestamp === messageData.timestamp && m.content === messageData.content
                            );
                            
                            if (!messageExists) {
                                const receivedMessage = {
                                    id: 'msg_' + Date.now(),
                                    from: messageData.from,
                                    to: this.currentUser.id,
                                    content: messageData.content,
                                    type: messageData.type || 'text',
                                    timestamp: messageData.timestamp,
                                    read: false
                                };
                                
                                this.conversations[messageData.from].push(receivedMessage);
                                
                                // æ›´æ–°å¥½å‹æœ€åæ¶ˆæ¯
                                sender.lastMessage = messageData.type === 'location' ? 'ğŸ“ ä½ç½®' : messageData.content;
                                sender.lastTime = messageData.timestamp;
                                
                                this.updateUnreadCount();
                                this.saveData();
                                
                                // æ¸…é™¤URLå‚æ•°
                                window.history.replaceState({}, document.title, window.location.pathname);
                                
                                // æ˜¾ç¤ºé€šçŸ¥
                                alert(`ğŸ’¬ æ”¶åˆ°æ¥è‡ª ${sender.name} çš„æ¶ˆæ¯ï¼\n\næ¶ˆæ¯å†…å®¹ï¼š${messageData.content}\n\nç‚¹å‡»ğŸ’¬æŒ‰é’®æŸ¥çœ‹æ¶ˆæ¯`);
                                
                                // å¦‚æœèŠå¤©çª—å£å·²æ‰“å¼€ï¼Œæ›´æ–°æ˜¾ç¤º
                                if (document.getElementById('chat-container').style.display !== 'none') {
                                    this.updateFriendsList();
                                }
                            }
                        } else {
                            // æ¶ˆæ¯ä¸æ˜¯å‘ç»™å½“å‰ç”¨æˆ·çš„
                            window.history.replaceState({}, document.title, window.location.pathname);
                            alert('âš ï¸ è¿™æ¡æ¶ˆæ¯ä¸æ˜¯å‘ç»™ä½ çš„ï¼Œè¯·ç¡®è®¤é“¾æ¥æ˜¯å¦æ­£ç¡®ã€‚');
                        }
                    } catch (error) {
                        console.error('è§£ææ¶ˆæ¯å¤±è´¥:', error);
                        window.history.replaceState({}, document.title, window.location.pathname);
                        alert('âŒ æ¶ˆæ¯æ ¼å¼é”™è¯¯ï¼Œæ— æ³•æ¥æ”¶ã€‚');
                    }
                }
            },

            // å‘é€æ¶ˆæ¯
            sendMessage(friendId, content, type = 'text') {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                if (!authService.isLoggedIn()) {
                    authManager.showModal();
                    return null;
                }

                const message = {
                    id: 'msg_' + Date.now(),
                    from: this.currentUser.id,
                    to: friendId,
                    content: content,
                    type: type,
                    timestamp: new Date().toISOString(),
                    read: false,
                    status: 'sending' // æ¶ˆæ¯çŠ¶æ€: sending(å‘é€ä¸­) -> sent(å·²å‘é€) -> read(å·²è¯»)
                };

                // ä¿å­˜åˆ°æœ¬åœ°å¯¹è¯è®°å½•
                if (!this.conversations[friendId]) {
                    this.conversations[friendId] = [];
                }
                this.conversations[friendId].push(message);
                
                // æ›´æ–°å¥½å‹æœ€åæ¶ˆæ¯
                const friend = this.friends.find(f => f.id === friendId);
                if (friend) {
                    friend.lastMessage = type === 'text' ? content : 'ğŸ“ ä½ç½®';
                    friend.lastTime = message.timestamp;
                }

                this.saveData();
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å‘ç»™AIæœºå™¨äººçš„æ¶ˆæ¯ï¼ˆæœºå™¨äººä¸åœ¨å¥½å‹åˆ—è¡¨ä¸­ï¼Œä½†å¯ä»¥é€šè¿‡IDåˆ¤æ–­ï¼‰
                if (friendId === 'totofun_bot') {
                    // å»¶è¿Ÿä¸€ä¸‹ï¼Œæ¨¡æ‹Ÿæ€è€ƒæ—¶é—´ï¼Œç„¶åè·å–AIå›å¤
                    setTimeout(() => {
                        this.getBotReply(content, friendId).then(reply => {
                            // ç¡®ä¿æœ‰å›å¤ï¼ˆå³ä½¿AIå¤±è´¥ä¹Ÿåº”è¯¥æœ‰é»˜è®¤å›å¤ï¼‰
                            const finalReply = reply || this.getDefaultBotReply() || 'æˆ‘åœ¨å‘¢ï¼æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼ŸğŸ˜Š';
                            
                            // æ¨¡æ‹Ÿæœºå™¨äººå‘é€æ¶ˆæ¯
                            const botMessage = {
                                id: 'msg_' + Date.now(),
                                from: friendId,
                                to: this.currentUser.id,
                                content: finalReply,
                                type: 'text',
                                timestamp: new Date().toISOString(),
                                read: false,
                                status: 'received'
                            };
                            
                            // æ·»åŠ åˆ°å¯¹è¯è®°å½•
                            this.addMessageToConversation(botMessage, true);
                            
                            // æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºå·²å‘é€
                            this.updateMessageStatus(friendId, message.id, 'sent');
                            
                            // æ›´æ–°æœºå™¨äººèŠå¤©çª—å£æ˜¾ç¤º
                            this.updateBotChatMessages();
                        }).catch(error => {
                            console.error('âŒ è·å–æœºå™¨äººå›å¤å¼‚å¸¸:', error);
                            // å³ä½¿å‡ºé”™ä¹Ÿæ˜¾ç¤ºé»˜è®¤å›å¤
                            const defaultReply = this.getDefaultBotReply() || 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æœ‰ç‚¹ç´¯ï¼Œç¨åå†èŠå§~ ğŸ˜´';
                            const botMessage = {
                                id: 'msg_' + Date.now(),
                                from: friendId,
                                to: this.currentUser.id,
                                content: defaultReply,
                                type: 'text',
                                timestamp: new Date().toISOString(),
                                read: false,
                                status: 'received'
                            };
                            this.addMessageToConversation(botMessage, true);
                            this.updateBotChatMessages();
                        });
                    }, 500); // 500mså»¶è¿Ÿï¼Œæ¨¡æ‹Ÿæ€è€ƒæ—¶é—´
                } else {
                    // æ™®é€šå¥½å‹æ¶ˆæ¯ï¼Œé€šè¿‡Firebaseå‘é€
                    if (firebaseEnabled && database) {
                        this.sendFirebaseMessage(friendId, message);
                    }
                }
                
                return message;
            },
            
            // AIæœºå™¨äººå›å¤æœåŠ¡
            async getBotReply(userMessage, botId) {
                try {
                    // å…ˆå°è¯•è§„åˆ™å›å¤ï¼ˆå¿«é€Ÿã€å…è´¹ï¼‰
                    const ruleReply = this.getRuleBasedReply(userMessage);
                    if (ruleReply) {
                        console.log('ğŸ¤– ä½¿ç”¨è§„åˆ™å›å¤:', ruleReply);
                        return ruleReply;
                    }
                    
                    // å¦‚æœæ²¡æœ‰åŒ¹é…çš„è§„åˆ™ï¼Œå°è¯•è°ƒç”¨AI API
                    try {
                        const aiReply = await this.getAIReply(userMessage);
                        if (aiReply && aiReply.trim()) {
                            console.log('ğŸ¤– ä½¿ç”¨AIå›å¤:', aiReply.substring(0, 50) + '...');
                            return aiReply;
                        }
                    } catch (aiError) {
                        console.error('âŒ AI APIè°ƒç”¨å¤±è´¥:', aiError);
                        // ç»§ç»­æ‰§è¡Œï¼Œä½¿ç”¨é»˜è®¤å›å¤
                    }
                    
                    // å¦‚æœAI APIä¸å¯ç”¨æˆ–è¿”å›ç©ºï¼Œè¿”å›é»˜è®¤å›å¤
                    const defaultReply = this.getDefaultBotReply();
                    console.log('ğŸ¤– ä½¿ç”¨é»˜è®¤å›å¤:', defaultReply);
                    return defaultReply;
                } catch (error) {
                    console.error('âŒ è·å–æœºå™¨äººå›å¤å¤±è´¥:', error);
                    return this.getDefaultBotReply() || 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æœ‰ç‚¹ç´¯ï¼Œç¨åå†èŠå§~ ğŸ˜´';
                }
            },
            
            // è§„åˆ™å›å¤ï¼ˆå¿«é€Ÿã€å…è´¹ï¼‰
            getRuleBasedReply(message) {
                const lowerMessage = message.toLowerCase().trim();
                
                // é—®å€™è¯­
                if (/^(ä½ å¥½|hello|hi|å—¨|æ—©ä¸Šå¥½|ä¸‹åˆå¥½|æ™šä¸Šå¥½|åœ¨å—|åœ¨ä¸åœ¨)/.test(lowerMessage)) {
                    return 'ä½ å¥½ï¼æˆ‘æ˜¯å°çªï¼Œä½ çš„å¯»å®ä¼™ä¼´ï¼ğŸ˜Š æœ‰ä»€ä¹ˆé—®é¢˜éƒ½å¯ä»¥é—®æˆ‘å“¦~';
                }
                
                // æ¸¸æˆå¼•å¯¼
                if (/^(æ€ä¹ˆ|å¦‚ä½•|æ€æ ·|ä¸ä¼š|ä¸æ‡‚|æ•™æˆ‘|å¼•å¯¼|æ–°æ‰‹|ç¬¬ä¸€æ¬¡)/.test(lowerMessage)) {
                    return 'è®©æˆ‘æ¥å¸®ä½ ï¼ğŸ®\n\n1ï¸âƒ£ ç‚¹å‡»"å¯åŠ¨å¯»å®ä¹‹æ—…"å¼€å§‹æ¸¸æˆ\n2ï¸âƒ£ å…è®¸GPSå®šä½æƒé™\n3ï¸âƒ£ åœ¨åœ°å›¾ä¸Šæ‰¾åˆ°é™„è¿‘çš„å®è—\n4ï¸âƒ£ ç‚¹å‡»å®è—æŸ¥çœ‹è¯¦æƒ…\n5ï¸âƒ£ åˆ°è¾¾å®è—ä½ç½®åç‚¹å‡»"å‘ç°å®è—"\n\næœ‰ä»€ä¹ˆä¸æ‡‚çš„éšæ—¶é—®æˆ‘ï¼';
                }
                
                // å¯»å®ç›¸å…³
                if (/^(å®è—|å¯»å®|æ‰¾åˆ°|å‘ç°|ä½ç½®|åœ¨å“ªé‡Œ|åœ¨å“ª)/.test(lowerMessage)) {
                    return 'å®è—å°±åœ¨ä½ èº«è¾¹ï¼ğŸ—ºï¸\n\nâ€¢ æ‰“å¼€åœ°å›¾å¯ä»¥çœ‹åˆ°é™„è¿‘çš„å®è—\nâ€¢ ç»¿è‰²æ ‡è®°æ˜¯æ™®é€šå®è—\nâ€¢ é‡‘è‰²æ ‡è®°æ˜¯ç¨€æœ‰å®è—\nâ€¢ ç‚¹å‡»æ ‡è®°å¯ä»¥æŸ¥çœ‹è¯¦æƒ…\nâ€¢ åˆ°è¾¾ä½ç½®åå°±èƒ½å‘ç°å®è—å•¦ï¼\n\nåŠ æ²¹ï¼Œå¯»å®è€…ï¼ğŸ’ª';
                }
                
                // å¥½å‹ç›¸å…³
                if (/^(å¥½å‹|æœ‹å‹|æ·»åŠ |åŠ å¥½å‹|æ€ä¹ˆåŠ )/.test(lowerMessage)) {
                    return 'æ·»åŠ å¥½å‹å¾ˆç®€å•ï¼ğŸ‘¥\n\n1ï¸âƒ£ ç‚¹å‡»èŠå¤©æŒ‰é’®ğŸ’¬\n2ï¸âƒ£ ç‚¹å‡»"æ·»åŠ å¥½å‹"\n3ï¸âƒ£ è¾“å…¥å¥½å‹çš„IDï¼ˆ10ä½æ•°å­—ï¼‰\n4ï¸âƒ£ æˆ–è€…è®©å¥½å‹æ·»åŠ ä½ çš„ID\n\nä½ çš„IDæ˜¯ï¼š' + this.currentUser.id + '\n\nåˆ†äº«ç»™æœ‹å‹ï¼Œä¸€èµ·å¯»å®å§ï¼';
                }
                
                // æˆå°±/ç­‰çº§ç›¸å…³
                if (/^(ç­‰çº§|ç»éªŒ|å‡çº§|æˆå°±|å¾½ç« |å¥–åŠ±)/.test(lowerMessage)) {
                    return 'å‡çº§å’Œæˆå°±ç³»ç»Ÿï¼ğŸ†\n\nâ€¢ å‘ç°å®è—å¯ä»¥è·å¾—ç»éªŒå€¼\nâ€¢ ç»éªŒå€¼æ»¡äº†å°±ä¼šå‡çº§\nâ€¢ å®Œæˆç‰¹æ®Šä»»åŠ¡å¯ä»¥è·å¾—å¾½ç« \nâ€¢ ç­‰çº§è¶Šé«˜ï¼Œèƒ½å‘ç°çš„å®è—è¶Šå¤š\n\nç»§ç»­å¯»å®ï¼Œæˆä¸ºå¯»å®å¤§å¸ˆå§ï¼â­';
                }
                
                // æƒ…æ„Ÿæ”¯æŒ
                if (/^(ç´¯|ç–²æƒ«|å›°|æƒ³ä¼‘æ¯|ä¸æƒ³ç©äº†)/.test(lowerMessage)) {
                    return 'ç´¯äº†å°±ä¼‘æ¯ä¸€ä¸‹å§ï¼ğŸ˜´\n\nå¯»å®è™½ç„¶æœ‰è¶£ï¼Œä½†ä¹Ÿè¦æ³¨æ„ä¼‘æ¯å“¦~ æˆ‘ä¼šä¸€ç›´åœ¨è¿™é‡Œç­‰ä½ ï¼Œéšæ—¶å¯ä»¥æ¥æ‰¾æˆ‘èŠå¤©ï¼ğŸ’™';
                }
                
                if (/^(å¼€å¿ƒ|é«˜å…´|å¿«ä¹|å…´å¥‹|å¤ªæ£’äº†)/.test(lowerMessage)) {
                    return 'å¤ªå¥½äº†ï¼çœ‹åˆ°ä½ å¼€å¿ƒæˆ‘ä¹Ÿå¾ˆå¼€å¿ƒï¼ğŸ˜„\n\nç»§ç»­åŠ æ²¹ï¼Œå‘ç°æ›´å¤šå®è—å§ï¼ğŸ’ª';
                }
                
                if (/^(éš¾è¿‡|ä¼¤å¿ƒ|ä¸å¼€å¿ƒ|æ²®ä¸§|å¤±æœ›)/.test(lowerMessage)) {
                    return 'åˆ«éš¾è¿‡~ æ¯ä¸ªäººéƒ½ä¼šé‡åˆ°æŒ«æŠ˜çš„ï¼ğŸ’™\n\nå¯»å®çš„è·¯ä¸Šæ€»ä¼šæœ‰æƒŠå–œï¼Œè¯´ä¸å®šä¸‹ä¸€ä¸ªå®è—å°±åœ¨ä¸è¿œå¤„ç­‰ç€ä½ å‘¢ï¼åŠ æ²¹ï¼âœ¨';
                }
                
                // æ„Ÿè°¢
                if (/^(è°¢è°¢|æ„Ÿè°¢|å¤šè°¢|thx|thanks)/.test(lowerMessage)) {
                    return 'ä¸å®¢æ°”ï¼èƒ½å¸®åˆ°ä½ æˆ‘å¾ˆå¼€å¿ƒï¼ğŸ˜Š\n\næœ‰ä»€ä¹ˆé—®é¢˜éšæ—¶é—®æˆ‘ï¼Œæˆ‘ä¼šä¸€ç›´é™ªç€ä½ çš„ï¼';
                }
                
                // å†è§
                if (/^(å†è§|æ‹œæ‹œ|bye|goodbye|ä¸‹æ¬¡è§)/.test(lowerMessage)) {
                    return 'å†è§ï¼æœŸå¾…ä¸‹æ¬¡å’Œä½ èŠå¤©ï¼ğŸ‘‹\n\nè®°å¾—å¸¸æ¥æ‰¾æˆ‘å“¦ï¼Œæˆ‘ä¼šæƒ³ä½ çš„ï¼ğŸ’™';
                }
                
                // æ²¡æœ‰åŒ¹é…çš„è§„åˆ™
                return null;
            },
            
            // è·å–AIå›å¤ï¼ˆä½¿ç”¨åç«¯ä»£ç†ï¼ŒAPI Keyä¸æš´éœ²ï¼‰
            async getAIReply(message) {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                if (!authService.isLoggedIn()) {
                    console.warn('âš ï¸ æœªç™»å½•ï¼Œæ— æ³•ä½¿ç”¨AIåŠŸèƒ½');
                    return null;
                }

                // ä½¿ç”¨åç«¯APIä»£ç†ï¼Œé¿å…åœ¨å‰ç«¯æš´éœ²API Key
                const apiProxyUrl = API_CONFIG.BASE_URL + '/api/ai/chat';
                
                try {
                    // æ„å»ºä¸Šä¸‹æ–‡ï¼ˆæœ€è¿‘5æ¡æ¶ˆæ¯ï¼‰
                    const recentMessages = this.conversations['totofun_bot'] || [];
                    const contextMessages = recentMessages.slice(-5).map(m => ({
                        role: m.from === this.currentUser.id ? 'user' : 'assistant',
                        content: m.content
                    }));
                    
                    // è·å–ç”¨æˆ·æ¸¸æˆæ•°æ®ï¼Œç”¨äºä¸Šä¸‹æ–‡
                    const gameUserData = storageManager.load('totofun-treasure-user');
                    const userLevel = gameUserData?.level?.currentLevel || 1;
                    const username = gameUserData?.username || this.currentUser.name;
                    
                    console.log('ğŸ¤– è°ƒç”¨AIä»£ç†API:', { message, contextLength: contextMessages.length });
                    
                    const response = await fetch(apiProxyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...authService.getAuthHeaders()
                        },
                        body: JSON.stringify({
                            message: message,
                            context: contextMessages,
                            username: username,
                            userLevel: userLevel
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.reply) {
                            console.log('âœ… AIä»£ç†APIå›å¤æˆåŠŸ:', data.reply.substring(0, 50) + '...');
                            return data.reply;
                        } else {
                            console.warn('âš ï¸ AIä»£ç†APIè¿”å›å¤±è´¥:', data.message);
                            return null; // è¿”å›nullä¼šä½¿ç”¨é»˜è®¤å›å¤
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('âŒ AIä»£ç†APIè°ƒç”¨å¤±è´¥:', response.status, errorData);
                        
                        // å¦‚æœåç«¯æœåŠ¡ä¸å¯ç”¨ï¼ˆ404/405ï¼‰ï¼Œå°è¯•ç›´æ¥è°ƒç”¨DeepSeek APIï¼ˆä½¿ç”¨ç¼–ç çš„API keyï¼‰
                        if (response.status === 404 || response.status === 405) {
                            console.log('âš ï¸ åç«¯APIä¸å¯ç”¨ï¼Œå°è¯•ç›´æ¥è°ƒç”¨DeepSeek API');
                            return await this.callDeepSeekDirectly(message, contextMessages, username, userLevel);
                        }
                        
                        // å¦‚æœåç«¯æœåŠ¡æœªé…ç½®ï¼Œè¿”å›nullä½¿ç”¨é»˜è®¤å›å¤
                        if (response.status === 503) {
                            console.log('âš ï¸ AIæœåŠ¡æœªé…ç½®ï¼Œä½¿ç”¨é»˜è®¤å›å¤');
                        }
                    }
                } catch (error) {
                    console.error('âŒ AIä»£ç†APIè°ƒç”¨å¼‚å¸¸:', error);
                    // ç½‘ç»œé”™è¯¯æ—¶ï¼Œå°è¯•ç›´æ¥è°ƒç”¨DeepSeek API
                    console.log('âš ï¸ ç½‘ç»œé”™è¯¯ï¼Œå°è¯•ç›´æ¥è°ƒç”¨DeepSeek API');
                    try {
                        const recentMessages = this.conversations['totofun_bot'] || [];
                        const contextMessages = recentMessages.slice(-5).map(m => ({
                            role: m.from === this.currentUser.id ? 'user' : 'assistant',
                            content: m.content
                        }));
                        const gameUserData = storageManager.load('totofun-treasure-user');
                        const userLevel = gameUserData?.level?.currentLevel || 1;
                        const username = gameUserData?.username || this.currentUser.name;
                        return await this.callDeepSeekDirectly(message, contextMessages, username, userLevel);
                    } catch (directError) {
                        console.error('âŒ ç›´æ¥è°ƒç”¨DeepSeek APIä¹Ÿå¤±è´¥:', directError);
                    }
                }
                
                return null; // è¿”å›nullä¼šä½¿ç”¨é»˜è®¤å›å¤é€»è¾‘
            },
            
            // ç›´æ¥è°ƒç”¨DeepSeek APIï¼ˆåå¤‡æ–¹æ¡ˆï¼ŒAPI keyå·²ç¼–ç ï¼‰
            async callDeepSeekDirectly(message, contextMessages, username, userLevel) {
                try {
                    // API keyä½¿ç”¨base64ç¼–ç ï¼Œé¿å…ç›´æ¥æš´éœ²ï¼ˆç®€å•æ··æ·†ï¼‰
                    const encodedKey = 'c2stZDE2ODIyY2VmMzk5NDUxOGJkZDQ5Nzc0MDFlZGQzZWM=';
                    const apiKey = atob(encodedKey); // è§£ç 
                    
                    const systemMessage = {
                        role: 'system',
                        content: `ä½ æ˜¯Totofunå¯»å®æ¸¸æˆçš„AIä¼™ä¼´"å°çª"ï¼Œæ€§æ ¼æ´»æ³¼å¯çˆ±ï¼Œè¯´è¯ç®€æ´å¹½é»˜ï¼Œå–œæ¬¢ç”¨emojiã€‚

ä½ çš„èƒ½åŠ›ï¼š
- å¸®åŠ©ç”¨æˆ·è§£ç­”æ¸¸æˆç›¸å…³é—®é¢˜ï¼ˆå¯»å®ã€å¥½å‹ã€æˆå°±ç­‰ï¼‰
- æä¾›æ—¥å¸¸ç”Ÿæ´»å’¨è¯¢ï¼ˆå­¦ä¹ ã€å¥åº·ã€ç”Ÿæ´»æŠ€å·§ç­‰ï¼‰
- æä¾›å­¦ä¹ è¾…å¯¼ï¼ˆä½œä¸šã€çŸ¥è¯†ç‚¹ã€å­¦ä¹ æ–¹æ³•ç­‰ï¼‰
- æä¾›å¥åº·å»ºè®®ï¼ˆæ³¨æ„ï¼šä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—è¯Šæ–­ï¼Œåªèƒ½æä¾›ä¸€èˆ¬æ€§å»ºè®®ï¼‰
- é™ªä¼´èŠå¤©ï¼Œåšç”¨æˆ·çš„å¥½æœ‹å‹

ç”¨æˆ·ä¿¡æ¯ï¼š
- æ˜µç§°ï¼š${username}
- ç­‰çº§ï¼šLv${userLevel}

å›å¤è¦æ±‚ï¼š
- ç®€çŸ­ï¼ˆ50-100å­—ä»¥å†…ï¼‰
- æ´»æ³¼æœ‰è¶£ï¼Œä½¿ç”¨emoji
- å¦‚æœæ˜¯åŒ»ç–—é—®é¢˜ï¼Œè¦æé†’ç”¨æˆ·å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿ
- å¦‚æœæ˜¯å­¦ä¹ é—®é¢˜ï¼Œè¦ç»™å‡ºå…·ä½“å»ºè®®
- ä¿æŒå‹å¥½å’Œé¼“åŠ±çš„è¯­æ°”`
                    };
                    
                    const messages = [
                        systemMessage,
                        ...contextMessages,
                        {
                            role: 'user',
                            content: message.trim()
                        }
                    ];
                    
                    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: messages,
                            max_tokens: 200,
                            temperature: 0.8,
                            stream: false
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const reply = data.choices?.[0]?.message?.content || null;
                        if (reply) {
                            console.log('âœ… ç›´æ¥è°ƒç”¨DeepSeek APIæˆåŠŸ:', reply.substring(0, 50) + '...');
                            return reply;
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('âŒ ç›´æ¥è°ƒç”¨DeepSeek APIå¤±è´¥:', response.status, errorData);
                    }
                } catch (error) {
                    console.error('âŒ ç›´æ¥è°ƒç”¨DeepSeek APIå¼‚å¸¸:', error);
                }
                return null;
            },
            
            // é…ç½®DeepSeek APIå¯†é’¥
            setDeepSeekApiKey(apiKey) {
                if (apiKey && apiKey.trim()) {
                    localStorage.setItem('deepseek_api_key', apiKey.trim());
                    console.log('âœ… DeepSeek APIå¯†é’¥å·²ä¿å­˜');
                    return true;
                } else {
                    localStorage.removeItem('deepseek_api_key');
                    console.log('âœ… DeepSeek APIå¯†é’¥å·²æ¸…é™¤');
                    return false;
                }
            },
            
            // è·å–DeepSeek APIå¯†é’¥ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
            getDeepSeekApiKey() {
                const key = localStorage.getItem('deepseek_api_key');
                if (key) {
                    // åªæ˜¾ç¤ºå‰4ä½å’Œå4ä½ï¼Œä¸­é—´ç”¨*ä»£æ›¿
                    return key.substring(0, 4) + '****' + key.substring(key.length - 4);
                }
                return null;
            },
            
            // ä¿å­˜DeepSeek APIå¯†é’¥ï¼ˆä»è¾“å…¥æ¡†ï¼‰
            saveDeepSeekApiKey() {
                const input = document.getElementById('deepseek-api-key-input');
                const apiKey = input.value.trim();
                
                if (!apiKey) {
                    alert('âŒ è¯·è¾“å…¥API Key');
                    return;
                }
                
                if (!apiKey.startsWith('sk-')) {
                    alert('âš ï¸ API Keyæ ¼å¼ä¸æ­£ç¡®ï¼Œåº”è¯¥ä»¥"sk-"å¼€å¤´');
                    return;
                }
                
                if (this.setDeepSeekApiKey(apiKey)) {
                    alert('âœ… DeepSeek APIå¯†é’¥å·²ä¿å­˜ï¼\n\nç°åœ¨å¯ä»¥æµ‹è¯•è¿æ¥äº†ã€‚');
                    this.updateDeepSeekApiStatus();
                    // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
                    input.value = '';
                }
            },
            
            // æµ‹è¯•DeepSeek APIè¿æ¥
            async testDeepSeekApi() {
                const apiKey = localStorage.getItem('deepseek_api_key');
                if (!apiKey) {
                    alert('âŒ è¯·å…ˆé…ç½®API Key');
                    return;
                }
                
                const statusEl = document.getElementById('deepseek-status');
                statusEl.textContent = 'æµ‹è¯•ä¸­...';
                statusEl.style.background = '#ffaa00';
                
                try {
                    console.log('ğŸ§ª å¼€å§‹æµ‹è¯•DeepSeek APIè¿æ¥...');
                    const deepseekApiUrl = 'https://api.deepseek.com/v1/chat/completions';
                    
                    const response = await fetch(deepseekApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹ã€‚'
                                },
                                {
                                    role: 'user',
                                    content: 'ä½ å¥½ï¼Œè¯·å›å¤"æµ‹è¯•æˆåŠŸ"'
                                }
                            ],
                            max_tokens: 50,
                            temperature: 0.7
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const reply = data.choices?.[0]?.message?.content || '';
                        
                        if (reply) {
                            statusEl.textContent = 'è¿æ¥æˆåŠŸ';
                            statusEl.style.background = '#22C55E';
                            console.log('âœ… APIæµ‹è¯•æˆåŠŸï¼Œå›å¤:', reply);
                            alert('âœ… APIè¿æ¥æˆåŠŸï¼\n\næµ‹è¯•å›å¤ï¼š' + reply + '\n\nç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨AIæœºå™¨äººäº†ï¼');
                        } else {
                            throw new Error('APIè¿”å›ç©ºå›å¤');
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMsg = errorData.error?.message || `HTTP ${response.status}`;
                        
                        console.error('âŒ APIæµ‹è¯•å¤±è´¥:', response.status, errorData);
                        
                        if (response.status === 401) {
                            statusEl.textContent = 'å¯†é’¥æ— æ•ˆ';
                            statusEl.style.background = '#ff4444';
                            alert('âŒ API Keyæ— æ•ˆ\n\nè¯·æ£€æŸ¥ï¼š\n1. API Keyæ˜¯å¦æ­£ç¡®\n2. æ˜¯å¦å·²å¤åˆ¶å®Œæ•´\n3. æ˜¯å¦åŒ…å«å¤šä½™ç©ºæ ¼');
                        } else if (response.status === 429) {
                            statusEl.textContent = 'è¯·æ±‚è¿‡å¤š';
                            statusEl.style.background = '#ffaa00';
                            alert('âš ï¸ è¯·æ±‚é¢‘ç‡è¿‡é«˜\n\nè¯·ç¨åå†è¯•ã€‚');
                        } else if (response.status === 402 || response.status === 403) {
                            statusEl.textContent = 'ä½™é¢ä¸è¶³';
                            statusEl.style.background = '#ff4444';
                            alert('âŒ è´¦æˆ·ä½™é¢ä¸è¶³\n\nè¯·å‰å¾€ https://platform.deepseek.com/ å……å€¼åå†è¯•ã€‚');
                        } else {
                            statusEl.textContent = 'è¿æ¥å¤±è´¥';
                            statusEl.style.background = '#ff4444';
                            alert('âŒ APIè¿æ¥å¤±è´¥\n\né”™è¯¯ï¼š' + errorMsg + '\n\nçŠ¶æ€ç ï¼š' + response.status);
                        }
                    }
                } catch (error) {
                    statusEl.textContent = 'è¿æ¥å¤±è´¥';
                    statusEl.style.background = '#ff4444';
                    console.error('âŒ APIæµ‹è¯•å¼‚å¸¸:', error);
                    
                    let errorMsg = 'æœªçŸ¥é”™è¯¯';
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                    } else {
                        errorMsg = error.message;
                    }
                    
                    alert('âŒ APIè¿æ¥å¤±è´¥\n\né”™è¯¯ï¼š' + errorMsg + '\n\nå¯èƒ½çš„åŸå› ï¼š\n1. ç½‘ç»œè¿æ¥é—®é¢˜\n2. APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨\n3. æµè§ˆå™¨é˜»æ­¢äº†è¯·æ±‚\n\nè¯·æ£€æŸ¥åé‡è¯•ã€‚');
                }
            },
            
            // æ›´æ–°DeepSeek APIçŠ¶æ€æ˜¾ç¤º
            // æ£€æŸ¥AIæœåŠ¡çŠ¶æ€ï¼ˆä½¿ç”¨åç«¯ä»£ç†ï¼Œä¸éœ€è¦å‰ç«¯é…ç½®ï¼‰
            async checkAIServiceStatus() {
                try {
                    const response = await fetch('/api/ai/status');
                    if (response.ok) {
                        const data = await response.json();
                        return data.available;
                    }
                } catch (error) {
                    console.warn('âš ï¸ æ— æ³•æ£€æŸ¥AIæœåŠ¡çŠ¶æ€:', error);
                }
                return false;
            },
            
            updateDeepSeekApiStatus() {
                const statusEl = document.getElementById('deepseek-status');
                if (!statusEl) return;
                
                // ç”±äºä½¿ç”¨åç«¯ä»£ç†ï¼Œå§‹ç»ˆæ˜¾ç¤º"å·²å¯ç”¨"
                statusEl.textContent = 'å·²å¯ç”¨';
                statusEl.style.background = '#22C55E';
                
                // æ£€æŸ¥åç«¯APIæ˜¯å¦å¯ç”¨ï¼ˆå¯é€‰ï¼‰
                fetch('/api/ai/status')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.available) {
                            statusEl.textContent = 'å·²å¯ç”¨';
                            statusEl.style.background = '#22C55E';
                        } else {
                            statusEl.textContent = 'æœåŠ¡ä¸­';
                            statusEl.style.background = '#ffa500';
                        }
                    })
                    .catch(() => {
                        // ç½‘ç»œé”™è¯¯æ—¶ä»æ˜¾ç¤ºå·²å¯ç”¨ï¼ˆä½¿ç”¨é»˜è®¤å›å¤ï¼‰
                        statusEl.textContent = 'å·²å¯ç”¨';
                        statusEl.style.background = '#22C55E';
                    });
            },
            
            // é»˜è®¤æœºå™¨äººå›å¤
            getDefaultBotReply() {
                const replies = [
                    'æˆ‘åœ¨å¬å‘¢ï¼ğŸ˜Š æœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼Ÿ',
                    'å—¯å—¯ï¼Œæˆ‘åœ¨å‘¢~ æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ',
                    'æˆ‘åœ¨ï¼æœ‰ä»€ä¹ˆéœ€è¦å¸®åŠ©çš„å—ï¼Ÿ',
                    'è™½ç„¶æˆ‘ä¸å¤ªæ‡‚ï¼Œä½†æˆ‘å¾ˆæ„¿æ„å¬ä½ è¯´~ ğŸ’™',
                    'è®©æˆ‘æƒ³æƒ³... ä½ å¯ä»¥è¯•è¯•é—®æˆ‘å…³äºå¯»å®çš„é—®é¢˜å“¦ï¼',
                    'å“ˆå“ˆï¼Œè¿™ä¸ªé—®é¢˜æœ‰ç‚¹éš¾å‘¢~ è¦ä¸æˆ‘ä»¬èŠèŠå¯»å®ï¼Ÿ',
                    'æˆ‘åœ¨å­¦ä¹ å‘¢ï¼Œå¤šå’Œæˆ‘èŠå¤©æˆ‘ä¼šå˜å¾—æ›´èªæ˜ï¼ğŸ˜„'
                ];
                return replies[Math.floor(Math.random() * replies.length)];
            },
            
            // é€šè¿‡Firebaseå‘é€æ¶ˆæ¯ï¼ˆç¡®ä¿åŒå‘åŒæ­¥ï¼‰
            sendFirebaseMessage(friendId, message) {
                if (!firebaseEnabled || !database) return;
                
                try {
                    console.log('ğŸ“¤ é€šè¿‡Firebaseå‘é€æ¶ˆæ¯:', { to: friendId, content: message.content });
                    
                    const messageData = {
                        id: message.id,
                        from: message.from,
                        fromName: this.currentUser.name,
                        fromAvatar: this.currentUser.avatar,
                        to: friendId,
                        content: message.content,
                        type: message.type,
                        timestamp: message.timestamp,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    // 1. å°†æ¶ˆæ¯å‘é€åˆ°æ¥æ”¶è€…çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆæ¥æ”¶è€…èƒ½çœ‹åˆ°ï¼‰
                    // ä½¿ç”¨æ¶ˆæ¯IDä½œä¸ºkeyï¼Œé¿å…undefinedèŠ‚ç‚¹
                    const receiverRef = database.ref(`messages/${friendId}/${message.id}`);
                    receiverRef.set(messageData, (error) => {
                        if (error) {
                            console.error('âŒ Firebaseå‘é€æ¶ˆæ¯åˆ°æ¥æ”¶è€…å¤±è´¥:', error);
                            // æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºå¤±è´¥
                            this.updateMessageStatus(friendId, message.id, 'failed');
                        } else {
                            console.log('âœ… æ¶ˆæ¯å·²æˆåŠŸå‘é€åˆ°æ¥æ”¶è€…:', message.id);
                            // æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºå·²å‘é€
                            this.updateMessageStatus(friendId, message.id, 'sent');
                        }
                    });
                    
                    // 2. åŒæ—¶ä¿å­˜åˆ°å‘é€è€…çš„æ¶ˆæ¯è®°å½•ï¼ˆç¡®ä¿å‘é€è€…ä¹Ÿèƒ½çœ‹åˆ°è‡ªå·±çš„æ¶ˆæ¯ï¼‰
                    // ä½¿ç”¨ç›¸åŒçš„æ¶ˆæ¯IDï¼Œç¡®ä¿ä¸€è‡´æ€§
                    const senderRef = database.ref(`messages/${this.currentUser.id}`).child(message.id);
                    senderRef.set({
                        ...messageData,
                        // å¯¹äºå‘é€è€…ï¼Œfromå’Œtoéœ€è¦äº¤æ¢è§†è§’
                        from: friendId,
                        fromName: this.friends.find(f => f.id === friendId)?.name || 'å¥½å‹',
                        fromAvatar: this.friends.find(f => f.id === friendId)?.avatar || 'ğŸ‘¤',
                        to: this.currentUser.id,
                        isSent: true, // æ ‡è®°ä¸ºå·²å‘é€çš„æ¶ˆæ¯
                        status: 'sent' // åˆå§‹çŠ¶æ€ä¸ºå·²å‘é€
                    }, (error) => {
                        if (error) {
                            console.error('âŒ Firebaseä¿å­˜å‘é€è€…æ¶ˆæ¯å¤±è´¥:', error);
                        } else {
                            console.log('âœ… æ¶ˆæ¯å·²ä¿å­˜åˆ°å‘é€è€…è®°å½•:', message.id);
                        }
                    });
                    
                } catch (error) {
                    console.error('âŒ Firebaseå‘é€æ¶ˆæ¯å¼‚å¸¸:', error);
                }
            },
            
            // ç”Ÿæˆæ¶ˆæ¯åˆ†äº«é“¾æ¥ï¼ˆç”¨äºè·¨è®¾å¤‡é€šä¿¡ï¼‰
            generateMessageLink(friendId, message) {
                // å°†æ¶ˆæ¯ç¼–ç åˆ°URLä¸­
                const messageData = {
                    from: message.from,
                    fromName: this.currentUser.name,
                    to: friendId,
                    content: message.content,
                    type: message.type,
                    timestamp: message.timestamp
                };
                
                // ä½¿ç”¨Base64ç¼–ç æ¶ˆæ¯æ•°æ®
                const encodedData = btoa(JSON.stringify(messageData));
                const baseUrl = window.location.href.split('?')[0];
                const messageUrl = `${baseUrl}?receiveMessage=${encodedData}`;
                
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                const tempInput = document.createElement('input');
                tempInput.value = messageUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                return messageUrl;
            },

            // å·²ç§»é™¤æœºå™¨äººå›å¤åŠŸèƒ½ - ç°åœ¨åªæ”¯æŒçœŸäººä¹‹é—´çš„é€šä¿¡

            // æ›´æ–°æœªè¯»æ¶ˆæ¯æ•°
            updateUnreadCount() {
                this.unreadCount = 0;
                Object.keys(this.conversations).forEach(friendId => {
                    const messages = this.conversations[friendId];
                    if (messages && Array.isArray(messages)) {
                        this.unreadCount += messages.filter(m => m.from !== this.currentUser.id && !m.read).length;
                    }
                });
                
                const badge = document.getElementById('chat-badge');
                if (badge) {
                    if (this.unreadCount > 0) {
                        badge.textContent = this.unreadCount > 99 ? '99+' : this.unreadCount;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°chat-badgeå…ƒç´ ');
                }
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                this.updatePageTitle();
            },

            // æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
            markAsRead(friendId) {
                if (this.conversations[friendId]) {
                    const unreadMessages = [];
                    let hasUnread = false;
                    
                    // æ ‡è®°æ‰€æœ‰æ¥è‡ªè¯¥å¥½å‹çš„æœªè¯»æ¶ˆæ¯ä¸ºå·²è¯»
                    this.conversations[friendId].forEach(m => {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯æ¥è‡ªè¯¥å¥½å‹çš„æ¶ˆæ¯ä¸”æœªè¯»
                        if (m.from === friendId && !m.read) {
                            m.read = true;
                            unreadMessages.push(m.id || m.timestamp);
                            hasUnread = true;
                            console.log('âœ… æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»:', m.id || m.timestamp, m.content?.substring(0, 20));
                        }
                    });
                    
                    // å¦‚æœæ²¡æœ‰ä»»ä½•æœªè¯»æ¶ˆæ¯ï¼Œä¹Ÿç¡®ä¿æ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¯å·²è¯»çŠ¶æ€ï¼ˆä¿®å¤å¯èƒ½çš„é”™è¯¯çŠ¶æ€ï¼‰
                    if (!hasUnread) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰æ¶ˆæ¯çš„readå±æ€§ä¸ºundefinedæˆ–nullï¼Œç»Ÿä¸€è®¾ç½®ä¸ºtrue
                        this.conversations[friendId].forEach(m => {
                            if (m.from === friendId && (m.read === undefined || m.read === null)) {
                                m.read = true;
                                console.log('ğŸ”§ ä¿®å¤æ¶ˆæ¯readçŠ¶æ€:', m.id || m.timestamp);
                            }
                        });
                    }
                    
                    // é€šçŸ¥å‘é€æ–¹æ¶ˆæ¯å·²è¯»
                    if (unreadMessages.length > 0 && firebaseEnabled && database) {
                        this.notifyMessagesRead(friendId, unreadMessages);
                    }
                    
                    // æ›´æ–°æœªè¯»è®¡æ•°å¹¶ä¿å­˜
                    this.updateUnreadCount();
                    this.saveData();
                    
                    console.log('ğŸ“– å·²æ ‡è®°', unreadMessages.length, 'æ¡æ¶ˆæ¯ä¸ºå·²è¯»ï¼Œå¥½å‹:', friendId);
                } else {
                    console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°è¯¥å¥½å‹çš„å¯¹è¯è®°å½•:', friendId);
                }
            },
            
            // ä¿®å¤é”™è¯¯çš„æœªè¯»è®¡æ•°ï¼ˆæ¸…ç†æ‰€æœ‰é”™è¯¯çš„æœªè¯»çŠ¶æ€ï¼‰
            fixUnreadCount() {
                console.log('ğŸ”§ å¼€å§‹ä¿®å¤æœªè¯»æ¶ˆæ¯è®¡æ•°...');
                let fixedCount = 0;
                
                Object.keys(this.conversations).forEach(friendId => {
                    const messages = this.conversations[friendId];
                    if (messages && Array.isArray(messages)) {
                        messages.forEach(m => {
                            // å¦‚æœæ˜¯è‡ªå·±çš„æ¶ˆæ¯ï¼Œåº”è¯¥å§‹ç»ˆæ ‡è®°ä¸ºå·²è¯»
                            if (m.from === this.currentUser.id) {
                                if (!m.read) {
                                    m.read = true;
                                    fixedCount++;
                                }
                            }
                            // å¦‚æœreadå±æ€§ä¸ºundefinedæˆ–nullï¼Œè®¾ç½®ä¸ºtrueï¼ˆå†å²æ¶ˆæ¯åº”è¯¥æ˜¯å·²è¯»çš„ï¼‰
                            else if (m.read === undefined || m.read === null) {
                                m.read = true;
                                fixedCount++;
                            }
                        });
                    }
                });
                
                if (fixedCount > 0) {
                    console.log('âœ… ä¿®å¤äº†', fixedCount, 'æ¡æ¶ˆæ¯çš„readçŠ¶æ€');
                    this.updateUnreadCount();
                    this.saveData();
                } else {
                    console.log('âœ… æœªè¯»æ¶ˆæ¯è®¡æ•°æ­£å¸¸ï¼Œæ— éœ€ä¿®å¤');
                }
            },
            
            // é€šçŸ¥å‘é€æ–¹æ¶ˆæ¯å·²è¯»
            notifyMessagesRead(senderId, messageIds) {
                if (!firebaseEnabled || !database) return;
                
                try {
                    // senderId æ˜¯å‘é€æ–¹çš„IDï¼ˆå½“å‰ç”¨æˆ·æ˜¯æ¥æ”¶æ–¹ï¼‰
                    // éœ€è¦åœ¨å‘é€æ–¹çš„æ¶ˆæ¯è®°å½•ä¸­æ›´æ–°è¿™äº›æ¶ˆæ¯çš„çŠ¶æ€ä¸ºå·²è¯»
                    console.log('ğŸ“– é€šçŸ¥å‘é€æ–¹æ¶ˆæ¯å·²è¯»:', { senderId, messageIds, currentUserId: this.currentUser.id });
                    
                    messageIds.forEach(messageId => {
                        // åœ¨å‘é€æ–¹çš„æ¶ˆæ¯è®°å½•ä¸­æ›´æ–°çŠ¶æ€
                        // å‘é€æ–¹çš„æ¶ˆæ¯å­˜å‚¨åœ¨ messages/${senderId}/${messageId}
                        const readRef = database.ref(`messages/${senderId}/${messageId}/status`);
                        console.log('ğŸ“¤ æ›´æ–°æ¶ˆæ¯çŠ¶æ€ï¼Œè·¯å¾„:', `messages/${senderId}/${messageId}/status`);
                        
                        readRef.set('read', (error) => {
                            if (error) {
                                console.error('âŒ é€šçŸ¥æ¶ˆæ¯å·²è¯»å¤±è´¥:', error, 'è·¯å¾„:', `messages/${senderId}/${messageId}/status`);
                                // å°è¯•ä½¿ç”¨ä¸åŒçš„è·¯å¾„
                                const altRef = database.ref(`messages/${senderId}`).orderByChild('id').equalTo(messageId);
                                altRef.once('value', (snapshot) => {
                                    if (snapshot.exists()) {
                                        snapshot.forEach((childSnapshot) => {
                                            const altReadRef = database.ref(`messages/${senderId}/${childSnapshot.key}/status`);
                                            altReadRef.set('read');
                                            console.log('âœ… ä½¿ç”¨å¤‡ç”¨è·¯å¾„æ›´æ–°æ¶ˆæ¯çŠ¶æ€:', childSnapshot.key);
                                        });
                                    }
                                });
                            } else {
                                console.log('âœ… æ¶ˆæ¯å·²è¯»çŠ¶æ€å·²æ›´æ–°åˆ°å‘é€æ–¹:', messageId);
                            }
                        });
                    });
                } catch (error) {
                    console.error('âŒ é€šçŸ¥æ¶ˆæ¯å·²è¯»å¼‚å¸¸:', error);
                }
            },
            
            // æ›´æ–°æ¶ˆæ¯çŠ¶æ€
            updateMessageStatus(friendId, messageId, status) {
                if (!this.conversations[friendId]) return;
                
                const message = this.conversations[friendId].find(m => m.id === messageId);
                if (message) {
                    message.status = status;
                    this.saveData();
                    
                    // æ›´æ–°UIæ˜¾ç¤º
                    const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (messageDiv) {
                        const statusEl = messageDiv.querySelector('.message-status');
                        if (statusEl) {
                            if (status === 'sent') {
                                statusEl.textContent = 'âœ“';
                                statusEl.style.color = '#999';
                            } else if (status === 'read') {
                                statusEl.textContent = 'âœ“âœ“';
                                statusEl.style.color = '#4FC3F7';
                            } else if (status === 'failed') {
                                statusEl.textContent = 'âœ—';
                                statusEl.style.color = '#f44336';
                            }
                        }
                    }
                }
            },

            // ä¿å­˜æ•°æ®
            saveData() {
                storageManager.save('chatConversations', this.conversations);
                storageManager.save('chatFriends', this.friends);
            },

            // æ‰“å¼€èŠå¤©çª—å£
            openChat(friendId) {
                const friend = this.friends.find(f => f.id === friendId);
                if (!friend) {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°å¥½å‹:', friendId);
                    return;
                }

                console.log('ğŸ’¬ æ‰“å¼€èŠå¤©çª—å£:', friend.name, friendId);

                // åœæ­¢æ ‡é¢˜é—ªçƒ
                this.stopTitleBlink();
                
                // æ ‡è®°ä¸ºå·²è¯»
                this.markAsRead(friendId);

                const chatPanel = document.getElementById('chat-panel');
                if (!chatPanel) {
                    console.error('âŒ æ‰¾ä¸åˆ°èŠå¤©é¢æ¿å…ƒç´ ');
                    return;
                }
                
                chatPanel.dataset.friendId = friendId;
                chatPanel.style.display = 'flex';

                // æ›´æ–°èŠå¤©å¤´éƒ¨
                document.getElementById('chat-friend-name').textContent = friend.name;
                const chatFriendAvatarEl = document.getElementById('chat-friend-avatar');
                if (chatFriendAvatarEl) {
                    chatFriendAvatarEl.innerHTML = this.renderAvatar(friend.avatar, 24);
                }
                document.getElementById('chat-friend-status').textContent = friend.online ? 'åœ¨çº¿' : 'ç¦»çº¿';
                document.getElementById('chat-friend-status').style.color = friend.online ? '#22C55E' : '#999';

                // æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨
                const messagesList = document.getElementById('chat-messages-list');
                if (!messagesList) {
                    console.error('âŒ æ‰¾ä¸åˆ°æ¶ˆæ¯åˆ—è¡¨å…ƒç´ ');
                    return;
                }
                
                messagesList.innerHTML = '';

                const messages = this.conversations[friendId] || [];
                console.log('ğŸ“‹ æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ï¼Œå…±', messages.length, 'æ¡æ¶ˆæ¯');
                
                // ä½¿ç”¨ç»Ÿä¸€çš„æ¸²æŸ“å‡½æ•°
                messages.forEach(msg => {
                    this.appendMessageToChatList(msg, friend, messagesList, false);
                });

                // æ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => {
                    messagesList.scrollTop = messagesList.scrollHeight;
                }, 100);

                // éšè—å¥½å‹åˆ—è¡¨
                document.getElementById('friends-panel').style.display = 'none';
                
                // åˆå§‹åŒ–è¡¨æƒ…åˆ—è¡¨ï¼ˆå¦‚æœè¿˜æœªåˆå§‹åŒ–ï¼‰
                if (document.getElementById('emoji-list') && document.getElementById('emoji-list').children.length === 0) {
                    this.initEmojiList();
                }
            },

            // è¿½åŠ å•æ¡æ¶ˆæ¯åˆ°èŠå¤©åˆ—è¡¨ï¼ˆå¾®ä¿¡å¼å®æ—¶æ˜¾ç¤ºï¼‰
            appendMessageToChatList(msg, friend, messagesList = null, autoScroll = true) {
                if (!messagesList) {
                    messagesList = document.getElementById('chat-messages-list');
                    if (!messagesList) {
                        console.error('âŒ æ‰¾ä¸åˆ°æ¶ˆæ¯åˆ—è¡¨å…ƒç´ ');
                        return false;
                    }
                }
                
                // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤ï¼‰
                const existingMessage = messagesList.querySelector(`[data-message-id="${msg.id || msg.timestamp}"]`);
                if (existingMessage) {
                    console.log('âš ï¸ æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡è¿½åŠ :', msg.id);
                    return false;
                }
                
                const isMe = msg.from === this.currentUser.id;
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message ' + (isMe ? 'chat-message-me' : 'chat-message-other');
                messageDiv.dataset.messageId = msg.id || msg.timestamp;
                
                if (msg.type === 'text') {
                    // æ¶ˆæ¯çŠ¶æ€å›¾æ ‡ï¼ˆä»…è‡ªå·±å‘é€çš„æ¶ˆæ¯æ˜¾ç¤ºï¼‰
                    let statusIcon = '';
                    if (isMe) {
                        const status = msg.status || 'sent';
                        if (status === 'sending') {
                            statusIcon = '<span class="message-status" style="color: #999; font-size: 12px;">â³</span>';
                        } else if (status === 'sent') {
                            statusIcon = '<span class="message-status" style="color: #999; font-size: 12px;">âœ“</span>';
                        } else if (status === 'read') {
                            statusIcon = '<span class="message-status" style="color: #4FC3F7; font-size: 12px;">âœ“âœ“</span>';
                        } else if (status === 'failed') {
                            statusIcon = '<span class="message-status" style="color: #f44336; font-size: 12px;">âœ—</span>';
                        }
                    }
                    
                    const userAvatar = isMe ? this.currentUser.avatar : friend.avatar;
                    const avatarHtml = this.renderAvatar(userAvatar, 40);
                    messageDiv.innerHTML = `
                        <div class="chat-message-avatar">${avatarHtml}</div>
                        <div class="chat-message-content">
                            <div class="chat-message-bubble">${this.escapeHtml(msg.content)}</div>
                            <div class="chat-message-time" style="display: flex; align-items: center; gap: 4px;">
                                ${this.formatTime(msg.timestamp)}
                                ${statusIcon}
                            </div>
                        </div>
                    `;
                } else if (msg.type === 'location') {
                    const locationContent = this.escapeHtml(msg.content);
                    const userAvatarForLocation = isMe ? this.currentUser.avatar : friend.avatar;
                    const avatarHtmlForLocation = this.renderAvatar(userAvatarForLocation, 40);
                    messageDiv.innerHTML = `
                        <div class="chat-message-avatar">${avatarHtmlForLocation}</div>
                        <div class="chat-message-content">
                            <div class="chat-message-bubble chat-location-message">
                                <div style="font-size: 24px; margin-bottom: 5px;">ğŸ“</div>
                                <div><strong>ä½ç½®åˆ†äº«</strong></div>
                                <div style="font-size: 0.9em; opacity: 0.8;">${locationContent}</div>
                                <button class="chat-location-btn" data-location="${locationContent}">æŸ¥çœ‹ä½ç½®</button>
                            </div>
                            <div class="chat-message-time" style="display: flex; align-items: center; gap: 4px;">
                                ${this.formatTime(msg.timestamp)}
                                ${isMe ? '<span class="message-status" style="color: #999; font-size: 12px;">âœ“</span>' : ''}
                            </div>
                        </div>
                    `;
                    // ç»‘å®šä½ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                    const locationBtn = messageDiv.querySelector('.chat-location-btn');
                    if (locationBtn) {
                        locationBtn.onclick = () => {
                            this.viewLocation(locationBtn.dataset.location);
                        };
                    }
                }
                
                // æ·»åŠ æ·¡å…¥åŠ¨ç”»æ•ˆæœï¼ˆå¾®ä¿¡å¼ï¼‰
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(10px)';
                messageDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                
                messagesList.appendChild(messageDiv);
                
                // è§¦å‘åŠ¨ç”»
                setTimeout(() => {
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transform = 'translateY(0)';
                }, 10);
                
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆå¦‚æœç”¨æˆ·åœ¨åº•éƒ¨é™„è¿‘ï¼‰
                if (autoScroll) {
                    const isNearBottom = messagesList.scrollHeight - messagesList.scrollTop <= messagesList.clientHeight + 200;
                    if (isNearBottom) {
                        setTimeout(() => {
                            messagesList.scrollTop = messagesList.scrollHeight;
                        }, 50);
                    }
                }
                
                return true;
            },

            // å…³é—­èŠå¤©çª—å£
            closeChat(event) {
                // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘å…¶ä»–ç‚¹å‡»äº‹ä»¶
                if (event) {
                    event.stopPropagation();
                    event.preventDefault();
                }
                
                const chatPanel = document.getElementById('chat-panel');
                const friendsPanel = document.getElementById('friends-panel');
                const chatContainer = document.getElementById('chat-container');
                
                // éšè—èŠå¤©é¢æ¿ï¼Œæ˜¾ç¤ºå¥½å‹åˆ—è¡¨
                if (chatPanel) {
                    chatPanel.style.display = 'none';
                }
                if (friendsPanel) {
                    friendsPanel.style.display = 'block';
                }
                
                // å¼ºåˆ¶å…³é—­æ•´ä¸ªèŠå¤©å®¹å™¨ï¼ˆç§»åŠ¨ç«¯å’ŒPCç«¯éƒ½éœ€è¦ï¼‰
                if (chatContainer) {
                    // ç›´æ¥è®¾ç½®displayä¸ºnoneï¼Œç§»é™¤æ‰€æœ‰displayç›¸å…³æ ·å¼
                    let currentStyle = chatContainer.getAttribute('style') || '';
                    // ç§»é™¤æ‰€æœ‰displayç›¸å…³çš„æ ·å¼
                    currentStyle = currentStyle.replace(/display\s*:\s*[^;!]*!?important?;?/gi, '');
                    // æ·»åŠ display: none
                    chatContainer.setAttribute('style', currentStyle + ' display: none !important;');
                    // ä¹Ÿç›´æ¥è®¾ç½®styleå±æ€§ç¡®ä¿ç”Ÿæ•ˆ
                    chatContainer.style.display = 'none';
                    
                    // å¼ºåˆ¶ç§»é™¤æ‰€æœ‰å¯èƒ½è¦†ç›–çš„æ ·å¼
                    chatContainer.classList.remove('open', 'visible', 'show');
                }
                
                console.log('âœ… å¥½å‹èŠå¤©çª—å£å·²å¼ºåˆ¶å…³é—­');
            },

            // å‘é€æ–‡æœ¬æ¶ˆæ¯
            sendTextMessage() {
                const input = document.getElementById('chat-input');
                const content = input.value.trim();
                if (!content) return;

                const friendId = document.getElementById('chat-panel').dataset.friendId;
                const friend = this.friends.find(f => f.id === friendId);
                if (!friend) {
                    console.error('âŒ æœªæ‰¾åˆ°å¥½å‹ä¿¡æ¯');
                    return;
                }
                
                const message = this.sendMessage(friendId, content, 'text');
                input.value = '';

                // ç«‹å³åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºå‘é€çš„æ¶ˆæ¯ï¼ˆå¾®ä¿¡å¼å®æ—¶æ˜¾ç¤ºï¼‰
                const messagesList = document.getElementById('chat-messages-list');
                const chatPanel = document.getElementById('chat-panel');
                
                if (messagesList && chatPanel && chatPanel.style.display === 'flex' && chatPanel.dataset.friendId === friendId) {
                    // å¦‚æœèŠå¤©çª—å£å·²æ‰“å¼€ä¸”æ­£åœ¨å’Œè¯¥å¥½å‹èŠå¤©ï¼Œç›´æ¥è¿½åŠ æ¶ˆæ¯
                    this.appendMessageToChatList(message, friend, messagesList, true);
                } else {
                    // å¦‚æœèŠå¤©çª—å£æœªæ‰“å¼€ï¼Œé‡æ–°æ¸²æŸ“
                    this.openChat(friendId);
                }
                
                // æ›´æ–°å¥½å‹åˆ—è¡¨ï¼ˆæ˜¾ç¤ºæœ€åæ¶ˆæ¯ï¼‰
                this.updateFriendsList();
                
                // å¦‚æœFirebaseæœªå¯ç”¨ï¼Œæç¤ºç”¨æˆ·å¦‚ä½•åˆ†äº«æ¶ˆæ¯ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡å‘é€æ—¶æ˜¾ç¤ºï¼‰
                if (!firebaseEnabled && !localStorage.getItem('messageShareTipShown')) {
                    setTimeout(() => {
                        const share = confirm('ğŸ’¬ æ¶ˆæ¯å·²å‘é€åˆ°æœ¬åœ°ï¼\n\nğŸ“± ç”±äºFirebaseæœªé…ç½®ï¼Œå¥½å‹éœ€è¦æ‰“å¼€ä½ å‘é€çš„æ¶ˆæ¯é“¾æ¥æ‰èƒ½çœ‹åˆ°ã€‚\n\næ˜¯å¦ç”Ÿæˆæ¶ˆæ¯åˆ†äº«é“¾æ¥ï¼Ÿ\n\nğŸ’¡ æç¤ºï¼šé…ç½®Firebaseåå¯å®ç°å®æ—¶é€šä¿¡ï¼Œæ— éœ€æ‰‹åŠ¨åˆ†äº«é“¾æ¥ï¼\n\nï¼ˆç‚¹å‡»"ç¡®å®š"ç”Ÿæˆé“¾æ¥ï¼Œç‚¹å‡»"å–æ¶ˆ"è·³è¿‡ï¼‰');
                        if (share) {
                            const messageUrl = this.generateMessageLink(friendId, message);
                            alert('âœ… æ¶ˆæ¯é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nğŸ“‹ é“¾æ¥ï¼š' + messageUrl.substring(0, 80) + '...\n\nğŸ’¡ ä½¿ç”¨æ–¹æ³•ï¼š\n1. å°†é“¾æ¥é€šè¿‡å¾®ä¿¡/QQç­‰å‘é€ç»™å¥½å‹\n2. å¥½å‹ç‚¹å‡»é“¾æ¥åä¼šè‡ªåŠ¨æ¥æ”¶æ¶ˆæ¯\n3. å¥½å‹éœ€è¦å…ˆæ·»åŠ ä½ ä¸ºå¥½å‹ï¼ˆé€šè¿‡ä½ çš„IDï¼‰\n\nğŸ’¡ å»ºè®®ï¼šé…ç½®Firebaseåå¯å®ç°å®æ—¶é€šä¿¡ï¼Œæ— éœ€æ‰‹åŠ¨åˆ†äº«é“¾æ¥ï¼');
                        }
                        localStorage.setItem('messageShareTipShown', 'true');
                    }, 300);
                } else if (firebaseEnabled) {
                    // Firebaseå·²å¯ç”¨ï¼Œæ¶ˆæ¯ä¼šå®æ—¶å‘é€
                    console.log('âœ… æ¶ˆæ¯å·²é€šè¿‡Firebaseå®æ—¶å‘é€');
                }
            },

            // åˆ†äº«å½“å‰ä½ç½®
            shareLocation() {
                const friendId = document.getElementById('chat-panel').dataset.friendId;
                const friend = this.friends.find(f => f.id === friendId);
                if (!friend) {
                    console.error('âŒ æœªæ‰¾åˆ°å¥½å‹ä¿¡æ¯');
                    return;
                }
                
                if (!currentPosition) {
                    alert('è¯·å…ˆè·å–GPSå®šä½');
                    return;
                }

                const locationText = `${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}`;
                const message = this.sendMessage(friendId, locationText, 'location');
                
                // ç«‹å³åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºä½ç½®æ¶ˆæ¯ï¼ˆå¾®ä¿¡å¼å®æ—¶æ˜¾ç¤ºï¼‰
                const messagesList = document.getElementById('chat-messages-list');
                const chatPanel = document.getElementById('chat-panel');
                
                if (messagesList && chatPanel && chatPanel.style.display === 'flex' && chatPanel.dataset.friendId === friendId) {
                    // å¦‚æœèŠå¤©çª—å£å·²æ‰“å¼€ä¸”æ­£åœ¨å’Œè¯¥å¥½å‹èŠå¤©ï¼Œç›´æ¥è¿½åŠ æ¶ˆæ¯
                    this.appendMessageToChatList(message, friend, messagesList, true);
                } else {
                    // å¦‚æœèŠå¤©çª—å£æœªæ‰“å¼€ï¼Œé‡æ–°æ¸²æŸ“
                    this.openChat(friendId);
                }
                
                // æ›´æ–°å¥½å‹åˆ—è¡¨
                this.updateFriendsList();
            },

            // æŸ¥çœ‹ä½ç½®
            viewLocation(coords) {
                alert('æŸ¥çœ‹ä½ç½®ï¼š' + coords + '\nï¼ˆå°†åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºï¼‰');
                // è¿™é‡Œå¯ä»¥å…³é—­èŠå¤©çª—å£å¹¶åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºä½ç½®
                this.toggleChat();
            },

            // æ›´æ–°å¥½å‹åˆ—è¡¨
            updateFriendsList() {
                const friendsList = document.getElementById('friends-list');
                if (!friendsList) {
                    console.error('âŒ æ‰¾ä¸åˆ°å¥½å‹åˆ—è¡¨å®¹å™¨ #friends-list');
                    return;
                }
                friendsList.innerHTML = '';

                // æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´æ’åºï¼Œå¹¶æ’é™¤æœºå™¨äººï¼ˆæœºå™¨äººå•ç‹¬æ˜¾ç¤ºåœ¨å·¦ä¸‹è§’ï¼‰
                const sortedFriends = [...this.friends]
                    .filter(friend => !friend.isBot) // æ’é™¤æœºå™¨äºº
                    .sort((a, b) => {
                        return new Date(b.lastTime || 0) - new Date(a.lastTime || 0);
                    });

                console.log('ğŸ”„ æ›´æ–°å¥½å‹åˆ—è¡¨ï¼Œå…±', sortedFriends.length, 'ä¸ªå¥½å‹ï¼ˆå·²æ’é™¤æœºå™¨äººï¼‰');

                sortedFriends.forEach((friend, index) => {
                    // ç¡®ä¿å¥½å‹æœ‰IDï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”Ÿæˆä¸€ä¸ª
                    if (!friend.id) {
                        friend.id = friend.name + '_' + Date.now();
                        console.warn('âš ï¸ å¥½å‹ç¼ºå°‘IDï¼Œå·²è‡ªåŠ¨ç”Ÿæˆ:', friend.id, 'å¥½å‹å:', friend.name);
                    }
                    
                    const friendId = friend.id;
                    const unread = this.conversations[friendId] ? 
                        this.conversations[friendId].filter(m => m.from === friendId && !m.read).length : 0;

                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'friend-item';
                    friendDiv.setAttribute('data-friend-id', friendId);
                    
                    // ç‚¹å‡»æ‰“å¼€èŠå¤©
                    friendDiv.onclick = (e) => {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸æ‰“å¼€èŠå¤©
                        if (e.target.closest('.friend-delete-btn')) {
                            return;
                        }
                        this.openChat(friendId);
                    };
                    
                    const friendAvatarHtml = this.renderAvatar(friend.avatar, 32);
                    friendDiv.innerHTML = `
                        <div class="friend-avatar">${friendAvatarHtml}</div>
                        <div class="friend-info">
                            <div class="friend-name">
                                ${friend.name}
                                <span class="friend-status" style="color: ${friend.online ? '#22C55E' : '#999'}">
                                    ${friend.online ? 'â—' : 'â—‹'}
                                </span>
                            </div>
                            <div class="friend-last-message">${friend.lastMessage || 'æš‚æ— æ¶ˆæ¯'}</div>
                        </div>
                        <div class="friend-meta">
                            <div class="friend-time">${this.formatTime(friend.lastTime)}</div>
                            ${unread > 0 ? `<div class="friend-unread">${unread}</div>` : ''}
                        </div>
                        ${friend.isBot ? '' : `<button class="friend-delete-btn" onclick="event.stopPropagation(); event.preventDefault(); chatManager.removeFriend('${friendId}')" title="åˆ é™¤å¥½å‹">
                            ğŸ—‘ï¸
                        </button>`}
                    `;
                    
                    // æ·»åŠ é•¿æŒ‰åŠŸèƒ½ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    let longPressTimer = null;
                    friendDiv.addEventListener('touchstart', (e) => {
                        longPressTimer = setTimeout(() => {
                            // é•¿æŒ‰åé«˜äº®æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                            const deleteBtn = friendDiv.querySelector('.friend-delete-btn');
                            if (deleteBtn) {
                                deleteBtn.style.background = 'rgba(244, 67, 54, 0.4)';
                                deleteBtn.style.transform = 'scale(1.2)';
                                // éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                                if (navigator.vibrate) {
                                    navigator.vibrate(50);
                                }
                            }
                        }, 500); // 500msé•¿æŒ‰
                    }, { passive: true });
                    
                    friendDiv.addEventListener('touchend', () => {
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                        // æ¢å¤åˆ é™¤æŒ‰é’®æ ·å¼
                        setTimeout(() => {
                            const deleteBtn = friendDiv.querySelector('.friend-delete-btn');
                            if (deleteBtn) {
                                deleteBtn.style.background = '';
                                deleteBtn.style.transform = '';
                            }
                        }, 200);
                    });
                    
                    friendDiv.addEventListener('touchmove', () => {
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                    });
                    
                    friendsList.appendChild(friendDiv);
                    
                    // éªŒè¯åˆ é™¤æŒ‰é’®æ˜¯å¦åˆ›å»ºæˆåŠŸ
                    setTimeout(() => {
                        const deleteBtn = friendDiv.querySelector('.friend-delete-btn');
                        if (deleteBtn) {
                            const rect = deleteBtn.getBoundingClientRect();
                            console.log(`âœ… å¥½å‹ "${friend.name}" çš„åˆ é™¤æŒ‰é’®å·²åˆ›å»º`, {
                                visible: rect.width > 0 && rect.height > 0,
                                position: { left: rect.left, top: rect.top, width: rect.width, height: rect.height },
                                styles: {
                                    display: window.getComputedStyle(deleteBtn).display,
                                    visibility: window.getComputedStyle(deleteBtn).visibility,
                                    opacity: window.getComputedStyle(deleteBtn).opacity
                                }
                            });
                        } else {
                            console.error(`âŒ å¥½å‹ "${friend.name}" çš„åˆ é™¤æŒ‰é’®åˆ›å»ºå¤±è´¥ï¼`);
                        }
                    }, 100);
                });
                
                console.log('âœ… å¥½å‹åˆ—è¡¨æ›´æ–°å®Œæˆï¼Œå…±', sortedFriends.length, 'ä¸ªå¥½å‹');
                
                // å…¨å±€æµ‹è¯•å‡½æ•°
                window.testDeleteButtons = function() {
                    const buttons = document.querySelectorAll('.friend-delete-btn');
                    console.log('ğŸ” æ‰¾åˆ°', buttons.length, 'ä¸ªåˆ é™¤æŒ‰é’®');
                    buttons.forEach((btn, i) => {
                        const rect = btn.getBoundingClientRect();
                        console.log(`æŒ‰é’® ${i + 1}:`, {
                            visible: rect.width > 0 && rect.height > 0,
                            position: rect,
                            computedStyle: {
                                display: window.getComputedStyle(btn).display,
                                visibility: window.getComputedStyle(btn).visibility,
                                opacity: window.getComputedStyle(btn).opacity,
                                width: window.getComputedStyle(btn).width,
                                height: window.getComputedStyle(btn).height
                            }
                        });
                    });
                    return buttons.length;
                };
            },

            // åˆ é™¤å¥½å‹
            removeFriend(friendId) {
                console.log('ğŸ—‘ï¸ å¼€å§‹åˆ é™¤å¥½å‹ï¼ŒID:', friendId);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æœºå™¨äººå¥½å‹
                const botFriend = this.friends.find(f => f.id === friendId);
                if (botFriend && botFriend.isBot) {
                    alert('ğŸ¤– å°çªæ˜¯ä½ çš„AIä¼™ä¼´ï¼Œä¸èƒ½åˆ é™¤å“¦~ æˆ‘ä¼šä¸€ç›´é™ªç€ä½ çš„ï¼ğŸ’™');
                    return;
                }
                
                // æ£€æŸ¥IDæ˜¯å¦æœ‰æ•ˆ
                if (!friendId || friendId === 'undefined' || friendId === 'null') {
                    console.error('âŒ æ— æ•ˆçš„å¥½å‹ID:', friendId);
                    alert('æ— æ•ˆçš„å¥½å‹IDï¼Œæ— æ³•åˆ é™¤ï¼');
                    return;
                }
                
                // å°è¯•é€šè¿‡IDæŸ¥æ‰¾å¥½å‹
                let friend = this.friends.find(f => f.id === friendId);
                
                // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•é€šè¿‡dataå±æ€§æŸ¥æ‰¾ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
                if (!friend) {
                    const friendDiv = document.querySelector(`[data-friend-id="${friendId}"]`);
                    if (friendDiv) {
                        const friendName = friendDiv.querySelector('.friend-name')?.textContent?.trim();
                        if (friendName) {
                            friend = this.friends.find(f => f.name === friendName);
                        }
                    }
                }
                
                if (!friend) {
                    console.error('âŒ æœªæ‰¾åˆ°å¥½å‹ä¿¡æ¯ï¼ŒID:', friendId);
                    console.log('å½“å‰å¥½å‹åˆ—è¡¨:', this.friends.map(f => ({ id: f.id, name: f.name })));
                    alert('æœªæ‰¾åˆ°å¥½å‹ä¿¡æ¯ï¼');
                    return;
                }

                const friendName = friend.name;
                console.log('ğŸ“‹ å‡†å¤‡åˆ é™¤å¥½å‹:', friendName);
                if (!confirm(`ç¡®å®šè¦åˆ é™¤å¥½å‹ "${friendName}" å—ï¼Ÿ\n\nåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼Œä¸”ä¼šæ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•ã€‚`)) {
                    console.log('âŒ ç”¨æˆ·å–æ¶ˆäº†åˆ é™¤æ“ä½œ');
                    return;
                }

                // ä»å¥½å‹åˆ—è¡¨ä¸­åˆ é™¤ï¼ˆæ”¯æŒé€šè¿‡IDæˆ–åç§°æŸ¥æ‰¾ï¼‰
                let friendIndex = this.friends.findIndex(f => f.id === friendId);
                if (friendIndex === -1) {
                    // å¦‚æœé€šè¿‡IDæ‰¾ä¸åˆ°ï¼Œå°è¯•é€šè¿‡åç§°æŸ¥æ‰¾
                    friendIndex = this.friends.findIndex(f => f.name === friendName);
                }
                
                if (friendIndex !== -1) {
                    const deletedFriend = this.friends[friendIndex];
                    this.friends.splice(friendIndex, 1);
                    console.log('âœ… å·²ä»å¥½å‹åˆ—è¡¨ä¸­ç§»é™¤:', deletedFriend.name);
                } else {
                    console.warn('âš ï¸ æœªåœ¨å¥½å‹åˆ—è¡¨ä¸­æ‰¾åˆ°è¦åˆ é™¤çš„å¥½å‹');
                }

                // åˆ é™¤å¯¹è¯è®°å½•ï¼ˆä½¿ç”¨å®é™…çš„å¥½å‹IDï¼‰
                const actualFriendId = friend?.id || friendId;
                if (this.conversations[actualFriendId]) {
                    delete this.conversations[actualFriendId];
                    console.log('âœ… å·²åˆ é™¤å¯¹è¯è®°å½•');
                }

                // å¦‚æœæ­£åœ¨å’Œè¯¥å¥½å‹èŠå¤©ï¼Œå…³é—­èŠå¤©çª—å£
                const chatPanel = document.getElementById('chat-panel');
                if (chatPanel && chatPanel.dataset.friendId === friendId) {
                    chatPanel.style.display = 'none';
                    document.getElementById('friends-panel').style.display = 'block';
                }

                // å¦‚æœFirebaseå·²å¯ç”¨ï¼Œå…ˆåˆ é™¤Firebaseä¸­çš„å¥½å‹å…³ç³»ï¼Œç„¶åå†ä¿å­˜æœ¬åœ°æ•°æ®
                if (firebaseEnabled && database) {
                    const userId = this.currentUser.id;
                    
                    console.log('ğŸ”¥ å¼€å§‹ä»Firebaseåˆ é™¤å¥½å‹å…³ç³»:', userId, friendId);
                    
                    // åˆ é™¤åŒå‘å¥½å‹å…³ç³»ï¼ˆä½¿ç”¨æ­£ç¡®çš„è·¯å¾„æ ¼å¼ï¼šfriendships/${userId}/${friendId}ï¼‰
                    Promise.all([
                        database.ref(`friendships/${userId}/${friendId}`).remove(),
                        database.ref(`friendships/${friendId}/${userId}`).remove()
                    ]).then(() => {
                        console.log('âœ… Firebaseå¥½å‹å…³ç³»å·²åˆ é™¤');
                        
                        // Firebaseåˆ é™¤æˆåŠŸåï¼Œä¿å­˜æœ¬åœ°æ•°æ®
                        this.saveData();
                        console.log('ğŸ’¾ æ•°æ®å·²ä¿å­˜');
                        
                        // æ›´æ–°å¥½å‹åˆ—è¡¨æ˜¾ç¤º
                        this.updateFriendsList();
                        console.log('ğŸ”„ å¥½å‹åˆ—è¡¨å·²æ›´æ–°');
                    }).catch(err => {
                        console.error('âŒ åˆ é™¤Firebaseå¥½å‹å…³ç³»å¤±è´¥:', err);
                        // å³ä½¿Firebaseåˆ é™¤å¤±è´¥ï¼Œä¹Ÿä¿å­˜æœ¬åœ°åˆ é™¤æ“ä½œ
                        this.saveData();
                        console.log('ğŸ’¾ æ•°æ®å·²ä¿å­˜ï¼ˆFirebaseåˆ é™¤å¤±è´¥ï¼Œä½†æœ¬åœ°å·²åˆ é™¤ï¼‰');
                        this.updateFriendsList();
                    });
                    
                    // åŒæ—¶åˆ é™¤æ—§æ ¼å¼çš„å¥½å‹å…³ç³»ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
                    const friendshipId1 = `${userId}_${friendId}`;
                    const friendshipId2 = `${friendId}_${userId}`;
                    Promise.all([
                        database.ref(`friendships/${friendshipId1}`).remove().catch(() => {}),
                        database.ref(`friendships/${friendshipId2}`).remove().catch(() => {})
                    ]).then(() => {
                        console.log('âœ… æ—§æ ¼å¼Firebaseå¥½å‹å…³ç³»å·²æ¸…ç†');
                    }).catch(() => {
                        // å¿½ç•¥é”™è¯¯ï¼Œå¯èƒ½ä¸å­˜åœ¨æ—§æ ¼å¼æ•°æ®
                    });
                } else {
                    // å¦‚æœæ²¡æœ‰Firebaseï¼Œç›´æ¥ä¿å­˜æœ¬åœ°æ•°æ®
                    this.saveData();
                    console.log('ğŸ’¾ æ•°æ®å·²ä¿å­˜');
                    
                    // æ›´æ–°å¥½å‹åˆ—è¡¨æ˜¾ç¤º
                    this.updateFriendsList();
                    console.log('ğŸ”„ å¥½å‹åˆ—è¡¨å·²æ›´æ–°');
                }

                console.log(`âœ… å·²æˆåŠŸåˆ é™¤å¥½å‹: ${friendName}`);
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                setTimeout(() => {
                    const statusEl = document.getElementById('status');
                    if (statusEl) {
                        statusEl.className = 'status success';
                        statusEl.innerHTML = `<span>âœ…</span><span>å·²åˆ é™¤å¥½å‹ "${friendName}"</span>`;
                        setTimeout(() => {
                            statusEl.className = 'status info';
                            statusEl.innerHTML = '<span>ğŸ”„</span><span>ç‚¹å‡»"å¯åŠ¨å¯»å®ä¹‹æ—…"å¼€å§‹æ¸¸æˆ...</span>';
                        }, 3000);
                    }
                }, 100);
            },

            // æ¸…ç©ºèŠå¤©è®°å½•ï¼ˆä¸åˆ é™¤å¥½å‹ï¼‰
            clearChatHistory() {
                const chatPanel = document.getElementById('chat-panel');
                const friendId = chatPanel?.dataset.friendId;
                
                if (!friendId) {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°å½“å‰èŠå¤©å¥½å‹ID');
                    return;
                }
                
                const friend = this.friends.find(f => f.id === friendId);
                const friendName = friend?.name || 'å¥½å‹';
                
                // ç¡®è®¤åˆ é™¤
                if (!confirm(`ç¡®å®šè¦æ¸…ç©ºä¸"${friendName}"çš„èŠå¤©è®°å½•å—ï¼Ÿ\n\næ³¨æ„ï¼šæ­¤æ“ä½œä¸ä¼šåˆ é™¤å¥½å‹ï¼Œåªæ˜¯æ¸…ç©ºèŠå¤©è®°å½•ã€‚`)) {
                    return;
                }
                
                console.log('ğŸ—‘ï¸ å¼€å§‹æ¸…ç©ºèŠå¤©è®°å½•:', friendId);
                
                // æ¸…ç©ºæœ¬åœ°å¯¹è¯è®°å½•
                if (this.conversations[friendId]) {
                    delete this.conversations[friendId];
                    console.log('âœ… å·²æ¸…ç©ºæœ¬åœ°å¯¹è¯è®°å½•');
                }
                
                // æ›´æ–°å¥½å‹çš„æœ€åæ¶ˆæ¯
                if (friend) {
                    friend.lastMessage = '';
                    friend.lastTime = null;
                }
                
                // æ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨æ˜¾ç¤º
                const messagesList = document.getElementById('chat-messages-list');
                if (messagesList) {
                    messagesList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ¶ˆæ¯</div>';
                }
                
                // å¦‚æœFirebaseå·²å¯ç”¨ï¼Œå…ˆåˆ é™¤Firebaseä¸­çš„æ¶ˆæ¯è®°å½•ï¼Œç„¶åå†ä¿å­˜æœ¬åœ°æ•°æ®
                if (firebaseEnabled && database) {
                    const userId = this.currentUser.id;
                    
                    console.log('ğŸ”¥ å¼€å§‹ä»Firebaseåˆ é™¤èŠå¤©è®°å½•:', userId, friendId);
                    
                    // åˆ é™¤å½“å‰ç”¨æˆ·æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸è¯¥å¥½å‹ç›¸å…³çš„æ‰€æœ‰æ¶ˆæ¯
                    // æ¶ˆæ¯å­˜å‚¨è·¯å¾„ï¼šmessages/${userId}/${messageId}
                    const userMessagesRef = database.ref(`messages/${userId}`);
                    userMessagesRef.once('value', (snapshot) => {
                        const allMessages = snapshot.val();
                        const deletePromises = [];
                        
                        if (allMessages) {
                            Object.keys(allMessages).forEach(messageId => {
                                const message = allMessages[messageId];
                                // å¦‚æœæ¶ˆæ¯æ˜¯ä¸è¯¥å¥½å‹ç›¸å…³çš„ï¼ˆfromæˆ–toæ˜¯è¯¥å¥½å‹ï¼‰
                                if (message && (message.from === friendId || message.to === friendId)) {
                                    deletePromises.push(
                                        database.ref(`messages/${userId}/${messageId}`).remove()
                                    );
                                }
                            });
                        }
                        
                        // åˆ é™¤å¥½å‹æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸å½“å‰ç”¨æˆ·ç›¸å…³çš„æ‰€æœ‰æ¶ˆæ¯
                        const friendMessagesRef = database.ref(`messages/${friendId}`);
                        friendMessagesRef.once('value', (friendSnapshot) => {
                            const friendAllMessages = friendSnapshot.val();
                            
                            if (friendAllMessages) {
                                Object.keys(friendAllMessages).forEach(messageId => {
                                    const message = friendAllMessages[messageId];
                                    // å¦‚æœæ¶ˆæ¯æ˜¯ä¸å½“å‰ç”¨æˆ·ç›¸å…³çš„ï¼ˆfromæˆ–toæ˜¯å½“å‰ç”¨æˆ·ï¼‰
                                    if (message && (message.from === userId || message.to === userId)) {
                                        deletePromises.push(
                                            database.ref(`messages/${friendId}/${messageId}`).remove()
                                        );
                                    }
                                });
                            }
                            
                            // åŒæ—¶åˆ é™¤ä¼šè¯è®°å½•
                            deletePromises.push(
                                database.ref(`conversations/${userId}/${friendId}`).remove().catch(() => {}),
                                database.ref(`conversations/${friendId}/${userId}`).remove().catch(() => {})
                            );
                            
                            // ç­‰å¾…æ‰€æœ‰åˆ é™¤æ“ä½œå®Œæˆ
                            Promise.all(deletePromises).then(() => {
                                console.log('âœ… FirebaseèŠå¤©è®°å½•å·²æ¸…ç©º');
                                
                                // Firebaseåˆ é™¤æˆåŠŸåï¼Œä¿å­˜æœ¬åœ°æ•°æ®
                                this.saveData();
                                console.log('ğŸ’¾ æ•°æ®å·²ä¿å­˜');
                                
                                // æ›´æ–°å¥½å‹åˆ—è¡¨æ˜¾ç¤º
                                this.updateFriendsList();
                                
                                // æ˜¾ç¤ºæˆåŠŸæç¤º
                                setTimeout(() => {
                                    const statusEl = document.getElementById('status');
                                    if (statusEl) {
                                        statusEl.className = 'status success';
                                        statusEl.innerHTML = `<span>âœ…</span><span>å·²æ¸…ç©ºä¸"${friendName}"çš„èŠå¤©è®°å½•</span>`;
                                        setTimeout(() => {
                                            statusEl.className = 'status info';
                                            statusEl.innerHTML = '<span>ğŸ”„</span><span>ç‚¹å‡»"å¯åŠ¨å¯»å®ä¹‹æ—…"å¼€å§‹æ¸¸æˆ...</span>';
                                        }, 3000);
                                    }
                                }, 100);
                                
                                console.log(`âœ… å·²æˆåŠŸæ¸…ç©ºä¸"${friendName}"çš„èŠå¤©è®°å½•`);
                            }).catch(err => {
                                console.error('âŒ æ¸…ç©ºFirebaseèŠå¤©è®°å½•å¤±è´¥:', err);
                                // å³ä½¿Firebaseåˆ é™¤å¤±è´¥ï¼Œä¹Ÿä¿å­˜æœ¬åœ°åˆ é™¤æ“ä½œ
                                this.saveData();
                                console.log('ğŸ’¾ æ•°æ®å·²ä¿å­˜ï¼ˆFirebaseåˆ é™¤å¤±è´¥ï¼Œä½†æœ¬åœ°å·²æ¸…ç©ºï¼‰');
                                this.updateFriendsList();
                                
                                // æ˜¾ç¤ºæç¤º
                                setTimeout(() => {
                                    const statusEl = document.getElementById('status');
                                    if (statusEl) {
                                        statusEl.className = 'status success';
                                        statusEl.innerHTML = `<span>âœ…</span><span>å·²æ¸…ç©ºæœ¬åœ°èŠå¤©è®°å½•</span>`;
                                        setTimeout(() => {
                                            statusEl.className = 'status info';
                                            statusEl.innerHTML = '<span>ğŸ”„</span><span>ç‚¹å‡»"å¯åŠ¨å¯»å®ä¹‹æ—…"å¼€å§‹æ¸¸æˆ...</span>';
                                        }, 3000);
                                    }
                                }, 100);
                            });
                        }).catch(err => {
                            console.error('âŒ è¯»å–å¥½å‹æ¶ˆæ¯å¤±è´¥:', err);
                            // å³ä½¿è¯»å–å¤±è´¥ï¼Œä¹Ÿä¿å­˜æœ¬åœ°åˆ é™¤æ“ä½œ
                            this.saveData();
                            this.updateFriendsList();
                        });
                    }).catch(err => {
                        console.error('âŒ è¯»å–ç”¨æˆ·æ¶ˆæ¯å¤±è´¥:', err);
                        // å³ä½¿è¯»å–å¤±è´¥ï¼Œä¹Ÿä¿å­˜æœ¬åœ°åˆ é™¤æ“ä½œ
                        this.saveData();
                        this.updateFriendsList();
                    });
                } else {
                    // å¦‚æœæ²¡æœ‰Firebaseï¼Œç›´æ¥ä¿å­˜æœ¬åœ°æ•°æ®
                    this.saveData();
                    console.log('ğŸ’¾ æ•°æ®å·²ä¿å­˜');
                    
                    // æ›´æ–°å¥½å‹åˆ—è¡¨æ˜¾ç¤º
                    this.updateFriendsList();
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    setTimeout(() => {
                        const statusEl = document.getElementById('status');
                        if (statusEl) {
                            statusEl.className = 'status success';
                            statusEl.innerHTML = `<span>âœ…</span><span>å·²æ¸…ç©ºä¸"${friendName}"çš„èŠå¤©è®°å½•</span>`;
                            setTimeout(() => {
                                statusEl.className = 'status info';
                                statusEl.innerHTML = '<span>ğŸ”„</span><span>ç‚¹å‡»"å¯åŠ¨å¯»å®ä¹‹æ—…"å¼€å§‹æ¸¸æˆ...</span>';
                            }, 3000);
                        }
                    }, 100);
                    
                    console.log(`âœ… å·²æˆåŠŸæ¸…ç©ºä¸"${friendName}"çš„èŠå¤©è®°å½•`);
                }
            },

            // åˆ‡æ¢èŠå¤©é¢æ¿æ˜¾ç¤º
            toggleChat(event) {
                // é˜»æ­¢äº‹ä»¶å†’æ³¡
                if (event) {
                    event.stopPropagation();
                    event.preventDefault();
                }
                
                const chatContainer = document.getElementById('chat-container');
                const chatPanel = document.getElementById('chat-panel');
                const friendsPanel = document.getElementById('friends-panel');
                
                if (!chatContainer) {
                    console.error('âŒ chat-container å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }
                
                // æ£€æŸ¥å½“å‰æ˜¾ç¤ºçŠ¶æ€ï¼ˆè€ƒè™‘!importantçš„æƒ…å†µï¼Œä½¿ç”¨computedStyleï¼‰
                const computedStyle = window.getComputedStyle(chatContainer);
                const isVisible = computedStyle.display !== 'none';
                
                if (!isVisible) {
                    // æ‰“å¼€èŠå¤©çª—å£
                    let currentStyle = chatContainer.getAttribute('style') || '';
                    // ç§»é™¤æ‰€æœ‰displayç›¸å…³çš„æ ·å¼
                    currentStyle = currentStyle.replace(/display\s*:\s*[^;!]*!?important?;?/gi, '');
                    
                    if (window.innerWidth <= 768) {
                        // ç§»åŠ¨ç«¯ä½¿ç”¨flex
                        chatContainer.setAttribute('style', currentStyle + ' display: flex !important;');
                        chatContainer.style.display = 'flex';
                    } else {
                        // PCç«¯ä½¿ç”¨block
                        chatContainer.setAttribute('style', currentStyle + ' display: block !important;');
                        chatContainer.style.display = 'block';
                    }
                    this.updateFriendsList();
                    // ç¡®ä¿æ˜¾ç¤ºå¥½å‹åˆ—è¡¨é¢æ¿
                    if (chatPanel) chatPanel.style.display = 'none';
                    if (friendsPanel) friendsPanel.style.display = 'block';
                    console.log('âœ… å¥½å‹èŠå¤©çª—å£å·²æ‰“å¼€');
                } else {
                    // å…³é—­èŠå¤©çª—å£ - ä½¿ç”¨ä¸“é—¨çš„å…³é—­å‡½æ•°
                    this.closeChatContainer();
                }
            },
            
            // ä¸“é—¨ç”¨äºå…³é—­èŠå¤©å®¹å™¨çš„å‡½æ•°
            closeChatContainer() {
                const chatContainer = document.getElementById('chat-container');
                const chatPanel = document.getElementById('chat-panel');
                const friendsPanel = document.getElementById('friends-panel');
                
                if (!chatContainer) return;
                
                // å¼ºåˆ¶å…³é—­ - ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿ç”Ÿæ•ˆ
                chatContainer.style.display = 'none';
                let currentStyle = chatContainer.getAttribute('style') || '';
                currentStyle = currentStyle.replace(/display\s*:\s*[^;!]*!?important?;?/gi, '');
                chatContainer.setAttribute('style', currentStyle + ' display: none !important;');
                
                if (chatPanel) chatPanel.style.display = 'none';
                if (friendsPanel) friendsPanel.style.display = 'block';
                
                // å¼ºåˆ¶ç§»é™¤æ‰€æœ‰å¯èƒ½è¦†ç›–çš„æ ·å¼
                chatContainer.classList.remove('open', 'visible', 'show');
                
                console.log('âœ… å¥½å‹èŠå¤©çª—å£å·²å¼ºåˆ¶å…³é—­');
            },

            // åˆå§‹åŒ–æœºå™¨äººèŠå¤©çª—å£
            initBotChat() {
                // é»˜è®¤éšè—æœºå™¨äººèŠå¤©çª—å£ï¼Œæ˜¾ç¤ºå¤´åƒæŒ‰é’®
                const botChatContainer = document.getElementById('bot-chat-container');
                const botAvatarButton = document.getElementById('bot-avatar-button');
                if (botChatContainer) {
                    // é»˜è®¤éšè—èŠå¤©çª—å£ï¼Œä¸è‡ªåŠ¨æ˜¾ç¤º
                    botChatContainer.style.display = 'none';
                }
                // ç¡®ä¿å¤´åƒæŒ‰é’®æ˜¾ç¤ºï¼ˆè®©ç”¨æˆ·å¯ä»¥ç‚¹å‡»æ‰“å¼€æœºå™¨äººèŠå¤©ï¼‰
                if (botAvatarButton) {
                    botAvatarButton.style.display = 'block';
                }
                
                // æ£€æµ‹spriteå›¾ç‰‡æ˜¯å¦åŠ è½½æˆåŠŸ
                this.checkBotSpriteImage();
            },
            
            // æ£€æµ‹æœºå™¨äººspriteå›¾ç‰‡æ˜¯å¦åŠ è½½æˆåŠŸ
            checkBotSpriteImage() {
                const spriteImage = new Image();
                spriteImage.onload = () => {
                    console.log('âœ… æœºå™¨äººspriteå›¾ç‰‡åŠ è½½æˆåŠŸ');
                    // å¯åŠ¨spriteåŠ¨ç”»
                    this.startBotSpriteAnimation();
                };
                spriteImage.onerror = () => {
                    console.warn('âš ï¸ æœºå™¨äººspriteå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨fallback');
                    // å¦‚æœspriteå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†æ‰€æœ‰bot-sprite-animationæ”¹ä¸ºä½¿ç”¨é™æ€å›¾ç‰‡
                    const spriteElements = document.querySelectorAll('.bot-sprite-animation');
                    spriteElements.forEach(el => {
                        el.classList.remove('bot-sprite-animation');
                        el.style.backgroundImage = "url('assets/images/xiaotu-bot.png')";
                        el.style.backgroundSize = 'contain';
                        el.style.backgroundPosition = 'center';
                        el.style.backgroundRepeat = 'no-repeat';
                        el.style.animation = 'none';
                    });
                };
                // æ·»åŠ ç‰ˆæœ¬å·é¿å…ç¼“å­˜é—®é¢˜ï¼ˆæ¯æ¬¡ä»£ç æ›´æ–°æ—¶æ”¹å˜è¿™ä¸ªç‰ˆæœ¬å·ï¼‰
                const spriteVersion = 'v2.0';
                spriteImage.src = `assets/images/xiaotu-bot01.png?${spriteVersion}`;
            },
            
            // å¯åŠ¨æœºå™¨äººspriteåŠ¨ç”»ï¼ˆä½¿ç”¨JavaScriptæ§åˆ¶ï¼‰
            startBotSpriteAnimation() {
                // æ£€æµ‹å¹³å°ç±»å‹
                const ua = navigator.userAgent;
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua) || 
                                 (window.innerWidth <= 768);
                // iOSè®¾å¤‡ï¼ˆiPad/iPhoneï¼‰ã€WebViewå¯¹åƒç´ å€¼æ”¯æŒå¥½
                const isIOS = /iPhone|iPad|iPod/i.test(ua);
                const isWebView = /MicroMessenger|wxwork|Seatalk|QQ/i.test(ua);
                const isHarmonyOS = /HarmonyOS/i.test(ua); // é¸¿è’™ç³»ç»Ÿ
                const isHuaweiBrowser = /HuaweiBrowser|HUAWEI|HiBrowser/i.test(ua); // åä¸ºæµè§ˆå™¨
                // ç»Ÿä¸€ä½¿ç”¨åƒç´ å€¼ï¼Œä½†åä¸ºæµè§ˆå™¨éœ€è¦ç‰¹æ®Šå¤„ç†
                const usePixelForMobile = true; // æ‰€æœ‰å¹³å°éƒ½ç”¨åƒç´ å€¼
                const isHuaweiDevice = isHarmonyOS || isHuaweiBrowser; // åä¸ºè®¾å¤‡éœ€è¦ç‰¹æ®Šå¤„ç†
                
                // å»¶è¿Ÿå¯åŠ¨ï¼Œç¡®ä¿DOMå…ƒç´ å·²ç»åˆ›å»º
                setTimeout(() => {
                    const spriteElements = document.querySelectorAll('.bot-sprite-animation');
                    console.log('ğŸ¬ å¯åŠ¨spriteåŠ¨ç”»ï¼Œæ‰¾åˆ°å…ƒç´ æ•°é‡:', spriteElements.length, 'å¹³å°:', isMobile ? 'ç§»åŠ¨ç«¯' : 'PC');
                    
                    if (spriteElements.length === 0) {
                        console.warn('âš ï¸ æœªæ‰¾åˆ°.bot-sprite-animationå…ƒç´ ï¼Œå»¶è¿Ÿé‡è¯•...');
                        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå†å»¶è¿Ÿé‡è¯•ä¸€æ¬¡
                        setTimeout(() => this.startBotSpriteAnimation(), 500);
                        return;
                    }
                    
                    // å¦‚æœå·²ç»æœ‰åŠ¨ç”»åœ¨è¿è¡Œï¼Œå…ˆæ¸…é™¤
                    if (this.botSpriteAnimationInterval) {
                        clearInterval(this.botSpriteAnimationInterval);
                    }
                    
                    // 4x4 spriteçš„16å¸§ä½ç½®
                    const frames = [
                        { x: 0, y: 0 },      // ç¬¬1å¸§ï¼šç¬¬1è¡Œç¬¬1åˆ—
                        { x: 1, y: 0 },      // ç¬¬2å¸§ï¼šç¬¬1è¡Œç¬¬2åˆ—
                        { x: 2, y: 0 },      // ç¬¬3å¸§ï¼šç¬¬1è¡Œç¬¬3åˆ—
                        { x: 3, y: 0 },      // ç¬¬4å¸§ï¼šç¬¬1è¡Œç¬¬4åˆ—
                        { x: 0, y: 1 },      // ç¬¬5å¸§ï¼šç¬¬2è¡Œç¬¬1åˆ—
                        { x: 1, y: 1 },      // ç¬¬6å¸§ï¼šç¬¬2è¡Œç¬¬2åˆ—
                        { x: 2, y: 1 },      // ç¬¬7å¸§ï¼šç¬¬2è¡Œç¬¬3åˆ—
                        { x: 3, y: 1 },      // ç¬¬8å¸§ï¼šç¬¬2è¡Œç¬¬4åˆ—
                        { x: 0, y: 2 },      // ç¬¬9å¸§ï¼šç¬¬3è¡Œç¬¬1åˆ—
                        { x: 1, y: 2 },      // ç¬¬10å¸§ï¼šç¬¬3è¡Œç¬¬2åˆ—
                        { x: 2, y: 2 },      // ç¬¬11å¸§ï¼šç¬¬3è¡Œç¬¬3åˆ—
                        { x: 3, y: 2 },      // ç¬¬12å¸§ï¼šç¬¬3è¡Œç¬¬4åˆ—
                        { x: 0, y: 3 },      // ç¬¬13å¸§ï¼šç¬¬4è¡Œç¬¬1åˆ—
                        { x: 1, y: 3 },      // ç¬¬14å¸§ï¼šç¬¬4è¡Œç¬¬2åˆ—
                        { x: 2, y: 3 },      // ç¬¬15å¸§ï¼šç¬¬4è¡Œç¬¬3åˆ—
                        { x: 3, y: 3 }       // ç¬¬16å¸§ï¼šç¬¬4è¡Œç¬¬4åˆ—
                    ];
                    
                    let currentFrame = 0;
                    const frameDuration = 150; // æ¯å¸§150msï¼Œæ€»å…±2.4sï¼ˆPCå’Œç§»åŠ¨ç«¯ç»Ÿä¸€é€Ÿåº¦ï¼‰
                    
                    // è¿‡æ»¤å‡ºæœ‰æœ‰æ•ˆå°ºå¯¸çš„å…ƒç´ 
                    const getValidElements = () => {
                        return Array.from(spriteElements).filter(el => {
                            const rect = el.getBoundingClientRect();
                            return rect.width > 0 && rect.height > 0;
                        });
                    };
                    
                    // æ›´æ–°æ¯ä¸€å¸§çš„å‡½æ•°
                    const updateFrame = () => {
                        const frame = frames[currentFrame];
                        const validElements = getValidElements();
                        
                        if (validElements.length === 0) {
                            // å¦‚æœæ²¡æœ‰æœ‰æ•ˆå…ƒç´ ï¼Œä¸è¾“å‡ºè­¦å‘Šï¼ˆé¿å…æ—¥å¿—è¿‡å¤šï¼‰
                            return;
                        }
                        
                        validElements.forEach((el, index) => {
                            // è·å–å®¹å™¨çš„å®é™…å°ºå¯¸
                            const rect = el.getBoundingClientRect();
                            const containerWidth = rect.width;
                            const containerHeight = rect.height;
                            
                            // ç»Ÿä¸€ä½¿ç”¨åƒç´ å€¼è®¡ç®—
                            const xPx = frame.x * containerWidth * -1;
                            const yPx = frame.y * containerHeight * -1;
                            const bgPosition = `${xPx}px ${yPx}px`;
                            
                            // åä¸ºè®¾å¤‡éœ€è¦å…ˆæ¸…é™¤backgroundPositionï¼Œå†è®¾ç½®ï¼Œé¿å…transition
                            if (isHuaweiDevice) {
                                // å…ˆæ¸…é™¤backgroundPosition
                                el.style.backgroundPosition = '';
                                // å¼ºåˆ¶é‡æ’
                                el.offsetHeight;
                            }
                            
                            // å½»åº•ç¦ç”¨æ‰€æœ‰transitionæ•ˆæœï¼Œè®©åˆ‡æ¢ç¬é—´å®Œæˆ
                            el.style.setProperty('transition', 'none', 'important');
                            el.style.setProperty('-webkit-transition', 'none', 'important');
                            el.style.setProperty('-moz-transition', 'none', 'important');
                            el.style.setProperty('-o-transition', 'none', 'important');
                            el.style.setProperty('transition-property', 'none', 'important');
                            el.style.setProperty('-webkit-transition-property', 'none', 'important');
                            el.style.setProperty('-moz-transition-property', 'none', 'important');
                            el.style.setProperty('-o-transition-property', 'none', 'important');
                            el.style.setProperty('transition-duration', '0s', 'important');
                            el.style.setProperty('-webkit-transition-duration', '0s', 'important');
                            el.style.setProperty('-moz-transition-duration', '0s', 'important');
                            el.style.setProperty('-o-transition-duration', '0s', 'important');
                            el.style.setProperty('will-change', 'auto', 'important'); // ç¦ç”¨ç¡¬ä»¶åŠ é€Ÿ
                            
                            el.style.backgroundSize = '400% 400%';
                            el.style.backgroundPosition = bgPosition;
                            
                            // å¼ºåˆ¶é‡ç»˜ï¼Œç¡®ä¿æ ·å¼ç«‹å³ç”Ÿæ•ˆ
                            el.offsetHeight; // è§¦å‘é‡æ’
                            
                            // åä¸ºè®¾å¤‡å†æ¬¡å¼ºåˆ¶é‡æ’ï¼Œç¡®ä¿æ ·å¼ç”Ÿæ•ˆ
                            if (isHuaweiDevice) {
                                requestAnimationFrame(() => {
                                    el.style.backgroundPosition = bgPosition;
                                    el.offsetHeight;
                                });
                            }
                            
                            // æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼ˆåªåœ¨ç¬¬ä¸€ä¸ªæœ‰æ•ˆå…ƒç´ æ—¶è¾“å‡ºï¼‰
                            if (index === 0) {
                                let platform = 'PC';
                                if (isMobile) {
                                    if (isIOS) platform = 'iOS';
                                    else if (isHarmonyOS) platform = 'é¸¿è’™';
                                    else if (isHuaweiBrowser) platform = 'åä¸ºæµè§ˆå™¨';
                                    else if (isWebView) platform = 'WebView';
                                    else platform = 'Androidæµè§ˆå™¨';
                                }
                                console.log(`ğŸ¬ å¸§ ${currentFrame + 1}/16: ä½ç½®(${frame.x},${frame.y}) â†’ bgPos(${bgPosition}) å®¹å™¨(${Math.round(containerWidth)}x${Math.round(containerHeight)}) å¹³å°:${platform} æœ‰æ•ˆå…ƒç´ :${validElements.length}/${spriteElements.length}`);
                            }
                        });
                        
                        currentFrame = (currentFrame + 1) % frames.length;
                    };
                    
                    // ç­‰å¾…è‡³å°‘æœ‰ä¸€ä¸ªæœ‰æ•ˆå…ƒç´ åå†å¯åŠ¨åŠ¨ç”»
                    const waitAndStart = () => {
                        const validElements = getValidElements();
                        if (validElements.length > 0) {
                            console.log(`âœ… æ‰¾åˆ° ${validElements.length} ä¸ªæœ‰æ•ˆå…ƒç´ ï¼Œå¯åŠ¨åŠ¨ç”»`);
                            // ç«‹å³æ˜¾ç¤ºç¬¬ä¸€å¸§
                            updateFrame();
                            // å¯åŠ¨åŠ¨ç”»å¾ªç¯
                            const animationInterval = setInterval(() => {
                                updateFrame();
                                // æ¯å¸§åæ£€æŸ¥æ˜¯å¦å›åˆ°ç¬¬ä¸€å¸§
                                if (currentFrame === 0) {
                                    console.log('ğŸ”„ åŠ¨ç”»å¾ªç¯å®Œæˆï¼Œé‡æ–°å¼€å§‹');
                                }
                            }, frameDuration);
                            
                            // ä¿å­˜interval IDä»¥ä¾¿åç»­æ¸…ç†
                            this.botSpriteAnimationInterval = animationInterval;
                            console.log('âœ… SpriteåŠ¨ç”»å·²å¯åŠ¨ï¼Œå¸§é—´éš”:', frameDuration + 'ms');
                        } else {
                            // å¦‚æœè¿˜æ²¡å‡†å¤‡å¥½ï¼Œ100msåé‡è¯•ï¼ˆæœ€å¤šé‡è¯•10æ¬¡ï¼‰
                            if (!this._spriteRetryCount) {
                                this._spriteRetryCount = 0;
                            }
                            if (this._spriteRetryCount < 10) {
                                this._spriteRetryCount++;
                                setTimeout(waitAndStart, 100);
                            } else {
                                console.warn('âš ï¸ 10æ¬¡é‡è¯•åä»æœªæ‰¾åˆ°æœ‰æ•ˆå…ƒç´ ï¼Œåœæ­¢å°è¯•');
                            }
                        }
                    };
                    
                    // å¼€å§‹ç­‰å¾…å¹¶å¯åŠ¨
                    waitAndStart();
                    
                    
                    // æ·»åŠ å…¨å±€æµ‹è¯•å‡½æ•°ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°æ‰‹åŠ¨è°ƒç”¨
                    window.testSpriteFrame = (frameIndex, method = 1) => {
                        if (frameIndex < 0 || frameIndex >= frames.length) {
                            console.error('å¸§ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œåº”è¯¥æ˜¯0-15');
                            return;
                        }
                        const validElements = getValidElements();
                        if (validElements.length === 0) {
                            console.error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆå…ƒç´ ');
                            return;
                        }
                        const frame = frames[frameIndex];
                        validElements.forEach((el, index) => {
                            const rect = el.getBoundingClientRect();
                            const containerWidth = rect.width;
                            const containerHeight = rect.height;
                            
                            if (method === 1) {
                                // æ–¹æ³•1ï¼šbackground-size: 400%ï¼Œä½¿ç”¨åƒç´ å€¼è®¡ç®—ï¼ˆPCç‰ˆæ­£ç¡®çš„æ–¹å¼ï¼‰
                                const xPx = frame.x * containerWidth * -1;
                                const yPx = frame.y * containerHeight * -1;
                                el.style.backgroundSize = '400% 400%';
                                el.style.backgroundPosition = `${xPx}px ${yPx}px`;
                            } else {
                                // æ–¹æ³•2ï¼šbackground-size: 100%ï¼Œæ¯å¸§ç§»åŠ¨25%
                                const xPercent = frame.x * -25;
                                const yPercent = frame.y * -25;
                                el.style.backgroundSize = '100% 100%';
                                el.style.backgroundPosition = `${xPercent}% ${yPercent}%`;
                            }
                            
                            if (index === 0) {
                                const computedStyle = window.getComputedStyle(el);
                                console.log(`ğŸ§ª æµ‹è¯•å¸§ ${frameIndex + 1}/16 (æ–¹æ³•${method}): ä½ç½®(${frame.x},${frame.y})`);
                                console.log(`ğŸ§ª å®¹å™¨å°ºå¯¸: ${Math.round(containerWidth)}x${Math.round(containerHeight)}`);
                                console.log(`ğŸ§ª è®¾ç½®æ ·å¼:`, {
                                    backgroundSize: el.style.backgroundSize,
                                    backgroundPosition: el.style.backgroundPosition
                                });
                                console.log(`ğŸ§ª è®¡ç®—åæ ·å¼:`, {
                                    backgroundSize: computedStyle.backgroundSize,
                                    backgroundPosition: computedStyle.backgroundPosition,
                                    backgroundImage: computedStyle.backgroundImage
                                });
                            }
                        });
                        console.log(`ğŸ§ª å·²è®¾ç½®å¸§ ${frameIndex + 1}/16 (æ–¹æ³•${method})ï¼Œè¯·æŸ¥çœ‹é¡µé¢ä¸Šçš„æ˜¾ç¤ºæ•ˆæœ`);
                    };
                    console.log('ğŸ’¡ æç¤ºï¼šå¯ä»¥åœ¨æ§åˆ¶å°ä½¿ç”¨ testSpriteFrame(0-15, 1æˆ–2) æ¥æµ‹è¯•æ˜¾ç¤ºç‰¹å®šå¸§');
                    console.log('ğŸ’¡ æ–¹æ³•1: background-size 400%ï¼Œæ–¹æ³•2: background-size 100%');
                }, 100);
            },

            // æ‰“å¼€æœºå™¨äººèŠå¤©çª—å£
            openBotChat() {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                if (!authService.isLoggedIn()) {
                    authManager.showModal();
                    return;
                }

                const botChatContainer = document.getElementById('bot-chat-container');
                const botAvatarButton = document.getElementById('bot-avatar-button');
                if (botChatContainer) {
                    botChatContainer.style.display = 'flex';
                    this.updateBotChatMessages();
                    // éšè—å¤´åƒæŒ‰é’®
                    if (botAvatarButton) {
                        botAvatarButton.style.display = 'none';
                    }
                }
            },

            // åˆ‡æ¢æœºå™¨äººèŠå¤©çª—å£æ˜¾ç¤º
            toggleBotChat(event) {
                // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘å…¶ä»–ç‚¹å‡»äº‹ä»¶
                if (event) {
                    event.stopPropagation();
                    event.preventDefault();
                }
                
                const botChatContainer = document.getElementById('bot-chat-container');
                const botAvatarButton = document.getElementById('bot-avatar-button');
                
                if (!botChatContainer) {
                    console.error('âŒ bot-chat-container å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }
                
                // æ£€æŸ¥å½“å‰æ˜¾ç¤ºçŠ¶æ€ï¼ˆè€ƒè™‘!importantçš„æƒ…å†µï¼‰
                const computedStyle = window.getComputedStyle(botChatContainer);
                const isVisible = computedStyle.display !== 'none';
                
                if (!isVisible) {
                    // æ‰“å¼€èŠå¤©çª—å£
                    let currentStyle = botChatContainer.getAttribute('style') || '';
                    currentStyle = currentStyle.replace(/display\s*:\s*[^;!]*!?important?;?/gi, '');
                    botChatContainer.setAttribute('style', currentStyle + ' display: flex !important;');
                    botChatContainer.style.display = 'flex';
                    this.updateBotChatMessages();
                    // éšè—å¤´åƒæŒ‰é’®
                    if (botAvatarButton) {
                        botAvatarButton.style.display = 'none';
                    }
                    console.log('âœ… æœºå™¨äººèŠå¤©çª—å£å·²æ‰“å¼€');
                } else {
                    // å…³é—­èŠå¤©çª—å£ - å¼ºåˆ¶å…³é—­
                    this.closeBotChat();
                }
            },
            
            // ä¸“é—¨ç”¨äºå…³é—­æœºå™¨äººèŠå¤©çª—å£çš„å‡½æ•°
            closeBotChat() {
                const botChatContainer = document.getElementById('bot-chat-container');
                const botAvatarButton = document.getElementById('bot-avatar-button');
                
                if (!botChatContainer) return;
                
                // å¼ºåˆ¶å…³é—­ - ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿ç”Ÿæ•ˆ
                botChatContainer.style.display = 'none';
                botChatContainer.setAttribute('style', (botChatContainer.getAttribute('style') || '').replace(/display\s*:\s*[^;!]*!?important?;?/gi, '') + ' display: none !important;');
                
                // æ˜¾ç¤ºå¤´åƒæŒ‰é’®å¹¶é‡ç½®transformå’ŒfilterçŠ¶æ€ï¼ˆé¿å…è¶…æ¡†ï¼‰
                if (botAvatarButton) {
                    botAvatarButton.style.display = 'block';
                    botAvatarButton.setAttribute('style', (botAvatarButton.getAttribute('style') || '').replace(/display\s*:\s*[^;!]*!?important?;?/gi, '') + ' display: block !important;');
                    // é‡ç½®transformå’Œfilterï¼Œé¿å…ç§»åŠ¨ç«¯ç‚¹å‡»åæ”¾å¤§çŠ¶æ€æ®‹ç•™
                    botAvatarButton.style.transform = 'scale(1)';
                    botAvatarButton.style.filter = 'drop-shadow(0 4px 15px rgba(79, 195, 247, 0.4))';
                }
                
                console.log('âœ… æœºå™¨äººèŠå¤©çª—å£å·²å¼ºåˆ¶å…³é—­');
            },

            // æ›´æ–°æœºå™¨äººèŠå¤©æ¶ˆæ¯æ˜¾ç¤º
            updateBotChatMessages() {
                const botMessagesContainer = document.getElementById('bot-chat-messages');
                if (!botMessagesContainer) return;

                const botId = 'totofun_bot';
                const messages = this.conversations[botId] || [];
                
                botMessagesContainer.innerHTML = '';

                if (messages.length === 0) {
                    botMessagesContainer.innerHTML = `
                        <div style="text-align: center; color: #999; padding: 20px;">
                            <div class="bot-sprite-animation" style="
                                width: 128px;
                                height: 128px;
                                min-width: 128px;
                                min-height: 128px;
                                max-width: 128px;
                                max-height: 128px;
                                margin: 0 auto 10px;
                                background-color: rgba(0, 0, 0, 0) !important;
                                border: none !important;
                                padding: 0 !important;
                                opacity: 1 !important;
                                object-fit: contain;
                                aspect-ratio: 1 / 1;
                            "></div>
                            <div>å¼€å§‹å’Œå°çªèŠå¤©å§ï¼</div>
                        </div>
                    `;
                    return;
                }

                messages.forEach(message => {
                    const isMe = message.from === this.currentUser.id;
                    const messageDiv = document.createElement('div');
                    messageDiv.style.cssText = `
                        margin-bottom: 15px;
                        display: flex;
                        justify-content: ${isMe ? 'flex-end' : 'flex-start'};
                        align-items: flex-start;
                        gap: 8px;
                    `;

                    if (!isMe) {
                        messageDiv.innerHTML += `
                            <div class="bot-sprite-animation" style="
                                width: 64px;
                                height: 64px;
                                min-width: 64px;
                                min-height: 64px;
                                max-width: 64px;
                                max-height: 64px;
                                background-color: transparent !important;
                                border: none !important;
                                padding: 0 !important;
                                margin: 0 !important;
                                flex-shrink: 0;
                                object-fit: contain;
                                aspect-ratio: 1 / 1;
                            "></div>
                        `;
                    }

                    messageDiv.innerHTML += `
                        <div style="
                            max-width: 70%;
                            padding: 10px 15px;
                            background: ${isMe ? '#4FC3F7' : '#e0e0e0'};
                            color: ${isMe ? 'white' : '#333'};
                            border-radius: 12px;
                            font-size: 14px;
                            line-height: 1.4;
                            word-wrap: break-word;
                        ">${this.escapeHtml(message.content)}</div>
                    `;

                    if (isMe) {
                        messageDiv.innerHTML += `
                            <div style="
                                width: 32px;
                                height: 32px;
                                background: #22C55E;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 16px;
                                flex-shrink: 0;
                                color: white;
                            ">${this.currentUser.name.charAt(0)}</div>
                        `;
                    }

                    botMessagesContainer.appendChild(messageDiv);
                });

                // æ»šåŠ¨åˆ°åº•éƒ¨
                botMessagesContainer.scrollTop = botMessagesContainer.scrollHeight;
            },

            // å‘é€æœºå™¨äººæ¶ˆæ¯
            sendBotMessage() {
                const input = document.getElementById('bot-chat-input');
                const content = input.value.trim();
                if (!content) return;

                const botId = 'totofun_bot';
                const message = this.sendMessage(botId, content, 'text');
                
                // æ›´æ–°æœºå™¨äººèŠå¤©æ¶ˆæ¯æ˜¾ç¤º
                this.updateBotChatMessages();
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';
                
                // ç­‰å¾…æœºå™¨äººå›å¤åå†æ¬¡æ›´æ–°
                setTimeout(() => {
                    this.updateBotChatMessages();
                }, 1000);
            },

            // æ ¼å¼åŒ–æ—¶é—´
            formatTime(timestamp) {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;

                if (diff < 60000) return 'åˆšåˆš';
                if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
                if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
                if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
                
                return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
            },

            // HTMLè½¬ä¹‰
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            // åˆå§‹åŒ–è¡¨æƒ…åˆ—è¡¨
            initEmojiList() {
                const emojiList = document.getElementById('emoji-list');
                if (!emojiList) return;
                
                // å¸¸ç”¨è¡¨æƒ…åˆ—è¡¨
                const emojis = [
                    'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£',
                    'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°',
                    'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ',
                    'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜',
                    'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'ğŸ˜£', 'ğŸ˜–',
                    'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡',
                    'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°',
                    'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶',
                    'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®',
                    'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤', 'ğŸ¥´',
                    'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ',
                    'ğŸ‘', 'ğŸ‘', 'ğŸ‘Š', 'âœŠ', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ¤', 'âœŒï¸',
                    'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ‘Œ', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ‘‡', 'â˜ï¸',
                    'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’ª',
                    'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤',
                    'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜',
                    'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ğŸ•‰', 'â˜¸ï¸', 'âœ¡ï¸',
                    'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›', 'â›', 'â™ˆ', 'â™‰',
                    'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™', 'â™‘',
                    'â™’', 'â™“', 'ğŸ†”', 'âš›ï¸', 'ğŸ‰‘', 'â˜¢ï¸', 'â˜£ï¸', 'ğŸ“´',
                    'ğŸ“³', 'ğŸˆ¶', 'ğŸˆš', 'ğŸˆ¸', 'ğŸˆº', 'ğŸˆ·ï¸', 'âœ´ï¸', 'ğŸ†š',
                    'ğŸ’®', 'ğŸ‰', 'ãŠ™ï¸', 'ãŠ—ï¸', 'ğŸˆ´', 'ğŸˆµ', 'ğŸˆ¹', 'ğŸˆ²',
                    'ğŸ…°ï¸', 'ğŸ…±ï¸', 'ğŸ†', 'ğŸ†‘', 'ğŸ…¾ï¸', 'ğŸ†˜', 'âŒ', 'â­•',
                    'ğŸ›‘', 'â›”', 'ğŸ“›', 'ğŸš«', 'ğŸ’¯', 'ğŸ’¢', 'â™¨ï¸', 'ğŸš·',
                    'ğŸš¯', 'ğŸš³', 'ğŸš±', 'ğŸ”', 'ğŸ“µ', 'ğŸš­', 'â—', 'â“',
                    'â•', 'â”', 'â€¼ï¸', 'â‰ï¸', 'ğŸ”…', 'ğŸ”†', 'ã€½ï¸', 'âš ï¸',
                    'ğŸš¸', 'ğŸ”±', 'âšœï¸', 'ğŸ”°', 'â™»ï¸', 'âœ…', 'ğŸˆ¯', 'ğŸ’¹',
                    'â‡ï¸', 'âœ³ï¸', 'â', 'ğŸŒ', 'ğŸ’ ', 'â“‚ï¸', 'ğŸŒ€', 'ğŸ’¤',
                    'ğŸ§', 'ğŸš¾', 'â™¿', 'ğŸ…¿ï¸', 'ğŸˆ³', 'ğŸˆ‚ï¸', 'ğŸ›‚', 'ğŸ›ƒ',
                    'ğŸ›„', 'ğŸ›…', 'ğŸš¹', 'ğŸšº', 'ğŸš¼', 'ğŸš»', 'ğŸš®', 'ğŸ¦',
                    'ğŸ“¶', 'ğŸˆ', 'ğŸ”£', 'â„¹ï¸', 'ğŸ”¤', 'ğŸ”¡', 'ğŸ” ', 'ğŸ†–',
                    'ğŸ†—', 'ğŸ†™', 'ğŸ†’', 'ğŸ†•', 'ğŸ†“', '0ï¸âƒ£', '1ï¸âƒ£', '2ï¸âƒ£',
                    '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ',
                    'ğŸ”¢', 'â–¶ï¸', 'â¸', 'â¯', 'â¹', 'âº', 'â­', 'â®',
                    'â©', 'âª', 'â«', 'â¬', 'â—€ï¸', 'ğŸ”¼', 'ğŸ”½', 'â¡ï¸',
                    'â¬…ï¸', 'â¬†ï¸', 'â¬‡ï¸', 'â†—ï¸', 'â†˜ï¸', 'â†™ï¸', 'â†–ï¸', 'â†•ï¸',
                    'â†”ï¸', 'â†ªï¸', 'â†©ï¸', 'â¤´ï¸', 'â¤µï¸', 'ğŸ”€', 'ğŸ”', 'ğŸ”‚',
                    'ğŸ”„', 'ğŸ”ƒ', 'ğŸµ', 'ğŸ¶', 'â•', 'â–', 'â—', 'âœ–ï¸',
                    'ğŸ’²', 'ğŸ’±', 'â„¢', 'Â©ï¸', 'Â®ï¸', 'ã€°ï¸', 'â°', 'â¿',
                    'ğŸ”š', 'ğŸ”™', 'ğŸ”›', 'ğŸ”œ', 'ğŸ”', 'ã€½ï¸', 'ğŸ”ƒ', 'ğŸ”„',
                    'ğŸ”™', 'ğŸ”š', 'ğŸ”›', 'ğŸ”œ', 'ğŸ”', 'ğŸ›', 'âš›ï¸', 'ğŸ•‰ï¸',
                    'â˜¸ï¸', 'â˜¯ï¸', 'âœ¡ï¸', 'â˜ªï¸', 'â˜¦ï¸', 'âœï¸', 'â˜®ï¸', 'ğŸ•',
                    'ğŸ”¯', 'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™',
                    'â™', 'â™', 'â™‘', 'â™’', 'â™“', 'â›', 'ğŸ”€', 'ğŸ”',
                    'ğŸ”‚', 'â–¶ï¸', 'â©', 'â­', 'â®', 'â¯', 'â¸', 'â¹',
                    'âº', 'â', 'ğŸ¦', 'ğŸ”…', 'ğŸ”†', 'ğŸ“¶', 'ğŸ“³', 'ğŸ“´',
                    'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™',
                    'â™', 'â™‘', 'â™’', 'â™“', 'â›', 'ğŸ”€', 'ğŸ”', 'ğŸ”‚',
                    'â–¶ï¸', 'â©', 'â­', 'â®', 'â¯', 'â¸', 'â¹', 'âº',
                    'â', 'ğŸ¦', 'ğŸ”…', 'ğŸ”†', 'ğŸ“¶', 'ğŸ“³', 'ğŸ“´', 'â™€ï¸',
                    'â™‚ï¸', 'âš§', 'âœ–ï¸', 'â•', 'â–', 'â—', 'â™¾', 'â€¼ï¸',
                    'â‰ï¸', 'â“', 'â”', 'â•', 'â—', 'ã€°ï¸', 'ğŸ’±', 'ğŸ’²',
                    'âš•ï¸', 'â™»ï¸', 'âš›ï¸', 'ğŸ›', 'ğŸ•‰ï¸', 'â˜¸ï¸', 'â˜¯ï¸', 'âœ¡ï¸',
                    'â˜ªï¸', 'â˜¦ï¸', 'âœï¸', 'â˜®ï¸', 'ğŸ•', 'ğŸ”¯', 'â™ˆ', 'â™‰',
                    'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™', 'â™‘',
                    'â™’', 'â™“', 'â›', 'ğŸ”€', 'ğŸ”', 'ğŸ”‚', 'â–¶ï¸', 'â©',
                    'â­', 'â®', 'â¯', 'â¸', 'â¹', 'âº', 'â', 'ğŸ¦',
                    'ğŸ”…', 'ğŸ”†', 'ğŸ“¶', 'ğŸ“³', 'ğŸ“´', 'â™€ï¸', 'â™‚ï¸', 'âš§',
                    'âœ–ï¸', 'â•', 'â–', 'â—', 'â™¾', 'â€¼ï¸', 'â‰ï¸', 'â“',
                    'â”', 'â•', 'â—', 'ã€°ï¸', 'ğŸ’±', 'ğŸ’²', 'âš•ï¸', 'â™»ï¸'
                ];
                
                emojiList.innerHTML = '';
                emojis.forEach(emoji => {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.textContent = emoji;
                    emojiBtn.style.cssText = `
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        padding: 5px;
                        border-radius: 5px;
                        transition: background 0.2s;
                    `;
                    emojiBtn.onmouseover = function() {
                        this.style.background = '#f0f0f0';
                    };
                    emojiBtn.onmouseout = function() {
                        this.style.background = 'none';
                    };
                    emojiBtn.onclick = () => {
                        this.insertEmoji(emoji);
                    };
                    emojiList.appendChild(emojiBtn);
                });
            },

            // åˆ‡æ¢è¡¨æƒ…é¢æ¿æ˜¾ç¤º/éšè—
            toggleEmojiPanel() {
                const emojiPanel = document.getElementById('emoji-panel');
                if (!emojiPanel) return;
                
                if (emojiPanel.style.display === 'none' || !emojiPanel.style.display) {
                    emojiPanel.style.display = 'block';
                    // å¦‚æœè¡¨æƒ…åˆ—è¡¨æœªåˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–
                    const emojiList = document.getElementById('emoji-list');
                    if (emojiList && emojiList.children.length === 0) {
                        this.initEmojiList();
                    }
                } else {
                    emojiPanel.style.display = 'none';
                }
            },

            // æ’å…¥è¡¨æƒ…åˆ°è¾“å…¥æ¡†
            insertEmoji(emoji) {
                const input = document.getElementById('chat-input');
                if (input) {
                    const cursorPos = input.selectionStart || input.value.length;
                    const textBefore = input.value.substring(0, cursorPos);
                    const textAfter = input.value.substring(cursorPos);
                    input.value = textBefore + emoji + textAfter;
                    input.focus();
                    // è®¾ç½®å…‰æ ‡ä½ç½®
                    const newPos = cursorPos + emoji.length;
                    input.setSelectionRange(newPos, newPos);
                }
            }
        };

        // åˆå§‹åŒ–èŠå¤©ç³»ç»Ÿ
        chatManager.init();
        chatManager.checkUrlParams();
        
        // å»¶è¿Ÿå¯åŠ¨spriteåŠ¨ç”»ï¼Œç¡®ä¿DOMå…ƒç´ å·²åˆ›å»º
        setTimeout(() => {
            if (chatManager.startBotSpriteAnimation) {
                chatManager.startBotSpriteAnimation();
            }
        }, 500);
        
        // ç§»åŠ¨ç«¯ï¼šæ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨ç¡®ä¿æŒ‰é’®å¯ç‚¹å‡»
        if (window.innerWidth <= 768) {
            // ä¸ºå…³é—­æŒ‰é’®æ·»åŠ é¢å¤–çš„è§¦æ‘¸äº‹ä»¶ç›‘å¬
            setTimeout(() => {
                const botCloseBtn = document.getElementById('bot-chat-close-btn');
                const chatCloseBtn = document.getElementById('chat-container-close-btn');
                const panelCloseBtn = document.getElementById('chat-panel-close-btn');
                
                if (botCloseBtn) {
                    botCloseBtn.addEventListener('touchend', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        chatManager.closeBotChat();
                    }, { passive: false });
                }
                
                if (chatCloseBtn) {
                    chatCloseBtn.addEventListener('touchend', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        chatManager.closeChatContainer();
                    }, { passive: false });
                }
                
                if (panelCloseBtn) {
                    panelCloseBtn.addEventListener('touchend', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        chatManager.closeChat();
                    }, { passive: false });
                }
            }, 500);
        }
        
        // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­è¡¨æƒ…é¢æ¿
        document.addEventListener('click', function(event) {
            const emojiPanel = document.getElementById('emoji-panel');
            const emojiButton = event.target.closest('button[onclick*="toggleEmojiPanel"]');
            
            if (emojiPanel && emojiPanel.style.display !== 'none') {
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯è¡¨æƒ…é¢æ¿å†…éƒ¨ï¼Œä¹Ÿä¸æ˜¯è¡¨æƒ…æŒ‰é’®ï¼Œåˆ™å…³é—­é¢æ¿
                if (!emojiPanel.contains(event.target) && !emojiButton) {
                    emojiPanel.style.display = 'none';
                }
            }
        });
    </script>

    <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="auth-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        z-index: 100000;
        align-items: center;
        justify-content: center;
    ">
        <div style="
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        ">
            <!-- å…³é—­æŒ‰é’® -->
            <button id="auth-modal-close" onclick="authManager.closeModal()" style="
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #999;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background 0.2s;
            " onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">Ã—</button>

            <!-- ç™»å½•è¡¨å• -->
            <div id="auth-login-form">
                <h2 style="margin-bottom: 20px; color: #333; text-align: center;">ğŸ” ç™»å½•</h2>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">é‚®ç®±</label>
                    <input type="email" id="login-email" placeholder="è¯·è¾“å…¥é‚®ç®±" style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #e0e0e0;
                        border-radius: 10px;
                        font-size: 16px;
                        box-sizing: border-box;
                    " />
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">å¯†ç </label>
                    <input type="password" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç " style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #e0e0e0;
                        border-radius: 10px;
                        font-size: 16px;
                        box-sizing: border-box;
                    " />
                </div>
                <button onclick="authManager.handleLogin()" style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    margin-bottom: 15px;
                ">ç™»å½•</button>
                <div style="text-align: center; color: #999; font-size: 14px;">
                    è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="authManager.showRegisterForm(); return false;" style="color: #4FC3F7; text-decoration: none;">ç«‹å³æ³¨å†Œ</a>
                </div>
                <div id="auth-login-error" style="
                    margin-top: 15px;
                    padding: 10px;
                    background: #fee;
                    color: #c33;
                    border-radius: 8px;
                    font-size: 14px;
                    display: none;
                "></div>
            </div>

            <!-- æ³¨å†Œè¡¨å• -->
            <div id="auth-register-form" style="display: none;">
                <h2 style="margin-bottom: 20px; color: #333; text-align: center;">âœ¨ æ³¨å†Œ</h2>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">ç”¨æˆ·å</label>
                    <input type="text" id="register-username" placeholder="3-20ä¸ªå­—ç¬¦ï¼Œæ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—" style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #e0e0e0;
                        border-radius: 10px;
                        font-size: 16px;
                        box-sizing: border-box;
                    " />
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">é‚®ç®±</label>
                    <input type="email" id="register-email" placeholder="è¯·è¾“å…¥é‚®ç®±" style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #e0e0e0;
                        border-radius: 10px;
                        font-size: 16px;
                        box-sizing: border-box;
                    " />
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">å¯†ç </label>
                    <input type="password" id="register-password" placeholder="è‡³å°‘6ä¸ªå­—ç¬¦" style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #e0e0e0;
                        border-radius: 10px;
                        font-size: 16px;
                        box-sizing: border-box;
                    " />
                </div>
                <button onclick="authManager.handleRegister()" style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    margin-bottom: 15px;
                ">æ³¨å†Œ</button>
                <div style="text-align: center; color: #999; font-size: 14px;">
                    å·²æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="authManager.showLoginForm(); return false;" style="color: #4FC3F7; text-decoration: none;">ç«‹å³ç™»å½•</a>
                </div>
                <div id="auth-register-error" style="
                    margin-top: 15px;
                    padding: 10px;
                    background: #fee;
                    color: #c33;
                    border-radius: 8px;
                    font-size: 14px;
                    display: none;
                "></div>
            </div>
        </div>
    </div>

    <!-- å°çªå¤´åƒæŒ‰é’®ï¼ˆå·¦ä¸‹è§’ï¼Œå…³é—­èŠå¤©çª—å£æ—¶æ˜¾ç¤ºï¼‰ -->
    <div id="bot-avatar-button" onclick="chatManager.openBotChat()" style="
        position: fixed;
        bottom: 30px;
        left: 30px;
        width: 160px;
        height: 160px;
        z-index: 9996;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
        background: none !important;
        background-color: rgba(0, 0, 0, 0) !important;
        line-height: 0 !important;
        overflow: visible !important;
    ">
        <div class="bot-sprite-animation" style="
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 15px rgba(79, 195, 247, 0.4));
            transition: transform 0.3s ease, filter 0.3s ease;
            transform-origin: center center;
            transform: scale(1);
            -webkit-transition: transform 0.3s ease, filter 0.3s ease;
            -moz-transition: transform 0.3s ease, filter 0.3s ease;
            -o-transition: transform 0.3s ease, filter 0.3s ease;
            -webkit-transform-origin: center center;
            -moz-transform-origin: center center;
            -ms-transform-origin: center center;
        " onmouseover="this.style.transform='scale(1.1)'; this.style.filter='drop-shadow(0 6px 20px rgba(79, 195, 247, 0.6))'" onmouseout="this.style.transform='scale(1)'; this.style.filter='drop-shadow(0 4px 15px rgba(79, 195, 247, 0.4))'" ontouchstart="this.style.transform='scale(1)'; this.style.filter='drop-shadow(0 4px 15px rgba(79, 195, 247, 0.4))'" ontouchend="this.style.transform='scale(1)'; this.style.filter='drop-shadow(0 4px 15px rgba(79, 195, 247, 0.4))'" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'width:100%;height:100%;background:linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:48px;color:white;\'>ğŸ¤–</div>';">
        </div>
    </div>

    <!-- æœºå™¨äººèŠå¤©çª—å£ï¼ˆå·¦ä¸‹è§’ï¼‰ -->
    <div id="bot-chat-container" style="
        position: fixed;
        bottom: 30px;
        left: 30px;
        width: 350px;
        height: 450px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        display: none !important;
        flex-direction: column;
        overflow: hidden;
    ">
        <!-- æœºå™¨äººèŠå¤©å¤´éƒ¨ -->
        <div style="
            background: linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: bold;
        ">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="bot-sprite-animation" style="
                    width: 64px;
                    height: 64px;
                    min-width: 64px;
                    min-height: 64px;
                    max-width: 64px;
                    max-height: 64px;
                    background-color: rgba(0, 0, 0, 0) !important;
                    border: none !important;
                    padding: 0 !important;
                    margin: 0 !important;
                    opacity: 1 !important;
                    flex-shrink: 0;
                    object-fit: contain;
                    aspect-ratio: 1 / 1;
                    transition: none !important;
                    -webkit-transition: none !important;
                    -moz-transition: none !important;
                    -o-transition: none !important;
                "></div>
                <div>
                    <div style="font-size: 16px;">å°çª AIåŠ©æ‰‹</div>
                    <div style="font-size: 11px; opacity: 0.9;">æ™ºèƒ½å¯»å®ä¼™ä¼´</div>
                </div>
            </div>
            <button id="bot-chat-close-btn" onclick="chatManager.toggleBotChat(event)" ontouchstart="chatManager.toggleBotChat(event)" style="
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                width: 44px;
                height: 44px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 20px;
                line-height: 1;
                flex-shrink: 0;
                z-index: 10001;
                position: relative;
                pointer-events: auto !important;
                -webkit-tap-highlight-color: rgba(255, 255, 255, 0.3);
                touch-action: manipulation;
                min-width: 44px;
                min-height: 44px;
                user-select: none;
                -webkit-user-select: none;
            ">Ã—</button>
        </div>
        
        <!-- æœºå™¨äººèŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->
        <div id="bot-chat-messages" style="
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px;
            background: #f5f5f5;
            min-height: 0;
            box-sizing: border-box;
        "></div>
        
        <!-- æœºå™¨äººèŠå¤©è¾“å…¥æ¡† -->
        <div style="
            padding: 10px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            position: relative;
            z-index: 10004;
            flex-shrink: 0;
        ">
            <input type="text" id="bot-chat-input" placeholder="é—®å°çª..." style="
                flex: 1;
                padding: 10px 15px;
                border: 1px solid #e0e0e0;
                border-radius: 20px;
                outline: none;
                font-size: 14px;
                position: relative;
                z-index: 10005;
            " onkeypress="if(event.key === 'Enter') chatManager.sendBotMessage()">
            <button onclick="chatManager.sendBotMessage()" style="
                background: #4FC3F7;
                border: none;
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                position: relative;
                z-index: 10005;
                cursor: pointer;
                font-size: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
            ">ğŸ“¤</button>
        </div>
    </div>

    <!-- èŠå¤©æµ®åŠ¨æŒ‰é’® -->
    <div id="chat-fab" onclick="chatManager.toggleChat()" style="
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(79, 195, 247, 0.5);
        z-index: 9999;
        transition: all 0.3s ease;
        font-size: 28px;
    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        ğŸ’¬
        <div id="chat-badge" style="
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f44336;
            color: white;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            display: none;
            min-width: 20px;
            text-align: center;
        "></div>
    </div>

    <!-- èŠå¤©å®¹å™¨ -->
    <div id="chat-container" style="
        display: none !important;
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 380px;
        height: 600px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        z-index: 9998;
        overflow: hidden;
        flex-direction: column;
    ">
        <!-- å¥½å‹åˆ—è¡¨é¢æ¿ -->
        <div id="friends-panel" style="
            display: flex;
            flex-direction: column;
            height: 100%;
        ">
            <div style="
                background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
                color: white;
                padding: 20px;
                font-weight: bold;
                font-size: 18px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <span>ğŸ’¬ å¥½å‹èŠå¤©</span>
                <div style="display: flex; gap: 10px;">
                    <button onclick="chatManager.showAddFriend()" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: none;
                        color: white;
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 18px;
                        line-height: 1;
                    " title="æ·»åŠ å¥½å‹">+</button>
                    <button onclick="chatManager.showMyProfile()" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: none;
                        color: white;
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 16px;
                        line-height: 1;
                    " title="æˆ‘çš„ä¿¡æ¯">ğŸ‘¤</button>
                    <button id="chat-container-close-btn" onclick="chatManager.toggleChat(event)" ontouchstart="chatManager.toggleChat(event)" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: none;
                        color: white;
                        width: 44px;
                        height: 44px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 20px;
                        line-height: 1;
                        flex-shrink: 0;
                        z-index: 10001;
                        position: relative;
                        pointer-events: auto !important;
                        -webkit-tap-highlight-color: rgba(255, 255, 255, 0.3);
                        touch-action: manipulation;
                        min-width: 44px;
                        min-height: 44px;
                        user-select: none;
                        -webkit-user-select: none;
                    ">Ã—</button>
                </div>
            </div>
            <div id="friends-list" style="
                flex: 1;
                overflow-y: auto;
                overflow-x: visible;
                padding: 8px 5px;
                width: 100%;
                box-sizing: border-box;
            "></div>
        </div>

        <!-- èŠå¤©é¢æ¿ -->
        <div id="chat-panel" style="
            display: none;
            flex-direction: column;
            height: 100%;
        ">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div style="
                background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
                color: white;
                padding: 15px 20px;
                display: flex;
                align-items: center;
                gap: 15px;
            ">
                <button id="chat-panel-close-btn" onclick="chatManager.closeChat(event)" ontouchstart="chatManager.closeChat(event)" style="
                    background: rgba(255, 255, 255, 0.2);
                    border: none;
                    color: white;
                    width: 44px;
                    height: 44px;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 20px;
                    line-height: 1;
                    flex-shrink: 0;
                    z-index: 10001;
                    position: relative;
                    pointer-events: auto !important;
                    -webkit-tap-highlight-color: rgba(255, 255, 255, 0.3);
                    touch-action: manipulation;
                    min-width: 44px;
                    min-height: 44px;
                    user-select: none;
                    -webkit-user-select: none;
                ">â†</button>
                <div id="chat-friend-avatar" style="font-size: 24px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; overflow: hidden;"></div>
                <div style="flex: 1;">
                    <div id="chat-friend-name" style="font-weight: bold; font-size: 16px;"></div>
                    <div id="chat-friend-status" style="font-size: 12px; opacity: 0.9;"></div>
                </div>
                <button onclick="chatManager.clearChatHistory()" style="
                    background: rgba(255, 255, 255, 0.2);
                    border: none;
                    color: white;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 16px;
                    line-height: 1;
                    margin-left: 10px;
                " title="æ¸…ç©ºèŠå¤©è®°å½•">ğŸ—‘ï¸</button>
            </div>

            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <div id="chat-messages-list" style="
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                padding-bottom: 80px;
                background: #f5f5f5;
                min-height: 0;
                box-sizing: border-box;
            "></div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div style="
                position: relative;
                flex-shrink: 0;
                z-index: 100;
                background: white;
            ">
                <!-- è¡¨æƒ…é€‰æ‹©é¢æ¿ -->
                <div id="emoji-panel" style="
                    display: none;
                    position: absolute;
                    bottom: 60px;
                    left: 50px;
                    width: 300px;
                    height: 200px;
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-radius: 15px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                    padding: 15px;
                    z-index: 10000;
                    overflow-y: auto;
                ">
                    <div style="
                        display: grid;
                        grid-template-columns: repeat(8, 1fr);
                        gap: 8px;
                    " id="emoji-list">
                        <!-- è¡¨æƒ…åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div style="
                    padding: 15px;
                    background: white;
                    border-top: 1px solid #e0e0e0;
                    display: flex;
                    gap: 10px;
                    align-items: center;
                    position: relative;
                    z-index: 100;
                    flex-shrink: 0;
                ">
                    <button onclick="chatManager.shareLocation()" style="
                        background: #4FC3F7;
                        border: none;
                        color: white;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 20px;
                        flex-shrink: 0;
                    " title="åˆ†äº«ä½ç½®">ğŸ“</button>
                    <button onclick="chatManager.toggleEmojiPanel()" style="
                        background: #FFA500;
                        border: none;
                        color: white;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 20px;
                        flex-shrink: 0;
                    " title="è¡¨æƒ…">ğŸ˜Š</button>
                    <input id="chat-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." style="
                        flex: 1;
                        padding: 10px 15px;
                        border: 1px solid #e0e0e0;
                        border-radius: 20px;
                        outline: none;
                        font-size: 14px;
                    " onkeypress="if(event.key==='Enter') chatManager.sendTextMessage()">
                    <button onclick="chatManager.sendTextMessage()" style="
                        background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
                        border: none;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-weight: bold;
                        flex-shrink: 0;
                    ">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¥½å‹é¢æ¿ -->
    <div id="add-friend-panel" style="
        display: none;
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 380px;
        height: 500px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        overflow: hidden;
        flex-direction: column;
    ">
        <div style="
            background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
            color: white;
            padding: 20px;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        ">
            <span>â• æ·»åŠ å¥½å‹</span>
            <button onclick="chatManager.closeAddFriend()" style="
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 20px;
                line-height: 1;
            ">Ã—</button>
        </div>
        
        <div style="padding: 20px; flex: 1; overflow-y: auto;">
            <!-- è¾“å…¥å¥½å‹ID -->
            <div style="margin-bottom: 25px;">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">é€šè¿‡IDæ·»åŠ </h3>
                <input id="friend-id-input" type="text" placeholder="è¾“å…¥å¥½å‹ID" style="
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #e0e0e0;
                    border-radius: 10px;
                    font-size: 14px;
                    margin-bottom: 10px;
                    box-sizing: border-box;
                ">
                <button onclick="chatManager.addFriendById()" style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 14px;
                ">æ·»åŠ å¥½å‹</button>
            </div>

            <!-- åˆ†äº«æˆ‘çš„ID -->
            <div style="margin-bottom: 25px;">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">åˆ†äº«æˆ‘çš„ID</h3>
                <div style="
                    background: #f5f5f5;
                    padding: 15px;
                    border-radius: 10px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                ">
                    <input id="my-id-display" type="text" readonly style="
                        flex: 1;
                        padding: 10px;
                        border: 1px solid #e0e0e0;
                        border-radius: 8px;
                        font-family: monospace;
                        font-size: 13px;
                        background: white;
                    ">
                    <button onclick="chatManager.copyMyId()" style="
                        padding: 10px 15px;
                        background: #4FC3F7;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 13px;
                        white-space: nowrap;
                    ">å¤åˆ¶</button>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 8px;">
                    ğŸ’¡ å°†æ­¤IDå‘é€ç»™æœ‹å‹ï¼Œè®©ä»–ä»¬æ·»åŠ ä½ 
                </p>
            </div>

            <!-- ç”Ÿæˆåˆ†äº«é“¾æ¥ -->
            <div style="margin-bottom: 25px;">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">ç”Ÿæˆåˆ†äº«é“¾æ¥</h3>
                <button onclick="chatManager.generateShareLink()" style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, #22C55E 0%, #4FC3F7 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 14px;
                ">ğŸ”— ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
                <p style="font-size: 12px; color: #666; margin-top: 8px;">
                    ğŸ’¡ ç”Ÿæˆä¸€ä¸ªé“¾æ¥ï¼Œæœ‹å‹ç‚¹å‡»åè‡ªåŠ¨æ·»åŠ ä½ ä¸ºå¥½å‹
                </p>
            </div>

            <!-- æ‰«æäºŒç»´ç ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰ -->
            <div style="
                background: #f9f9f9;
                padding: 15px;
                border-radius: 10px;
                text-align: center;
                border: 2px dashed #ddd;
            ">
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“±</div>
                <p style="color: #999; font-size: 13px;">æ‰«æäºŒç»´ç æ·»åŠ å¥½å‹</p>
                <p style="color: #999; font-size: 12px; margin-top: 5px;">ï¼ˆå³å°†æ¨å‡ºï¼‰</p>
            </div>
        </div>
    </div>

    <!-- æˆ‘çš„ä¿¡æ¯é¢æ¿ -->
    <div id="my-profile-panel" style="
        display: none;
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 380px;
        height: 500px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        overflow: hidden;
        flex-direction: column;
    ">
        <div style="
            background: linear-gradient(135deg, #4FC3F7 0%, #22C55E 100%);
            color: white;
            padding: 20px;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        ">
            <span>ğŸ‘¤ æˆ‘çš„ä¿¡æ¯</span>
            <button onclick="chatManager.closeMyProfile()" style="
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 20px;
                line-height: 1;
            ">Ã—</button>
        </div>
        
        <div style="padding: 20px; flex: 1; overflow-y: auto;">
            <!-- å¤´åƒå’Œæ˜µç§° -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div id="profile-avatar" style="
                    font-size: 80px;
                    margin-bottom: 15px;
                ">ğŸ‘¤</div>
                <input id="profile-name-input" type="text" placeholder="è¾“å…¥æ˜µç§°" style="
                    width: 200px;
                    padding: 10px;
                    border: 2px solid #e0e0e0;
                    border-radius: 10px;
                    font-size: 16px;
                    text-align: center;
                    font-weight: bold;
                ">
                <button onclick="chatManager.updateProfile()" style="
                    display: block;
                    margin: 10px auto 0;
                    padding: 8px 20px;
                    background: #4FC3F7;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 13px;
                ">ä¿å­˜</button>
            </div>

            <!-- æˆ‘çš„ID -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 14px;">æˆ‘çš„ID</h3>
                <div style="
                    background: #f5f5f5;
                    padding: 12px;
                    border-radius: 8px;
                    font-family: monospace;
                    font-size: 13px;
                    word-break: break-all;
                " id="profile-my-id"></div>
            </div>

            <!-- é€‰æ‹©å¤´åƒ -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 14px;">é€‰æ‹©å¤´åƒ</h3>
                <div id="avatar-selector" style="
                    display: grid;
                    grid-template-columns: repeat(5, 1fr);
                    gap: 10px;
                ">
                    <!-- å¤´åƒé€‰é¡¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div style="
                background: linear-gradient(135deg, #f5f5f5 0%, #e9ecef 100%);
                padding: 15px;
                border-radius: 10px;
            ">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 14px;">ç»Ÿè®¡</h3>
                <div style="display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #4FC3F7;" id="profile-friends-count">0</div>
                        <div style="font-size: 12px; color: #666;">å¥½å‹</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #22C55E;" id="profile-messages-count">0</div>
                        <div style="font-size: 12px; color: #666;">æ¶ˆæ¯</div>
                    </div>
                </div>
            </div>

            <!-- DeepSeek API é…ç½® -->
            <div style="
                background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%);
                padding: 15px;
                border-radius: 10px;
                margin-top: 15px;
                border: 2px solid #4FC3F7;
            ">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 14px; display: flex; align-items: center; gap: 5px;">
                    ğŸ¤– AI èŠå¤©æœåŠ¡
                    <span id="deepseek-status" style="
                        font-size: 10px;
                        padding: 2px 6px;
                        border-radius: 10px;
                        background: #22C55E;
                        color: white;
                        font-weight: normal;
                    ">å·²å¯ç”¨</span>
                </h3>
                <div style="
                    padding: 10px;
                    background: rgba(255, 255, 255, 0.7);
                    border-radius: 8px;
                    font-size: 12px;
                    color: #666;
                    line-height: 1.6;
                    margin-bottom: 8px;
                ">
                    âœ… èŠå¤©åŠŸèƒ½å·²å¯ç”¨ï¼Œæ— éœ€é…ç½®API Key<br>
                    ğŸ’¡ ä½¿ç”¨æœåŠ¡å™¨AIæœåŠ¡ï¼Œå®‰å…¨ä¾¿æ·<br>
                    ğŸ® ç›´æ¥å’Œå°çªèŠå¤©å³å¯ä½¿ç”¨AIåŠŸèƒ½
                </div>
                <!-- éšè—çš„API Keyè¾“å…¥ï¼ˆä¿ç•™ç”¨äºé«˜çº§ç”¨æˆ·ï¼Œé»˜è®¤éšè—ï¼‰ -->
                <div style="display: none;">
                    <input id="deepseek-api-key-input" type="password" placeholder="è¾“å…¥DeepSeek API Key (sk-...)" style="
                        width: 100%;
                        padding: 10px;
                        border: 2px solid #ffd699;
                        border-radius: 8px;
                        font-size: 13px;
                        margin-bottom: 8px;
                        font-family: monospace;
                        box-sizing: border-box;
                    ">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="chatManager.saveDeepSeekApiKey()" style="
                            flex: 1;
                            padding: 8px;
                            background: #4FC3F7;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: bold;
                        ">ğŸ’¾ ä¿å­˜</button>
                        <button onclick="chatManager.testDeepSeekApi()" style="
                            flex: 1;
                            padding: 8px;
                            background: #22C55E;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: bold;
                        ">ğŸ§ª æµ‹è¯•</button>
                    </div>
                </div>
                <p style="font-size: 11px; color: #666; margin-top: 8px; line-height: 1.4;">
                    ğŸ’¡ AIæœåŠ¡ç”±æœåŠ¡å™¨æä¾›ï¼ŒAPI Keyå®‰å…¨ä¿å­˜åœ¨åç«¯<br>
                    ğŸ”’ æ‚¨çš„éšç§å’Œæ•°æ®å®‰å…¨å—åˆ°ä¿æŠ¤
                </p>
            </div>
            
            <!-- å¥½å‹åˆ—è¡¨ -->
            <div style="
                background: linear-gradient(135deg, #f5f5f5 0%, #e9ecef 100%);
                padding: 15px;
                border-radius: 10px;
                margin-top: 15px;
            ">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 14px;">æˆ‘çš„å¥½å‹</h3>
                <div id="profile-friends-list" style="
                    max-height: 200px;
                    overflow-y: auto;
                ">
                    <!-- å¥½å‹åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>

