<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊäñÂÆù - GPSÂØªÂÆùÊ∏∏Êàè</title>
    <meta name="description" content="Âü∫‰∫éGPSÂÆö‰ΩçÁöÑÂÆûÊó∂ÂØªÂÆùÊ∏∏ÊàèÔºåÊîØÊåÅÈ´òÂæ∑Âú∞Âõæ">
    <meta name="keywords" content="GPSÂØªÂÆù,ÊäñÈü≥,È´òÂæ∑Âú∞Âõæ,ÂÆö‰ΩçÊ∏∏Êàè">
    
    <!-- PWAÊîØÊåÅ -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: system-ui, -apple-system, 'PingFang SC', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            color: white;
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .stat {
            text-align: center;
            color: white;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin: 20px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .api-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .api-input:focus {
            border-color: #667eea;
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover:before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn:disabled:before {
            display: none;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status.info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%);
            color: #1976d2;
            border: 1px solid #2196F3;
        }
        
        .status.success {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            color: #2e7d32;
            border: 1px solid #4CAF50;
        }
        
        .status.error {
            background: linear-gradient(135deg, #ffebee 0%, #ffeef0 100%);
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .status.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #fffbf0 100%);
            color: #856404;
            border: 1px solid #ffc107;
        }
        
        #map-container {
            width: 100%;
            height: 60vh;
            min-height: 400px;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid #e1e5e9;
            margin: 20px 0;
            position: relative;
            background: #f8f9fa;
        }
        
        .map-placeholder {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
            color: #666; 
            flex-direction: column;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .map-placeholder-icon {
            font-size: 4rem; 
            margin-bottom: 20px;
            opacity: 0.6;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .controls {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .gps-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .gps-info h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .gps-data {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 0.9rem;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            line-height: 1.5;
        }
        
        .tutorial {
            background: linear-gradient(135deg, #fff3cd 0%, #fffbf0 100%);
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            font-size: 0.95rem;
        }
        
        .tutorial h4 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .tutorial ol {
            margin-left: 20px;
        }
        
        .tutorial li {
            margin: 8px 0;
        }
        
        .tutorial a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .tutorial a:hover {
            text-decoration: underline;
        }
        
        .features {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        @media (min-width: 768px) {
            .features {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .feature {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .feature:hover {
            transform: translateY(-5px);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .feature h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üó∫Ô∏è ÊäñÂÆù</h1>
            <p class="subtitle">Âü∫‰∫éGPSÁöÑÂÆûÊó∂ÂØªÂÆùÊ∏∏Êàè</p>
            <div class="hero-stats">
                <div class="stat">
                    <span class="stat-number" id="online-users">0</span>
                    <span class="stat-label">Âú®Á∫øÁî®Êà∑</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="total-treasures">0</span>
                    <span class="stat-label">ÂÆùËóèÊÄªÊï∞</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="accuracy">0m</span>
                    <span class="stat-label">ÂÆö‰ΩçÁ≤æÂ∫¶</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>üîë È´òÂæ∑Âú∞ÂõæÈÖçÁΩÆ</h3>
            <div class="input-group">
                <label for="api-key">È´òÂæ∑Âú∞ÂõæAPI Key:</label>
                <input type="password" id="api-key" class="api-input" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÈ´òÂæ∑Âú∞ÂõæWebÊúçÂä°API Key">
            </div>
            <button class="btn" onclick="initMap()">
                <span id="init-btn-text">üöÄ ÂêØÂä®ÂØªÂÆù‰πãÊóÖ</span>
            </button>
            
            <div class="tutorial">
                <h4>üìã Âø´ÈÄüÂºÄÂßãÊåáÂçó:</h4>
                <ol>
                    <li>Áî≥ËØ∑<a href="https://console.amap.com/" target="_blank">È´òÂæ∑Âú∞ÂõæAPI Key</a></li>
                    <li>ËæìÂÖ•API KeyÂπ∂ÁÇπÂáªÂêØÂä®</li>
                    <li>ÂÖÅËÆ∏ÊµèËßàÂô®Ëé∑Âèñ‰ΩçÁΩÆÊùÉÈôê</li>
                    <li>Âú®Êà∑Â§ñÁéØÂ¢É‰∏≠Ëé∑ÂæóÊúÄ‰Ω≥GPS‰ΩìÈ™å</li>
                    <li>ÂºÄÂßãÂØªÊâæÈôÑËøëÁöÑÂÆùËóèÔºÅ</li>
                </ol>
                
                <h4>üîß ÁßªÂä®Á´ØË∞ÉËØï:</h4>
                <p style="font-size: 0.85rem; color: #666;">
                    ‚Ä¢ ÈïøÊåâGPS‰ø°ÊÅØÂå∫ÂüüÊü•ÁúãËØ¶ÁªÜË∞ÉËØï‰ø°ÊÅØ<br>
                    ‚Ä¢ Â¶ÇÊûúÂÆö‰ΩçÂ§±Ë¥•Ôºå‰ºöËá™Âä®‰ΩøÁî®‰∏äÊµ∑‰ΩçÁΩÆ<br>
                    ‚Ä¢ Á°Æ‰øùÂú®HTTPSÁéØÂ¢É‰∏ã‰ΩøÁî®ÔºàGitHub PagesËá™Âä®ÊîØÊåÅÔºâ<br>
                    ‚Ä¢ ÈîÆÁõòÂø´Êç∑ÈîÆ: Ctrl+S ÂàáÊç¢Âà∞‰∏äÊµ∑‰ΩçÁΩÆÔºåCtrl+D ÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ
                </p>
            </div>
            
            <div class="status info" id="status">
                <span>üîÑ</span>
                <span>Á≠âÂæÖÈÖçÁΩÆAPI KeyÂêØÂä®Âú∞ÂõæÊúçÂä°...</span>
            </div>
        </div>

        <div class="features">
            <div class="feature">
                <div class="feature-icon">üì±</div>
                <h4>ÁßªÂä®Á´Ø‰ºòÂåñ</h4>
                <p>‰∏ì‰∏∫ÊâãÊú∫Á´ØËÆæËÆ°ÔºåÊîØÊåÅËß¶Êë∏Êìç‰ΩúÂíåÂìçÂ∫îÂºèÂ∏ÉÂ±Ä</p>
            </div>
            <div class="feature">
                <div class="feature-icon">üéØ</div>
                <h4>Á≤æÂáÜÂÆö‰Ωç</h4>
                <p>‰ΩøÁî®È´òÁ≤æÂ∫¶GPSÂÆö‰ΩçÔºåÊîØÊåÅÂÆ§Â§ñÁ≤æÁ°ÆÂØªÂÆù</p>
            </div>
            <div class="feature">
                <div class="feature-icon">üèÜ</div>
                <h4>Â§öÁßçÂÆùËóè</h4>
                <p>ÈíªÁü≥„ÄÅÁöáÂÜ†„ÄÅÈáëÂ∏ÅÁ≠âÂ§öÁßçÂÆùËóèÁ±ªÂûãÁ≠â‰Ω†ÂèëÁé∞</p>
            </div>
            <div class="feature">
                <div class="feature-icon">üåç</div>
                <h4>ÂÆûÊó∂Âú∞Âõæ</h4>
                <p>Âü∫‰∫éÈ´òÂæ∑Âú∞ÂõæÁöÑÂÆûÊó∂‰ΩçÁΩÆÊòæÁ§∫ÂíåÂØºËà™</p>
            </div>
        </div>

        <div class="card">
            <h3>üìç GPSÁä∂ÊÄÅ‰ø°ÊÅØ</h3>
            <div class="gps-info">
                <h4>ÂΩìÂâç‰ΩçÁΩÆ‰ø°ÊÅØ:</h4>
                <div class="gps-data" id="gps-data">
                    Á≠âÂæÖËé∑ÂèñGPSÊï∞ÊçÆ...
                </div>
            </div>
        </div>

        <div class="card">
            <div id="map-container">
                <div class="map-placeholder">
                    <div class="map-placeholder-icon pulse">üó∫Ô∏è</div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">Âú∞ÂõæÂç≥Â∞ÜÂä†ËΩΩ</div>
                        <div style="color: #888;">ÈÖçÁΩÆAPI KeyÂêéÂç≥ÂèØÊòæÁ§∫È´òÂæ∑Âú∞Âõæ</div>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="testGPS()" disabled id="gps-btn">
                    üìç ÈáçÊñ∞ÂÆö‰Ωç
                </button>
                <button class="btn" onclick="generateNearbyTreasures()" disabled id="generate-btn">
                    üó∫Ô∏è ÁîüÊàêÂÆùËóè
                </button>
                <button class="btn" onclick="addTreasure()" disabled id="treasure-btn">
                    ‚ú® Ê∑ªÂä†ÂÆùËóè
                </button>
                <button class="btn" onclick="clearMap()" disabled id="clear-btn">
                    üóëÔ∏è Ê∏ÖÁ©∫Âú∞Âõæ
                </button>
                <button class="btn" onclick="emergencyTest()" style="background: #ff6b6b;">
                    üö® Á¥ßÊÄ•ÊµãËØï
                </button>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let map = null;
        let userMarker = null;
        let treasureMarkers = [];
        let userLocation = null;
        let watchId = null;

        // Áî®Êà∑Êï∞ÊçÆÁÆ°ÁêÜ
        let userData = {
            username: '',
            level: {
                currentLevel: 1,
                experience: 0,
                badges: []
            },
            stats: {
                treasuresCreated: 0,
                treasuresDiscovered: 0,
                totalLikes: 0,
                totalViews: 0
            },
            preferences: {
                interests: [],
                explorationRadius: 5000,
                language: 'zh-CN'
            },
            discoveredTreasures: [],
            createdTreasures: [],
            achievements: [],
            lastActiveAt: new Date()
        };

        // Êú¨Âú∞Â≠òÂÇ®ÁÆ°ÁêÜ
        const storageManager = {
            save: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Â≠òÂÇ®Â§±Ë¥•:', error);
                    return false;
                }
            },
            load: (key) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('ËØªÂèñÂ§±Ë¥•:', error);
                    return null;
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('Âà†Èô§Â§±Ë¥•:', error);
                    return false;
                }
            }
        };

        // ÂÆåÊï¥ÁöÑÂÆùËóèÁ±ªÂûãÁ≥ªÁªüÔºàÂü∫‰∫éÊï∞ÊçÆÊ®°ÂûãÔºâ
        const treasureTypes = [
            { 
                icon: 'üíé', 
                name: 'ÈíªÁü≥ÂÆùËóè', 
                color: '#e74c3c', 
                rarity: 'legendary',
                category: 'ÊëÑÂΩ±',
                rewards: { experience: 100, coins: 50 },
                discoveryRadius: 30
            },
            { 
                icon: 'üëë', 
                name: 'ÁöáÂÜ†ÂÆùËóè', 
                color: '#9b59b6', 
                rarity: 'epic',
                category: 'ÂéÜÂè≤',
                rewards: { experience: 80, coins: 40 },
                discoveryRadius: 35
            },
            { 
                icon: 'üí∞', 
                name: 'ÈáëÂ∏ÅÂÆùËóè', 
                color: '#f1c40f', 
                rarity: 'rare',
                category: 'Ë¥≠Áâ©',
                rewards: { experience: 60, coins: 30 },
                discoveryRadius: 40
            },
            { 
                icon: 'üè∫', 
                name: 'Âè§Ëë£ÂÆùËóè', 
                color: '#e67e22', 
                rarity: 'uncommon',
                category: 'Ëâ∫ÊúØ',
                rewards: { experience: 40, coins: 20 },
                discoveryRadius: 45
            },
            { 
                icon: 'üíç', 
                name: 'ÊàíÊåáÂÆùËóè', 
                color: '#3498db', 
                rarity: 'common',
                category: 'ÁæéÈ£ü',
                rewards: { experience: 20, coins: 10 },
                discoveryRadius: 50
            },
            { 
                icon: 'üé≠', 
                name: 'Èù¢ÂÖ∑ÂÆùËóè', 
                color: '#8e44ad', 
                rarity: 'rare',
                category: 'Èü≥‰πê',
                rewards: { experience: 55, coins: 25 },
                discoveryRadius: 40
            },
            { 
                icon: '‚öîÔ∏è', 
                name: 'Á•ûÂô®ÂÆùËóè', 
                color: '#2c3e50', 
                rarity: 'legendary',
                category: 'ËøêÂä®',
                rewards: { experience: 120, coins: 60 },
                discoveryRadius: 25
            },
            { 
                icon: 'üèÜ', 
                name: 'Â•ñÊùØÂÆùËóè', 
                color: '#f39c12', 
                rarity: 'epic',
                category: 'ÊóÖÊ∏∏',
                rewards: { experience: 90, coins: 45 },
                discoveryRadius: 30
            }
        ];

        // Áî®Êà∑Á≠âÁ∫ßÁ≥ªÁªü
        const levelSystem = {
            getLevel: (experience) => Math.floor(Math.sqrt(experience / 100)) + 1,
            getExpForLevel: (level) => Math.pow(level - 1, 2) * 100,
            getExpToNext: (currentExp) => {
                const currentLevel = levelSystem.getLevel(currentExp);
                const nextLevelExp = levelSystem.getExpForLevel(currentLevel + 1);
                return nextLevelExp - currentExp;
            }
        };

        // ÂæΩÁ´†Á≥ªÁªü
        const badgeSystem = [
            { name: 'first_treasure', icon: 'üéØ', title: 'ÂàùÊé¢ËÄÖ', description: 'ÂèëÁé∞Á¨¨‰∏Ä‰∏™ÂÆùËóè' },
            { name: 'treasure_hunter', icon: 'üèÉ', title: 'ÂØªÂÆùÁåé‰∫∫', description: 'ÂèëÁé∞10‰∏™ÂÆùËóè' },
            { name: 'treasure_master', icon: 'üëë', title: 'ÂØªÂÆùÂ§ßÂ∏à', description: 'ÂèëÁé∞50‰∏™ÂÆùËóè' },
            { name: 'legendary_finder', icon: 'üíé', title: '‰º†Â•áÂèëÁé∞ËÄÖ', description: 'ÂèëÁé∞‰º†Â•áÁ∫ßÂÆùËóè' },
            { name: 'category_expert', icon: 'üéì', title: 'ÂàÜÁ±ª‰∏ìÂÆ∂', description: 'Âú®ÊØè‰∏™ÂàÜÁ±ª‰∏≠ÈÉΩÂèëÁé∞ÂÆùËóè' },
            { name: 'speed_runner', icon: '‚ö°', title: 'Èó™Áîµ‰æ†', description: '1Â∞èÊó∂ÂÜÖÂèëÁé∞5‰∏™ÂÆùËóè' },
            { name: 'explorer', icon: 'üó∫Ô∏è', title: 'Êé¢Èô©ÂÆ∂', description: 'Êé¢Á¥¢Ë∂ÖËøá5ÂÖ¨ÈáåËåÉÂõ¥' },
            { name: 'social_star', icon: '‚≠ê', title: 'Á§æ‰∫§‰πãÊòü', description: 'ÂàõÂª∫ÁöÑÂÆùËóèË¢´ÂèëÁé∞100Ê¨°' }
        ];

        // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
        function updateStatus(message, type = 'info', showLoading = false) {
            const status = document.getElementById('status');
            const iconMap = {
                info: 'üîÑ',
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };
            
            const icon = showLoading ? '<span class="loading"></span>' : iconMap[type];
            status.innerHTML = `${icon}<span>${message}</span>`;
            status.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Êõ¥Êñ∞GPSÊï∞ÊçÆÊòæÁ§∫
        function updateGPSData(data) {
            const gpsData = document.getElementById('gps-data');
            gpsData.innerHTML = data;
        }

        // ÂÆùËóèÁÆ°ÁêÜÁ≥ªÁªü
        const treasureManager = {
            // ÂàõÂª∫ÂÆùËóèÊï∞ÊçÆ
            createTreasure: (position, type, creator = 'system') => {
                const treasure = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    title: type.name,
                    description: `‰∏Ä‰∏™ÁèçË¥µÁöÑ${type.name}ÔºåÁ≠âÂæÖÁùÄÂãáÊï¢ÁöÑÊé¢Èô©ËÄÖÊù•ÂèëÁé∞ÔºÅ`,
                    creator: creator,
                    location: {
                        coordinates: position,
                        discoveryRadius: type.discoveryRadius
                    },
                    category: type.category,
                    rewards: type.rewards,
                    rarity: type.rarity,
                    icon: type.icon,
                    color: type.color,
                    stats: {
                        views: 0,
                        likes: 0,
                        discoveries: 0
                    },
                    createdAt: new Date(),
                    status: 'active'
                };
                return treasure;
            },

            // ÂèëÁé∞ÂÆùËóè
            discoverTreasure: (treasureId, userPosition) => {
                const treasureIndex = userData.createdTreasures.findIndex(t => t.id === treasureId);
                if (treasureIndex === -1) return { success: false, reason: 'treasure_not_found' };

                const treasure = userData.createdTreasures[treasureIndex];
                const distance = calculateDistance(userPosition, treasure.location.coordinates);

                if (distance > treasure.location.discoveryRadius) {
                    return { 
                        success: false, 
                        reason: 'too_far',
                        distance: distance,
                        requiredDistance: treasure.location.discoveryRadius
                    };
                }

                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂèëÁé∞Ëøá
                if (userData.discoveredTreasures.includes(treasureId)) {
                    return { success: false, reason: 'already_discovered' };
                }

                // ËÆ∞ÂΩïÂèëÁé∞
                userData.discoveredTreasures.push(treasureId);
                userData.stats.treasuresDiscovered += 1;
                treasure.stats.discoveries += 1;

                // Â•ñÂä±ÁªèÈ™åÂíåÈáëÂ∏Å
                const reward = userManager.addExperience(treasure.rewards.experience);
                userManager.addCoins(treasure.rewards.coins);

                // Ê£ÄÊü•ÊàêÂ∞±
                achievementManager.checkAchievements();

                // ‰øùÂ≠òÊï∞ÊçÆ
                saveUserData();

                return {
                    success: true,
                    treasure: treasure,
                    rewards: treasure.rewards,
                    levelUp: reward.levelUp
                };
            }
        };

        // Áî®Êà∑ÁÆ°ÁêÜÁ≥ªÁªü
        const userManager = {
            // Ê∑ªÂä†ÁªèÈ™åÂÄº
            addExperience: (points) => {
                const oldLevel = userData.level.currentLevel;
                userData.level.experience += points;
                
                const newLevel = levelSystem.getLevel(userData.level.experience);
                if (newLevel > oldLevel) {
                    userData.level.currentLevel = newLevel;
                    
                    // Á≠âÁ∫ßÊèêÂçáÂ•ñÂä±
                    const reward = {
                        coins: newLevel * 10,
                        badge: newLevel % 10 === 0 ? `level_${newLevel}` : null
                    };

                    if (reward.badge) {
                        userManager.addBadge(reward.badge, 'üèÜ', `ËææÂà∞Á¨¨${newLevel}Á∫ß`);
                    }

                    return {
                        levelUp: true,
                        oldLevel: oldLevel,
                        newLevel: newLevel,
                        reward: reward
                    };
                }
                
                return { levelUp: false };
            },

            // Ê∑ªÂä†ÂæΩÁ´†
            addBadge: (badgeName, icon, description) => {
                const existingBadge = userData.level.badges.find(badge => badge.name === badgeName);
                if (!existingBadge) {
                    userData.level.badges.push({
                        name: badgeName,
                        icon: icon,
                        description: description,
                        unlockedAt: new Date()
                    });
                    return true;
                }
                return false;
            },

            // Ê∑ªÂä†ÈáëÂ∏ÅÔºàËôöÊãüË¥ßÂ∏ÅÔºâ
            addCoins: (amount) => {
                if (!userData.coins) userData.coins = 0;
                userData.coins += amount;
            },

            // Ëé∑ÂèñÁî®Êà∑Á≠âÁ∫ß‰ø°ÊÅØ
            getLevelInfo: () => {
                const currentExp = userData.level.experience;
                const currentLevel = userData.level.currentLevel;
                const expForCurrentLevel = levelSystem.getExpForLevel(currentLevel);
                const expForNextLevel = levelSystem.getExpForLevel(currentLevel + 1);
                const expToNext = expForNextLevel - currentExp;
                const progress = ((currentExp - expForCurrentLevel) / (expForNextLevel - expForCurrentLevel)) * 100;

                return {
                    currentLevel,
                    currentExp,
                    expToNext,
                    progress: Math.max(0, Math.min(100, progress))
                };
            }
        };

        // ÊàêÂ∞±Á≥ªÁªü
        const achievementManager = {
            checkAchievements: () => {
                const achievements = [];

                // Á¨¨‰∏Ä‰∏™ÂÆùËóè
                if (userData.stats.treasuresDiscovered === 1) {
                    achievements.push(userManager.addBadge('first_treasure', 'üéØ', 'ÂèëÁé∞Á¨¨‰∏Ä‰∏™ÂÆùËóè'));
                }

                // ÂØªÂÆùÁåé‰∫∫
                if (userData.stats.treasuresDiscovered === 10) {
                    achievements.push(userManager.addBadge('treasure_hunter', 'üèÉ', 'ÂèëÁé∞10‰∏™ÂÆùËóè'));
                }

                // ÂØªÂÆùÂ§ßÂ∏à
                if (userData.stats.treasuresDiscovered === 50) {
                    achievements.push(userManager.addBadge('treasure_master', 'üëë', 'ÂèëÁé∞50‰∏™ÂÆùËóè'));
                }

                // ‰º†Â•áÂèëÁé∞ËÄÖÔºàÂèëÁé∞‰º†Â•áÁ∫ßÂÆùËóèÔºâ
                const legendaryFound = userData.createdTreasures.some(t => 
                    userData.discoveredTreasures.includes(t.id) && t.rarity === 'legendary'
                );
                if (legendaryFound) {
                    achievements.push(userManager.addBadge('legendary_finder', 'üíé', 'ÂèëÁé∞‰º†Â•áÁ∫ßÂÆùËóè'));
                }

                return achievements.filter(Boolean);
            }
        };

        // Ë∑ùÁ¶ªËÆ°ÁÆóÂ∑•ÂÖ∑
        function calculateDistance(pos1, pos2) {
            const R = 6371000; // Âú∞ÁêÉÂçäÂæÑ(Á±≥)
            const lat1 = pos1[1] * Math.PI / 180;
            const lat2 = pos2[1] * Math.PI / 180;
            const deltaLat = (pos2[1] - pos1[1]) * Math.PI / 180;
            const deltaLng = (pos2[0] - pos1[0]) * Math.PI / 180;

            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // ‰øùÂ≠òÂíåÂä†ËΩΩÁî®Êà∑Êï∞ÊçÆ
        function saveUserData() {
            userData.lastActiveAt = new Date();
            storageManager.save('douyin-treasure-user', userData);
        }

        function loadUserData() {
            const saved = storageManager.load('douyin-treasure-user');
            if (saved) {
                userData = { ...userData, ...saved };
                // Á°Æ‰øùÊó•ÊúüÂ≠óÊÆµÊ≠£Á°ÆËß£Êûê
                if (saved.lastActiveAt) {
                    userData.lastActiveAt = new Date(saved.lastActiveAt);
                }
            }
        }

        // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆÊòæÁ§∫
        function updateStats(accuracy = 0) {
            document.getElementById('online-users').textContent = '1';
            document.getElementById('total-treasures').textContent = treasureMarkers.length;
            document.getElementById('accuracy').textContent = `${Math.round(accuracy)}m`;
            
            // Êõ¥Êñ∞Áî®Êà∑Á≠âÁ∫ß‰ø°ÊÅØ
            const levelInfo = userManager.getLevelInfo();
            if (document.getElementById('user-level')) {
                document.getElementById('user-level').textContent = `LV.${levelInfo.currentLevel}`;
            }
            if (document.getElementById('user-exp')) {
                document.getElementById('user-exp').textContent = `${userData.level.experience} EXP`;
            }
        }

        // ÂàùÂßãÂåñÂú∞Âõæ
        function initMap() {
            const apiKey = document.getElementById('api-key').value.trim();
            
            if (!apiKey) {
                updateStatus('ËØ∑ËæìÂÖ•È´òÂæ∑Âú∞ÂõæAPI KeyÔºÅ', 'error');
                return;
            }

            updateStatus('Ê≠£Âú®Âä†ËΩΩÈ´òÂæ∑Âú∞Âõæ...', 'info', true);
            localStorage.setItem('amap-api-key', apiKey);

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            const initBtn = document.getElementById('init-btn-text');
            initBtn.innerHTML = '<span class="loading"></span> Ê≠£Âú®Âä†ËΩΩ...';

            // Âä®ÊÄÅÂä†ËΩΩÈ´òÂæ∑Âú∞ÂõæAPI
            const script = document.createElement('script');
            script.src = `https://webapi.amap.com/maps?v=2.0&key=${apiKey}&plugin=AMap.Geolocation`;
            script.onload = function() {
                createMap();
            };
            script.onerror = function() {
                updateStatus('È´òÂæ∑Âú∞ÂõæAPIÂä†ËΩΩÂ§±Ë¥•ÔºÅËØ∑Ê£ÄÊü•KeyÊòØÂê¶Ê≠£Á°ÆÊàñÁΩëÁªúËøûÊé•', 'error');
                document.getElementById('init-btn-text').innerHTML = 'üöÄ ÈáçÊñ∞ÂêØÂä®';
            };
            document.head.appendChild(script);
        }

        // ÂàõÂª∫Âú∞ÂõæÂÆû‰æã
        function createMap() {
            try {
                updateStatus('Ê≠£Âú®ÂàõÂª∫Âú∞ÂõæÂÆû‰æã...', 'info', true);
                
                map = new AMap.Map('map-container', {
                    zoom: 14,
                    center: [121.4737, 31.2304], // ÈªòËÆ§‰∏äÊµ∑ÂùêÊ†á
                    viewMode: '2D',
                    showLabel: true,
                    mapStyle: 'amap://styles/normal',
                    resizeEnable: true
                });

                // Âú∞ÂõæÂä†ËΩΩÂÆåÊàê‰∫ã‰ª∂
                map.on('complete', function() {
                    updateStatus('Âú∞ÂõæÂä†ËΩΩÊàêÂäüÔºÅÊ≠£Âú®Ëé∑ÂèñÊÇ®ÁöÑ‰ΩçÁΩÆ...', 'success');
                    
                    // ÈáçÁΩÆÊåâÈíÆ
                    document.getElementById('init-btn-text').innerHTML = '‚úÖ Âú∞ÂõæÂ∑≤ÂêØÂä®';
                    
                    // ÂêØÁî®ÊéßÂà∂ÊåâÈíÆ
                    document.querySelectorAll('.btn').forEach(btn => {
                        if (!btn.onclick || btn.onclick.toString().includes('initMap')) {
                            return;
                        }
                        btn.disabled = false;
                    });

                    // Ëá™Âä®Ëé∑Âèñ‰ΩçÁΩÆ
                    setTimeout(() => {
                        testGPS();
                    }, 1000);
                });

                // Âú∞ÂõæÁÇπÂáª‰∫ã‰ª∂ - Ê∑ªÂä†ÂÆùËóè
                map.on('click', function(e) {
                    if (userLocation && confirm('Âú®Ê≠§‰ΩçÁΩÆÊ∑ªÂä†ÂÆùËóèÔºü')) {
                        addTreasureAtPosition([e.lnglat.lng, e.lnglat.lat]);
                    }
                });

            } catch (error) {
                updateStatus('Âú∞ÂõæÂàõÂª∫Â§±Ë¥•: ' + error.message, 'error');
                document.getElementById('init-btn-text').innerHTML = 'üöÄ ÈáçÊñ∞ÂêØÂä®';
            }
        }

        // ÊµãËØïGPSÂÆö‰Ωç
        function testGPS() {
            if (!map) {
                updateStatus('ËØ∑ÂÖàÂàùÂßãÂåñÂú∞ÂõæÔºÅ', 'warning');
                return;
            }

            updateStatus('Ê≠£Âú®Ëé∑ÂèñGPS‰ΩçÁΩÆ...', 'info', true);
            updateGPSData('<div class="loading"></div> Ê≠£Âú®ÂÆö‰Ωç...');

            // Áõ¥Êé•‰ΩøÁî®ÊµèËßàÂô®ÂéüÁîüGPSÔºàÊõ¥ÂèØÈù†Ôºâ
            useNativeGeolocation();
            
            // Â¶ÇÊûúÂéüÁîüAPIÂ§±Ë¥•ÔºåÂÜçÂ∞ùËØïÈ´òÂæ∑ÂÆö‰ΩçÔºà‰Ωú‰∏∫Â§áÈÄâÔºâ
            setTimeout(() => {
                if (!userLocation && window.AMap && AMap.Geolocation) {
                    updateStatus('Â∞ùËØïÈ´òÂæ∑Âú∞ÂõæÂÆö‰ΩçÊúçÂä°...', 'info', true);
                    
                    const geolocation = new AMap.Geolocation({
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 10000,
                        convert: true,
                        showButton: false,
                        showMarker: false,
                        showCircle: false
                    });

                    geolocation.getCurrentPosition((status, result) => {
                        if (status === 'complete' && !userLocation) {
                            handleLocationSuccess({
                                coords: {
                                    latitude: result.position.lat,
                                    longitude: result.position.lng,
                                    accuracy: result.accuracy || 100
                                },
                                timestamp: Date.now()
                            });
                        } else if (status === 'error') {
                            console.log('È´òÂæ∑ÂÆö‰ΩçÂ§±Ë¥•:', result);
                            if (!userLocation) {
                                // ÊúÄÂêé‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆ
                                handleLocationError({ code: 0, message: 'ÊâÄÊúâÂÆö‰ΩçÊñπÂºèÂùáÂ§±Ë¥•' });
                            }
                        }
                    });
                }
            }, 3000);
        }

        // ‰ΩøÁî®ÊµèËßàÂô®ÂéüÁîüÂÆö‰ΩçAPI
        function useNativeGeolocation() {
            console.log('ÂºÄÂßãGPSÂÆö‰ΩçÊµÅÁ®ã...');
            
            if (!navigator.geolocation) {
                updateStatus('ÊµèËßàÂô®‰∏çÊîØÊåÅGPSÂÆö‰ΩçÂäüËÉΩ', 'error');
                updateGPSData('ÈîôËØØ: ÊµèËßàÂô®‰∏çÊîØÊåÅÂú∞ÁêÜÂÆö‰ΩçAPI');
                console.error('ÊµèËßàÂô®‰∏çÊîØÊåÅgeolocation');
                return;
            }

            console.log('ÊµèËßàÂô®ÊîØÊåÅGPSÔºåÂºÄÂßãÂÆö‰Ωç...');
            updateStatus('Ê≠£Âú®‰ΩøÁî®GPSÂÆö‰Ωç...', 'info', true);
            
            // ËÆæÁΩÆÂÆö‰ΩçÈÄâÈ°π
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };
            
            console.log('ÂÆö‰ΩçÈÄâÈ°π:', options);
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('GPSÂÆö‰ΩçÊàêÂäü:', position);
                    handleLocationSuccess(position);
                },
                (error) => {
                    console.error('GPSÂÆö‰ΩçÂ§±Ë¥•:', error);
                    console.log('ÈîôËØØ‰ª£Á†Å:', error.code, 'ÈîôËØØÊ∂àÊÅØ:', error.message);
                    
                    updateStatus('GPSÂÆö‰ΩçÂ§±Ë¥•ÔºåÂ∞ùËØï‰ΩéÁ≤æÂ∫¶ÂÆö‰Ωç...', 'warning', true);
                    
                    // ÈôçÁ∫ßÂà∞‰ΩéÁ≤æÂ∫¶ÂÆö‰Ωç
                    const lowAccuracyOptions = {
                        enableHighAccuracy: false,
                        timeout: 20000,
                        maximumAge: 600000
                    };
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            console.log('‰ΩéÁ≤æÂ∫¶ÂÆö‰ΩçÊàêÂäü:', position);
                            handleLocationSuccess(position);
                        },
                        (fallbackError) => {
                            console.error('ÊâÄÊúâÂÆö‰ΩçÊñπÂºèÂ§±Ë¥•:', fallbackError);
                            handleLocationError(fallbackError);
                        },
                        lowAccuracyOptions
                    );
                },
                options
            );
        }

        // Â§ÑÁêÜÂÆö‰ΩçÊàêÂäü
        function handleLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy || 0;
            const timestamp = new Date(position.timestamp).toLocaleString();
            
            userLocation = [lng, lat];
            
            updateStatus(`GPSÂÆö‰ΩçÊàêÂäüÔºÅÁ≤æÂ∫¶: ${Math.round(accuracy)}Á±≥`, 'success');
            updateGPSData(`
                <strong>üìç ‰ΩçÁΩÆ‰ø°ÊÅØ</strong><br>
                Á∫¨Â∫¶: ${lat.toFixed(6)} ${lat > 30 && lat < 32 ? '‚úÖ' : '‚ùì'}<br>
                ÁªèÂ∫¶: ${lng.toFixed(6)} ${lng > 120 && lng < 122 ? '‚úÖ' : '‚ùì'}<br>
                Á≤æÂ∫¶: ${Math.round(accuracy)}Á±≥ ${accuracy < 100 ? '‚úÖ' : accuracy < 500 ? '‚ö†Ô∏è' : '‚ùå'}<br>
                Êó∂Èó¥: ${timestamp}<br>
                <small style="color: #666;">
                    ÂùêÊ†áÁ≥ª: WGS84<br>
                    ${lat > 30 && lat < 32 && lng > 120 && lng < 122 ? 'üéØ ‰∏äÊµ∑Âú∞Âå∫ÂÆö‰ΩçÊàêÂäü' : 'üåç Èùû‰∏äÊµ∑Âú∞Âå∫ÊàñÂÆö‰ΩçÂºÇÂ∏∏'}
                </small>
            `);
            
            updateStats(accuracy);
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(17);
            
            // Ëá™Âä®ÁîüÊàêÂë®Âõ¥ÁöÑÂÆùËóè
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1500);
        }

        // Â§ÑÁêÜÂÆö‰ΩçÈîôËØØ
        function handleLocationError(error) {
            let errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'Áî®Êà∑ÊãíÁªù‰∫Ü‰ΩçÁΩÆÊùÉÈôêÔºåËØ∑Âú®ÊµèËßàÂô®ËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏‰ΩçÁΩÆËÆøÈóÆ';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = '‰ΩçÁΩÆ‰ø°ÊÅØ‰∏çÂèØÁî®ÔºåËØ∑Ê£ÄÊü•GPSÊòØÂê¶ÂºÄÂêØ';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'ÂÆö‰ΩçËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑ÈáçËØï';
                    break;
                default:
                    errorMsg = 'Êú™Áü•ÂÆö‰ΩçÈîôËØØÔºåËØ∑ÈáçËØï';
                    break;
            }
            
            updateStatus(`GPSÂÆö‰ΩçÂ§±Ë¥•: ${errorMsg}`, 'error');
            updateGPSData(`
                <strong>‚ùå ÂÆö‰ΩçÂ§±Ë¥•</strong><br>
                ÈîôËØØ: ${errorMsg}<br>
                <small style="color: #666;">
                    Âª∫ËÆÆ:<br>
                    ‚Ä¢ Âú®Êà∑Â§ñÈáçËØï<br>
                    ‚Ä¢ Ê£ÄÊü•ÊµèËßàÂô®ÊùÉÈôêËÆæÁΩÆ<br>
                    ‚Ä¢ Á°Æ‰øùGPSÂäüËÉΩÂ∑≤ÂºÄÂêØ
                </small>
            `);
            
            // ‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆÔºà‰∏äÊµ∑Â§ñÊª©Ôºâ
            userLocation = [121.4737, 31.2304];
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            updateStatus('GPSÂÆö‰ΩçÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆÔºà‰∏äÊµ∑Â§ñÊª©Ôºâ„ÄÇÂª∫ËÆÆÂú®Êà∑Â§ñÈáçÊñ∞Â∞ùËØïÂÆö‰Ωç„ÄÇ', 'warning');
            
            // Âç≥‰ΩøÊòØÈªòËÆ§‰ΩçÁΩÆ‰πüÁîüÊàêÂÆùËóè
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1000);
        }

        // ÂàõÂª∫Áî®Êà∑‰ΩçÁΩÆÊ†áËÆ∞
        function createUserMarker() {
            if (!map || !userLocation) return;

            if (userMarker) {
                map.remove(userMarker);
            }

            userMarker = new AMap.Marker({
                position: userLocation,
                icon: new AMap.Icon({
                    image: 'data:image/svg+xml;base64,' + btoa(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60">
                            <circle cx="30" cy="30" r="25" fill="#4CAF50" stroke="white" stroke-width="5"/>
                            <circle cx="30" cy="30" r="8" fill="white"/>
                            <text x="30" y="38" text-anchor="middle" fill="white" font-size="24">üìç</text>
                        </svg>
                    `),
                    size: new AMap.Size(60, 60),
                    imageOffset: new AMap.Pixel(-30, -30)
                }),
                title: 'ÊàëÁöÑ‰ΩçÁΩÆ',
                zIndex: 1000,
                animation: 'AMAP_ANIMATION_BOUNCE'
            });

            map.add(userMarker);
        }

        // ÁîüÊàêÂë®Âõ¥ÁöÑÂÆùËóè
        function generateNearbyTreasures() {
            console.log('ÂºÄÂßãÁîüÊàêÂÆùËóè...');
            console.log('Âú∞ÂõæÁä∂ÊÄÅ:', map ? 'Â∑≤ÂàùÂßãÂåñ' : 'Êú™ÂàùÂßãÂåñ');
            console.log('Áî®Êà∑‰ΩçÁΩÆ:', userLocation);
            
            if (!map) {
                updateStatus('ËØ∑ÂÖàÂàùÂßãÂåñÂú∞ÂõæÔºÅ', 'warning');
                console.error('Âú∞ÂõæÊú™ÂàùÂßãÂåñ');
                return;
            }
            
            if (!userLocation) {
                updateStatus('ËØ∑ÂÖàËé∑ÂèñGPS‰ΩçÁΩÆÔºÅ', 'warning');
                console.error('Áî®Êà∑‰ΩçÁΩÆÊú™Ëé∑Âèñ');
                return;
            }

            // Ê∏ÖÁ©∫Áé∞ÊúâÂÆùËóè
            if (treasureMarkers.length > 0) {
                console.log('Ê∏ÖÁ©∫Áé∞ÊúâÂÆùËóè:', treasureMarkers.length);
                clearMap();
            }

            updateStatus('Ê≠£Âú®‰∏∫ÊÇ®ÁîüÊàêÂë®Âõ¥ÁöÑÂÆùËóè...', 'info', true);
            console.log('ÂºÄÂßãÁîüÊàêÂÆùËóèÊµÅÁ®ã...');

            // ÁîüÊàê3-6‰∏™ÂÆùËóè
            const treasureCount = Math.floor(Math.random() * 4) + 3;
            console.log('ËÆ°ÂàíÁîüÊàêÂÆùËóèÊï∞Èáè:', treasureCount);
            
            for (let i = 0; i < treasureCount; i++) {
                setTimeout(() => {
                    console.log(`ÁîüÊàêÁ¨¨${i + 1}‰∏™ÂÆùËóè...`);
                    
                    // ÈöèÊú∫ÈÄâÊã©ÂÆùËóèÁ±ªÂûãÔºåÁ®ÄÊúâÂ∫¶ÂΩ±ÂìçÊ¶ÇÁéá
                    const treasureType = getRandomTreasureByRarity();
                    console.log('ÈÄâÊã©ÁöÑÂÆùËóèÁ±ªÂûã:', treasureType);
                    
                    // Âú®Áî®Êà∑‰ΩçÁΩÆÂë®Âõ¥500Á±≥ÂÜÖÈöèÊú∫ÁîüÊàê
                    const angle = Math.random() * 2 * Math.PI;
                    const distance = Math.random() * 0.005 + 0.001; // 100-600Á±≥
                    
                    const offsetLng = Math.cos(angle) * distance;
                    const offsetLat = Math.sin(angle) * distance;
                    const position = [userLocation[0] + offsetLng, userLocation[1] + offsetLat];
                    
                    console.log('ÂÆùËóè‰ΩçÁΩÆ:', position);

                    try {
                        addTreasureAtPosition(position, treasureType);
                        console.log(`Á¨¨${i + 1}‰∏™ÂÆùËóèÁîüÊàêÊàêÂäü`);
                    } catch (error) {
                        console.error(`Á¨¨${i + 1}‰∏™ÂÆùËóèÁîüÊàêÂ§±Ë¥•:`, error);
                    }
                    
                    if (i === treasureCount - 1) {
                        updateStatus(`üó∫Ô∏è Â∑≤ÁîüÊàê${treasureCount}‰∏™ÂÆùËóèÔºÅÂºÄÂßãÊÇ®ÁöÑÂØªÂÆù‰πãÊóÖÂêßÔºÅ`, 'success');
                        console.log('ÊâÄÊúâÂÆùËóèÁîüÊàêÂÆåÊàê');
                    }
                }, i * 300); // Áº©Áü≠Èó¥ÈöîÂà∞300ms
            }
        }

        // Ê†πÊçÆÁ®ÄÊúâÂ∫¶ÈöèÊú∫ÈÄâÊã©ÂÆùËóèÁ±ªÂûã
        function getRandomTreasureByRarity() {
            const rarityWeights = {
                'common': 40,
                'uncommon': 30,
                'rare': 20,
                'epic': 8,
                'legendary': 2
            };

            // ÂàõÂª∫Âä†ÊùÉÊï∞ÁªÑ
            let weightedArray = [];
            treasureTypes.forEach(type => {
                const weight = rarityWeights[type.rarity] || 10;
                for (let i = 0; i < weight; i++) {
                    weightedArray.push(type);
                }
            });

            return weightedArray[Math.floor(Math.random() * weightedArray.length)];
        }

        // ÊâãÂä®Ê∑ªÂä†Âçï‰∏™ÂÆùËóè
        function addTreasure() {
            if (!map || !userLocation) {
                updateStatus('ËØ∑ÂÖàËé∑ÂèñGPS‰ΩçÁΩÆÔºÅ', 'warning');
                return;
            }

            const treasureType = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
            
            // Âú®Áî®Êà∑‰ΩçÁΩÆÈôÑËøëÈöèÊú∫ÁîüÊàêÂÆùËóè
            const offsetLng = (Math.random() - 0.5) * 0.008; // Á∫¶400Á±≥ËåÉÂõ¥
            const offsetLat = (Math.random() - 0.5) * 0.008;
            const position = [userLocation[0] + offsetLng, userLocation[1] + offsetLat];

            addTreasureAtPosition(position, treasureType);
        }

        // Âú®ÊåáÂÆö‰ΩçÁΩÆÊ∑ªÂä†ÂÆùËóè
        function addTreasureAtPosition(position, treasureType = null) {
            console.log('addTreasureAtPosition Ë¢´Ë∞ÉÁî®');
            console.log('‰ΩçÁΩÆÂèÇÊï∞:', position);
            console.log('ÂÆùËóèÁ±ªÂûãÂèÇÊï∞:', treasureType);
            console.log('ÂΩìÂâçÂú∞ÂõæÁä∂ÊÄÅ:', map);
            
            if (!position || !Array.isArray(position) || position.length !== 2) {
                console.error('Êó†ÊïàÁöÑ‰ΩçÁΩÆÂèÇÊï∞:', position);
                updateStatus('‚ùå ‰ΩçÁΩÆÂèÇÊï∞ÈîôËØØ', 'error');
                return;
            }
            
            if (!map) {
                console.error('Âú∞ÂõæÊú™ÂàùÂßãÂåñ');
                updateStatus('‚ùå Âú∞ÂõæÊú™ÂàùÂßãÂåñ', 'error');
                return;
            }

            if (!treasureType) {
                treasureType = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
                console.log('ÈöèÊú∫ÈÄâÊã©ÂÆùËóèÁ±ªÂûã:', treasureType);
            }

            try {
                // ÂàõÂª∫ÂÆùËóèÊï∞ÊçÆ
                console.log('ÂàõÂª∫ÂÆùËóèÊï∞ÊçÆ...');
                const treasureData = treasureManager.createTreasure(position, treasureType, 'player');
                console.log('ÂÆùËóèÊï∞ÊçÆÂàõÂª∫ÊàêÂäü:', treasureData);
                
                userData.createdTreasures.push(treasureData);
                userData.stats.treasuresCreated += 1;
                console.log('Áî®Êà∑Êï∞ÊçÆÊõ¥Êñ∞ÂÆåÊàê');

                // ÂàõÂª∫Âú∞ÂõæÊ†áËÆ∞
                console.log('ÂàõÂª∫Âú∞ÂõæÊ†áËÆ∞...');
                const treasureMarker = new AMap.Marker({
                    position: position,
                    icon: new AMap.Icon({
                        image: 'data:image/svg+xml;base64,' + btoa(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50">
                                <circle cx="25" cy="25" r="20" fill="${treasureType.color}" stroke="white" stroke-width="4"/>
                                <circle cx="25" cy="25" r="15" fill="${treasureType.color}" opacity="0.3"/>
                                <text x="25" y="33" text-anchor="middle" fill="white" font-size="18">${treasureType.icon}</text>
                            </svg>
                        `),
                        size: new AMap.Size(50, 50),
                        imageOffset: new AMap.Pixel(-25, -25)
                    }),
                    title: `${treasureType.name} (${treasureType.rarity})`,
                    zIndex: 500
                });
                console.log('Âú∞ÂõæÊ†áËÆ∞ÂàõÂª∫ÊàêÂäü:', treasureMarker);

            // Â≠òÂÇ®ÂÆùËóèIDÂà∞Ê†áËÆ∞‰∏ä
            treasureMarker.treasureId = treasureData.id;

            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
            treasureMarker.on('click', function() {
                if (userLocation) {
                    const distance = calculateDistance(userLocation, position);
                    const requiredDistance = treasureData.location.discoveryRadius;
                    
                    if (distance <= requiredDistance) {
                        // Â∞ùËØïÂèëÁé∞ÂÆùËóè
                        const result = treasureManager.discoverTreasure(treasureData.id, userLocation);
                        
                        if (result.success) {
                            // ÂèëÁé∞ÊàêÂäü
                            map.remove(treasureMarker);
                            treasureMarkers = treasureMarkers.filter(m => m !== treasureMarker);
                            
                            let message = `üéâ ÊÅ≠ÂñúÔºÅÊÇ®ÂèëÁé∞‰∫Ü${result.treasure.title}ÔºÅ\n`;
                            message += `üí∞ Ëé∑Âæó ${result.rewards.coins} ÈáëÂ∏Å\n`;
                            message += `‚≠ê Ëé∑Âæó ${result.rewards.experience} ÁªèÈ™å`;
                            
                            if (result.levelUp) {
                                message += `\nüéä Á≠âÁ∫ßÊèêÂçáÔºÅLV.${result.levelUp.oldLevel} ‚Üí LV.${result.levelUp.newLevel}`;
                            }
                            
                            updateStatus(message, 'success');
                            
                            // Ê£ÄÊü•Êñ∞ÊàêÂ∞±
                            const newAchievements = achievementManager.checkAchievements();
                            if (newAchievements.length > 0) {
                                setTimeout(() => {
                                    updateStatus('üèÜ Ëé∑ÂæóÊñ∞ÊàêÂ∞±ÔºÅÊü•ÁúãÂæΩÁ´†Á≥ªÁªü‰∫ÜËß£ËØ¶ÊÉÖ', 'success');
                                }, 2000);
                            }
                            
                        } else {
                            // ÂèëÁé∞Â§±Ë¥•
                            if (result.reason === 'already_discovered') {
                                updateStatus('ÊÇ®Â∑≤ÁªèÂèëÁé∞ËøáËøô‰∏™ÂÆùËóè‰∫Ü', 'warning');
                            } else if (result.reason === 'too_far') {
                                updateStatus(`Ë∑ùÁ¶ªÂ§™ËøúÔºÅËøòÈúÄË¶ÅÈù†Ëøë${Math.round(result.distance - result.requiredDistance)}Á±≥`, 'warning');
                            }
                        }
                    } else {
                        updateStatus(`${treasureType.name}Ë∑ùÁ¶ªÊÇ®ËøòÊúâ${Math.round(distance)}Á±≥ÔºàÈúÄË¶ÅÂú®${requiredDistance}Á±≥ÂÜÖÔºâ`, 'info');
                        
                        // ÊòæÁ§∫Ë∑ùÁ¶ªÊåáÁ§∫
                        const infoWindow = new AMap.InfoWindow({
                            content: `
                                <div style="padding: 10px; text-align: center;">
                                    <div style="font-size: 1.2rem; margin-bottom: 5px;">${treasureType.icon} ${treasureType.name}</div>
                                    <div style="color: #666; font-size: 0.9rem;">Ë∑ùÁ¶ª: ${Math.round(distance)}Á±≥</div>
                                    <div style="color: #666; font-size: 0.9rem;">ÈúÄË¶Å: ${requiredDistance}Á±≥ÂÜÖ</div>
                                    <div style="color: #667eea; font-size: 0.8rem; margin-top: 5px;">
                                        üí∞ ${treasureType.rewards.coins} ÈáëÂ∏Å | ‚≠ê ${treasureType.rewards.experience} ÁªèÈ™å
                                    </div>
                                </div>
                            `,
                            anchor: 'bottom-center',
                            offset: new AMap.Pixel(0, -5)
                        });
                        infoWindow.open(map, position);
                        
                        // 3ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
                        setTimeout(() => {
                            infoWindow.close();
                        }, 3000);
                    }
                }
            });

                // Ê∑ªÂä†Âà∞Âú∞Âõæ
                console.log('Ê∑ªÂä†Ê†áËÆ∞Âà∞Âú∞Âõæ...');
                map.add(treasureMarker);
                treasureMarkers.push(treasureMarker);
                console.log('Ê†áËÆ∞Â∑≤Ê∑ªÂä†Âà∞Âú∞ÂõæÔºåÂΩìÂâçÂÆùËóèÊï∞Èáè:', treasureMarkers.length);
                
                // ‰øùÂ≠òÊï∞ÊçÆ
                saveUserData();
                
                updateStatus(`‚ú® ÂàõÂª∫‰∫Ü${treasureType.name}ÂÆùËóèÔºÅÔºà${treasureType.category}Á±ªÂà´Ôºâ`, 'success');
                updateStats();
                
            } catch (error) {
                console.error('Ê∑ªÂä†ÂÆùËóèÂ§±Ë¥•:', error);
                updateStatus(`‚ùå ÂÆùËóèÂàõÂª∫Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // Ê∏ÖÁ©∫Âú∞Âõæ
        function clearMap() {
            if (treasureMarkers.length === 0) {
                updateStatus('Âú∞Âõæ‰∏äÊ≤°ÊúâÂÆùËóè', 'info');
                return;
            }

            map.remove(treasureMarkers);
            treasureMarkers = [];
            updateStatus('üóëÔ∏è Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâÂÆùËóè', 'success');
            updateStats();
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÁöÑÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆ
            loadUserData();
            
            const savedKey = localStorage.getItem('amap-api-key');
            if (savedKey) {
                document.getElementById('api-key').value = savedKey;
                updateStatus('ÂèëÁé∞Â∑≤‰øùÂ≠òÁöÑAPI KeyÔºåÁÇπÂáªÂêØÂä®Âç≥ÂèØÂºÄÂßãÊ∏∏Êàè', 'success');
            }

            // ÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØ
            if (userData.stats.treasuresDiscovered > 0) {
                updateStatus(`Ê¨¢ËøéÂõûÊù•ÔºÅÊÇ®Â∑≤ÂèëÁé∞ ${userData.stats.treasuresDiscovered} ‰∏™ÂÆùËóèÔºåÂΩìÂâçÁ≠âÁ∫ß LV.${userData.level.currentLevel}`, 'success');
            }

            // Êõ¥Êñ∞ÂàùÂßãÁªüËÆ°
            updateStats();
            
            // ÊòæÁ§∫Áî®Êà∑ÁªüËÆ°‰ø°ÊÅØ
            updateUserDisplay();
        });

        // Êõ¥Êñ∞Áî®Êà∑ÊòæÁ§∫‰ø°ÊÅØ
        function updateUserDisplay() {
            const levelInfo = userManager.getLevelInfo();
            
            // Êõ¥Êñ∞ÁªüËÆ°ÊòæÁ§∫
            if (document.getElementById('total-treasures')) {
                document.getElementById('total-treasures').textContent = userData.stats.treasuresDiscovered;
            }
            
            // Â¶ÇÊûúÊúâÂæΩÁ´†ÊòæÁ§∫Âå∫ÂüüÔºåÊõ¥Êñ∞ÂæΩÁ´†
            if (userData.level.badges.length > 0) {
                console.log('üèÜ Â∑≤Ëé∑ÂæóÂæΩÁ´†:', userData.level.badges.map(b => `${b.icon} ${b.description}`).join(', '));
            }
        }

        // ÂØºÂá∫Áî®Êà∑Êï∞ÊçÆÔºàÁî®‰∫éË∞ÉËØïÊàñÂ§á‰ªΩÔºâ
        function exportUserData() {
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'douyin-treasure-userdata.json';
            a.click();
            URL.revokeObjectURL(url);
            updateStatus('Áî®Êà∑Êï∞ÊçÆÂ∑≤ÂØºÂá∫', 'success');
        }

        // ÈáçÁΩÆÁî®Êà∑Êï∞ÊçÆ
        function resetUserData() {
            if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÊ∏∏ÊàèÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ')) {
                storageManager.remove('douyin-treasure-user');
                location.reload();
            }
        }

        // ÁßªÂä®Á´ØË∞ÉËØïÂäüËÉΩ
        function debugLocationInfo() {
            let debugInfo = `
                <strong>üîß Ë∞ÉËØï‰ø°ÊÅØ</strong><br>
                Áî®Êà∑‰ª£ÁêÜ: ${navigator.userAgent.substring(0, 50)}...<br>
                ÊîØÊåÅGPS: ${navigator.geolocation ? '‚úÖ' : '‚ùå'}<br>
                ÂΩìÂâçÊó∂Èó¥: ${new Date().toLocaleString()}<br>
                Âú∞ÂõæÁä∂ÊÄÅ: ${map ? '‚úÖ Â∑≤ÂàùÂßãÂåñ' : '‚ùå Êú™ÂàùÂßãÂåñ'}<br>
                Áî®Êà∑‰ΩçÁΩÆ: ${userLocation ? `${userLocation[1].toFixed(4)}, ${userLocation[0].toFixed(4)}` : '‚ùå Êú™Ëé∑Âèñ'}<br>
                ÂÆùËóèÊï∞Èáè: ${treasureMarkers.length}<br>
                HTTPS: ${location.protocol === 'https:' ? '‚úÖ' : '‚ùå GPSÈúÄË¶ÅHTTPS'}<br>
            `;
            
            // Ê£ÄÊü•ÊùÉÈôêÁä∂ÊÄÅ
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    debugInfo += `GPSÊùÉÈôê: ${result.state}<br>`;
                    updateGPSData(debugInfo);
                });
            } else {
                updateGPSData(debugInfo);
            }
        }

        // Á¥ßÊÄ•ÊµãËØïÂäüËÉΩ
        function emergencyTest() {
            console.log('üö® ÂºÄÂßãÁ¥ßÊÄ•ÊµãËØï...');
            updateStatus('üö® Á¥ßÊÄ•ÊµãËØïÂºÄÂßã...', 'info', true);
            
            // Âº∫Âà∂ËÆæÁΩÆ‰∏äÊµ∑‰ΩçÁΩÆ
            userLocation = [121.4737, 31.2304];
            console.log('ËÆæÁΩÆÁî®Êà∑‰ΩçÁΩÆ:', userLocation);
            
            if (!map) {
                console.error('Âú∞ÂõæÊú™ÂàùÂßãÂåñÔºåÊó†Ê≥ïËøõË°åÊµãËØï');
                updateStatus('‚ùå Âú∞ÂõæÊú™ÂàùÂßãÂåñ', 'error');
                return;
            }
            
            // ÂàõÂª∫Áî®Êà∑Ê†áËÆ∞
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            
            updateGPSData(`
                <strong>üö® Á¥ßÊÄ•ÊµãËØï‰ΩçÁΩÆ</strong><br>
                Á∫¨Â∫¶: 31.230400 ‚úÖ<br>
                ÁªèÂ∫¶: 121.473700 ‚úÖ<br>
                Á≤æÂ∫¶: ÊµãËØïÊ®°Âºè<br>
                Êó∂Èó¥: ${new Date().toLocaleString()}<br>
                <small style="color: #666;">üéØ ‰∏äÊµ∑Â§ñÊª©ÊµãËØï‰ΩçÁΩÆ</small>
            `);
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÂÆùËóè
            clearMap();
            
            // Áõ¥Êé•ÂàõÂª∫‰∏Ä‰∏™ÊµãËØïÂÆùËóè
            console.log('ÂàõÂª∫ÊµãËØïÂÆùËóè...');
            setTimeout(() => {
                const testPosition = [121.4737 + 0.001, 31.2304 + 0.001]; // Á®çÂæÆÂÅèÁßª
                const testTreasure = treasureTypes[0]; // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÂÆùËóèÁ±ªÂûã
                
                console.log('ÊµãËØïÂÆùËóè‰ΩçÁΩÆ:', testPosition);
                console.log('ÊµãËØïÂÆùËóèÁ±ªÂûã:', testTreasure);
                
                try {
                    addTreasureAtPosition(testPosition, testTreasure);
                    updateStatus('üö® Á¥ßÊÄ•ÊµãËØïÂÆåÊàêÔºÅÂ¶ÇÊûúÁúãÂà∞ÂÆùËóèËØ¥ÊòéÂäüËÉΩÊ≠£Â∏∏', 'success');
                } catch (error) {
                    console.error('Á¥ßÊÄ•ÊµãËØïÂ§±Ë¥•:', error);
                    updateStatus('‚ùå Á¥ßÊÄ•ÊµãËØïÂ§±Ë¥•: ' + error.message, 'error');
                }
            }, 500);
        }

        // Âº∫Âà∂‰ΩøÁî®‰∏äÊµ∑‰ΩçÁΩÆÔºàË∞ÉËØïÁî®Ôºâ
        function useShanghai() {
            userLocation = [121.4737, 31.2304]; // ‰∏äÊµ∑Â§ñÊª©
            createUserMarker();
            map.setCenter(userLocation);
            map.setZoom(16);
            updateStatus('üó∫Ô∏è Â∑≤ÂàáÊç¢Âà∞‰∏äÊµ∑Â§ñÊª©‰ΩçÁΩÆ', 'success');
            updateGPSData(`
                <strong>üìç ‰∏äÊµ∑Â§ñÊª©‰ΩçÁΩÆ</strong><br>
                Á∫¨Â∫¶: 31.230400 ‚úÖ<br>
                ÁªèÂ∫¶: 121.473700 ‚úÖ<br>
                Á≤æÂ∫¶: Ê®°Êãü‰ΩçÁΩÆ<br>
                Êó∂Èó¥: ${new Date().toLocaleString()}<br>
                <small style="color: #666;">üéØ ‰∏äÊµ∑Âú∞Âå∫Ê®°ÊãüÂÆö‰Ωç</small>
            `);
            
            // ÁîüÊàêÂÆùËóè
            setTimeout(() => {
                generateNearbyTreasures();
            }, 1000);
        }

        // ÈîÆÁõòÂø´Êç∑ÈîÆÂíåËß¶Êë∏‰∫ã‰ª∂
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        if (!map) initMap();
                        else testGPS();
                        break;
                    case 't':
                        e.preventDefault();
                        addTreasure();
                        break;
                    case 's':
                        e.preventDefault();
                        useShanghai();
                        break;
                    case 'd':
                        e.preventDefault();
                        debugLocationInfo();
                        break;
                    case 'Delete':
                    case 'Backspace':
                        e.preventDefault();
                        clearMap();
                        break;
                }
            }
        });

        // ÁßªÂä®Á´ØÈïøÊåâÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ
        let touchTimer;
        document.addEventListener('touchstart', function(e) {
            if (e.target.id === 'gps-data') {
                touchTimer = setTimeout(() => {
                    debugLocationInfo();
                }, 1000);
            }
        });

        document.addEventListener('touchend', function() {
            clearTimeout(touchTimer);
        });
    </script>
</body>
</html>
