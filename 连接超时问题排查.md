# 🔍 连接超时问题排查指南

## 当前问题
- **错误类型**：`ERR_CONNECTION_TIMED_OUT`
- **现象**：电脑和手机上都无法连接到服务器
- **服务器地址**：`https://totofun-server007.vercel.app`

## 🔧 排查步骤

### 步骤1：检查 Vercel 部署状态

1. 访问 [Vercel Dashboard](https://vercel.com/dashboard)
2. 找到项目 `totofun-server007`
3. 检查最新部署状态：
   - ✅ 如果显示 "Ready"，说明部署成功
   - ❌ 如果显示 "Error" 或 "Building"，需要查看日志

### 步骤2：查看 Vercel 部署日志

1. 在 Vercel Dashboard 中点击项目
2. 点击 "Deployments" 标签
3. 点击最新的部署
4. 查看 "Build Logs" 和 "Function Logs"
5. **查找错误信息**：
   - MongoDB 连接错误
   - 环境变量缺失
   - 代码执行错误

### 步骤3：测试健康检查端点

在浏览器中访问：
```
https://totofun-server007.vercel.app/health
```

**预期结果**：
```json
{
  "status": "ok",
  "timestamp": "...",
  "uptime": ...,
  "environment": "production"
}
```

**如果超时或错误**：
- 说明 Serverless 函数没有正确部署
- 或者 MongoDB 连接导致超时

### 步骤4：检查 MongoDB Atlas 网络访问（最重要！）

这是**最可能的原因**！

1. 登录 [MongoDB Atlas](https://cloud.mongodb.com/)
2. 进入你的集群（Cluster0）
3. 点击 **"Network Access"**（网络访问）
4. 检查 IP 地址列表：
   - ✅ 如果有 `0.0.0.0/0`，说明已配置（允许所有IP）
   - ❌ 如果没有，需要添加

**添加网络访问**：
1. 点击 **"Add IP Address"**
2. 选择 **"Allow Access from Anywhere"**（允许从任何地方访问）
3. 或者手动添加 `0.0.0.0/0`
4. 点击 **"Confirm"**
5. ⚠️ **等待 1-2 分钟**让配置生效

### 步骤5：检查 Vercel 环境变量

在 Vercel Dashboard 中：
1. 进入项目设置 → "Environment Variables"
2. 确认以下变量已设置：
   - ✅ `MONGODB_URI` - MongoDB 连接字符串
   - ✅ `JWT_SECRET` - JWT 密钥
   - ✅ `JWT_REFRESH_SECRET` - JWT 刷新密钥
   - ✅ `JWT_EXPIRES_IN` - `7d`
   - ✅ `NODE_ENV` - `production`
   - ✅ `CLIENT_URL` - `https://luciuswang.github.io`

### 步骤6：重新部署

在 Vercel Dashboard 中：
1. 点击项目
2. 点击 "Deployments"
3. 点击最新部署右侧的 **"..."** 菜单
4. 选择 **"Redeploy"**
5. 等待部署完成（约 2-3 分钟）

## 🎯 快速解决方案

### 方案1：配置 MongoDB Atlas 网络访问（推荐）

1. 登录 MongoDB Atlas
2. Network Access → Add IP Address → Allow Access from Anywhere
3. 等待 1-2 分钟
4. 在 Vercel 中重新部署

### 方案2：检查 Vercel 函数日志

1. Vercel Dashboard → 项目 → Deployments → 最新部署
2. 查看 "Function Logs"
3. 查找 MongoDB 连接错误
4. 根据错误信息修复

### 方案3：使用本地服务器测试（临时）

如果 Vercel 部署有问题，可以先用本地服务器测试：

1. 在 `server` 目录运行：
   ```bash
   npm start
   ```

2. 在浏览器控制台设置：
   ```javascript
   localStorage.setItem('API_BASE_URL', 'http://localhost:5000');
   location.reload();
   ```

3. 测试注册功能

## 📋 检查清单

- [ ] MongoDB Atlas 网络访问已配置（`0.0.0.0/0`）
- [ ] Vercel 环境变量已正确设置
- [ ] Vercel 部署状态为 "Ready"
- [ ] `/health` 端点可以访问
- [ ] 部署日志中没有错误

## 🆘 如果问题仍然存在

请提供以下信息：
1. Vercel 部署日志（特别是错误信息）
2. MongoDB Atlas 网络访问配置截图
3. `/health` 端点的访问结果
4. 浏览器控制台的完整错误信息

