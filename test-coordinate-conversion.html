<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åæ ‡è½¬æ¢æµ‹è¯• - GPSä¿®å¤éªŒè¯</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
        }
        
        .header {
            text-align: center;
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .result {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            line-height: 1.8;
        }
        
        .result strong {
            color: #667eea;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .comparison { grid-template-columns: 1fr; }
        }
        
        .coord-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e1e5e9;
        }
        
        .coord-box h4 {
            margin-bottom: 10px;
            color: #667eea;
        }
        
        #map {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            border: 3px solid #e1e5e9;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª åæ ‡è½¬æ¢æµ‹è¯•å·¥å…·</h1>
            <p>éªŒè¯GPSå®šä½ä¿®å¤æ•ˆæœ</p>
        </div>

        <div class="card">
            <h3>ğŸ”‘ APIé…ç½®</h3>
            <div class="input-group">
                <label for="api-key">é«˜å¾·åœ°å›¾API Key:</label>
                <input type="text" id="api-key" class="input" placeholder="è¾“å…¥ä½ çš„API Key">
            </div>
            <button class="btn" onclick="initMap()">åˆå§‹åŒ–åœ°å›¾</button>
            <div id="init-status" class="status info">ç­‰å¾…åˆå§‹åŒ–...</div>
        </div>

        <div class="card">
            <h3>ğŸ“ æµ‹è¯•åæ ‡è½¬æ¢</h3>
            
            <div class="input-group">
                <label>æµ‹è¯•æ–¹æ³•:</label>
                <button class="btn" onclick="testCurrentGPS()">ğŸ“¡ ä½¿ç”¨å½“å‰GPSä½ç½®</button>
                <button class="btn" onclick="testShanghaiCoords()">ğŸ—¼ æµ‹è¯•ä¸Šæµ·åæ ‡</button>
                <button class="btn" onclick="testBeijingCoords()">ğŸ›ï¸ æµ‹è¯•åŒ—äº¬åæ ‡</button>
            </div>
            
            <div class="input-group">
                <label>æˆ–æ‰‹åŠ¨è¾“å…¥WGS84åæ ‡:</label>
                <input type="number" id="manual-lng" class="input" placeholder="ç»åº¦ (ä¾‹: 121.473701)" step="0.000001" style="margin-bottom: 10px;">
                <input type="number" id="manual-lat" class="input" placeholder="çº¬åº¦ (ä¾‹: 31.230416)" step="0.000001">
                <button class="btn" onclick="testManualCoords()">ğŸ”„ è½¬æ¢</button>
            </div>

            <div id="test-result" class="result" style="display: none;">
                <!-- æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>

            <div class="comparison" id="comparison" style="display: none;">
                <div class="coord-box">
                    <h4>ğŸŒ åŸå§‹åæ ‡ (WGS84)</h4>
                    <div id="wgs84-coords"></div>
                </div>
                <div class="coord-box">
                    <h4>ğŸ—ºï¸ è½¬æ¢ååæ ‡ (GCJ-02)</h4>
                    <div id="gcj02-coords"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ—ºï¸ å¯è§†åŒ–å¯¹æ¯”</h3>
            <div id="map"></div>
        </div>

        <div class="card">
            <h3>ğŸ“Š æµ‹è¯•è¯´æ˜</h3>
            <div style="line-height: 1.8;">
                <p><strong>æµ‹è¯•ç›®çš„:</strong> éªŒè¯WGS84åˆ°GCJ-02çš„åæ ‡è½¬æ¢æ˜¯å¦æ­£ç¡®</p>
                <br>
                <p><strong>æœŸæœ›ç»“æœ:</strong></p>
                <ul style="margin-left: 20px;">
                    <li>è½¬æ¢åçš„åæ ‡åº”è¯¥ä¸åŸå§‹åæ ‡æœ‰50-500ç±³çš„åç§»</li>
                    <li>åœ¨åœ°å›¾ä¸Šï¼Œçº¢è‰²æ ‡è®°(WGS84)å’Œè“è‰²æ ‡è®°(GCJ-02)åº”è¯¥æœ‰æ˜æ˜¾é—´è·</li>
                    <li>è“è‰²æ ‡è®°(è½¬æ¢å)åº”è¯¥æ›´æ¥è¿‘åœ°å›¾ä¸Šçš„çœŸå®ä½ç½®</li>
                </ul>
                <br>
                <p><strong>å·²çŸ¥é—®é¢˜:</strong></p>
                <ul style="margin-left: 20px;">
                    <li>å¦‚æœç›´æ¥ä½¿ç”¨WGS84åæ ‡ï¼Œæ ‡è®°ä¼šåç¦»å®é™…ä½ç½®</li>
                    <li>å¿…é¡»ä½¿ç”¨è½¬æ¢åçš„GCJ-02åæ ‡æ‰èƒ½å‡†ç¡®å®šä½</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let map = null;
        let markers = [];

        function showStatus(message, type = 'info', elementId = 'init-status') {
            const status = document.getElementById(elementId);
            status.textContent = message;
            status.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function initMap() {
            const apiKey = document.getElementById('api-key').value.trim();
            
            if (!apiKey) {
                showStatus('è¯·è¾“å…¥API Keyï¼', 'error');
                return;
            }

            showStatus('æ­£åœ¨åŠ è½½é«˜å¾·åœ°å›¾API...', 'info');
            localStorage.setItem('amap-api-key', apiKey);

            const script = document.createElement('script');
            script.src = `https://webapi.amap.com/maps?v=2.0&key=${apiKey}`;
            script.onload = function() {
                console.log('é«˜å¾·åœ°å›¾APIåŠ è½½æˆåŠŸ');
                createMap();
            };
            script.onerror = function() {
                showStatus('APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥Keyæ˜¯å¦æ­£ç¡®', 'error');
            };
            document.head.appendChild(script);
        }

        function createMap() {
            try {
                map = new AMap.Map('map', {
                    zoom: 14,
                    center: [121.4737, 31.2304],
                    viewMode: '2D'
                });

                map.on('complete', function() {
                    showStatus('âœ… åœ°å›¾åˆå§‹åŒ–æˆåŠŸï¼å¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
                });
            } catch (error) {
                showStatus('åœ°å›¾åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        function testCurrentGPS() {
            if (!map) {
                alert('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼');
                return;
            }

            showStatus('æ­£åœ¨è·å–GPSä½ç½®...', 'info', 'init-status');

            if (!navigator.geolocation) {
                showStatus('æµè§ˆå™¨ä¸æ”¯æŒGPS', 'error', 'init-status');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    testCoordinateConversion(lng, lat, `å½“å‰GPSä½ç½® (ç²¾åº¦: ${Math.round(position.coords.accuracy)}ç±³)`);
                },
                (error) => {
                    showStatus('GPSå®šä½å¤±è´¥: ' + error.message, 'error', 'init-status');
                    // ä½¿ç”¨é»˜è®¤åæ ‡
                    testShanghaiCoords();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function testShanghaiCoords() {
            testCoordinateConversion(121.473701, 31.230416, 'ä¸Šæµ·ä¸œæ–¹æ˜ç ');
        }

        function testBeijingCoords() {
            testCoordinateConversion(116.397428, 39.90923, 'åŒ—äº¬å¤©å®‰é—¨');
        }

        function testManualCoords() {
            const lng = parseFloat(document.getElementById('manual-lng').value);
            const lat = parseFloat(document.getElementById('manual-lat').value);

            if (isNaN(lng) || isNaN(lat)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç»çº¬åº¦ï¼');
                return;
            }

            testCoordinateConversion(lng, lat, 'æ‰‹åŠ¨è¾“å…¥åæ ‡');
        }

        function testCoordinateConversion(lng, lat, sourceName) {
            if (!map) {
                alert('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼');
                return;
            }

            console.log('å¼€å§‹æµ‹è¯•åæ ‡è½¬æ¢:', { lng, lat, sourceName });
            
            // æ¸…é™¤æ—§æ ‡è®°
            if (markers.length > 0) {
                map.remove(markers);
                markers = [];
            }

            // æ˜¾ç¤ºåŸå§‹åæ ‡
            document.getElementById('wgs84-coords').innerHTML = `
                ç»åº¦: ${lng.toFixed(6)}<br>
                çº¬åº¦: ${lat.toFixed(6)}<br>
                æ¥æº: ${sourceName}
            `;
            document.getElementById('comparison').style.display = 'grid';

            // åˆ›å»ºåŸå§‹åæ ‡æ ‡è®°ï¼ˆçº¢è‰²ï¼‰
            const wgs84Marker = new AMap.Marker({
                position: [lng, lat],
                icon: new AMap.Icon({
                    image: 'data:image/svg+xml;base64,' + btoa(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                            <circle cx="20" cy="20" r="15" fill="#e74c3c" stroke="white" stroke-width="3"/>
                            <text x="20" y="26" text-anchor="middle" fill="white" font-size="16">âŒ</text>
                        </svg>
                    `),
                    size: new AMap.Size(40, 40)
                }),
                title: 'åŸå§‹WGS84åæ ‡ï¼ˆé”™è¯¯ä½ç½®ï¼‰',
                offset: new AMap.Pixel(-20, -20)
            });
            map.add(wgs84Marker);
            markers.push(wgs84Marker);

            // ä½¿ç”¨é«˜å¾·APIè½¬æ¢åæ ‡
            AMap.convertFrom([lng, lat], 'gps', function(status, result) {
                console.log('åæ ‡è½¬æ¢ç»“æœ:', status, result);

                if (result.info === 'ok' && result.locations && result.locations.length > 0) {
                    const converted = result.locations[0];
                    const convertedLng = converted.lng;
                    const convertedLat = converted.lat;

                    // è®¡ç®—åç§»è·ç¦»
                    const distance = calculateDistance(lat, lng, convertedLat, convertedLng);

                    // æ˜¾ç¤ºè½¬æ¢ååæ ‡
                    document.getElementById('gcj02-coords').innerHTML = `
                        ç»åº¦: ${convertedLng.toFixed(6)}<br>
                        çº¬åº¦: ${convertedLat.toFixed(6)}<br>
                        åç§»è·ç¦»: ${Math.round(distance)}ç±³
                    `;

                    // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                    const resultDiv = document.getElementById('test-result');
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `
                        <strong>ğŸ“Š è½¬æ¢ç»“æœ:</strong><br>
                        <br>
                        <strong>åŸå§‹åæ ‡ (WGS84):</strong><br>
                        ç»åº¦: ${lng.toFixed(6)}<br>
                        çº¬åº¦: ${lat.toFixed(6)}<br>
                        <br>
                        <strong>è½¬æ¢ååæ ‡ (GCJ-02):</strong><br>
                        ç»åº¦: ${convertedLng.toFixed(6)}<br>
                        çº¬åº¦: ${convertedLat.toFixed(6)}<br>
                        <br>
                        <strong>ç»åº¦åç§»:</strong> ${(convertedLng - lng).toFixed(6)}Â° (çº¦${Math.round((convertedLng - lng) * 111000)}ç±³)<br>
                        <strong>çº¬åº¦åç§»:</strong> ${(convertedLat - lat).toFixed(6)}Â° (çº¦${Math.round((convertedLat - lat) * 111000)}ç±³)<br>
                        <strong>æ€»åç§»è·ç¦»:</strong> ${Math.round(distance)}ç±³<br>
                        <br>
                        <strong>âœ… ç»“è®º:</strong> ${distance > 30 && distance < 1000 ? 'åæ ‡è½¬æ¢æ­£å¸¸ï¼Œåç§»ç¬¦åˆé¢„æœŸ' : 'âš ï¸ åç§»å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥'}
                    `;

                    // åˆ›å»ºè½¬æ¢ååæ ‡æ ‡è®°ï¼ˆè“è‰²ï¼‰
                    const gcj02Marker = new AMap.Marker({
                        position: [convertedLng, convertedLat],
                        icon: new AMap.Icon({
                            image: 'data:image/svg+xml;base64,' + btoa(`
                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                                    <circle cx="20" cy="20" r="15" fill="#3498db" stroke="white" stroke-width="3"/>
                                    <text x="20" y="26" text-anchor="middle" fill="white" font-size="16">âœ“</text>
                                </svg>
                            `),
                            size: new AMap.Size(40, 40)
                        }),
                        title: 'è½¬æ¢åGCJ-02åæ ‡ï¼ˆæ­£ç¡®ä½ç½®ï¼‰',
                        offset: new AMap.Pixel(-20, -20)
                    });
                    map.add(gcj02Marker);
                    markers.push(gcj02Marker);

                    // ç»˜åˆ¶è¿çº¿
                    const polyline = new AMap.Polyline({
                        path: [[lng, lat], [convertedLng, convertedLat]],
                        strokeColor: '#FF9800',
                        strokeWeight: 3,
                        strokeStyle: 'dashed'
                    });
                    map.add(polyline);
                    markers.push(polyline);

                    // è°ƒæ•´åœ°å›¾è§†é‡
                    map.setFitView();

                    showStatus(`âœ… åæ ‡è½¬æ¢æˆåŠŸï¼åç§»${Math.round(distance)}ç±³`, 'success', 'init-status');
                } else {
                    showStatus('âŒ åæ ‡è½¬æ¢å¤±è´¥', 'error', 'init-status');
                    document.getElementById('test-result').style.display = 'block';
                    document.getElementById('test-result').innerHTML = `
                        <strong style="color: red;">âŒ è½¬æ¢å¤±è´¥</strong><br>
                        çŠ¶æ€: ${status}<br>
                        ä¿¡æ¯: ${result.info || 'æœªçŸ¥é”™è¯¯'}
                    `;
                }
            });
        }

        // è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»ï¼ˆç±³ï¼‰
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // åœ°çƒåŠå¾„(ç±³)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤API Key
        document.addEventListener('DOMContentLoaded', function() {
            const savedKey = localStorage.getItem('amap-api-key');
            if (savedKey) {
                document.getElementById('api-key').value = savedKey;
                showStatus('å‘ç°å·²ä¿å­˜çš„API Key', 'success');
            }
        });
    </script>
</body>
</html>


